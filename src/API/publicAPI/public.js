"use strict";const e=require("path"),t=require("fs"),a=require("moment"),n=require("../../Models/Submenu"),s=require("../../Models/ChildSub"),r=require("../../Models/Sidemenu"),i=require("../../Models/Corps"),o=require("../../Models/CorpsSign"),l=require("../../Models/CorpsBackground"),c=require("../../Models/Command"),u=require("../../Models/CommandSign"),d=require("../../Models/CommandBackground"),p=require("../../Models/Category"),h=require("../../Models/News"),g=require("../../Models/ActualContent"),{all:f}=require("../../Routes/public_router"),_=require("../../Models/Link"),w=require("../../Models/Contact"),{SSL_OP_SSLEAY_080_CLIENT_DH_BUG:y}=require("constants"),b=async e=>{const t={type:"casual",anchors:[],redirect_pages:[]};switch(e){case"historyWar":const e=await Content.find().where({page_subclass:"historyWar",public_status:"active"});if(0!==e.length){e.forEach(e=>{t.anchors.includes(e.anchor_label)||t.anchors.push(e.anchor_label)}),t.anchors.forEach(a=>{const n=[];e.filter(e=>e.anchor_label===a).forEach(e=>{n.push({title:e.page_title,id_page:e._id})});const s={anchor:a,pages:n};t.type="historyWar",t.redirect_pages.push(s)});const a=t.anchors.map(e=>({title:e}));t.anchors=a}break;case"files":t.type="files";const a=await Content.find().where({page_subclass:"files",public_status:"active"});if(0!==a.length)for(let n=0;n<a.length;n++){const{content_folder:e,page_title:s}=a[n],r="/files/"+e,i=await FileNames.findOne().where({base_url:a[n].content_baseUrl});let o;i&&(o=i.names.map(e=>({title:e,link:`${r}/${e}`})));const l={title:s,files:o};t.redirect_pages.push(l)}break;case"contact":(await Content.find().where({page_subclass:"contacts",public_status:"active"})).forEach(e=>{t.redirect_pages.push({title:e.page_title,id_page:e._id})}),t.type="contact"}return t};module.exports.getOneElementBody=async e=>{if("files"!==e&&"contact"!==e&&"historyWar"!==e){const t=JSON.parse(JSON.stringify(await n.findById(e))),a=JSON.parse(JSON.stringify(await s.findById(e)));if(t){const e={...t},a=await Content.findById(t.content_id);return e.content=a,e.type="casual",null!=a&&"cancel"!==a.public_status?e:null}if(a){const e={...t},n=await Content.findById(a.content_id);return e.content=n,e.type="casual",null!=n&&"cancel"!==n.public_status?e:null}return null}return await b(e)},module.exports.getSideMenu=async e=>{const t=JSON.parse(JSON.stringify(await r.find().where({lang:e}))),a=[];for(let n=0;n<t.length;n++){const e={...t[n]};if(null!==t[n].content_id){const s=await Content.findById(t[n].content_id);"cancel"!==s.public_status&&(e.content=s,e.photo=await getPhotoPath(e.content.content_baseUrl),a.push(e))}}return a},module.exports.getNews=async(e,t)=>{let a=await h.find().where({public_status:"active",language:e}).select({id:1,publishDate:2,mainPhoto:3,categoryFK:4,description:5,title:6,type:7}).limit(30).lean();return a.sort((e,t)=>new Date(t.publishDate)-new Date(e.publishDate)),{news:a,category:await p.find().where({contentType:"news"}).lean()}},module.exports.getFiltersNews=async e=>{let t=[],n=[],s=await h.find().where({language:e.lang,public_status:"active"}).select({_id:1,publishDate:2,mainPhoto:3,categoryFK:4,description:5,title:6,type:7}).lean();s.sort((e,t)=>new Date(t.publishDate)-new Date(e.publishDate));let r=await p.find().where({contentType:"news"}).lean();return""===e.date&""===e.category?(t=[...r],{news:s,category:t}):(""!==e.date?(n=s.filter(t=>a(t.publishDate).format("DD/MM/YY")===e.date),""!==e.category&&(n=n.filter(t=>t.categoryFK===e.category))):""!==e.category&&(n=s.filter(t=>t.categoryFK===e.category)),t=[...r],{news:n,category:t})},module.exports.getResultForTroops=async()=>await i.find().lean(),module.exports.getResultForCommand=async()=>await c.find().lean(),module.exports.getActual=async e=>{let t;switch(e){case"en":t=await g.find().where({published:!0,$or:[{hasEnContent:!0},{hasDirectLinkEn:!0}]});break;case"ua":t=await g.find().where({published:!0,$or:[{hasUaContent:!0},{hasDirectLinkUa:!0}]})}for(let a=0;a<t.length;a++){if(1==t[a].hasUaContent){let e=t[a].url_ua.slice(14,t[a].url_ua.length);console.log(e),t[a].url_ua=e}if(1==t[a].hasEnContent){console.log("in en");let e=t[a].url_en.slice(14,t[a].url_en.length);t[a].url_en=e}}return t};