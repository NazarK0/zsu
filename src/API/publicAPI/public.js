"use strict";const e=require("../../Models/Content"),t=require("../../Models/Submenu"),n=require("../../Models/ChildSub"),a=require("../../Models/Sidemenu"),l=require("../../Models/MainPhoto"),i=require("../../Models/Corps"),r=require("../../Models/CorpsSign"),s=require("../../Models/CorpsBackground"),o=require("../../Models/Command"),u=require("../../Models/CommandSign"),d=require("../../Models/CommandBackground"),c=require("../../Models/SliderNames"),f=require("../../Models/Category"),_=require("../../Models/CategoryPhoto"),g=require("path"),p=require("fs");let y=require("moment");const{all:w}=require("../../Routes/public_router");async function h(e,t){let n=null,a=null;if(null===e&&null===t)return{front_url:null,back_url:null};const l=await JSON.parse(JSON.stringify(await r.findById(e))),i=await JSON.parse(JSON.stringify(await s.findById(t)));return null!==l&&void 0!==l.url&&(n=l.base64),null!==i&&void 0!==i.url&&(a=i.base64),{front_base64:n,back_base64:a}}async function b(e,t){let n=null,a=null;if(null===e&&null===t)return{front_url:null,back_url:null};const l=await JSON.parse(JSON.stringify(await u.findById(e))),i=await JSON.parse(JSON.stringify(await d.findById(t)));return null!==l&&void 0!==l.url&&(n=l.base64),null!==i&&void 0!==i.url&&(a=i.base64),{front_base64:n,back_base64:a}}async function S(e,t){const n=await l.findOne().where({base_url:e});if(null!==n&&void 0!==n.name){const t=g.join(__dirname,"../../../","uploads",e,"fullsize",n.name),a=g.join(__dirname,"../../../","uploads",e,"middlesize",n.name),l=g.join(__dirname,"../../../","uploads",e,"smallsize",n.name);return{small:p.readFileSync(l,"base64"),middle:p.readFileSync(a,"base64"),full:p.readFileSync(t,"base64")}}return null}module.exports.getOneElementBody=async a=>{const l=JSON.parse(JSON.stringify(await t.findById(a))),i=JSON.parse(JSON.stringify(await n.findById(a)));if(Boolean(l)){let t={...l};const n=await e.findById(l.content_id);return t.content=n,"cancel"!==n.public_status?t:null}if(Boolean(i)){let t={...l};const n=await e.findById(i.content_id);return t.content=n,"cancel"!==n.public_status?t:null}return null},module.exports.getSideMenu=async t=>{const n=JSON.parse(JSON.stringify(await a.find().where({lang:t}))),l=[];for(let a=0;a<n.length;a++){let t={...n[a]};if(null!==n[a].content_id){let i=await e.findById(n[a].content_id);"cancel"!==i.public_status&&(t.content=i,t.photo=await S(t.content.content_baseUrl),l.push(t))}}return l},module.exports.getNews=async t=>{let n=[],a=[],l=[];const i=JSON.parse(JSON.stringify(await e.find().where({page_type:"news",lang:t}).where({public_status:"active"})));for(let e=0;e<i.length;e++){let t={...i[e]};if(t.photo=await S(i[e].content_baseUrl),n.push(t),void 0!==i[e].generated_category_link&&null!==i[e].generated_category_link&&!l.includes(i[e].generated_category_link)){let t=JSON.parse(JSON.stringify(await f.findById(i[e].generated_category_link))),n=JSON.parse(JSON.stringify(await _.findById(t.photo)));t.photo=n.base64,a.push(t),l.push(t._id)}}return{news:n,category:a}},module.exports.getFiltersNews=async t=>{let n=[],a=[],l=[],i=JSON.parse(JSON.stringify(await e.find().where({page_type:"news",lang:t.lang,public_status:"active"})));for(let e=0;e<i.length;e++)if(null!==i[e].content_baseUrl){let t={...i[e]},n=await S(i[e].content_baseUrl);t.photo=null!==n?n.middle:null,l.push(t)}if(""===t.date&""===t.category){let e=await f.find();if(0!==e.length)for(let t=0;t<e.length;t++){let a=await s(e[t]._id);n.push(a)}return{news:l,category:n}}""!==t.date?(a=l.filter(e=>y(e.date).format("DD/MM/YY")===t.date),""!==t.category&&(a=a.filter(e=>e.generated_category_link===t.category))):""!==t.category&&(a=l.filter(e=>e.generated_category_link===t.category));let r=await f.find();if(0!==r.length)for(let e=0;e<r.length;e++){let t=await s(r[e]._id);n.push(t)}async function s(e){let t=await f.findById(e),n=null;return null!==t&&(n=await _.findById(t.photo),null!==n&&(t.photo=n.base64)),t}return{news:a,category:n}},module.exports.getResultForTroops=async()=>{let e=[],t=JSON.parse(JSON.stringify(await i.find()));for(let n=0;n<t.length;n++){const a=await h(t[n].sign_id,t[n].bg_id);let l={title_ua:t[n].title_ua,title_en:t[n].title_en,link:t[n].link,front_photo:a.front_base64,back_photo:a.back_base64};e.push(l)}return e},module.exports.getResultForCommand=async()=>{let e=[],t=JSON.parse(JSON.stringify(await o.find()));for(let n=0;n<t.length;n++){const a=await b(t[n].sign_id,t[n].bg_id);let l={title_ua:t[n].title_ua,title_en:t[n].title_en,link:t[n].link,front_photo:a.front_base64,back_photo:a.back_base64};e.push(l)}return e},module.exports.getSlidersPhotoPath=async(t,n)=>{const a=[],l=[];if(2==n)var i=await e.findOne().where({generated_sidemenu_link:t.params.id});else i=await e.findById(t.params.id);const r=JSON.parse(JSON.stringify(await c.findOne().where({base_url:i.content_baseUrl})));if(r){const{names:e,base_url:t}=r;for(let n=0;n<e.length;n++)a.push(t+"sliders/"+e[n]);for(let n=0;n<a.length;n++){const e=g.join(__dirname,"../../../","uploads",a[n]);l.push(p.readFileSync(e,"base64"))}return l}return null};