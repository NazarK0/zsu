"use strict";const e=require("path"),n=require("fs"),t=require("moment"),a=require("../../Models/Submenu"),l=require("../../Models/ChildSub"),i=require("../../Models/Sidemenu"),r=require("../../Models/Corps"),s=require("../../Models/CorpsSign"),o=require("../../Models/CorpsBackground"),u=require("../../Models/Command"),c=require("../../Models/CommandSign"),d=require("../../Models/CommandBackground"),f=require("../../Models/Category"),p=require("../../Models/News"),_=require("../../Models/ActualContent"),{all:h}=require("../../Routes/public_router"),y=require("../../Models/Link"),g=require("../../Models/Contact"),{SSL_OP_SSLEAY_080_CLIENT_DH_BUG:w}=require("constants"),m=async e=>{const n={type:"casual",anchors:[],redirect_pages:[]};switch(e){case"historyWar":const e=await Content.find().where({page_subclass:"historyWar",public_status:"active"});if(0!==e.length){e.forEach(e=>{n.anchors.includes(e.anchor_label)||n.anchors.push(e.anchor_label)}),n.anchors.forEach(t=>{const a=[];e.filter(e=>e.anchor_label===t).forEach(e=>{a.push({title:e.page_title,id_page:e._id})});const l={anchor:t,pages:a};n.type="historyWar",n.redirect_pages.push(l)});const t=n.anchors.map(e=>({title:e}));n.anchors=t}break;case"files":n.type="files";const t=await Content.find().where({page_subclass:"files",public_status:"active"});if(0!==t.length)for(let a=0;a<t.length;a++){const{content_folder:e,page_title:l}=t[a],i="/files/"+e,r=await FileNames.findOne().where({base_url:t[a].content_baseUrl});let s;r&&(s=r.names.map(e=>({title:e,link:`${i}/${e}`})));const o={title:l,files:s};n.redirect_pages.push(o)}break;case"contact":(await Content.find().where({page_subclass:"contacts",public_status:"active"})).forEach(e=>{n.redirect_pages.push({title:e.page_title,id_page:e._id})}),n.type="contact"}return n};async function b(e,n){let t=null,a=null;if(null===e&&null===n)return{front_url:null,back_url:null};const l=await JSON.parse(JSON.stringify(await s.findById(e))),i=await JSON.parse(JSON.stringify(await o.findById(n)));return null!==l&&void 0!==l.url&&(t=l.base64),null!==i&&void 0!==i.url&&(a=i.base64),{front_base64:t,back_base64:a}}async function S(e,n){let t=null,a=null;if(null===e&&null===n)return{front_url:null,back_url:null};const l=await JSON.parse(JSON.stringify(await c.findById(e))),i=await JSON.parse(JSON.stringify(await d.findById(n)));return null!==l&&void 0!==l.url&&(t=l.base64),null!==i&&void 0!==i.url&&(a=i.base64),{front_base64:t,back_base64:a}}async function O(t){const a=[],l=[],i=JSON.parse(JSON.stringify(await SliderNames.findOne().where({base_url:t})));if(i){const{names:t,base_url:r}=i;for(let e=0;e<t.length;e++)a.push(`${r}sliders/${t[e]}`);for(let i=0;i<a.length;i++){const t=e.join(__dirname,"../../../","uploads",a[i]);l.push(n.readFileSync(t,"base64"))}return l}return null}async function N(e){let n=null;return n=JSON.parse(JSON.stringify(await SliderNames.findOne().where({base_url:e}))),null!==n?n.names:null}async function C(t,a){const l=await MainPhoto.findOne().where({base_url:t});if(null!==l&&void 0!==l.name){const a=e.join(__dirname,"../../../","uploads",t,"fullsize",l.name),i=e.join(__dirname,"../../../","uploads",t,"middlesize",l.name),r=e.join(__dirname,"../../../","uploads",t,"smallsize",l.name);return{small:n.readFileSync(r,"base64"),middle:n.readFileSync(i,"base64"),full:n.readFileSync(a,"base64")}}return null}async function J(e){const n=await ContentLink.findOne().where({base_url:e});return JSON.parse(JSON.stringify(n))}module.exports.getOneElementBody=async e=>{if("files"!==e&&"contact"!==e&&"historyWar"!==e){const n=JSON.parse(JSON.stringify(await a.findById(e))),t=JSON.parse(JSON.stringify(await l.findById(e)));if(n){const e={...n},t=await Content.findById(n.content_id);return e.content=t,e.type="casual",null!=t&&"cancel"!==t.public_status?e:null}if(t){const e={...n},a=await Content.findById(t.content_id);return e.content=a,e.type="casual",null!=a&&"cancel"!==a.public_status?e:null}return null}return await m(e)},module.exports.getSideMenu=async e=>{const n=JSON.parse(JSON.stringify(await i.find().where({lang:e}))),t=[];for(let a=0;a<n.length;a++){const e={...n[a]};if(null!==n[a].content_id){const l=await Content.findById(n[a].content_id);"cancel"!==l.public_status&&(e.content=l,e.photo=await C(e.content.content_baseUrl),t.push(e))}}return t},module.exports.getNews=async(e,n)=>{let t=await p.find().where({public_status:"active",language:e}).select({id:1,publishDate:2,mainPhoto:3,categoryFK:4,description:5,title:6,type:7}).limit(30).lean();return t.sort((e,n)=>new Date(n.publishDate)-new Date(e.publishDate)),{news:t,category:await f.find().where({contentType:"news"}).lean()}},module.exports.getFiltersNews=async e=>{let n=[],a=[],l=await p.find().where({language:e.lang,public_status:"active"}).select({_id:1,publishDate:2,mainPhoto:3,categoryFK:4,description:5,title:6,type:7}).lean();l.sort((e,n)=>new Date(n.publishDate)-new Date(e.publishDate));let i=await f.find().where({contentType:"news"}).lean();return""===e.date&""===e.category?(n=[...i],{news:l,category:n}):(""!==e.date?(a=l.filter(n=>t(n.publishDate).format("DD/MM/YY")===e.date),""!==e.category&&(a=a.filter(n=>n.categoryFK===e.category))):""!==e.category&&(a=l.filter(n=>n.categoryFK===e.category)),n=[...i],{news:a,category:n})},module.exports.getResultForTroops=async()=>await r.find().lean(),module.exports.getResultForCommand=async()=>await u.find().lean(),module.exports.getSlidersPhotoPath=async(t,a)=>{const l=[],i=[];if(2==a)var r=await Content.findOne().where({generated_sidemenu_link:t.params.id});else r=await Content.findById(t.params.id);const s=JSON.parse(JSON.stringify(await SliderNames.findOne().where({base_url:r.content_baseUrl})));if(s){const{names:t,base_url:a}=s;for(let e=0;e<t.length;e++)l.push(`${a}sliders/${t[e]}`);for(let r=0;r<l.length;r++){const t=e.join(__dirname,"../../../","uploads",l[r]);i.push(n.readFileSync(t,"base64"))}return i}return null},module.exports.getOneActual=async e=>{const n=await Content.findById(e);let t=null;let a=null;const l=[];if(null!==n){const{page_title:e,description:i,date:r,content_folder:s,html_body:o,content_baseUrl:u}=n;let c=await ContentLink.findOne().where({base_url:n.content_baseUrl});if(c=JSON.parse(JSON.stringify(c)),null!==c){const{links:{pages:e,directLink:n,contacts:i}}=c;if(null!==i&&i.forEach(async e=>{const n=await y.findById(e);console.log(n),l.push(n.link)}),""!==n)return{redirectLink:n,content:t};null!==e&&(a=e)}return t={page_title:e,description:i,date:r,html_body:o,files:null!==await N(u)?{names:await N(u),folder:s}:null,slider_photos:await O(u),shared_pages:a,contacs_link:l},{redirectLink:null,content:t}}return{content:null,redirectLink:null}},module.exports.getActual=async e=>{let n;switch(e){case"en":n=await _.find().where({published:!0,$or:[{hasEnContent:!0},{hasDirectLinkEn:!0}]});break;case"ua":n=await _.find().where({published:!0,$or:[{hasUaContent:!0},{hasDirectLinkUa:!0}]})}for(let t=0;t<n.length;t++){if(1==n[t].hasUaContent){let e=n[t].url_ua.slice(14,n[t].url_ua.length);console.log(e),n[t].url_ua=e}if(1==n[t].hasEnContent){console.log("in en");let e=n[t].url_en.slice(14,n[t].url_en.length);n[t].url_en=e}}return n},module.exports.getPhoto=async(t,a)=>{const l=await MainPhoto.findOne().where({base_url:t});if(null!==l&&void 0!==l.name){const i=e.join(__dirname,"../../../","uploads",t,"smallsize",l.name),r=e.join(__dirname,"../../../","uploads",t,"middlesize",l.name),s=e.join(__dirname,"../../../","uploads",t,"fullsize",l.name);switch(a){case"small":return n.readFileSync(i,"base64");case"middle":return n.readFileSync(r,"base64");case"full":return n.readFileSync(s,"base64")}}return null};