"use strict";const e=require("path"),t=require("fs"),n=require("moment"),a=require("../../Models/Submenu"),i=require("../../Models/ChildSub"),l=require("../../Models/Sidemenu"),r=require("../../Models/Corps"),s=require("../../Models/CorpsSign"),o=require("../../Models/CorpsBackground"),c=require("../../Models/Command"),u=require("../../Models/CommandSign"),d=require("../../Models/CommandBackground"),f=require("../../Models/Category"),_=require("../../Models/News"),p=require("../../Models/ActualContent"),{all:h}=require("../../Routes/public_router"),g=require("../../Models/Link"),y=require("../../Models/Contact"),{SSL_OP_SSLEAY_080_CLIENT_DH_BUG:w}=require("constants"),b=async e=>{const t={type:"casual",anchors:[],redirect_pages:[]};switch(e){case"historyWar":const e=await Content.find().where({page_subclass:"historyWar",public_status:"active"});if(0!==e.length){e.forEach(e=>{t.anchors.includes(e.anchor_label)||t.anchors.push(e.anchor_label)}),t.anchors.forEach(n=>{const a=[];e.filter(e=>e.anchor_label===n).forEach(e=>{a.push({title:e.page_title,id_page:e._id})});const i={anchor:n,pages:a};t.type="historyWar",t.redirect_pages.push(i)});const n=t.anchors.map(e=>({title:e}));t.anchors=n}break;case"files":t.type="files";const n=await Content.find().where({page_subclass:"files",public_status:"active"});if(0!==n.length)for(let a=0;a<n.length;a++){const{content_folder:e,page_title:i}=n[a],l="/files/".concat(e),r=await FileNames.findOne().where({base_url:n[a].content_baseUrl});let s;r&&(s=r.names.map(e=>({title:e,link:"".concat(l,"/").concat(e)})));const o={title:i,files:s};t.redirect_pages.push(o)}break;case"contact":(await Content.find().where({page_subclass:"contacts",public_status:"active"})).forEach(e=>{t.redirect_pages.push({title:e.page_title,id_page:e._id})}),t.type="contact"}return t};async function m(e,t){let n=null,a=null;if(null===e&&null===t)return{front_url:null,back_url:null};const i=await JSON.parse(JSON.stringify(await s.findById(e))),l=await JSON.parse(JSON.stringify(await o.findById(t)));return null!==i&&void 0!==i.url&&(n=i.base64),null!==l&&void 0!==l.url&&(a=l.base64),{front_base64:n,back_base64:a}}async function S(e,t){let n=null,a=null;if(null===e&&null===t)return{front_url:null,back_url:null};const i=await JSON.parse(JSON.stringify(await u.findById(e))),l=await JSON.parse(JSON.stringify(await d.findById(t)));return null!==i&&void 0!==i.url&&(n=i.base64),null!==l&&void 0!==l.url&&(a=l.base64),{front_base64:n,back_base64:a}}async function O(n){const a=[],i=[],l=JSON.parse(JSON.stringify(await SliderNames.findOne().where({base_url:n})));if(l){const{names:n,base_url:r}=l;for(let e=0;e<n.length;e++)a.push("".concat(r,"sliders/").concat(n[e]));for(let l=0;l<a.length;l++){const n=e.join(__dirname,"../../../","uploads",a[l]);i.push(t.readFileSync(n,"base64"))}return i}return null}async function N(e){let t=null;return t=JSON.parse(JSON.stringify(await SliderNames.findOne().where({base_url:e}))),null!==t?t.names:null}async function k(n,a){const i=await MainPhoto.findOne().where({base_url:n});if(null!==i&&void 0!==i.name){const a=e.join(__dirname,"../../../","uploads",n,"fullsize",i.name),l=e.join(__dirname,"../../../","uploads",n,"middlesize",i.name),r=e.join(__dirname,"../../../","uploads",n,"smallsize",i.name);return{small:t.readFileSync(r,"base64"),middle:t.readFileSync(l,"base64"),full:t.readFileSync(a,"base64")}}return null}async function J(e){const t=await ContentLink.findOne().where({base_url:e});return JSON.parse(JSON.stringify(t))}module.exports.getOneElementBody=async e=>{if("files"!==e&&"contact"!==e&&"historyWar"!==e){const t=JSON.parse(JSON.stringify(await a.findById(e))),n=JSON.parse(JSON.stringify(await i.findById(e)));if(t){const e={...t},n=await Content.findById(t.content_id);return e.content=n,e.type="casual",null!=n&&"cancel"!==n.public_status?e:null}if(n){const e={...t},a=await Content.findById(n.content_id);return e.content=a,e.type="casual",null!=a&&"cancel"!==a.public_status?e:null}return null}return await b(e)},module.exports.getSideMenu=async e=>{const t=JSON.parse(JSON.stringify(await l.find().where({lang:e}))),n=[];for(let a=0;a<t.length;a++){const e={...t[a]};if(null!==t[a].content_id){const i=await Content.findById(t[a].content_id);"cancel"!==i.public_status&&(e.content=i,e.photo=await k(e.content.content_baseUrl),n.push(e))}}return n},module.exports.getNews=async(e,t)=>({news:await _.find().where({public_status:"active",language:e}).sort({date:-1}).limit(30).lean(),category:await f.find().where({contentType:"news"}).lean()}),module.exports.getFiltersNews=async e=>{let t=[],a=[],i=await _.find().where({language:e.lang,public_status:"active"}).select({_id:1,publishDate:2,mainPhoto:3,categoryFK:4,description:5,title:6,type:7}).lean(),l=await f.find().where({contentType:"news"}).lean();return""===e.date&""===e.category?(t=[...l],{news:i,category:t}):(""!==e.date?(a=i.filter(t=>n(t.publishDate).format("DD/MM/YY")===e.date),""!==e.category&&(a=a.filter(t=>t.categoryFK===e.category))):""!==e.category&&(a=i.filter(t=>t.categoryFK===e.category)),t=[...l],{news:a,category:t})},module.exports.getResultForTroops=async()=>{const e=[],t=JSON.parse(JSON.stringify(await r.find()));for(let n=0;n<t.length;n++){const a=await m(t[n].sign_id,t[n].bg_id),i={title_ua:t[n].title_ua,title_en:t[n].title_en,link:t[n].link,front_photo:a.front_base64,back_photo:a.back_base64};e.push(i)}return e},module.exports.getResultForCommand=async()=>{const e=[],t=JSON.parse(JSON.stringify(await c.find()));for(let n=0;n<t.length;n++){const a=await S(t[n].sign_id,t[n].bg_id),i={title_ua:t[n].title_ua,title_en:t[n].title_en,link:t[n].link,front_photo:a.front_base64,back_photo:a.back_base64};e.push(i)}return e},module.exports.getSlidersPhotoPath=async(n,a)=>{const i=[],l=[];if(2==a)var r=await Content.findOne().where({generated_sidemenu_link:n.params.id});else r=await Content.findById(n.params.id);const s=JSON.parse(JSON.stringify(await SliderNames.findOne().where({base_url:r.content_baseUrl})));if(s){const{names:n,base_url:a}=s;for(let e=0;e<n.length;e++)i.push("".concat(a,"sliders/").concat(n[e]));for(let r=0;r<i.length;r++){const n=e.join(__dirname,"../../../","uploads",i[r]);l.push(t.readFileSync(n,"base64"))}return l}return null},module.exports.getOneActual=async e=>{const t=await Content.findById(e);let n=null;let a=null;const i=[];if(null!==t){const{page_title:e,description:l,date:r,content_folder:s,html_body:o,content_baseUrl:c}=t;let u=await ContentLink.findOne().where({base_url:t.content_baseUrl});if(u=JSON.parse(JSON.stringify(u)),null!==u){const{links:{pages:e,directLink:t,contacts:l}}=u;if(null!==l&&l.forEach(async e=>{const t=await g.findById(e);console.log(t),i.push(t.link)}),""!==t)return{redirectLink:t,content:n};null!==e&&(a=e)}return n={page_title:e,description:l,date:r,html_body:o,files:null!==await N(c)?{names:await N(c),folder:s}:null,slider_photos:await O(c),shared_pages:a,contacs_link:i},{redirectLink:null,content:n}}return{content:null,redirectLink:null}},module.exports.getActual=async e=>{let t;switch(e){case"en":t=await p.find().where({published:!0,$or:[{hasEnContent:!0},{hasDirectLinkEn:!0}]});break;case"ua":t=await p.find().where({published:!0,$or:[{hasUaContent:!0},{hasDirectLinkUa:!0}]})}for(let n=0;n<t.length;n++){if(1==t[n].hasUaContent){let e=t[n].url_ua.slice(14,t[n].url_ua.length);console.log(e),t[n].url_ua=e}if(1==t[n].hasEnContent){console.log("in en");let e=t[n].url_en.slice(14,t[n].url_en.length);t[n].url_en=e}}return t},module.exports.getPhoto=async(n,a)=>{const i=await MainPhoto.findOne().where({base_url:n});if(null!==i&&void 0!==i.name){const l=e.join(__dirname,"../../../","uploads",n,"smallsize",i.name),r=e.join(__dirname,"../../../","uploads",n,"middlesize",i.name),s=e.join(__dirname,"../../../","uploads",n,"fullsize",i.name);switch(a){case"small":return t.readFileSync(l,"base64");case"middle":return t.readFileSync(r,"base64");case"full":return t.readFileSync(s,"base64")}}return null};