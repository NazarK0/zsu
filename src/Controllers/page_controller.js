"use strict";const e=require("fs"),n=require("path"),t=require("../Models/User"),i=require("../Models/Content"),a=require("../Models/Sidemenu"),r=require("../Models/MainPhoto"),s=require("../Models/SliderNames"),d=require("../Models/FileNames"),l=require("../Models/Submenu"),o=require("../Models/ChildSub"),u=require("../Models/History"),c=require("../Models/ContentLinks"),_=require("../API/getAdminid"),p=require("../API/op_categories"),{getAllPage:g,getCanceledPage:f}=require("../API/PageApi/page"),{ValidSession:m}=require("../API/Session/session"),P=require("../API/userAPI/hasAccess"),w=require("../API/userAPI/enabledIds"),{setWith:b}=require("lodash");async function A(e,n){null!==e&&await a.findByIdAndUpdate(e,{content_id:null}),null!==n&&(await l.findByIdAndUpdate(n,{content_id:null}),await o.findByIdAndUpdate(n,{content_id:null}))}module.exports.getCanceledPages=async(e,n)=>{const i=await t.findById(_.getId(e));if(!i)return n.status(400).render("infopage",{info:"Виявлено зміну користувача, авторизуйтесь в системі",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:void 0});if(!0===await m(e.session,i.id,n)){if(await P(i.id,p.PAGES)){const t=await w(i.id,p.PAGES),a=await f(t);a.reverse();const r=a.filter(e=>"Відсутня"!==e.dependense_main_title),s=a.filter(e=>"Відсутня"!==e.dependense_side_title),d=[];return[...r,...s].forEach(e=>{"Відсутня"!==e.dependense_main_title&&d.push({title:e.dependense_main_title}),"Відсутня"!==e.dependense_side_title&&d.push({title:e.dependense_side_title})}),n.render("main_canceled_page",{user:_.getId(e),contentPages:a,menu_names:d,current_page:1})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id})}},module.exports.getAllPages=async(e,n)=>{const i=await t.findById(_.getId(e));if(!i)return n.status(400).render("infopage",{info:"Виявлено зміну користувача, авторизуйтесь в системі",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:void 0});if(!0===await m(e.session,i.id,n)){if(await P(i.id,p.PAGES)){const t=await w(i.id,p.PAGES),a=await g(t);a.reverse();for(let e=0;e<a.length;e++)switch(a[e].page_subclass){case"historyWar":a[e].page_subclass="Історія війни";break;case"current":a[e].page_subclass="Актуальне";break;case"files":a[e].page_subclass="Нормативно-правова база";break;case"contacts":a[e].page_subclass="Контакти";break;case"casual":a[e].page_subclass="Звичайна"}const r=a.filter(e=>"Відсутня"!==e.dependense_main_title),s=[];return[...r].forEach(e=>{"Відсутня"!==e.dependense_main_title&&s.push({title:e.dependense_main_title})}),n.render("main_page",{user:_.getId(e),menu_names:s,contentPages:a,current_page:1})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id})}return null===await m(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.deletePage=async(a,l)=>{const o=await t.findById(_.getId(a));if(!o)return l.status(400).render("infopage",{info:"Виявлено зміну користувача, авторизуйтесь в системі",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:void 0});if(!0===await m(a.session,o.id,l)){if(await P(o.id,p.PAGES)){const t=await i.findByIdAndDelete(a.params.id),{generated_sidemenu_link:_,generated_menu_link:p}=t;try{await r.findOneAndDelete({base_url:t.content_baseUrl}),await s.deleteMany({base_url:t.content_baseUrl}),await d.deleteMany({base_url:t.content_baseUrl}),await c.findOneAndRemove({base_url:t.content_baseUrl}),e.rmdirSync(n.join(__dirname,"../..","uploads/images/".concat(t.content_folder)),{recursive:!0}),await A(_,p),await new u({type_content:"Cторінки",operation:"Видалення Сторінки :  ".concat(t.title),user:o.login}).save()}catch(g){console.error(g)}return l.redirect("../1")}return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id})}return null===await m(a.session,o.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.postCancelPublicPage=async function(e,n){const t=_.getId(e);try{return await require("../API/Content/publishOperation").CancelPublish(e.params.id_page),n.redirect("/admin/".concat(t,"/pages/1"))}catch(i){console.error(i)}},module.exports.postPublicPage=async function(e,n){const t=_.getId(e);try{return await require("../API/Content/publishOperation").Publish(e.params.id_page),n.redirect("/admin/".concat(t,"/pages/cancel-publish/1"))}catch(i){console.error(i)}};