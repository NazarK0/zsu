"use strict";const e=require("fs"),n=require("path"),i=require("../Models/User"),t=require("../Models/Content"),r=require("../Models/Sidemenu"),a=require("../Models/MainPhoto"),s=require("../Models/SliderNames"),d=require("../Models/FileNames"),o=require("../Models/Submenu"),l=require("../Models/ChildSub"),u=require("../Models/History"),c=require("../Models/ContentLinks"),_=require("../API/getAdminid"),p=require("../API/op_categories"),{getAllPage:g,getCanceledPage:m}=require("../API/PageApi/page"),{ValidSession:f}=require("../API/Session/session"),P=require("../API/userAPI/hasAccess"),w=require("../API/userAPI/enabledIds");async function A(e,n){null!==e&&await r.findByIdAndUpdate(e,{content_id:null}),null!==n&&(await o.findByIdAndUpdate(n,{content_id:null}),await l.findByIdAndUpdate(n,{content_id:null}))}module.exports.getCanceledPages=async(e,n)=>{const t=await i.findById(_.getId(e));if(!t)return n.status(400).render("infopage",{info:"Виявлено зміну користувача, авторизуйтесь в системі",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:void 0});if(!0===await f(e.session,t.id,n)){if(await P(t.id,p.PAGES)){const i=await w(t.id,p.PAGES),r=await m(i);r.reverse();const a=r.filter(e=>"Відсутня"!==e.dependense_main_title),s=r.filter(e=>"Відсутня"!==e.dependense_side_title),d=[];return[...a,...s].forEach(e=>{"Відсутня"!==e.dependense_main_title&&d.push({title:e.dependense_main_title}),"Відсутня"!==e.dependense_side_title&&d.push({title:e.dependense_side_title})}),n.render("main_canceled_page",{user:_.getId(e),contentPages:r,menu_names:d,current_page:1})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id})}},module.exports.getAllPages=async(e,n)=>{const t=await i.findById(_.getId(e));if(!t)return n.status(400).render("infopage",{info:"Виявлено зміну користувача, авторизуйтесь в системі",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:void 0});if(!0===await f(e.session,t.id,n)){if(await P(t.id,p.PAGES)){const i=await w(t.id,p.PAGES),r=await g(i);r.reverse();const a=r.filter(e=>"Відсутня"!==e.dependense_main_title),s=r.filter(e=>"Відсутня"!==e.dependense_side_title),d=[];return[...a,...s].forEach(e=>{"Відсутня"!==e.dependense_main_title&&d.push({title:e.dependense_main_title}),"Відсутня"!==e.dependense_side_title&&d.push({title:e.dependense_side_title})}),n.render("main_page",{user:_.getId(e),menu_names:d,contentPages:r,current_page:1})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id})}return null===await f(e.session,t.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.deletePage=async(r,o)=>{const l=await i.findById(_.getId(r));if(!l)return o.status(400).render("infopage",{info:"Виявлено зміну користувача, авторизуйтесь в системі",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:void 0});if(!0===await f(r.session,l.id,o)){if(await P(l.id,p.PAGES)){const i=await t.findByIdAndDelete(r.params.id),{generated_sidemenu_link:_,generated_menu_link:p}=i;try{await a.findOneAndDelete({base_url:i.content_baseUrl}),await s.deleteMany({base_url:i.content_baseUrl}),await d.deleteMany({base_url:i.content_baseUrl}),await c.findOneAndRemove({base_url:i.content_baseUrl}),e.rmdirSync(n.join(__dirname,"../..","uploads/images/".concat(i.content_folder)),{recursive:!0}),await A(_,p),await new u({type_content:"Cторінки",operation:"Видалення Сторінки :  ".concat(i.title),user:l.login}).save()}catch(g){console.error(g)}return o.redirect("../1")}return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id})}return null===await f(r.session,l.id,o)?o.redirect("/admin/login"):o.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:l.id})},module.exports.postCancelPublicPage=async function(e,n){const i=_.getId(e);try{return await require("../API/Content/publishOperation").CancelPublish(e.params.id_page),n.redirect("/admin/".concat(i,"/pages/1"))}catch(t){console.error(t)}},module.exports.postPublicPage=async function(e,n){const i=_.getId(e);try{return await require("../API/Content/publishOperation").Publish(e.params.id_page),n.redirect("/admin/".concat(i,"/pages/cancel-publish/1"))}catch(t){console.error(t)}};