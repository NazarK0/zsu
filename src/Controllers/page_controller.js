"use strict";const e=require("fs"),n=require("path"),i=require("../Models/User"),t=require("../Models/Content"),r=require("../Models/Sidemenu"),a=require("../Models/MainPhoto"),s=require("../Models/SliderNames"),d=require("../Models/FileNames"),l=require("../Models/Submenu"),o=require("../Models/ChildSub"),u=require("../Models/History"),c=require("../API/getAdminid"),_=require("../API/op_categories"),{getAllPage:p,getCanceledPage:g}=require("../API/PageApi/page"),{ValidSession:m}=require("../API/Session/session"),f=require("../API/userAPI/hasAccess"),P=require("../API/userAPI/enabledIds");async function w(e,n){null!==e&&await r.findByIdAndUpdate(e,{content_id:null}),null!==n&&(await l.findByIdAndUpdate(n,{content_id:null}),await o.findByIdAndUpdate(n,{content_id:null}))}module.exports.getCanceledPages=async(e,n)=>{const t=await i.findById(c.getId(e));if(!t)return n.status(400).render("infopage",{info:"Виявлено зміну користувача, авторизуйтесь в системі",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:void 0});if(!0===await m(e.session,t.id,n)){if(await f(t.id,_.PAGES)){const i=await P(t.id,_.PAGES),r=await g(i);r.reverse();const a=r.filter(e=>"Відсутня"!==e.dependense_main_title),s=r.filter(e=>"Відсутня"!==e.dependense_side_title),d=[];return[...a,...s].forEach(e=>{"Відсутня"!==e.dependense_main_title&&d.push({title:e.dependense_main_title}),"Відсутня"!==e.dependense_side_title&&d.push({title:e.dependense_side_title})}),n.render("main_canceled_page",{user:c.getId(e),contentPages:r,menu_names:d,current_page:1})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id})}},module.exports.getAllPages=async(e,n)=>{const t=await i.findById(c.getId(e));if(!t)return n.status(400).render("infopage",{info:"Виявлено зміну користувача, авторизуйтесь в системі",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:void 0});if(!0===await m(e.session,t.id,n)){if(await f(t.id,_.PAGES)){const i=await P(t.id,_.PAGES),r=await p(i);r.reverse();const a=r.filter(e=>"Відсутня"!==e.dependense_main_title),s=r.filter(e=>"Відсутня"!==e.dependense_side_title),d=[];return[...a,...s].forEach(e=>{"Відсутня"!==e.dependense_main_title&&d.push({title:e.dependense_main_title}),"Відсутня"!==e.dependense_side_title&&d.push({title:e.dependense_side_title})}),n.render("main_page",{user:c.getId(e),menu_names:d,contentPages:r,current_page:1})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id})}return null===await m(e.session,t.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.deletePage=async(r,l)=>{const o=await i.findById(c.getId(r));if(!o)return l.status(400).render("infopage",{info:"Виявлено зміну користувача, авторизуйтесь в системі",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:void 0});if(!0===await m(r.session,o.id,l)){if(await f(o.id,_.PAGES)){const i=await t.findByIdAndDelete(r.params.id),{generated_sidemenu_link:c,generated_menu_link:_}=i;try{await a.findOneAndDelete({base_url:i.content_baseUrl}),await s.deleteMany({base_url:i.content_baseUrl}),await d.deleteMany({base_url:i.content_baseUrl}),e.rmdirSync(n.join(__dirname,"../..","uploads/images/".concat(i.content_folder)),{recursive:!0}),await w(c,_),await new u({type_content:"Cторінки",operation:"Видалення Сторінки :  ".concat(i.title),user:o.login}).save()}catch(p){console.error(p)}return l.redirect("../1")}return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id})}return null===await m(r.session,o.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.postCancelPublicPage=async function(e,n){const i=c.getId(e);try{return await require("../API/Content/publishOperation").CancelPublish(e.params.id_page),n.redirect("/admin/".concat(i,"/pages/1"))}catch(t){console.error(t)}},module.exports.postPublicPage=async function(e,n){const i=c.getId(e);try{return await require("../API/Content/publishOperation").Publish(e.params.id_page),n.redirect("/admin/".concat(i,"/pages/cancel-publish/1"))}catch(t){console.error(t)}};