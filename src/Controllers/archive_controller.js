"use strict";const e=require("../Models/MessageArchive"),i=require("../Models/History"),r=require("../Models/User"),{ValidSession:t}=require("../API/Session/session"),n=require("../API/getAdminid"),s=require("../API/op_categories");async function a(i,a){const o=await r.findById(n.getId(i));if(!0===await t(i.session,o.id,a)){if(!o.operation.includes(s.MESSAGE))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{let r=JSON.parse(JSON.stringify(await(await e.find()).reverse())),{page:t}=i.params;const n=o.settings.recordsPerPage.message,s=Math.ceil(r.length/n);(t<1||t>s)&&(t=1);const d=r.slice(n*(t-1),t*n);return a.status(200).render("main_menu_archive_message",{archive:d,user:o.id,pages:s,current_page:t})}catch(d){throw new Error(d)}}return null===await t(i.session,o.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})}async function o(i,a){const o=await r.findById(n.getId(i));if(!0===await t(i.session,o.id,a)){if(!o.operation.includes(s.MESSAGE))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{let r=JSON.parse(JSON.stringify(await(await e.findById(i.params.id))));const{email:t,text:n,date:s,login_response:d,text_response:u,date_response:l}=r;return a.status(200).render("viewArchiveMessage",{user:o.id,email:t,date:s,text:n,login_response:d,text_response:u,date_response:l})}catch(d){throw new Error(d)}}return null===await t(i.session,o.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})}async function d(s,a){const o=await r.findById(n.getId(s));if(!0===await t(s.session,o.id,a)){if(void 0===o.type||"system_user"!=o.type)return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної функції, видаляти Архів дозволено тільки Системному користувачу!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{return await e.remove({}),await new i({type_content:" Архів",operation:"Видалення архіву",user:o.login}).save(),a.status(200).render("infopage",{info:"Архів успішно видалено",url:`/admin/${o.id}/archive/1`,url_text:"Повернутися до Архіву",user:o.id})}catch(d){throw new Error(d)}}return null===await t(s.session,o.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})}module.exports={getAllArchive:a,getOneArchiveMessage:o,ClearArchive:d};