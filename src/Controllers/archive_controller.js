"use strict";const e=require("../Models/MessageArchive"),i=require("../Models/History"),r=require("../Models/User"),t=require("../API/userAPI/hasAccess"),{ValidSession:s}=require("../API/Session/session"),n=require("../API/getAdminid"),a=require("../API/op_categories");async function o(i,o){const d=await r.findById(n.getId(i));if(!0===await s(i.session,d.id,o)){if(!(await t(d.id,a.MESSAGE)))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});try{const r=JSON.parse(JSON.stringify(await(await e.find()).reverse()));let{page:t}=i.params;const s=d.settings.recordsPerPage.message,n=Math.ceil(r.length/s);(t<1||t>n)&&(t=1);const a=r.slice(s*(t-1),t*s);return o.status(200).render("main_menu_archive_message",{archive:a,user:d.id,pages:n,current_page:t})}catch(u){throw new Error(u)}}return null===await s(i.session,d.id,o)?o.redirect("/admin/login"):o.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}async function d(i,o){const d=await r.findById(n.getId(i));if(!0===await s(i.session,d.id,o)){if(!(await t(d.id,a.MESSAGE)))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});try{const r=JSON.parse(JSON.stringify(await(await e.findById(i.params.id)))),{email:t,text:s,date:n,login_response:a,text_response:u,date_response:c}=r;return o.status(200).render("viewArchiveMessage",{user:d.id,email:t,date:n,text:s,login_response:a,text_response:u,date_response:c})}catch(u){throw new Error(u)}}return null===await s(i.session,d.id,o)?o.redirect("/admin/login"):o.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}async function u(t,a){const o=await r.findById(n.getId(t));if(!0===await s(t.session,o.id,a)){if(void 0===o.type||"system_user"!==o.type)return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної функції, видаляти Архів дозволено тільки Системному користувачу!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});try{return await e.remove({}),await new i({type_content:" Архів",operation:"Видалення архіву",user:o.login}).save(),a.status(200).render("infopage",{info:"Архів успішно видалено",url:"/admin/".concat(o.id,"/archive/1"),url_text:"Повернутися до Архіву",user:o.id})}catch(d){throw new Error(d)}}return null===await s(t.session,o.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})}module.exports={getAllArchive:o,getOneArchiveMessage:d,ClearArchive:u};