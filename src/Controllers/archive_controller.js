"use strict";const e=require("../Models/MessageArchive"),i=require("../Models/History"),r=require("../Models/User"),t=require("../API/userAPI/hasAccess"),{ValidSession:s}=require("../API/Session/session"),n=require("../API/getAdminid"),a=require("../API/op_categories");async function d(i,d){const o=await r.findById(n.getId(i));if(!0===await s(i.session,o.id,d)){if(!(await t(o.id,a.MESSAGE)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{const r=JSON.parse(JSON.stringify(await(await e.find()).reverse()));let{page:t}=i.params;const s=o.settings.recordsPerPage.message,n=Math.ceil(r.length/s);(t<1||t>n)&&(t=1);const a=r.slice(s*(t-1),t*s);return d.status(200).render("main_menu_archive_message",{archive:a,user:o.id,pages:n,current_page:t})}catch(u){throw new Error(u)}}return null===await s(i.session,o.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})}async function o(i,d){const o=await r.findById(n.getId(i));if(!0===await s(i.session,o.id,d)){if(!(await t(o.id,a.MESSAGE)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{const r=JSON.parse(JSON.stringify(await(await e.findById(i.params.id)))),{email:t,text:s,date:n,login_response:a,text_response:u,date_response:l}=r;return d.status(200).render("viewArchiveMessage",{user:o.id,email:t,date:n,text:s,login_response:a,text_response:u,date_response:l})}catch(u){throw new Error(u)}}return null===await s(i.session,o.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})}async function u(t,a){const d=await r.findById(n.getId(t));if(!0===await s(t.session,d.id,a)){if(void 0===d.type||"system_user"!==d.type)return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної функції, видаляти Архів дозволено тільки Системному користувачу!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{return await e.remove({}),await new i({type_content:" Архів",operation:"Видалення архіву",user:d.login}).save(),a.status(200).render("infopage",{info:"Архів успішно видалено",url:`/admin/${d.id}/archive/1`,url_text:"Повернутися до Архіву",user:d.id})}catch(o){throw new Error(o)}}return null===await s(t.session,d.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}module.exports={getAllArchive:d,getOneArchiveMessage:o,ClearArchive:u};