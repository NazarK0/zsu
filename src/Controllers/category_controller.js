"use strict";const t=require("../Models/Category"),e=require("../Models/User"),r=require("../Models/History"),o=require("../API/getAdminid"),{ValidSession:a}=require("../API/Session/session"),i=require("../API/userAPI/hasAccess"),s=require("../API/op_categories"),d=require("../API/userAPI/enabledIds"),{getConvert:n}=require("../API/Converter");module.exports.getCategoryList=async(r,a)=>{const i=await e.findById(o.getId(r));try{let{page:e}=r.params;const o=JSON.parse(JSON.stringify(await t.find()));for(let t=0;t<o.length;t++){const e=await CategoryPhoto.findById(o[t].photo);o[t].photo=null!==e?e.base64:null}const s=i.settings.recordsPerPage.command,d=Math.ceil(o.length/s);(e<1||e>d)&&(e=1);const n=o.slice(s*(e-1),e*s);return a.render("main_menu_category",{user:i.id,category:n,pages:d,current_page:e})}catch(s){console.log(s)}},module.exports.getAddCategory=async(t,r)=>{const a=await e.findById(o.getId(t)),i=JSON.parse(JSON.stringify(await CategoryPhoto.find()));try{r.render("edit_category",{action_type:"add",userid:a.id,category_photos:i,parameter:"false"})}catch(s){console.log(s)}},module.exports.getEditCategory=async(r,a)=>{try{const i=await e.findById(o.getId(r)),s=JSON.parse(JSON.stringify(await t.findById(r.params.categoryId))),d=JSON.parse(JSON.stringify(await CategoryPhoto.findById(s.photo))),n=JSON.parse(JSON.stringify(await CategoryPhoto.find()));s.photo=d;const{photo:c,title_ua:y,title_en:g,_id:u}=s;return a.render("edit_category",{action_type:"edit/"+u,title_ua:y,title_en:g,current_photo:c,userid:i.id,category_photos:n,categoryId:r.params.categoryId})}catch(i){a.status(500)}},module.exports.postAddCategory=async(e,r)=>{try{const{title_ua:o,title_en:a,bg_id:i}=e.body;return await new t({title_ua:o,title_en:a,photo:i}).save(),r.redirect("./1")}catch(o){r.status(500)}},module.exports.postEditCategory=async(r,a)=>{const i=await e.findById(o.getId(r)),{title_ua:s,title_en:d,bg_id:n}=r.body;return await t.findByIdAndUpdate({_id:r.params.categoryId},{$set:{title_ua:s,title_en:d,photo:n}}),a.redirect(`/admin/${i._id}/news/category/1`)},module.exports.postRemoveCategory=async(r,a)=>{try{const i=await e.findById(o.getId(r));return await t.findByIdAndDelete(r.params.categoryId),a.redirect(`/admin/${i._id}/news/category/1`)}catch(i){}},module.exports.getPhtotoEditor=async(t,r)=>{current_user=await e.findById(o.getId(t));try{const t=n(await CategoryPhoto.find());return r.status(200).render("category_photo_editor",{photos:t,user:current_user.id})}catch(a){return r.status(500)}},module.exports.postRemovePhotoCategory=async(t,e)=>{try{const r=o.getId(t);await CategoryPhoto.findByIdAndRemove(t.params.id);return e.redirect(`/admin/${r}/news/category/photo-editor`)}catch(r){e.status(500).json("Error postRemovePhotoCategory")}};