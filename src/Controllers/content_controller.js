"use strict";const e=require("sharp"),n=require("fs"),i=require("os"),t=require("path"),a=require("image-size"),d=require("../Models/User"),r=require("../Models/Content"),o=require("../Models/Sidemenu"),s=require("../Models/SliderNames"),l=require("../Models/FileNames"),u=require("../Models/MainPhoto"),c=require("../Models/History"),m=require("../Models/Submenu"),f=require("../Models/ChildSub"),{updateContent:_}=require("../API/childSubApi/update"),p=require("../API/sideMenuApi/getAllSideMenu"),g=require("../API/getAdminid"),y=require("../API/op_categories"),{ValidSession:w}=require("../API/Session/session"),{host:h,port:I}=require("../../settings.json");async function S(){const e=require("../Models/Main_Menu"),n=require("../API/SubMenuAPI/getAllChildMain"),i=[];let t=await e.find();for(let a=0;a<t.length;a++)t[a].submenu_item=await n(t[a].id),i.push(t[a]);return t}async function b(e,n){await m.findByIdAndUpdate(e,{content_id:n}),await f.findByIdAndUpdate(e,{content_id:n})}module.exports.getCreateContentFolder=async(e,n)=>{const i=await d.findById(g.getId(e));return!0===await w(e.session,i.id,n)?i.operation.includes(y.CONTENT)?n.render("content_name",{userid:i.id,content_folder_title:""}):n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id}):null===await w(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.postCreatedContentFolder=async(e,i)=>{const a=await d.findById(g.getId(e));if(!a.operation.includes(y.CONTENT))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{content_folder_title:d}=e.body,r=t.join(__dirname,"../../uploads/images",d);n.existsSync(r)?i.render("content_name",{content_folder_title:d,userid:a.id}):(n.mkdirSync(r),i.render("content_slider",{port:I,folder_path:`/images/${d}/`,folder_name:d,userid:a.id}))}},module.exports.postNewContent=async(e,i)=>{const a=await d.findById(g.getId(e));if(a.operation.includes(y.CONTENT)){let{page_title:d,description:s,content_folder:l,page_type:u,news_type:m,generated_menu_link:f,generated_sidemenu_link:p,keywords:g,html_body:y,lang:w,mainmenu_checkbox:I,sidemenu_checkbox:S}=e.body;switch(u){case"news":f=null,p=null;break;case"content_page":m=null,(void 0===I||void 0===f)&&(f=null),(void 0===S||void 0===p)&&(p=null)}const x=new r({content_baseUrl:`/images/${l}/`,description:s,content_folder:l,page_title:d,page_type:u,news_type:m,lang:w,keywords:g,generated_menu_link:f,generated_sidemenu_link:p,html_body:y,user_id:a.id});if("news"===u){const e=`<item>\n        <title>${d}</title>\n        <link>http://${h}</link>\n        <description>${s}</description>\n        <guid>${Date.now()}</guid>\n      </item>\n    </channel>\n  </rss>\n      `,i=t.join(__dirname,"../..","public","rss.xml");n.readFile(i,(t,a)=>{if(t)throw t;const d=a.indexOf("</channel>");n.open(i,"r+",666,(i,t)=>{n.write(t,e,d,"utf-8",()=>{n.close(t)})})})}let k;return f&&"undefined"!==f&&(await _(f,x.id),await b(f,x.id)),p&&"undefined"!==p&&(await o.updateMany({content_id:x.id},{content_id:null}),await r.updateMany({generated_sidemenu_link:p},{generated_sidemenu_link:null}),await o.findByIdAndUpdate(p,{content_id:x.id})),await x.save(),"news"===u?(k=new c({type_content:"Новина",operation:"Додавання новини "+d,user:a.login}),await k.save(),i.redirect("news/1")):"content_page"===u?(k=new c({type_content:"Новина",operation:"Додавання cторінки "+d,user:a.login}),await k.save(),i.redirect("pages/1")):i.redirect("main")}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id})},module.exports.postEditedContent=async(e,n)=>{const i=await d.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){let{content_id:a,page_title:d,description:s,page_type:l,news_type:u,generated_menu_link:m,generated_sidemenu_link:f,keywords:p,html_body:g,lang:y,mainmenu_checkbox:w,sidemenu_checkbox:h}=e.body;switch(l){case"news":m=null,f=null;try{await o.updateMany({content_id:a},{content_id:null}),await b(m,null);const e=new c({type_content:"Новина",operation:"Редагування новини "+d,user:i.login});await e.save()}catch(t){}break;case"content_page":u=null,(void 0===w||void 0===m)&&(m=null),void 0===h?(f=null,await o.updateMany({content_id:a},{content_id:null})):void 0===f&&(f=null);const e=new c({type_content:"Новина",operation:"Редагування cторінки "+d,user:i.login});await e.save()}return await r.findByIdAndUpdate(a,{description:s,page_title:d,page_type:l,news_type:u,keywords:p,lang:y,generated_menu_link:m,generated_sidemenu_link:f,html_body:g}),m&&(await _(m,a),await b(m,a)),f&&(await o.updateMany({content_id:a},{content_id:null}),await r.updateMany({generated_sidemenu_link:f},{generated_sidemenu_link:null}),await o.findByIdAndUpdate(f,{content_id:a}),await r.findByIdAndUpdate(a,{generated_sidemenu_link:f})),n.redirect("news/1")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.getEditContentForm=async(e,n)=>{const i=await d.findById(g.getId(e));if(!0===await w(e.session,i.id,n)){if(i.operation.includes(y.CONTENT)){const a=await r.findById(e.params.id),d=t.join(__dirname,"../../uploads/images",a.content_folder),o=await p();return n.render("wysiwyg",{content_folder_title:a.content_folder,folder_path:d,folder_name:a.content_folder,menu:await S(),sidemenu:o,userid:i.id,page_title:a.page_title,description:a.description,keywords:a.keywords,html_body:a.html_body,content_id:a.id,operation:"edit"})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})}return null===await w(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.postSendSliderPhotos=async(e,i)=>{const a=await d.findById(g.getId(e));if(!a.operation.includes(y.CONTENT))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{folder_path:d,folder_name:r}=e.body,o=t.join(__dirname,"../..","uploads",d,"sliders");let l=await s.findOne({base_url:d}),u=[];if(e.files.length){if(n.existsSync(o)){const e=n.readdirSync(o);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(o,e[i]))}else n.mkdirSync(o);await e.files.map(e=>{n.renameSync(t.join(__dirname,"../../uploads/images/temp",e.filename),t.join(__dirname,"../..","uploads",d,"sliders",e.originalname)),u.push(e.originalname)}),l?(await s.findByIdAndUpdate(l.id,{names:u}),l.names=u):(l=new s({names:u,base_url:d}),await l.save())}const c=l?l.names:null;i.render("content_slider",{port:I,folder_path:d,folder_name:r,userid:a.id,sliderImgs:c})}},module.exports.postSendImage=async(i,r)=>{const o=await d.findById(g.getId(i));if(o.operation.includes(y.CONTENT)){const d=await i.file,{folder_path:s,folder_name:l}=i.body;let c=await u.findOne({base_url:s});if(d){const i=t.join(__dirname,"../..","uploads",s,"fullsize"),r=t.join(__dirname,"../..","uploads",s,"middlesize"),o=t.join(__dirname,"../..","uploads",s,"smallsize");if(n.existsSync(i)){const e=n.readdirSync(i);for(let a=0;a<e.length;a++)n.unlinkSync(t.join(i,e[a]))}else n.mkdirSync(i);if(n.existsSync(r)){const e=n.readdirSync(r);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(r,e[i]))}else n.mkdirSync(r);if(n.existsSync(o)){const e=n.readdirSync(o);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(o,e[i]))}else n.mkdirSync(o);n.renameSync(t.join(__dirname,"../../uploads/images/temp",d.filename),t.join(__dirname,"../..","uploads",s,"fullsize",d.originalname));const l=t.join(i,d.originalname);a(l,(function(n,i){e(l).resize({height:parseInt((i.height/2).toString().split(".")[0]),width:parseInt((i.width/2).toString().split(".")[0])}).toFile(t.join(r,d.originalname)).catch((function(e){console.log("Error occured",e)})),e(l).resize({height:parseInt((i.height/4).toString().split(".")[0]),width:parseInt((i.width/4).toString().split(".")[0])}).toFile(t.join(o,d.originalname)).catch((function(e){console.log("Error occured",e)}))})),c?(await u.findByIdAndUpdate(c.id,{name:d.originalname}),c.name=d.originalname):(c=new u({base_url:s,name:d.originalname}),await c.save())}const m=c?c.name:null;return r.render("content_main_photo",{port:I,userid:o.id,folder_path:s,folder_name:l,name:m})}return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.postSendPageFiles=async(e,i)=>{const a=await d.findById(g.getId(e));if(a.operation.includes(y.CONTENT)){const{folder_path:d,folder_name:r}=e.body,o=t.join(__dirname,"../..","uploads",d,"files");let s=await l.findOne({base_url:d}),u=[];if(e.files.length){if(n.existsSync(o)){const e=n.readdirSync(o);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(o,e[i]))}else n.mkdirSync(o);await e.files.map(e=>{n.renameSync(t.join(__dirname,"../../uploads/images/temp",e.filename),t.join(__dirname,"../..","uploads",d,"files",e.originalname)),u.push(e.originalname)}),s?(await l.findByIdAndUpdate(s.id,{names:u}),s.names=u):(s=new l({names:u,base_url:d}),await s.save())}const c=s?s.names:null;return i.render("content_files",{port:I,folder_path:d,folder_name:r,userid:a.id,files:c})}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id})},module.exports.postAddSliderPhotos=async(e,i)=>{const a=await d.findById(g.getId(e));if(!a.operation.includes(y.CONTENT))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{folder_path:d,folder_name:r}=e.body,o=await s.findOne({base_url:d}),l=o?o.names:[];if(e.files.length){let i=[];await e.files.map(e=>{n.renameSync(t.join(__dirname,"../../uploads/images/temp",e.filename),t.join(__dirname,"../..","uploads",d,"sliders",e.originalname)),i.push(e.originalname)}),l.push(i),o&&await s.findByIdAndUpdate(o.id,{names:l})}i.render("content_slider",{port:I,folder_path:d,folder_name:r,userid:a.id,sliderImgs:l})}},module.exports.postAddPageFiles=async(e,i)=>{const a=await d.findById(g.getId(e));if(!a.operation.includes(y.CONTENT))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{folder_path:d,folder_name:r}=e.body,o=await l.findOne({base_url:d}),s=o?o.names:[];if(e.files.length){let i=[];await e.files.map(e=>{n.renameSync(t.join(__dirname,"../../uploads/images/temp",e.filename),t.join(__dirname,"../..","uploads",d,"files",e.originalname)),i.push(e.originalname)}),s.push(i),o&&await l.findByIdAndUpdate(o.id,{names:s})}i.render("content_files",{port:I,folder_path:d,folder_name:r,userid:a.id,files:s})}},module.exports.getEditSliderPhotos=async(e,n)=>{const i=await d.findById(g.getId(e));if(!i.operation.includes(y.CONTENT))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id});{const{id:a}=e.params,{content_folder:d,content_baseUrl:o}=await r.findById(a).select({_id:0,content_folder:1,content_baseUrl:2});let l=[];try{const{names:e}=await s.findOne({base_url:o}).select({_id:0,names:1});l=e||[]}catch(t){l=[]}n.render("content_slider",{port:I,folder_path:o,folder_name:d,userid:i.id,sliderImgs:l})}},module.exports.postEditSendImage=async(i,r)=>{const o=await d.findById(g.getId(i));if(o.operation.includes(y.CONTENT)){const d=await i.file;if(d){const{folder_path:s,folder_name:l}=i.body,c=t.join(s,"fullsize"),m=t.join(s,"middlesize"),f=t.join(s,"smallsize");if(n.existsSync(c)){const e=n.readdirSync(c);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(c,e[i]))}else n.mkdirSync(c);if(n.existsSync(m)){const e=n.readdirSync(m);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(m,e[i]))}else n.mkdirSync(m);if(n.existsSync(f)){const e=n.readdirSync(f);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(f,e[i]))}else n.mkdirSync(f);n.renameSync(t.join(__dirname,"../../uploads/images/temp",d.filename),t.join(s,"fullsize",d.originalname));const _=t.join(c,d.originalname);a(_,(function(n,i){e(_).resize({height:parseInt((i.height/2).toString().split(".")[0]),width:parseInt((i.width/2).toString().split(".")[0])}).toFile(t.join(m,d.originalname)).catch((function(e){console.log("Error occured",e)})),e(_).resize({height:parseInt((i.height/4).toString().split(".")[0]),width:parseInt((i.width/4).toString().split(".")[0])}).toFile(t.join(f,d.originalname)).catch((function(e){console.log("Error occured",e)}))}));const p=`/images/${l}/`,g=await u.findOne({base_url:p});if(g)await u.findByIdAndUpdate(g.id,{name:d.originalname});else{new u({base_url:p,name:d.originalname}).save()}return r.render("content_files",{userid:o.id,folder_path:s,folder_name:l})}return r.redirect("main")}return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.postEditSendPageFiles=async(e,i)=>{const a=await d.findById(g.getId(e));if(a.operation.includes(y.CONTENT)){const{folder_path:d,folder_name:r}=e.body,o=t.join(d,"files");if(n.existsSync(o)){const e=n.readdirSync(o);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(o,e[i]))}else n.mkdirSync(o);if(e.files){let i=[];await e.files.map(e=>{n.renameSync(t.join(__dirname,"../../uploads/images/temp",e.filename),t.join(d,"files",e.originalname)),i.push(e.originalname)});const a=`/images/${r}/`,o=await l.findOne({base_url:a});if(o)await l.findByIdAndUpdate(o.id,{names:i});else{const e=new l({names:i,base_url:a});await e.save()}}const s=await p(),u=await S();return i.render("wysiwyg",{userid:a.id,folder_path:d,folder_name:r,operation:"create",menu:u,sidemenu:s})}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id})},module.exports.postRedirectSlider=async(e,n)=>{const i=await d.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){const{folder_path:t,folder_name:a}=e.body,d=await s.findOne({base_url:t}),r=d?d.names:[];return n.render("content_slider",{port:I,userid:i.id,folder_path:t,folder_name:a,sliderImgs:r})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postRedirectImage=async(e,n)=>{const i=await d.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){const{folder_path:t,folder_name:a}=e.body,d=await u.findOne({base_url:t}).select({_id:0,name:1}),r=d?d.name:null;return n.render("content_main_photo",{userid:i.id,folder_path:t,folder_name:a,name:r})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postRedirectFiles=async(e,n)=>{const i=await d.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){const{folder_path:t,folder_name:a}=e.body,d=await l.findOne({base_url:t}),r=d?d.names:[];return n.render("content_files",{userid:i.id,folder_path:t,folder_name:a,files:r})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postRedirectEditor=async(e,n)=>{const i=await d.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){const{folder_path:t,folder_name:a}=e.body,d=await r.findOne({content_baseUrl:t}).select({_id:1});if(d)return n.redirect("edit-content/"+d.id);{const e=await p(),d=await S();return n.render("wysiwyg",{userid:i.id,folder_path:t,folder_name:a,operation:"create",menu:d,sidemenu:e})}}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postDeleteSliderPhoto=async(e,i)=>{const a=await d.findById(g.getId(e));if(a.operation.includes(y.CONTENT)){const{name:d}=e.params,{folder_path:o,folder_name:l}=e.body,u=await s.findOne({base_url:o}).select({names:1}),c=u?u.names.indexOf(d):-1;if(-1!==c)try{n.unlinkSync(t.join(__dirname,"../..","uploads",o,"sliders",d));const e=[...u.names.slice(0,c),...u.names.slice(c+1)];if(e.length)return await s.findOneAndUpdate({base_url:o},{names:e}),i.render("content_slider",{port:I,folder_path:o,folder_name:l,userid:a.id,sliderImgs:e});await s.findOneAndDelete({base_url:o})}catch(r){console.log(r)}return i.render("content_slider",{port:I,folder_path:o,folder_name:l,userid:a.id})}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id})},module.exports.postDeleteMainPhoto=async(e,i)=>{const a=await d.findById(g.getId(e));if(a.operation.includes(y.CONTENT)){const{folder_path:d,folder_name:o}=e.body,s=await u.findOne({base_url:d}).select({name:1});if(s)try{n.unlinkSync(t.join(__dirname,"../..","uploads",d,"fullsize",s.name)),n.unlinkSync(t.join(__dirname,"../..","uploads",d,"middlesize",s.name)),n.unlinkSync(t.join(__dirname,"../..","uploads",d,"smallsize",s.name)),await u.findOneAndDelete({base_url:d})}catch(r){console.log(r)}return i.render("content_main_photo",{port:I,folder_path:d,folder_name:o,userid:a.id,name:null})}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id})},module.exports.postDeleteFile=async(e,i)=>{const a=await d.findById(g.getId(e));if(a.operation.includes(y.CONTENT)){const{name:d}=e.params,{folder_path:o,folder_name:s}=e.body,u=await l.findOne({base_url:o}).select({names:1}),c=u?u.names.indexOf(d):-1;if(-1!==c)try{n.unlinkSync(t.join(__dirname,"../..","uploads",o,"files",d));const e=[...u.names.slice(0,c),...u.names.slice(c+1)];if(e.length)return await l.findOneAndUpdate({base_url:o},{names:e}),i.render("content_files",{port:I,folder_path:o,folder_name:s,userid:a.id,files:e});await l.findOneAndDelete({base_url:o})}catch(r){console.log(r)}return i.render("content_files",{port:I,folder_path:o,folder_name:s,userid:a.id})}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id})};