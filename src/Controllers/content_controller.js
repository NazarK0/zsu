"use strict";const e=require("sharp"),n=require("fs"),i=require("os"),t=require("path"),a=require("image-size"),d=require("../Models/User"),o=require("../Models/Content"),r=require("../Models/Sidemenu"),s=require("../Models/SliderNames"),l=require("../Models/FileNames"),u=require("../Models/MainPhoto"),c=require("../Models/History"),_=require("../Models/Submenu"),m=require("../Models/ChildSub"),{updateContent:p}=require("../API/childSubApi/update"),f=require("../API/sideMenuApi/getAllSideMenu"),g=require("../API/getAdminid"),y=require("../API/op_categories"),{ValidSession:w}=require("../API/Session/session"),{host:h}=require("../../settings.json");async function S(e,n){await _.findByIdAndUpdate(e,{content_id:n}),await m.findByIdAndUpdate(e,{content_id:n})}async function I(){const e=require("../Models/Main_Menu"),n=require("../API/SubMenuAPI/getAllChildMain"),i=[];let t=await e.find();for(let a=0;a<t.length;a++)t[a].submenu_item=await n(t[a].id),i.push(t[a]);return t}module.exports.getCreateContentFolder=async(e,n)=>{const i=await d.findById(g.getId(e));return!0===await w(e.session,i.id,n)?i.operation.includes(y.CONTENT)?n.render("content_name",{userid:i.id,content_folder_title:""}):n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id}):null===await w(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.postCreatedContentFolder=async(e,i)=>{const a=await d.findById(g.getId(e));if(!a.operation.includes(y.CONTENT))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{content_folder_title:d}=e.body,o=t.join(__dirname,"../../uploads/images",d);if(n.existsSync(o))i.render("content_name",{content_folder_title:d,userid:a.id});else{n.mkdirSync(o);const e=await f();i.render("wysiwyg",{content_folder_title:d,folder_path:o,folder_name:d,menu:await I(),sidemenu:e,userid:a.id,operation:"create"})}}},module.exports.postSendImage=async(i,o)=>{const r=await d.findById(g.getId(i));if(!r.operation.includes(y.CONTENT))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});{const d=await i.file;if(d){const{folder_path:o,folder_name:r}=i.body,s=t.join(o,"fullsize"),l=t.join(o,"middlesize"),c=t.join(o,"smallsize");if(n.existsSync(s)){const e=n.readdirSync(s);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(s,e[i]))}else n.mkdirSync(s);if(n.existsSync(l)){const e=n.readdirSync(l);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(l,e[i]))}else n.mkdirSync(l);if(n.existsSync(c)){const e=n.readdirSync(c);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(c,e[i]))}else n.mkdirSync(c);n.renameSync(t.join(__dirname,"../../uploads/images/temp",d.filename),t.join(o,"fullsize",d.originalname));const _=t.join(s,d.originalname);a(_,(function(n,i){e(_).resize({height:parseInt((i.height/2).toString().split(".")[0]),width:parseInt((i.width/2).toString().split(".")[0])}).toFile(t.join(l,d.originalname)).catch((function(e){console.log("Error occured",e)})),e(_).resize({height:parseInt((i.height/4).toString().split(".")[0]),width:parseInt((i.width/4).toString().split(".")[0])}).toFile(t.join(c,d.originalname)).catch((function(e){console.log("Error occured",e)}))}));const m=`/images/${r}/`,p=await u.findOne({base_url:m});if(p)await u.findByIdAndUpdate(p.id,{name:d.originalname});else{new u({base_url:m,name:d.originalname}).save()}}}},module.exports.postNewContent=async(e,i)=>{const a=await d.findById(g.getId(e));if(a.operation.includes(y.CONTENT)){let{page_title:d,description:s,content_folder:l,page_type:u,news_type:_,generated_menu_link:m,generated_sidemenu_link:f,keywords:g,html_body:y,lang:w,mainmenu_checkbox:I,sidemenu_checkbox:k}=e.body;switch(u){case"news":m=null,f=null;break;case"content_page":_=null,(void 0===I||void 0===m)&&(m=null),(void 0===k||void 0===f)&&(f=null)}const b=new o({content_baseUrl:`/images/${l}/`,description:s,content_folder:l,page_title:d,page_type:u,news_type:_,lang:w,keywords:g,generated_menu_link:m,generated_sidemenu_link:f,html_body:y,user_id:a.id});if("news"===u){const e=`<item>\n        <title>${d}</title>\n        <link>http://${h}</link>\n        <description>${s}</description>\n        <guid>${Date.now()}</guid>\n      </item>\n    </channel>\n  </rss>\n      `,i=t.join(__dirname,"../..","public","rss.xml");n.readFile(i,(t,a)=>{if(t)throw t;const d=a.indexOf("</channel>");n.open(i,"r+",666,(i,t)=>{n.write(t,e,d,"utf-8",()=>{n.close(t)})})})}let x;return m&&"undefined"!==m&&(await p(m,b.id),await S(m,b.id)),f&&"undefined"!==f&&(console.log(f,"SIDE"),await r.updateMany({content_id:b.id},{content_id:null}),await o.updateMany({generated_sidemenu_link:f},{generated_sidemenu_link:null}),await r.findByIdAndUpdate(f,{content_id:b.id})),await b.save(),"news"===u?(x=new c({type_content:"Новина",operation:"Додавання новини "+d,user:a.login}),await x.save(),i.redirect("news/1")):"content_page"===u?(x=new c({type_content:"Новина",operation:"Додавання cторінки "+d,user:a.login}),await x.save(),i.redirect("pages/1")):i.redirect("news/1")}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id})},module.exports.postSendSliderPhotos=async(e,i)=>{const a=await d.findById(g.getId(e));if(!a.operation.includes(y.CONTENT))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{folder_path:a,folder_name:d}=e.body,o=t.join(a,"sliders");if(n.existsSync(o)){const e=n.readdirSync(o);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(o,e[i]))}else n.mkdirSync(o);if(e.files){let o=[];await e.files.map(e=>{n.renameSync(t.join(__dirname,"../../uploads/images/temp",e.filename),t.join(a,"sliders",e.originalname)),o.push(e.originalname)});const r=`/images/${d}/`,l=await s.findOne({base_url:r});if(l)await s.findByIdAndUpdate(l.id,{names:o});else{const e=new s({names:o,base_url:r});await e.save()}i.status(200)}}},module.exports.getEditContentForm=async(e,n)=>{const i=await d.findById(g.getId(e));if(!0===await w(e.session,i.id,n)){if(i.operation.includes(y.CONTENT)){const a=await o.findById(e.params.id),d=t.join(__dirname,"../../uploads/images",a.content_folder),r=await f();return n.render("wysiwyg",{content_folder_title:a.content_folder,folder_path:d,folder_name:a.content_folder,menu:await I(),sidemenu:r,userid:i.id,page_title:a.page_title,description:a.description,keywords:a.keywords,html_body:a.html_body,content_id:a.id,operation:"edit"})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})}return null===await w(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.postEditedContent=async(e,n)=>{const i=await d.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){let{content_id:a,page_title:d,description:s,page_type:l,news_type:u,generated_menu_link:_,generated_sidemenu_link:m,keywords:f,html_body:g,lang:y,mainmenu_checkbox:w,sidemenu_checkbox:h}=e.body;switch(l){case"news":_=null,m=null;try{await r.updateMany({content_id:a},{content_id:null}),await S(_,null);const e=new c({type_content:"Новина",operation:"Редагування новини "+d,user:i.login});await e.save()}catch(t){}break;case"content_page":u=null,(void 0===w||void 0===_)&&(_=null),void 0===h?(m=null,await r.updateMany({content_id:a},{content_id:null})):void 0===m&&(m=null);const e=new c({type_content:"Новина",operation:"Редагування cторінки "+d,user:i.login});await e.save()}return await o.findByIdAndUpdate(a,{description:s,page_title:d,page_type:l,news_type:u,keywords:f,lang:y,generated_menu_link:_,generated_sidemenu_link:m,html_body:g}),_&&(await p(_,a),await S(_,a)),m&&(await r.updateMany({content_id:a},{content_id:null}),await o.updateMany({generated_sidemenu_link:m},{generated_sidemenu_link:null}),await r.findByIdAndUpdate(m,{content_id:a}),await o.findByIdAndUpdate(a,{generated_sidemenu_link:m})),n.redirect("news/1")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postSendPageFiles=async(e,i)=>{const a=await d.findById(g.getId(e));if(!a.operation.includes(y.CONTENT))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{folder_path:a,folder_name:d}=e.body,o=t.join(a,"files");if(n.existsSync(o)){const e=n.readdirSync(o);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(o,e[i]))}else n.mkdirSync(o);if(e.files){let o=[];await e.files.map(e=>{n.renameSync(t.join(__dirname,"../../uploads/images/temp",e.filename),t.join(a,"files",e.originalname)),o.push(e.originalname)});const r=`/images/${d}/`,s=await l.findOne({base_url:r});if(s)await l.findByIdAndUpdate(s.id,{names:o});else{const e=new l({names:o,base_url:r});await e.save()}return i.status(200)}}};