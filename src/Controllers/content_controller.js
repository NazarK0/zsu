"use strict";const e=require("sharp"),n=require("fs"),i=require("os"),t=require("path"),d=require("image-size"),a=require("../Models/User"),r=require("../Models/Content"),o=require("../Models/Sidemenu"),s=require("../Models/SliderNames"),l=require("../Models/FileNames"),u=require("../Models/MainPhoto"),c=require("../Models/History"),_=require("../Models/Submenu"),m=require("../Models/ChildSub"),{updateContent:p}=require("../API/childSubApi/update"),f=require("../API/sideMenuApi/getAllSideMenu"),g=require("../API/getAdminid"),y=require("../API/op_categories"),{ValidSession:w}=require("../API/Session/session"),{host:h}=require("../../settings.json");async function I(){const e=require("../Models/Main_Menu"),n=require("../API/SubMenuAPI/getAllChildMain"),i=[];let t=await e.find();for(let d=0;d<t.length;d++)t[d].submenu_item=await n(t[d].id),i.push(t[d]);return t}async function S(e,n){await _.findByIdAndUpdate(e,{content_id:n}),await m.findByIdAndUpdate(e,{content_id:n})}module.exports.getCreateContentFolder=async(e,n)=>{const i=await a.findById(g.getId(e));return!0===await w(e.session,i.id,n)?i.operation.includes(y.CONTENT)?n.render("content_name",{userid:i.id,content_folder_title:""}):n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id}):null===await w(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.postCreatedContentFolder=async(e,i)=>{const d=await a.findById(g.getId(e));if(!d.operation.includes(y.CONTENT))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});{const{content_folder_title:a}=e.body,r=t.join(__dirname,"../../uploads/images",a);n.existsSync(r)?i.render("content_name",{content_folder_title:a,userid:d.id}):(n.mkdirSync(r),i.render("content_slider",{folder_path:r,folder_name:a,userid:d.id}))}},module.exports.postSendImage=async(i,r)=>{const o=await a.findById(g.getId(i));if(o.operation.includes(y.CONTENT)){const a=await i.file;if(a){const{folder_path:s,folder_name:l}=i.body,c=t.join(s,"fullsize"),_=t.join(s,"middlesize"),m=t.join(s,"smallsize");if(n.existsSync(c)){const e=n.readdirSync(c);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(c,e[i]))}else n.mkdirSync(c);if(n.existsSync(_)){const e=n.readdirSync(_);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(_,e[i]))}else n.mkdirSync(_);if(n.existsSync(m)){const e=n.readdirSync(m);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(m,e[i]))}else n.mkdirSync(m);n.renameSync(t.join(__dirname,"../../uploads/images/temp",a.filename),t.join(s,"fullsize",a.originalname));const p=t.join(c,a.originalname);d(p,(function(n,i){e(p).resize({height:parseInt((i.height/2).toString().split(".")[0]),width:parseInt((i.width/2).toString().split(".")[0])}).toFile(t.join(_,a.originalname)).catch((function(e){console.log("Error occured",e)})),e(p).resize({height:parseInt((i.height/4).toString().split(".")[0]),width:parseInt((i.width/4).toString().split(".")[0])}).toFile(t.join(m,a.originalname)).catch((function(e){console.log("Error occured",e)}))}));const f=`/images/${l}/`,g=await u.findOne({base_url:f});if(g)await u.findByIdAndUpdate(g.id,{name:a.originalname});else{new u({base_url:f,name:a.originalname}).save()}return r.render("content_files",{userid:o.id,folder_path:s,folder_name:l})}return r.redirect("main")}return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.postNewContent=async(e,i)=>{const d=await a.findById(g.getId(e));if(d.operation.includes(y.CONTENT)){let{page_title:a,description:s,content_folder:l,page_type:u,news_type:_,generated_menu_link:m,generated_sidemenu_link:f,keywords:g,html_body:y,lang:w,mainmenu_checkbox:I,sidemenu_checkbox:k}=e.body;switch(u){case"news":m=null,f=null;break;case"content_page":_=null,(void 0===I||void 0===m)&&(m=null),(void 0===k||void 0===f)&&(f=null)}const x=new r({content_baseUrl:`/images/${l}/`,description:s,content_folder:l,page_title:a,page_type:u,news_type:_,lang:w,keywords:g,generated_menu_link:m,generated_sidemenu_link:f,html_body:y,user_id:d.id});if("news"===u){const e=`<item>\n        <title>${a}</title>\n        <link>http://${h}</link>\n        <description>${s}</description>\n        <guid>${Date.now()}</guid>\n      </item>\n    </channel>\n  </rss>\n      `,i=t.join(__dirname,"../..","public","rss.xml");n.readFile(i,(t,d)=>{if(t)throw t;const a=d.indexOf("</channel>");n.open(i,"r+",666,(i,t)=>{n.write(t,e,a,"utf-8",()=>{n.close(t)})})})}let b;return m&&"undefined"!==m&&(await p(m,x.id),await S(m,x.id)),f&&"undefined"!==f&&(await o.updateMany({content_id:x.id},{content_id:null}),await r.updateMany({generated_sidemenu_link:f},{generated_sidemenu_link:null}),await o.findByIdAndUpdate(f,{content_id:x.id})),await x.save(),"news"===u?(b=new c({type_content:"Новина",operation:"Додавання новини "+a,user:d.login}),await b.save(),i.redirect("news/1")):"content_page"===u?(b=new c({type_content:"Новина",operation:"Додавання cторінки "+a,user:d.login}),await b.save(),i.redirect("pages/1")):i.redirect("main")}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id})},module.exports.postSendSliderPhotos=async(e,i)=>{const d=await a.findById(g.getId(e));if(!d.operation.includes(y.CONTENT))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});{const{folder_path:a,folder_name:r}=e.body,o=t.join(a,"sliders");if(n.existsSync(o)){const e=n.readdirSync(o);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(o,e[i]))}else n.mkdirSync(o);if(e.files){let o=[];await e.files.map(e=>{n.renameSync(t.join(__dirname,"../../uploads/images/temp",e.filename),t.join(a,"sliders",e.originalname)),o.push(e.originalname)});const l=`/images/${r}/`,u=await s.findOne({base_url:l});if(u)await s.findByIdAndUpdate(u.id,{names:o});else{const e=new s({names:o,base_url:l});await e.save()}return i.render("content_main_photo",{userid:d.id,folder_path:a,folder_name:r})}}},module.exports.getEditContentForm=async(e,n)=>{const i=await a.findById(g.getId(e));if(!0===await w(e.session,i.id,n)){if(i.operation.includes(y.CONTENT)){const d=await r.findById(e.params.id),a=t.join(__dirname,"../../uploads/images",d.content_folder),o=await f();return n.render("wysiwyg",{content_folder_title:d.content_folder,folder_path:a,folder_name:d.content_folder,menu:await I(),sidemenu:o,userid:i.id,page_title:d.page_title,description:d.description,keywords:d.keywords,html_body:d.html_body,content_id:d.id,operation:"edit"})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})}return null===await w(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.postEditedContent=async(e,n)=>{const i=await a.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){let{content_id:d,page_title:a,description:s,page_type:l,news_type:u,generated_menu_link:_,generated_sidemenu_link:m,keywords:f,html_body:g,lang:y,mainmenu_checkbox:w,sidemenu_checkbox:h}=e.body;switch(l){case"news":_=null,m=null;try{await o.updateMany({content_id:d},{content_id:null}),await S(_,null);const e=new c({type_content:"Новина",operation:"Редагування новини "+a,user:i.login});await e.save()}catch(t){}break;case"content_page":u=null,(void 0===w||void 0===_)&&(_=null),void 0===h?(m=null,await o.updateMany({content_id:d},{content_id:null})):void 0===m&&(m=null);const e=new c({type_content:"Новина",operation:"Редагування cторінки "+a,user:i.login});await e.save()}return await r.findByIdAndUpdate(d,{description:s,page_title:a,page_type:l,news_type:u,keywords:f,lang:y,generated_menu_link:_,generated_sidemenu_link:m,html_body:g}),_&&(await p(_,d),await S(_,d)),m&&(await o.updateMany({content_id:d},{content_id:null}),await r.updateMany({generated_sidemenu_link:m},{generated_sidemenu_link:null}),await o.findByIdAndUpdate(m,{content_id:d}),await r.findByIdAndUpdate(d,{generated_sidemenu_link:m})),n.redirect("news/1")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postSendPageFiles=async(e,i)=>{const d=await a.findById(g.getId(e));if(d.operation.includes(y.CONTENT)){const{folder_path:a,folder_name:r}=e.body,o=t.join(a,"files");if(n.existsSync(o)){const e=n.readdirSync(o);for(let i=0;i<e.length;i++)n.unlinkSync(t.join(o,e[i]))}else n.mkdirSync(o);if(e.files){let i=[];await e.files.map(e=>{n.renameSync(t.join(__dirname,"../../uploads/images/temp",e.filename),t.join(a,"files",e.originalname)),i.push(e.originalname)});const d=`/images/${r}/`,o=await l.findOne({base_url:d});if(o)await l.findByIdAndUpdate(o.id,{names:i});else{const e=new l({names:i,base_url:d});await e.save()}}const s=await f(),u=await I();return i.render("wysiwyg",{userid:d.id,folder_path:a,folder_name:r,operation:"create",menu:u,sidemenu:s})}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id})},module.exports.postRedirectImage=async(e,n)=>{const i=await a.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){const{folder_path:t,folder_name:d}=e.body;return n.render("content_main_photo",{userid:i.id,folder_path:t,folder_name:d})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postRedirectFiles=async(e,n)=>{const i=await a.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){const{folder_path:t,folder_name:d}=e.body;return n.render("content_files",{userid:i.id,folder_path:t,folder_name:d})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postRedirectEditor=async(e,n)=>{const i=await a.findById(g.getId(e));if(i.operation.includes(y.CONTENT)){const{folder_path:t,folder_name:d}=e.body,a=await f(),r=await I();return n.render("wysiwyg",{userid:i.id,folder_path:t,folder_name:d,operation:"create",menu:r,sidemenu:a})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})};