"use strict";const e=require("sharp"),n=require("fs"),i=require("path"),t=require("image-size"),a=require("../Models/User"),d=require("../Models/Content"),o=require("../Models/Sidemenu"),r=require("../Models/SliderNames"),s=require("../Models/FileNames"),l=require("../Models/MainPhoto"),u=require("../Models/Submenu"),c=require("../Models/ChildSub"),{updateContent:_}=require("../API/childSubApi/update"),m=require("../API/sideMenuApi/getAllSideMenu"),p=require("../API/getAdminid"),f=require("../API/op_categories"),{ValidSession:g}=require("../API/Session/session");async function y(e,n){await u.findByIdAndUpdate(e,{content_id:n}),await c.findByIdAndUpdate(e,{content_id:n})}async function w(){const e=require("../Models/Main_Menu"),n=require("../API/SubMenuAPI/getAllChildMain"),i=[];let t=await e.find();for(let a=0;a<t.length;a++)t[a].submenu_item=await n(t[a].id),i.push(t[a]);return t}module.exports.getCreateContentFolder=async(e,n)=>{const i=await a.findById(p.getId(e));return!0===await g(e.session,i.id,n)?i.operation.includes(f.CONTENT)?n.render("content_name",{userid:i.id,content_folder_title:""}):n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id}):null===await g(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.postCreatedContentFolder=async(e,t)=>{const d=await a.findById(p.getId(e));if(!d.operation.includes(f.CONTENT))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});{const{content_folder_title:a}=e.body,o=i.join(__dirname,"../../uploads/images",a);if(n.existsSync(o))t.render("content_name",{content_folder_title:a,userid:d.id});else{n.mkdirSync(o);const e=await m();t.render("wysiwyg",{content_folder_title:a,folder_path:o,folder_name:a,menu:await w(),sidemenu:e,userid:d.id,operation:"create"})}}},module.exports.postSendImage=async(d,o)=>{const r=await a.findById(p.getId(d));if(!r.operation.includes(f.CONTENT))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});{const a=await d.file;if(a){const{folder_path:o,folder_name:r}=d.body,s=i.join(o,"fullsize"),u=i.join(o,"middlesize"),c=i.join(o,"smallsize");if(n.existsSync(s)){const e=n.readdirSync(s);for(let t=0;t<e.length;t++)n.unlinkSync(i.join(s,e[t]))}else n.mkdirSync(s);if(n.existsSync(u)){const e=n.readdirSync(u);for(let t=0;t<e.length;t++)n.unlinkSync(i.join(u,e[t]))}else n.mkdirSync(u);if(n.existsSync(c)){const e=n.readdirSync(c);for(let t=0;t<e.length;t++)n.unlinkSync(i.join(c,e[t]))}else n.mkdirSync(c);n.renameSync(i.join(__dirname,"../../uploads/images/temp",a.filename),i.join(o,"fullsize",a.originalname));const _=i.join(s,a.originalname);t(_,(function(n,t){e(_).resize({height:parseInt((t.height/2).toString().split(".")[0]),width:parseInt((t.width/2).toString().split(".")[0])}).toFile(i.join(u,a.originalname)).catch((function(e){console.log("Error occured",e)})),e(_).resize({height:parseInt((t.height/4).toString().split(".")[0]),width:parseInt((t.width/4).toString().split(".")[0])}).toFile(i.join(c,a.originalname)).catch((function(e){console.log("Error occured",e)}))}));const m=`/images/${r}/`,p=await l.findOne({base_url:m});if(p)await l.findByIdAndUpdate(p.id,{name:a.originalname});else{new l({base_url:m,name:a.originalname}).save()}}}},module.exports.postNewContent=async(e,n)=>{const i=await a.findById(p.getId(e));if(i.operation.includes(f.CONTENT)){let{page_title:t,description:a,content_folder:r,page_type:s,news_type:l,generated_menu_link:u,generated_sidemenu_link:c,keywords:m,html_body:p,lang:f,mainmenu_checkbox:g,sidemenu_checkbox:w}=e.body;switch(s){case"news":u=null,c=null;break;case"content_page":l=null,(void 0===g||void 0===u)&&(u=null),(void 0===w||void 0===c)&&(c=null)}const h=new d({content_baseUrl:`/images/${r}/`,description:a,content_folder:r,page_title:t,page_type:s,news_type:l,lang:f,keywords:m,generated_menu_link:u,generated_sidemenu_link:c,html_body:p,user_id:i.id});let S;return u&&(await _(u,h.id),await y(u,h.id)),c&&(await o.updateMany({content_id:h.id},{content_id:null}),await d.updateMany({generated_sidemenu_link:c},{generated_sidemenu_link:null}),await o.findByIdAndUpdate(c,{content_id:h.id})),await h.save(),"news"===s&&(S=new History({type_content:"Новина",operation:"Додавання новини "+t,user:i.login}),await S.save()),"content_page"===s&&(S=new History({type_content:"Новина",operation:"Додавання cторінки "+t,user:i.login}),await S.save()),n.redirect("news/1")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postSendSliderPhotos=async(e,t)=>{const d=await a.findById(p.getId(e));if(!d.operation.includes(f.CONTENT))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});{const{folder_path:a,folder_name:d}=e.body,o=i.join(a,"sliders");if(n.existsSync(o)){const e=n.readdirSync(o);for(let t=0;t<e.length;t++)n.unlinkSync(i.join(o,e[t]))}else n.mkdirSync(o);if(e.files){let o=[];await e.files.map(e=>{n.renameSync(i.join(__dirname,"../../uploads/images/temp",e.filename),i.join(a,"sliders",e.originalname)),o.push(e.originalname)});const s=`/images/${d}/`,l=await r.findOne({base_url:s});if(l)await r.findByIdAndUpdate(l.id,{names:o});else{const e=new r({names:o,base_url:s});await e.save()}t.status(200)}}},module.exports.getEditContentForm=async(e,n)=>{const t=await a.findById(p.getId(e));if(!0===await g(e.session,t.id,n)){if(t.operation.includes(f.CONTENT)){const a=await d.findById(e.params.id),o=i.join(__dirname,"../../uploads/images",a.content_folder),r=await m();return n.render("wysiwyg",{content_folder_title:a.content_folder,folder_path:o,folder_name:a.content_folder,menu:await w(),sidemenu:r,userid:t.id,page_title:a.page_title,description:a.description,keywords:a.keywords,html_body:a.html_body,content_id:a.id,operation:"edit"})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id})}return null===await g(e.session,t.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.postEditedContent=async(e,n)=>{const i=await a.findById(p.getId(e));if(i.operation.includes(f.CONTENT)){let{content_id:a,page_title:r,description:s,page_type:l,news_type:u,generated_menu_link:c,generated_sidemenu_link:m,keywords:p,html_body:f,lang:g,mainmenu_checkbox:w,sidemenu_checkbox:h}=e.body;switch(l){case"news":c=null,m=null;try{await o.updateMany({content_id:a},{content_id:null}),await y(c,null);const e=new History({type_content:"Новина",operation:"Редагування новини "+r,user:i.login});await e.save()}catch(t){}break;case"content_page":u=null,(void 0===w||void 0===c)&&(c=null),void 0===h?(m=null,await o.updateMany({content_id:a},{content_id:null})):void 0===m&&(m=null);const e=new History({type_content:"Новина",operation:"Редагування cторінки "+r,user:i.login});await e.save()}return await d.findByIdAndUpdate(a,{description:s,page_title:r,page_type:l,news_type:u,keywords:p,lang:g,generated_menu_link:c,generated_sidemenu_link:m,html_body:f}),c&&(await _(c,a),await y(c,a)),m&&(await o.updateMany({content_id:a},{content_id:null}),await d.updateMany({generated_sidemenu_link:m},{generated_sidemenu_link:null}),await o.findByIdAndUpdate(m,{content_id:a}),await d.findByIdAndUpdate(a,{generated_sidemenu_link:m})),n.redirect("news/1")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postSendPageFiles=async(e,t)=>{const d=await a.findById(p.getId(e));if(!d.operation.includes(f.CONTENT))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});{const{folder_path:a,folder_name:d}=e.body,o=i.join(a,"files");if(n.existsSync(o)){const e=n.readdirSync(o);for(let t=0;t<e.length;t++)n.unlinkSync(i.join(o,e[t]))}else n.mkdirSync(o);if(e.files){let o=[];await e.files.map(e=>{n.renameSync(i.join(__dirname,"../../uploads/images/temp",e.filename),i.join(a,"files",e.originalname)),o.push(e.originalname)});const r=`/images/${d}/`,l=await s.findOne({base_url:r});if(l)await s.findByIdAndUpdate(l.id,{names:o});else{const e=new s({names:o,base_url:r});await e.save()}return t.status(200)}}};