"use strict";const e=require("fs"),t=require("path"),n=require("moment"),a=require("../Models/User"),i=require("../Models/Content"),s=require("../Models/Sidemenu"),r=require("../Models/SliderNames"),o=require("../Models/FileNames"),c=require("../Models/MainPhoto"),l=require("../Models/History"),d=require("../Models/Submenu"),u=require("../Models/ChildSub"),p=require("../Models/PublishTime"),_=require("../API/constants/typeNews"),g=require("../API/constants/typeContentPage"),y=require("../API/userAPI/hasAccess"),{updateContent:b}=require("../API/childSubApi/update"),m=require("../API/sideMenuApi/getAllSideMenu"),w=require("../API/MainMenuApi/getAllMenu"),f=require("../API/getAllCategories"),h=require("../API/getAdminid"),C=require("../API/op_categories"),{ValidSession:k}=require("../API/Session/session"),{host:A,port:I}=require("../../settings.json"),{time:P}=require("console"),{HISTORY_WAR:S}=require("../API/constants/typeContentPage");let q,L=!0;async function M(e,t){if(t){const a=n(t).startOf("minutes").valueOf(),s=await p.findOne({news_id:e.id});s?await p.findByIdAndUpdate(s.id,{timestamp:a}):await new p({timestamp:a,news_id:e.id}).save(),await i.findByIdAndUpdate(e.id,{date:t,public_status:"deffered"})}else e.date||await i.findByIdAndUpdate(e.id,{public_status:"active"})}module.exports.getEditor=async(n,s)=>{const l=await a.findById(h.getId(n));if(!(await y(l.id,C.CONTENT)))return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id});{const n={displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayTypes:"block",displayContentPage:"none",action:"create"},a=await i.find().select({_id:0,anchor_label:1}).distinct("anchor_label");if(n.historyWarLabelsList=a,L){q=Date.now().toString();const n=t.join(__dirname,"../../uploads/images",q);e.mkdir(n,e=>{e&&console.error(e),L=!1})}else{const e=await c.findOne({base_url:"/images/".concat(q,"/")}).select({_id:0,name:1});if(e){const t="/images/".concat(q,"/middlesize/").concat(e.name);n.mainPhotoCurrent=t,n.displayMainPhotoCurrent="block"}else n.displayMainPhotoCurrent="none";const t=await r.findOne({base_url:"/images/".concat(q,"/")}).select({_id:1,names:2});if(t){const e=t.names.map(e=>({url:"/images/".concat(q,"/sliders/").concat(e),id:t.id,filename:e}));n.sliderCurrent=e,n.displaySliderCurrent="block"}else n.displaySliderCurrent="none";const a=await o.findOne({base_url:"/images/".concat(q,"/")}).select({_id:1,names:2});if(a){const e=a.names.map(e=>({id:a.id,filename:e}));n.filesCurrent=e,n.displayFilesCurrent="block"}else n.displayFilesCurrent="none"}n.folder_path="/images/".concat(q,"/"),n.content_folder=q,n.categories=await f(),n.userid=l.id,s.render("wysiwyg",n)}},module.exports.postNewContent=async(n,s)=>{const r=await a.findById(h.getId(n));if(await y(r.id,C.CONTENT)){const{page_title:a,description:o,content_folder:c,page_type:d,news_type:u,contentPage_type:p,generated_category_link:y,keywords:b,html_body:m,lang:w,time_to_publish:f,historyWarLinkLabel:h,historyWarLinkLabelNew:C}=n.body,k={content_baseUrl:"/images/".concat(c,"/"),content_folder:c,page_type:d,description:o,page_title:a,keywords:b,lang:w,html_body:m,user_id:r.id};if("news"===d)switch("no_change"!==y&&"unlink"!==y&&(k.generated_category_link=y),u){case"casual":k.page_subclass=_.CASUAL;break;case"main":k.page_subclass=_.MAIN;break;case"current":k.page_subclass=_.CURRENT}else if("content_page"===d)switch(k.public_status="deffered",p){case"casual":k.page_subclass=g.CASUAL;break;case"current":k.page_subclass=g.CURRENT;break;case"historyWar":{let e;k.page_subclass=g.HISTORY_WAR,h&&(e=h.trim());const t=e||C.trim();t&&(k.anchor_label=t)}break;case"links":k.page_subclass=g.LINKS}const I=await new i(k).save();if("news"===d){await M(I,f);const n="<item>\n        <title>".concat(a,"</title>\n        <link>http://").concat(A,"</link>\n        <description>").concat(o,"</description>\n        <guid>").concat(Date.now(),"</guid>\n      </item>\n    </channel>\n  </rss>"),i=t.join(__dirname,"../..","public","rss.xml");e.readFile(i,(t,a)=>{if(t)throw t;const s=a.indexOf("</channel>");e.open(i,"r+",666,(t,a)=>{e.write(a,n,s,"utf-8",()=>{e.close(a)})})})}return L=!0,"news"===d?(await new l({type_content:"Новина",operation:"Додавання новини ".concat(a),user:r.login}).save(),s.redirect("news/1")):"content_page"===d?(await new l({type_content:"Cторінка",operation:"Додавання cторінки ".concat(a),user:r.login}).save(),s.redirect("pages/1")):s.redirect("main")}return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id})},module.exports.postEditedContent=async(e,t)=>{const n=await a.findById(h.getId(e)),{content_id:s,page_title:r,description:o,keywords:c,html_body:d,lang:u,time_to_publish:p,historyWarLinkLabel:_,historyWarLinkLabelNew:y,generated_category_link:b}=e.body,m=await i.findById(s);if(!m)return t.status(400).render("infopage",{info:"Некоректні дані. Даного запису не існує!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});{const e={description:o,page_title:r,keywords:c,lang:u,html_body:d};switch(m.page_type){case"news":"unlink"===b?e.generated_category_link=null:"no_change"!==b&&(e.generated_category_link=b),await M(m,p);try{await new l({type_content:"Новина",operation:"Редагування новини ".concat(r),user:n.login}).save()}catch(w){console.error(w)}break;case"content_page":switch(e.public_status="deffered",m.page_subclass){case g.CASUAL:case g.CURRENT:break;case g.HISTORY_WAR:{let t;e.page_subclass=g.HISTORY_WAR,_&&(t=_.trim());const n=t||y.trim();n&&(e.anchor_label=n)}break;case g.LINKS:}}if(await i.findByIdAndUpdate(s,e),"news"===m.page_type)return t.redirect("news/1");if("content_page"===m.page_type)return t.redirect("pages/1")}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id})},module.exports.getEditContentForm=async(e,t)=>{const n=await a.findById(h.getId(e));if(!0===await k(e.session,n.id,t)){const a=await i.findById(e.params.id),s="news"===a.page_type,l={folder_path:a.content_baseUrl,menu:await w(),sidemenu:await m(),categories:await f(),userid:n.id,page_title:a.page_title,description:a.description,keywords:a.keywords,html_body:a.html_body,content_id:a.id,displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayNews:s?"block":"none",displayContentPage:s?"none":"block",displayTypes:"none",current_category:a.generated_category_link,current_page_subclass:a.page_subclass,action:"edit",timeToPublish:a.date},d=await i.find().select({_id:0,anchor_label:1}).distinct("anchor_label");if(l.historyWarLabelsList=d,"content_page"===a.page_type&&a.page_subclass===g.HISTORY_WAR&&(l.currentHistoryWarLinkLabel=a.anchor_label),"content_page"===a.page_type)switch(a.page_subclass){case g.CASUAL:l.page_subclass="casual";break;case g.CURRENT:l.page_subclass="current";break;case g.HISTORY_WAR:l.page_subclass="historyWar",l.historyWarLinkLabel=a.anchor_label;break;case g.LINKS:l.page_subclass="links"}const u=await c.findOne({base_url:a.content_baseUrl}).select({_id:0,name:1});if(u){const e="http://".concat(A,":").concat(I).concat(a.content_baseUrl,"middlesize/").concat(u.name);l.mainPhotoCurrent=e,l.displayMainPhotoCurrent="block"}else l.displayMainPhotoCurrent="none";const p=await r.findOne({base_url:a.content_baseUrl}).select({_id:1,names:2});if(p){const e=p.names.map(e=>({url:"http://".concat(A,":").concat(I).concat(a.content_baseUrl,"sliders/").concat(e),id:p.id,filename:e}));l.sliderCurrent=e,l.displaySliderCurrent="block"}else l.displaySliderCurrent="none";const _=await o.findOne({base_url:a.content_baseUrl}).select({_id:1,names:2});if(_){const e=_.names.map(e=>({id:_.id,filename:e}));l.filesCurrent=e,l.displayFilesCurrent="block"}else l.displayFilesCurrent="none";return t.render("wysiwyg",l)}return null===await k(e.session,n.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})};