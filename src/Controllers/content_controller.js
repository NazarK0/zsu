"use strict";const e=require("fs"),a=require("path"),s=require("moment"),i=require("jimp"),t=require("../Models/User"),n=require("../Models/Content"),l=require("../Models/Sidemenu"),o=require("../Models/SliderNames"),c=require("../Models/FileNames"),r=require("../Models/Link"),d=require("../Models/MainPhoto"),b=require("../Models/History"),u=require("../Models/Submenu"),p=require("../Models/ChildSub"),k=require("../Models/PublishTime"),y=require("../API/constants/typeNews"),_=require("../API/constants/typeContentPage"),g=require("../API/userAPI/hasAccess"),{updateContent:h}=require("../API/childSubApi/update"),m=require("../API/sideMenuApi/getAllSideMenu"),w=require("../API/MainMenuApi/getAllMenu"),f=require("../API/getAllCategories"),C=require("../API/getAdminid"),P=require("../API/op_categories"),{ValidSession:L}=require("../API/Session/session"),{host:S,port:I}=require("../../settings.json"),{time:q}=require("console"),{HISTORY_WAR:M}=require("../API/constants/typeContentPage"),A=require("../API/userAPI/enabledIds"),$=require("../Models/ContentLinks");let T,W=!0;module.exports.getEditor=async(s,i)=>{const l=await t.findById(C.getId(s));if(!(await g(l.id,P.CONTENT)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${l.id}/main`,url_text:"Повернутися до Головного Меню",user:l.id});{const s=await g(l.id,P.PAGES),t=await g(l.id,P.NEWS),b=["history","historyWar","current"];let u="none",p="none",k="none",y="none",_="none",h="none",m="none",w="none",C="none",L="none",S="none",I="none",q="none",M="none",A="none",$="none",F="none",N="none",O="",U="",x="",H="",D="",E="",B="";if(t&&(C="block",L="block",S="block",I="block",q="block",A="block",$="block"),s){const e=await g(l.id,"casual"),a=await g(l.id,"current"),s=await g(l.id,"contacts"),i=await g(l.id,"historyWar"),t=await g(l.id,"history"),n=await g(l.id,"files"),o=await g(l.id,"commander"),c=[e,s,a,n,t,i,o].reduce((e,a)=>a?e+1:e,0);0===c?(O="checked",p="block",k="block",y="block",_="block",h="block",m="block",w="block"):1===c?(e&&(C="block",S="block",I="block",q="block",O="checked"),a&&(C="block",q="block",L="block",H="checked"),s&&(C="block",q="block",b.push("files","casual"),D="checked"),i&&(S="block",I="block",q="block",M="block",F="block",U="checked"),t&&(S="block",I="block",q="block",M="block",N="block",x="checked"),n&&(C="block",I="block",b.push("contacts","casual"),E="checked"),o&&(L="block",q="block",I="block",B="checked")):c>1&&(M="block",F="none",N="none",O="",U="",x="",H="",D="",E="",e?(C="block",S="block",I="block",q="block",p="block",O="checked",a&&(_="block"),s&&(h="block"),i&&(y="block"),t&&(k="block"),n&&(m="block"),o&&(w="block")):i?(S="block",I="block",q="block",y="block",F="block",U="checked",a&&(_="block"),s&&(h="block"),t&&(k="block"),n&&(m="block"),o&&(w="block")):t?(S="block",I="block",q="block",k="block",N="block",x="checked",a&&(_="block"),s&&(h="block"),n&&(m="block"),o&&(w="block")):a?(C="block",q="block",L="block",_="block",H="checked",s&&(h="block"),n&&(m="block"),o&&(w="block")):s?(C="block",q="block",h="block",m="block",b.push("files","casual"),D="checked",n&&(m="block"),o&&(w="block")):n&&o&&(C="block",q="none",m="block",w="block",b.push("files"),B="checked"))}t&&s&&(u="block");const v={displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayContentPage:"none",displayHWLabel:F,displayTypes:u,displayLinksTab:C,displayMainPhotoTab:L,displaySliderTab:S,displayFilesTab:I,displayCPOtherTab:M,displayNewsCategoryTab:A,displayNewsOtherTab:$,displayWysiwyg:q,displayPageSubclassCPCasual:p,displayPageSubclassCPCurrent:_,displayPageSubclassCPContacts:h,displayPageSubclassCPHistoryWar:y,displayPageSubclassCPHistory:k,displayPageSubclassCPFiles:m,"displayPageSubclassCPСommander":w,pageSubclassCPCasualChecked:O,pageSubclassCPHistoryChecked:x,pageSubclassCPHistoryWarChecked:U,pageSubclassCPCurrentChecked:H,pageSubclassCPContactsChecked:D,pageSubclassCPFilesChecked:E,pageSubclassCPCommanderChecked:B,action:"create"},K=await n.find({page_subclass:"history"}).select({_id:0,anchor_label:1}).distinct("anchor_label");v.historyLabelsList=K;const Y=await n.find({page_subclass:"historyWar"}).select({_id:0,anchor_label:1}).distinct("anchor_label");v.historyWarLabelsList=Y;const j=await r.find().select({_id:1,title_ua:2});v.usefulLinks={list:j,selectedIds:[]};const R=await n.find({page_type:"content_page",public_status:"active",page_subclass:{$nin:b}}).select({_id:1,page_title:2,page_subclass:3}).lean();if(v.usefulPages={list:R,selectedIds:[]},W){T=Date.now().toString();const s=a.join(__dirname,"../../uploads/images",T);e.mkdir(s,e=>{e&&console.error(e),W=!1})}else{const e=await d.findOne({base_url:`/images/${T}/`}).select({_id:0,name:1});if(e){const a=`/images/${T}/middlesize/${e.name}`;v.mainPhotoCurrent=a,v.displayMainPhotoCurrent="block"}else v.displayMainPhotoCurrent="none";const a=await o.findOne({base_url:`/images/${T}/`}).select({_id:1,names:2});if(a){const e=a.names.map(e=>({url:`/images/${T}/sliders/${e}`,id:a.id,filename:e}));v.sliderCurrent=e,v.displaySliderCurrent="block"}else v.displaySliderCurrent="none";const s=await c.findOne({base_url:`/images/${T}/`}).select({_id:1,names:2});if(s){const e=s.names.map(e=>({id:s.id,filename:e}));v.filesCurrent=e,v.displayFilesCurrent="block"}else v.displayFilesCurrent="none"}v.folder_path=`/images/${T}/`,v.content_folder=T,v.categories=await f(),v.userid=l.id,i.render("wysiwyg",v)}},module.exports.postNewContent=async(s,i)=>{const l=await t.findById(C.getId(s));if(await g(l.id,P.CONTENT)){const{page_title:t,description:o,content_folder:c,page_type:r,news_type:d,contentPage_type:u,categoryFK:p,keywords:k,html_body:_,lang:g,publishDate:h,historyLinkLabel:m,historyLinkLabelNew:w,historyWarLinkLabel:f,historyWarLinkLabelNew:C}=s.body,P={content_baseUrl:`/images/${c}/`,content_folder:c,page_type:r,description:o,page_title:t,keywords:k,lang:g,html_body:_,user_id:l.id};if("news"===r)switch("no_change"!==p&&"unlink"!==p&&(P.categoryFK=p),d){case"casual":P.page_subclass=y.CASUAL;break;case"main":P.page_subclass=y.MAIN;break;case"current":P.page_subclass=y.CURRENT}else if("content_page"===r)switch(P.public_status="deffered",P.page_subclass=u,u){case"history":{let e;m?e=m.trim():w&&(e=w.trim()),e&&(P.anchor_label=e)}break;case"historyWar":{let e;f?e=f.trim():C&&(e=C.trim()),e&&(P.anchor_label=e)}}const L=await new n(P).save();if("news"===r){await addToDeffered(L,h);const s=`<item>\n        <title>${t}</title>\n        <link>http://${S}</link>\n        <description>${o}</description>\n        <guid>${Date.now()}</guid>\n      </item>\n    </channel>\n  </rss>`,i=a.join(__dirname,"../..","public","rss.xml");e.readFile(i,(a,t)=>{if(a)throw a;const n=t.indexOf("</channel>");e.open(i,"r+",666,(a,i)=>{e.write(i,s,n,"utf-8",()=>{e.close(i)})})})}return W=!0,"news"===r?(await new b({type_content:"Новина",operation:"Додавання новини "+t,user:l.login}).save(),i.redirect("news/1")):"content_page"===r?(await new b({type_content:"Cторінка",operation:"Додавання cторінки "+t,user:l.login}).save(),i.redirect("pages/1")):i.redirect("main")}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${l.id}/main`,url_text:"Повернутися до Головного Меню",user:l.id})},module.exports.postEditedContent=async(e,a)=>{const s=await t.findById(C.getId(e)),{content_id:i,page_title:l,description:o,keywords:c,html_body:r,lang:d,publishDate:u,historyLinkLabel:p,historyLinkLabelNew:k,historyWarLinkLabel:y,historyWarLinkLabelNew:_,categoryFK:g}=e.body,h=await n.findById(i);if(!h)return a.status(400).render("infopage",{info:"Некоректні дані. Даного запису не існує!",url:`/admin/${s.id}/main`,url_text:"Повернутися до Головного Меню",user:s.id});{const e={description:o,page_title:l,keywords:c,lang:d,html_body:r};switch(h.page_type){case"news":"unlink"===g?e.categoryFK=null:"no_change"!==g&&(e.categoryFK=g),await addToDeffered(h,u);try{await new b({type_content:"Новина",operation:"Редагування новини "+l,user:s.login}).save()}catch(m){console.error(m)}break;case"content_page":switch(e.public_status="deffered",h.page_subclass){case"history":{let a;p?a=p.trim():k&&(a=k.trim()),a&&(e.anchor_label=a)}break;case"historyWar":{let a;y?a=y.trim():_&&(a=_.trim()),a&&(e.anchor_label=a)}}}if(await n.findByIdAndUpdate(i,e),"news"===h.page_type)return a.redirect("news/1");if("content_page"===h.page_type)return a.redirect("pages/1")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${s.id}/main`,url_text:"Повернутися до Головного Меню",user:s.id})},module.exports.getEditContentForm=async(e,a)=>{const i=await t.findById(C.getId(e));if(!0===await L(e.session,i.id,a)){const t=await n.findById(e.params.id),l="none";let b="none",u="none",p="none",k="none",y="none",_="none",g="none",h="none",m="none",w="none";switch(t.page_type){case"news":b="block",u="block",p="block",k="block",y="block",g="block",h="block";break;case"content_page":switch(t.page_subclass){case"casual":b="block",p="block",k="block",y="block",w="none";break;case"current":b="block",y="block",u="block",w="none";break;case"contacts":b="block",y="block",w="none";break;case"history":p="block",k="block",y="block",_="block",m="block";break;case"files":b="block",k="block",w="none";break;case"commander":y="block",u="block",k="block"}}const C=s(t.date).format("DD.MM.YYYY, HH:mm"),P={folder_path:t.content_baseUrl,categories:await f(),userid:i.id,page_title:t.page_title,description:t.description,keywords:t.keywords,html_body:t.html_body,content_id:t.id,timeToPublish:C,displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayHWLabel:w,displayHistoryLabel:m,displayTypes:l,displayLinksTab:b,displayMainPhotoTab:u,displaySliderTab:p,displayFilesTab:k,displayWysiwyg:y,displayCPOtherTab:_,displayNewsCategoryTab:g,displayNewsOtherTab:h,current_category:t.categoryFK,current_page_subclass:t.page_subclass,action:"edit"},L=await n.find({page_subclass:"history"}).select({_id:0,anchor_label:1}).distinct("anchor_label");P.historyLabelsList=L;const q=await n.find({page_subclass:"historyWar"}).select({_id:0,anchor_label:1}).distinct("anchor_label");P.historyWarLabelsList=q;const M=await r.find().select({_id:1,title_ua:2}),A=await $.findOne({base_url:t.content_baseUrl}).lean();let T,W;if(A){const{links:{contacts:e,pages:a,directLink:s}}=A;T=e||[],W=a||[],P.directLink=s}P.usefulLinks={list:M,selectedIds:T};const F=["history","historyWar","current"],N={page_type:"content_page",public_status:"active",_id:{$ne:t.id},page_subclass:{$nin:F}};if("content_page"===t.page_type)switch(t.page_subclass){case"contacts":F.push("files","casual");break;case"files":F.push("contacts","casual")}const O=await n.find(N).select({_id:1,page_title:2}).lean();P.usefulPages={list:O,selectedIds:W},"content_page"===t.page_type&&"historyWar"===t.page_subclass&&(P.historyWarLinkLabel=t.anchor_label),"content_page"===t.page_type&&"history"===t.page_subclass&&(P.historyLinkLabel=t.anchor_label);const U=await d.findOne({base_url:t.content_baseUrl}).select({_id:0,name:1});if(U){const e=`http://${S}:${I}${t.content_baseUrl}middlesize/${U.name}`;P.mainPhotoCurrent=e,P.displayMainPhotoCurrent="block"}else P.displayMainPhotoCurrent="none";const x=await o.findOne({base_url:t.content_baseUrl}).select({_id:1,names:2});if(x){const e=x.names.map(e=>({url:`http://${S}:${I}${t.content_baseUrl}sliders/${e}`,id:x.id,filename:e}));P.sliderCurrent=e,P.displaySliderCurrent="block"}else P.displaySliderCurrent="none";const H=await c.findOne({base_url:t.content_baseUrl}).select({_id:1,names:2});if(H){const e=H.names.map(e=>({id:H.id,filename:e}));P.filesCurrent=e,P.displayFilesCurrent="block"}else P.displayFilesCurrent="none";return a.render("wysiwyg",P)}return null===await L(e.session,i.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})};