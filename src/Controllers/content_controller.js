"use strict";const e=require("fs"),a=require("path"),t=require("moment"),n=require("../Models/User"),i=require("../Models/Content"),s=require("../Models/Sidemenu"),o=require("../Models/SliderNames"),c=require("../Models/FileNames"),l=require("../Models/Link"),r=require("../Models/MainPhoto"),d=require("../Models/History"),u=require("../Models/Submenu"),b=require("../Models/ChildSub"),p=require("../Models/PublishTime"),k=require("../API/constants/typeNews"),_=require("../API/constants/typeContentPage"),y=require("../API/userAPI/hasAccess"),{updateContent:g}=require("../API/childSubApi/update"),h=require("../API/sideMenuApi/getAllSideMenu"),w=require("../API/MainMenuApi/getAllMenu"),f=require("../API/getAllCategories"),m=require("../API/getAdminid"),C=require("../API/op_categories"),{ValidSession:P}=require("../API/Session/session"),{host:S,port:I}=require("../../settings.json"),{time:A}=require("console"),{HISTORY_WAR:q}=require("../API/constants/typeContentPage"),M=require("../API/userAPI/enabledIds"),L=require("../Models/ContentLinks");let T,W=!0;async function O(e,a){if(a){const n=t(a).startOf("minutes").valueOf(),s=await p.findOne({news_id:e.id});s?await p.findByIdAndUpdate(s.id,{timestamp:n}):await new p({timestamp:n,news_id:e.id}).save(),await i.findByIdAndUpdate(e.id,{date:a,public_status:"deffered"})}else e.date||await i.findByIdAndUpdate(e.id,{date:t(),public_status:"active"})}module.exports.getEditor=async(t,s)=>{const d=await n.findById(m.getId(t));if(!(await y(d.id,C.CONTENT)))return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});{const t=await y(d.id,C.PAGES),n=await y(d.id,C.NEWS),u=["historyWar","current"];let b="none",p="none",k="none",_="none",g="none",h="none",w="none",m="none",P="none",S="none",I="none",A="none",q="none",M="none",L="none",O="",N="",U="",F="",x="";if(n&&(w="block",m="block",P="block",S="block",I="block",q="block",M="block"),t){const e=await y(d.id,"casual"),a=await y(d.id,"current"),t=await y(d.id,"contacts"),n=await y(d.id,"historyWar"),i=await y(d.id,"files"),s=[e,t,a,i,n].reduce((e,a)=>a?e+1:e,0);0===s?(O="checked",p="block",k="block",_="block",g="block",h="block"):1===s?(e&&(w="block",P="block",S="block",I="block",O="checked"),a&&(w="block",I="block",m="block",U="checked"),t&&(w="block",I="block",u.push("files","casual"),F="checked"),n&&(P="block",S="block",I="block",A="block",L="block",N="checked"),i&&(w="block",S="block",u.push("contacts","casual"),x="checked")):s>1&&(A="block",L="none",O="",N="",U="",F="",x="",e?(w="block",P="block",S="block",I="block",p="block",O="checked",a&&(_="block"),t&&(g="block"),n&&(k="block"),i&&(h="block")):n?(P="block",S="block",I="block",k="block",L="block",N="checked",a&&(_="block"),t&&(g="block"),i&&(h="block")):a?(w="block",I="block",m="block",_="block",U="checked",t&&(g="block"),i&&(h="block")):t&&i&&(w="block",I="block",g="block",h="block",u.push("files","casual"),F="checked"))}n&&t&&(b="block");const B={displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayContentPage:"none",displayHWLabel:L,displayTypes:b,displayLinksTab:w,displayMainPhotoTab:m,displaySliderTab:P,displayFilesTab:S,displayCPOtherTab:A,displayNewsCategoryTab:q,displayNewsOtherTab:M,displayWysiwyg:I,displayPageSubclassCPCasual:p,displayPageSubclassCPCurrent:_,displayPageSubclassCPContacts:g,displayPageSubclassCPHistoryWar:k,displayPageSubclassCPFiles:h,pageSubclassCPCasualChecked:O,pageSubclassCPHistoryWarChecked:N,pageSubclassCPCurrentChecked:U,pageSubclassCPContactsChecked:F,pageSubclassCPFilesChecked:x,action:"create"},v=await i.find().select({_id:0,anchor_label:1}).distinct("anchor_label");B.historyWarLabelsList=v;const H=await l.find().select({_id:1,title_ua:2});B.usefulLinks={list:H,selectedIds:[]};const E=await i.find({page_type:"content_page",public_status:"active",page_subclass:{$nin:u}}).select({_id:1,page_title:2,page_subclass:3}).lean();if(B.usefulPages={list:E,selectedIds:[]},W){T=Date.now().toString();const t=a.join(__dirname,"../../uploads/images",T);e.mkdir(t,e=>{e&&console.error(e),W=!1})}else{const e=await r.findOne({base_url:"/images/".concat(T,"/")}).select({_id:0,name:1});if(e){const a="/images/".concat(T,"/middlesize/").concat(e.name);B.mainPhotoCurrent=a,B.displayMainPhotoCurrent="block"}else B.displayMainPhotoCurrent="none";const a=await o.findOne({base_url:"/images/".concat(T,"/")}).select({_id:1,names:2});if(a){const e=a.names.map(e=>({url:"/images/".concat(T,"/sliders/").concat(e),id:a.id,filename:e}));B.sliderCurrent=e,B.displaySliderCurrent="block"}else B.displaySliderCurrent="none";const t=await c.findOne({base_url:"/images/".concat(T,"/")}).select({_id:1,names:2});if(t){const e=t.names.map(e=>({id:t.id,filename:e}));B.filesCurrent=e,B.displayFilesCurrent="block"}else B.displayFilesCurrent="none"}B.folder_path="/images/".concat(T,"/"),B.content_folder=T,B.categories=await f(),B.userid=d.id,s.render("wysiwyg",B)}},module.exports.postNewContent=async(t,s)=>{const o=await n.findById(m.getId(t));if(await y(o.id,C.CONTENT)){const{page_title:n,description:c,content_folder:l,page_type:r,news_type:u,contentPage_type:b,generated_category_link:p,keywords:_,html_body:y,lang:g,time_to_publish:h,historyWarLinkLabel:w,historyWarLinkLabelNew:f}=t.body,m={content_baseUrl:"/images/".concat(l,"/"),content_folder:l,page_type:r,description:c,page_title:n,keywords:_,lang:g,html_body:y,user_id:o.id};if("news"===r)switch("no_change"!==p&&"unlink"!==p&&(m.generated_category_link=p),u){case"casual":m.page_subclass=k.CASUAL;break;case"main":m.page_subclass=k.MAIN;break;case"current":m.page_subclass=k.CURRENT}else if("content_page"===r)switch(m.public_status="deffered",m.page_subclass=b,b){case"historyWar":{let e;w?e=w.trim():f&&(e=f.trim()),e&&(m.anchor_label=e)}}const C=await new i(m).save();if("news"===r){await O(C,h);const t="<item>\n        <title>".concat(n,"</title>\n        <link>http://").concat(S,"</link>\n        <description>").concat(c,"</description>\n        <guid>").concat(Date.now(),"</guid>\n      </item>\n    </channel>\n  </rss>"),i=a.join(__dirname,"../..","public","rss.xml");e.readFile(i,(a,n)=>{if(a)throw a;const s=n.indexOf("</channel>");e.open(i,"r+",666,(a,n)=>{e.write(n,t,s,"utf-8",()=>{e.close(n)})})})}return W=!0,"news"===r?(await new d({type_content:"Новина",operation:"Додавання новини ".concat(n),user:o.login}).save(),s.redirect("news/1")):"content_page"===r?(await new d({type_content:"Cторінка",operation:"Додавання cторінки ".concat(n),user:o.login}).save(),s.redirect("pages/1")):s.redirect("main")}return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.postEditedContent=async(e,a)=>{const t=await n.findById(m.getId(e)),{content_id:s,page_title:o,description:c,keywords:l,html_body:r,lang:u,time_to_publish:b,historyWarLinkLabel:p,historyWarLinkLabelNew:k,generated_category_link:_}=e.body,y=await i.findById(s);if(!y)return a.status(400).render("infopage",{info:"Некоректні дані. Даного запису не існує!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});{const e={description:c,page_title:o,keywords:l,lang:u,html_body:r};switch(y.page_type){case"news":"unlink"===_?e.generated_category_link=null:"no_change"!==_&&(e.generated_category_link=_),await O(y,b);try{await new d({type_content:"Новина",operation:"Редагування новини ".concat(o),user:t.login}).save()}catch(g){console.error(g)}break;case"content_page":switch(e.public_status="deffered",y.page_subclass){case"historyWar":{let a;p?a=p.trim():k&&(a=k.trim()),a&&(e.anchor_label=a)}}}if(await i.findByIdAndUpdate(s,e),"news"===y.page_type)return a.redirect("news/1");if("content_page"===y.page_type)return a.redirect("pages/1")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id})},module.exports.getEditContentForm=async(e,a)=>{const t=await n.findById(m.getId(e));if(!0===await P(e.session,t.id,a)){const n=await i.findById(e.params.id),s="none";let d="none",u="none",b="none",p="none",k="none",y="none",g="none",h="none",w="none",m="",C="",P="",A="",q="";switch(n.page_type){case"news":d="block",u="block",b="block",p="block",k="block",g="block",h="block";break;case"content_page":switch(n.page_subclass){case"casual":d="block",b="block",p="block",k="block",w="none";break;case"current":d="block",k="block",u="block",w="none";break;case"contacts":d="block",k="block",w="none";break;case"historyWar":b="block",p="block",k="block",y="block",w="block";break;case"files":d="block",p="block",w="none"}}const M={folder_path:n.content_baseUrl,categories:await f(),userid:t.id,page_title:n.page_title,description:n.description,keywords:n.keywords,html_body:n.html_body,content_id:n.id,displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayHWLabel:w,displayTypes:s,displayLinksTab:d,displayMainPhotoTab:u,displaySliderTab:b,displayFilesTab:p,displayWysiwyg:k,displayCPOtherTab:y,displayNewsCategoryTab:g,displayNewsOtherTab:h,pageSubclassCPCasualChecked:m,pageSubclassCPHistoryWarChecked:C,pageSubclassCPCurrentChecked:P,pageSubclassCPContactsChecked:A,pageSubclassCPFilesChecked:q,current_category:n.generated_category_link,current_page_subclass:n.page_subclass,action:"edit",timeToPublish:n.date},T=await i.find().select({_id:0,anchor_label:1}).distinct("anchor_label");M.historyWarLabelsList=T;const W=await l.find().select({_id:1,title_ua:2}),O=await L.findOne({base_url:n.content_baseUrl}).lean();let N,U;if(O){const{links:{contacts:e,pages:a,directLink:t}}=O;N=e||[],U=a||[],M.directLink=t}M.usefulLinks={list:W,selectedIds:N};const F=["historyWar","current"],x={page_type:"content_page",public_status:"active",_id:{$ne:n.id},page_subclass:{$nin:F}};if("content_page"===n.page_type)switch(n.page_subclass){case"contacts":F.push("files","casual");break;case"files":F.push("contacts","casual")}const B=await i.find(x).select({_id:1,page_title:2}).lean();M.usefulPages={list:B,selectedIds:U},"content_page"===n.page_type&&n.page_subclass===_.HISTORY_WAR&&(M.currentHistoryWarLinkLabel=n.anchor_label);const v=await r.findOne({base_url:n.content_baseUrl}).select({_id:0,name:1});if(v){const e="http://".concat(S,":").concat(I).concat(n.content_baseUrl,"middlesize/").concat(v.name);M.mainPhotoCurrent=e,M.displayMainPhotoCurrent="block"}else M.displayMainPhotoCurrent="none";const H=await o.findOne({base_url:n.content_baseUrl}).select({_id:1,names:2});if(H){const e=H.names.map(e=>({url:"http://".concat(S,":").concat(I).concat(n.content_baseUrl,"sliders/").concat(e),id:H.id,filename:e}));M.sliderCurrent=e,M.displaySliderCurrent="block"}else M.displaySliderCurrent="none";const E=await c.findOne({base_url:n.content_baseUrl}).select({_id:1,names:2});if(E){const e=E.names.map(e=>({id:E.id,filename:e}));M.filesCurrent=e,M.displayFilesCurrent="block"}else M.displayFilesCurrent="none";return a.render("wysiwyg",M)}return null===await P(e.session,t.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})};