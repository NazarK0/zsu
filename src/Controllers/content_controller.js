"use strict";const e=require("fs"),a=require("path"),t=require("moment"),n=require("jimp"),i=require("../Models/User"),s=require("../Models/Content"),c=require("../Models/Sidemenu"),o=require("../Models/SliderNames"),l=require("../Models/FileNames"),r=require("../Models/Link"),d=require("../Models/MainPhoto"),u=require("../Models/History"),b=require("../Models/Submenu"),p=require("../Models/ChildSub"),k=require("../Models/PublishTime"),_=require("../API/constants/typeNews"),g=require("../API/constants/typeContentPage"),y=require("../API/userAPI/hasAccess"),{updateContent:m}=require("../API/childSubApi/update"),h=require("../API/sideMenuApi/getAllSideMenu"),f=require("../API/MainMenuApi/getAllMenu"),w=require("../API/getAllCategories"),C=require("../API/getAdminid"),P=require("../API/op_categories"),{ValidSession:S}=require("../API/Session/session"),{host:I,port:A}=require("../../settings.json"),{time:M}=require("console"),{HISTORY_WAR:q}=require("../API/constants/typeContentPage"),L=require("../API/userAPI/enabledIds"),T=require("../Models/ContentLinks");let O,W=!0;async function N(e,a){if(a){const n=t(a,"DD.MM.YYYY, HH:mm").valueOf();let i="active";if(n>=t().valueOf()){i="deffered";const a=await k.findOne({news_id:e.id}),s=t(n).startOf("minutes").valueOf();a?await k.findByIdAndUpdate(a.id,{timestamp:s}):await new k({timestamp:s,news_id:e.id}).save()}await s.findByIdAndUpdate(e.id,{date:t(n).toISOString(),public_status:i})}else await s.findByIdAndUpdate(e.id,{date:t().toISOString(),public_status:"active"})}module.exports.getEditor=async(t,n)=>{const c=await i.findById(C.getId(t));if(!(await y(c.id,P.CONTENT)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(c.id,"/main"),url_text:"Повернутися до Головного Меню",user:c.id});{const t=await y(c.id,P.PAGES),i=await y(c.id,P.NEWS),u=["historyWar","current"];let b="none",p="none",k="none",_="none",g="none",m="none",h="none",f="none",C="none",S="none",I="none",A="none",M="none",q="none",L="none",T="none",N="",U="",F="",H="",v="",x="";if(i&&(f="block",C="block",S="block",I="block",A="block",q="block",L="block"),t){const e=await y(c.id,"casual"),a=await y(c.id,"current"),t=await y(c.id,"contacts"),n=await y(c.id,"historyWar"),i=await y(c.id,"files"),s=await y(c.id,"commander"),o=[e,t,a,i,n,s].reduce((e,a)=>a?e+1:e,0);0===o?(N="checked",p="block",k="block",_="block",g="block",m="block",h="block"):1===o?(e&&(f="block",S="block",I="block",A="block",N="checked"),a&&(f="block",A="block",C="block",F="checked"),t&&(f="block",A="block",u.push("files","casual"),H="checked"),n&&(S="block",I="block",A="block",M="block",T="block",U="checked"),i&&(f="block",I="block",u.push("contacts","casual"),v="checked"),s&&(C="block",A="block",I="block",x="checked")):o>1&&(M="block",T="none",N="",U="",F="",H="",v="",e?(f="block",S="block",I="block",A="block",p="block",N="checked",a&&(_="block"),t&&(g="block"),n&&(k="block"),i&&(m="block"),s&&(h="block")):n?(S="block",I="block",A="block",k="block",T="block",U="checked",a&&(_="block"),t&&(g="block"),i&&(m="block"),s&&(h="block")):a?(f="block",A="block",C="block",_="block",F="checked",t&&(g="block"),i&&(m="block"),s&&(h="block")):t?(f="block",A="block",g="block",m="block",u.push("files","casual"),H="checked",i&&(m="block"),s&&(h="block")):i&&s&&(f="block",A="none",m="block",h="block",u.push("files"),x="checked"))}i&&t&&(b="block");const B={displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayContentPage:"none",displayHWLabel:T,displayTypes:b,displayLinksTab:f,displayMainPhotoTab:C,displaySliderTab:S,displayFilesTab:I,displayCPOtherTab:M,displayNewsCategoryTab:q,displayNewsOtherTab:L,displayWysiwyg:A,displayPageSubclassCPCasual:p,displayPageSubclassCPCurrent:_,displayPageSubclassCPContacts:g,displayPageSubclassCPHistoryWar:k,displayPageSubclassCPFiles:m,"displayPageSubclassCPСommander":h,pageSubclassCPCasualChecked:N,pageSubclassCPHistoryWarChecked:U,pageSubclassCPCurrentChecked:F,pageSubclassCPContactsChecked:H,pageSubclassCPFilesChecked:v,pageSubclassCPCommanderChecked:x,action:"create"},Y=await s.find().select({_id:0,anchor_label:1}).distinct("anchor_label");B.historyWarLabelsList=Y;const E=await r.find().select({_id:1,title_ua:2});B.usefulLinks={list:E,selectedIds:[]};const D=await s.find({page_type:"content_page",public_status:"active",page_subclass:{$nin:u}}).select({_id:1,page_title:2,page_subclass:3}).lean();if(B.usefulPages={list:D,selectedIds:[]},W){O=Date.now().toString();const t=a.join(__dirname,"../../uploads/images",O);e.mkdir(t,e=>{e&&console.error(e),W=!1})}else{const e=await d.findOne({base_url:"/images/".concat(O,"/")}).select({_id:0,name:1});if(e){const a="/images/".concat(O,"/middlesize/").concat(e.name);B.mainPhotoCurrent=a,B.displayMainPhotoCurrent="block"}else B.displayMainPhotoCurrent="none";const a=await o.findOne({base_url:"/images/".concat(O,"/")}).select({_id:1,names:2});if(a){const e=a.names.map(e=>({url:"/images/".concat(O,"/sliders/").concat(e),id:a.id,filename:e}));B.sliderCurrent=e,B.displaySliderCurrent="block"}else B.displaySliderCurrent="none";const t=await l.findOne({base_url:"/images/".concat(O,"/")}).select({_id:1,names:2});if(t){const e=t.names.map(e=>({id:t.id,filename:e}));B.filesCurrent=e,B.displayFilesCurrent="block"}else B.displayFilesCurrent="none"}B.folder_path="/images/".concat(O,"/"),B.content_folder=O,B.categories=await w(),B.userid=c.id,n.render("wysiwyg",B)}},module.exports.postNewContent=async(t,n)=>{const c=await i.findById(C.getId(t));if(await y(c.id,P.CONTENT)){const{page_title:i,description:o,content_folder:l,page_type:r,news_type:d,contentPage_type:b,generated_category_link:p,keywords:k,html_body:g,lang:y,time_to_publish:m,historyWarLinkLabel:h,historyWarLinkLabelNew:f}=t.body,w={content_baseUrl:"/images/".concat(l,"/"),content_folder:l,page_type:r,description:o,page_title:i,keywords:k,lang:y,html_body:g,user_id:c.id};if("news"===r)switch("no_change"!==p&&"unlink"!==p&&(w.generated_category_link=p),d){case"casual":w.page_subclass=_.CASUAL;break;case"main":w.page_subclass=_.MAIN;break;case"current":w.page_subclass=_.CURRENT}else if("content_page"===r)switch(w.public_status="deffered",w.page_subclass=b,b){case"historyWar":{let e;h?e=h.trim():f&&(e=f.trim()),e&&(w.anchor_label=e)}}const C=await new s(w).save();if("news"===r){await N(C,m);const t="<item>\n        <title>".concat(i,"</title>\n        <link>http://").concat(I,"</link>\n        <description>").concat(o,"</description>\n        <guid>").concat(Date.now(),"</guid>\n      </item>\n    </channel>\n  </rss>"),n=a.join(__dirname,"../..","public","rss.xml");e.readFile(n,(a,i)=>{if(a)throw a;const s=i.indexOf("</channel>");e.open(n,"r+",666,(a,n)=>{e.write(n,t,s,"utf-8",()=>{e.close(n)})})})}return W=!0,"news"===r?(await new u({type_content:"Новина",operation:"Додавання новини ".concat(i),user:c.login}).save(),n.redirect("news/1")):"content_page"===r?(await new u({type_content:"Cторінка",operation:"Додавання cторінки ".concat(i),user:c.login}).save(),n.redirect("pages/1")):n.redirect("main")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(c.id,"/main"),url_text:"Повернутися до Головного Меню",user:c.id})},module.exports.postEditedContent=async(e,a)=>{const t=await i.findById(C.getId(e)),{content_id:n,page_title:c,description:o,keywords:l,html_body:r,lang:d,time_to_publish:b,historyWarLinkLabel:p,historyWarLinkLabelNew:k,generated_category_link:_}=e.body,g=await s.findById(n);if(!g)return a.status(400).render("infopage",{info:"Некоректні дані. Даного запису не існує!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});{const e={description:o,page_title:c,keywords:l,lang:d,html_body:r};switch(g.page_type){case"news":"unlink"===_?e.generated_category_link=null:"no_change"!==_&&(e.generated_category_link=_),await N(g,b);try{await new u({type_content:"Новина",operation:"Редагування новини ".concat(c),user:t.login}).save()}catch(y){console.error(y)}break;case"content_page":switch(e.public_status="deffered",g.page_subclass){case"historyWar":{let a;p?a=p.trim():k&&(a=k.trim()),a&&(e.anchor_label=a)}}}if(await s.findByIdAndUpdate(n,e),"news"===g.page_type)return a.redirect("news/1");if("content_page"===g.page_type)return a.redirect("pages/1")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id})},module.exports.getEditContentForm=async(e,a)=>{const n=await i.findById(C.getId(e));if(!0===await S(e.session,n.id,a)){const i=await s.findById(e.params.id),c="none";let u="none",b="none",p="none",k="none",_="none",y="none",m="none",h="none",f="none",C="",P="",S="",M="",q="";switch(i.page_type){case"news":u="block",b="block",p="block",k="block",_="block",m="block",h="block";break;case"content_page":switch(i.page_subclass){case"casual":u="block",p="block",k="block",_="block",f="none";break;case"current":u="block",_="block",b="block",f="none";break;case"contacts":u="block",_="block",f="none";break;case"historyWar":p="block",k="block",_="block",y="block",f="block";break;case"files":u="block",k="block",f="none";break;case"commander":_="block",b="block",k="block"}}const L=t(i.date).format("DD.MM.YYYY, HH:mm"),O={folder_path:i.content_baseUrl,categories:await w(),userid:n.id,page_title:i.page_title,description:i.description,keywords:i.keywords,html_body:i.html_body,content_id:i.id,timeToPublish:L,displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayHWLabel:f,displayTypes:c,displayLinksTab:u,displayMainPhotoTab:b,displaySliderTab:p,displayFilesTab:k,displayWysiwyg:_,displayCPOtherTab:y,displayNewsCategoryTab:m,displayNewsOtherTab:h,pageSubclassCPCasualChecked:C,pageSubclassCPHistoryWarChecked:P,pageSubclassCPCurrentChecked:S,pageSubclassCPContactsChecked:M,pageSubclassCPFilesChecked:q,current_category:i.generated_category_link,current_page_subclass:i.page_subclass,action:"edit"},W=await s.find().select({_id:0,anchor_label:1}).distinct("anchor_label");O.historyWarLabelsList=W;const N=await r.find().select({_id:1,title_ua:2}),U=await T.findOne({base_url:i.content_baseUrl}).lean();let F,H;if(U){const{links:{contacts:e,pages:a,directLink:t}}=U;F=e||[],H=a||[],O.directLink=t}O.usefulLinks={list:N,selectedIds:F};const v=["historyWar","current"],x={page_type:"content_page",public_status:"active",_id:{$ne:i.id},page_subclass:{$nin:v}};if("content_page"===i.page_type)switch(i.page_subclass){case"contacts":v.push("files","casual");break;case"files":v.push("contacts","casual")}const B=await s.find(x).select({_id:1,page_title:2}).lean();O.usefulPages={list:B,selectedIds:H},"content_page"===i.page_type&&i.page_subclass===g.HISTORY_WAR&&(O.currentHistoryWarLinkLabel=i.anchor_label);const Y=await d.findOne({base_url:i.content_baseUrl}).select({_id:0,name:1});if(Y){const e="http://".concat(I,":").concat(A).concat(i.content_baseUrl,"middlesize/").concat(Y.name);O.mainPhotoCurrent=e,O.displayMainPhotoCurrent="block"}else O.displayMainPhotoCurrent="none";const E=await o.findOne({base_url:i.content_baseUrl}).select({_id:1,names:2});if(E){const e=E.names.map(e=>({url:"http://".concat(I,":").concat(A).concat(i.content_baseUrl,"sliders/").concat(e),id:E.id,filename:e}));O.sliderCurrent=e,O.displaySliderCurrent="block"}else O.displaySliderCurrent="none";const D=await l.findOne({base_url:i.content_baseUrl}).select({_id:1,names:2});if(D){const e=D.names.map(e=>({id:D.id,filename:e}));O.filesCurrent=e,O.displayFilesCurrent="block"}else O.displayFilesCurrent="none";return a.render("wysiwyg",O)}return null===await S(e.session,n.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})};