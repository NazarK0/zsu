"use strict";const e=require("fs"),a=require("path"),t=require("moment"),n=require("jimp"),s=require("../Models/User"),i=require("../Models/Content"),o=require("../Models/Sidemenu"),c=require("../Models/SliderNames"),l=require("../Models/FileNames"),r=require("../Models/Link"),d=require("../Models/MainPhoto"),b=require("../Models/History"),u=require("../Models/Submenu"),p=require("../Models/ChildSub"),k=require("../Models/PublishTime"),y=require("../API/constants/typeNews"),_=require("../API/constants/typeContentPage"),g=require("../API/userAPI/hasAccess"),{updateContent:h}=require("../API/childSubApi/update"),m=require("../API/sideMenuApi/getAllSideMenu"),w=require("../API/MainMenuApi/getAllMenu"),f=require("../API/getAllCategories"),C=require("../API/getAdminid"),P=require("../API/op_categories"),{ValidSession:L}=require("../API/Session/session"),{host:S,port:I}=require("../../settings.json"),{time:q}=require("console"),{HISTORY_WAR:M}=require("../API/constants/typeContentPage"),A=require("../API/userAPI/enabledIds"),T=require("../Models/ContentLinks");let W,F=!0;module.exports.getEditor=async(t,n)=>{const o=await s.findById(C.getId(t));if(!(await g(o.id,P.CONTENT)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});{const t=await g(o.id,P.PAGES),s=await g(o.id,P.NEWS),b=["history","historyWar","current"];let u="none",p="none",k="none",y="none",_="none",h="none",m="none",w="none",C="none",L="none",S="none",I="none",q="none",M="none",A="none",T="none",N="none",O="none",U="",x="",H="",D="",E="",B="",v="";if(s&&(C="block",L="block",S="block",I="block",q="block",A="block",T="block"),t){const e=await g(o.id,"casual"),a=await g(o.id,"current"),t=await g(o.id,"contacts"),n=await g(o.id,"historyWar"),s=await g(o.id,"history"),i=await g(o.id,"files"),c=await g(o.id,"commander"),l=[e,t,a,i,s,n,c].reduce((e,a)=>a?e+1:e,0);0===l?(U="checked",p="block",k="block",y="block",_="block",h="block",m="block",w="block"):1===l?(e&&(C="block",S="block",I="block",q="block",U="checked"),a&&(C="block",q="block",L="block",D="checked"),t&&(C="block",q="block",b.push("files","casual"),E="checked"),n&&(S="block",I="block",q="block",M="block",N="block",x="checked"),s&&(S="block",I="block",q="block",M="block",O="block",H="checked"),i&&(C="block",I="block",b.push("contacts","casual"),B="checked"),c&&(L="block",q="block",I="block",v="checked")):l>1&&(M="block",N="none",O="none",U="",x="",H="",D="",E="",B="",e?(C="block",S="block",I="block",q="block",p="block",U="checked",a&&(_="block"),t&&(h="block"),n&&(y="block"),s&&(k="block"),i&&(m="block"),c&&(w="block")):n?(S="block",I="block",q="block",y="block",N="block",x="checked",a&&(_="block"),t&&(h="block"),s&&(k="block"),i&&(m="block"),c&&(w="block")):s?(S="block",I="block",q="block",k="block",O="block",H="checked",a&&(_="block"),t&&(h="block"),i&&(m="block"),c&&(w="block")):a?(C="block",q="block",L="block",_="block",D="checked",t&&(h="block"),i&&(m="block"),c&&(w="block")):t?(C="block",q="block",h="block",m="block",b.push("files","casual"),E="checked",i&&(m="block"),c&&(w="block")):i&&c&&(C="block",q="none",m="block",w="block",b.push("files"),v="checked"))}s&&t&&(u="block");const K={displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayContentPage:"none",displayHWLabel:N,displayTypes:u,displayLinksTab:C,displayMainPhotoTab:L,displaySliderTab:S,displayFilesTab:I,displayCPOtherTab:M,displayNewsCategoryTab:A,displayNewsOtherTab:T,displayWysiwyg:q,displayPageSubclassCPCasual:p,displayPageSubclassCPCurrent:_,displayPageSubclassCPContacts:h,displayPageSubclassCPHistoryWar:y,displayPageSubclassCPHistory:k,displayPageSubclassCPFiles:m,"displayPageSubclassCPСommander":w,pageSubclassCPCasualChecked:U,pageSubclassCPHistoryChecked:H,pageSubclassCPHistoryWarChecked:x,pageSubclassCPCurrentChecked:D,pageSubclassCPContactsChecked:E,pageSubclassCPFilesChecked:B,pageSubclassCPCommanderChecked:v,action:"create"},Y=await i.find({page_subclass:"history"}).select({_id:0,anchor_label:1}).distinct("anchor_label");K.historyLabelsList=Y;const j=await i.find({page_subclass:"historyWar"}).select({_id:0,anchor_label:1}).distinct("anchor_label");K.historyWarLabelsList=j;const R=await r.find().select({_id:1,title_ua:2});K.usefulLinks={list:R,selectedIds:[]};const $=await i.find({page_type:"content_page",public_status:"active",page_subclass:{$nin:b}}).select({_id:1,page_title:2,page_subclass:3}).lean();if(K.usefulPages={list:$,selectedIds:[]},F){W=Date.now().toString();const t=a.join(__dirname,"../../uploads/images",W);e.mkdir(t,e=>{e&&console.error(e),F=!1})}else{const e=await d.findOne({base_url:"/images/".concat(W,"/")}).select({_id:0,name:1});if(e){const a="/images/".concat(W,"/middlesize/").concat(e.name);K.mainPhotoCurrent=a,K.displayMainPhotoCurrent="block"}else K.displayMainPhotoCurrent="none";const a=await c.findOne({base_url:"/images/".concat(W,"/")}).select({_id:1,names:2});if(a){const e=a.names.map(e=>({url:"/images/".concat(W,"/sliders/").concat(e),id:a.id,filename:e}));K.sliderCurrent=e,K.displaySliderCurrent="block"}else K.displaySliderCurrent="none";const t=await l.findOne({base_url:"/images/".concat(W,"/")}).select({_id:1,names:2});if(t){const e=t.names.map(e=>({id:t.id,filename:e}));K.filesCurrent=e,K.displayFilesCurrent="block"}else K.displayFilesCurrent="none"}K.folder_path="/images/".concat(W,"/"),K.content_folder=W,K.categories=await f(),K.userid=o.id,n.render("wysiwyg",K)}},module.exports.postNewContent=async(t,n)=>{const o=await s.findById(C.getId(t));if(await g(o.id,P.CONTENT)){const{page_title:s,description:c,content_folder:l,page_type:r,news_type:d,contentPage_type:u,categoryFK:p,keywords:k,html_body:_,lang:g,publishDate:h,historyLinkLabel:m,historyLinkLabelNew:w,historyWarLinkLabel:f,historyWarLinkLabelNew:C}=t.body,P={content_baseUrl:"/images/".concat(l,"/"),content_folder:l,page_type:r,description:c,page_title:s,keywords:k,lang:g,html_body:_,user_id:o.id};if("news"===r)switch("no_change"!==p&&"unlink"!==p&&(P.categoryFK=p),d){case"casual":P.page_subclass=y.CASUAL;break;case"main":P.page_subclass=y.MAIN;break;case"current":P.page_subclass=y.CURRENT}else if("content_page"===r)switch(P.public_status="deffered",P.page_subclass=u,u){case"history":{let e;m?e=m.trim():w&&(e=w.trim()),e&&(P.anchor_label=e)}break;case"historyWar":{let e;f?e=f.trim():C&&(e=C.trim()),e&&(P.anchor_label=e)}}const L=await new i(P).save();if("news"===r){await addToDeffered(L,h);const t="<item>\n        <title>".concat(s,"</title>\n        <link>http://").concat(S,"</link>\n        <description>").concat(c,"</description>\n        <guid>").concat(Date.now(),"</guid>\n      </item>\n    </channel>\n  </rss>"),n=a.join(__dirname,"../..","public","rss.xml");e.readFile(n,(a,s)=>{if(a)throw a;const i=s.indexOf("</channel>");e.open(n,"r+",666,(a,n)=>{e.write(n,t,i,"utf-8",()=>{e.close(n)})})})}return F=!0,"news"===r?(await new b({type_content:"Новина",operation:"Додавання новини ".concat(s),user:o.login}).save(),n.redirect("news/1")):"content_page"===r?(await new b({type_content:"Cторінка",operation:"Додавання cторінки ".concat(s),user:o.login}).save(),n.redirect("pages/1")):n.redirect("main")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.postEditedContent=async(e,a)=>{const t=await s.findById(C.getId(e)),{content_id:n,page_title:o,description:c,keywords:l,html_body:r,lang:d,publishDate:u,historyLinkLabel:p,historyLinkLabelNew:k,historyWarLinkLabel:y,historyWarLinkLabelNew:_,categoryFK:g}=e.body,h=await i.findById(n);if(!h)return a.status(400).render("infopage",{info:"Некоректні дані. Даного запису не існує!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});{const e={description:c,page_title:o,keywords:l,lang:d,html_body:r};switch(h.page_type){case"news":"unlink"===g?e.categoryFK=null:"no_change"!==g&&(e.categoryFK=g),await addToDeffered(h,u);try{await new b({type_content:"Новина",operation:"Редагування новини ".concat(o),user:t.login}).save()}catch(m){console.error(m)}break;case"content_page":switch(e.public_status="deffered",h.page_subclass){case"history":{let a;p?a=p.trim():k&&(a=k.trim()),a&&(e.anchor_label=a)}break;case"historyWar":{let a;y?a=y.trim():_&&(a=_.trim()),a&&(e.anchor_label=a)}}}if(await i.findByIdAndUpdate(n,e),"news"===h.page_type)return a.redirect("news/1");if("content_page"===h.page_type)return a.redirect("pages/1")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id})},module.exports.getEditContentForm=async(e,a)=>{const n=await s.findById(C.getId(e));if(!0===await L(e.session,n.id,a)){const s=await i.findById(e.params.id),o="none";let b="none",u="none",p="none",k="none",y="none",_="none",g="none",h="none",m="none",w="none";switch(s.page_type){case"news":b="block",u="block",p="block",k="block",y="block",g="block",h="block";break;case"content_page":switch(s.page_subclass){case"casual":b="block",p="block",k="block",y="block",w="none";break;case"current":b="block",y="block",u="block",w="none";break;case"contacts":b="block",y="block",w="none";break;case"history":p="block",k="block",y="block",_="block",m="block";break;case"files":b="block",k="block",w="none";break;case"commander":y="block",u="block",k="block"}}const C=t(s.date).format("DD.MM.YYYY, HH:mm"),P={folder_path:s.content_baseUrl,categories:await f(),userid:n.id,page_title:s.page_title,description:s.description,keywords:s.keywords,html_body:s.html_body,content_id:s.id,timeToPublish:C,displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayHWLabel:w,displayHistoryLabel:m,displayTypes:o,displayLinksTab:b,displayMainPhotoTab:u,displaySliderTab:p,displayFilesTab:k,displayWysiwyg:y,displayCPOtherTab:_,displayNewsCategoryTab:g,displayNewsOtherTab:h,current_category:s.categoryFK,current_page_subclass:s.page_subclass,action:"edit"},L=await i.find({page_subclass:"history"}).select({_id:0,anchor_label:1}).distinct("anchor_label");P.historyLabelsList=L;const q=await i.find({page_subclass:"historyWar"}).select({_id:0,anchor_label:1}).distinct("anchor_label");P.historyWarLabelsList=q;const M=await r.find().select({_id:1,title_ua:2}),A=await T.findOne({base_url:s.content_baseUrl}).lean();let W,F;if(A){const{links:{contacts:e,pages:a,directLink:t}}=A;W=e||[],F=a||[],P.directLink=t}P.usefulLinks={list:M,selectedIds:W};const N=["history","historyWar","current"],O={page_type:"content_page",public_status:"active",_id:{$ne:s.id},page_subclass:{$nin:N}};if("content_page"===s.page_type)switch(s.page_subclass){case"contacts":N.push("files","casual");break;case"files":N.push("contacts","casual")}const U=await i.find(O).select({_id:1,page_title:2}).lean();P.usefulPages={list:U,selectedIds:F},"content_page"===s.page_type&&"historyWar"===s.page_subclass&&(P.historyWarLinkLabel=s.anchor_label),"content_page"===s.page_type&&"history"===s.page_subclass&&(P.historyLinkLabel=s.anchor_label);const x=await d.findOne({base_url:s.content_baseUrl}).select({_id:0,name:1});if(x){const e="http://".concat(S,":").concat(I).concat(s.content_baseUrl,"middlesize/").concat(x.name);P.mainPhotoCurrent=e,P.displayMainPhotoCurrent="block"}else P.displayMainPhotoCurrent="none";const H=await c.findOne({base_url:s.content_baseUrl}).select({_id:1,names:2});if(H){const e=H.names.map(e=>({url:"http://".concat(S,":").concat(I).concat(s.content_baseUrl,"sliders/").concat(e),id:H.id,filename:e}));P.sliderCurrent=e,P.displaySliderCurrent="block"}else P.displaySliderCurrent="none";const D=await l.findOne({base_url:s.content_baseUrl}).select({_id:1,names:2});if(D){const e=D.names.map(e=>({id:D.id,filename:e}));P.filesCurrent=e,P.displayFilesCurrent="block"}else P.displayFilesCurrent="none";return a.render("wysiwyg",P)}return null===await L(e.session,n.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})};