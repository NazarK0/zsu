"use strict";const e=require("fs"),t=require("path"),a=require("moment"),n=require("../Models/User"),i=require("../Models/Content"),s=require("../Models/Sidemenu"),o=require("../Models/SliderNames"),l=require("../Models/FileNames"),c=require("../Models/Link"),r=require("../Models/MainPhoto"),d=require("../Models/History"),u=require("../Models/Submenu"),b=require("../Models/ChildSub"),p=require("../Models/PublishTime"),_=require("../API/constants/typeNews"),y=require("../API/constants/typeContentPage"),k=require("../API/userAPI/hasAccess"),{updateContent:g}=require("../API/childSubApi/update"),w=require("../API/sideMenuApi/getAllSideMenu"),f=require("../API/MainMenuApi/getAllMenu"),m=require("../API/getAllCategories"),h=require("../API/getAdminid"),C=require("../API/op_categories"),{ValidSession:P}=require("../API/Session/session"),{host:I,port:A}=require("../../settings.json"),{time:q}=require("console"),{HISTORY_WAR:M}=require("../API/constants/typeContentPage"),S=require("../API/userAPI/enabledIds"),T=require("../Models/ContentLinks");let L,O=!0;async function W(e,t){if(t){const n=a(t).startOf("minutes").valueOf(),s=await p.findOne({news_id:e.id});s?await p.findByIdAndUpdate(s.id,{timestamp:n}):await new p({timestamp:n,news_id:e.id}).save(),await i.findByIdAndUpdate(e.id,{date:t,public_status:"deffered"})}else e.date||await i.findByIdAndUpdate(e.id,{public_status:"active"})}module.exports.getEditor=async(a,s)=>{const d=await n.findById(h.getId(a));if(!(await k(d.id,C.CONTENT)))return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});{const a=await k(d.id,C.PAGES),n=await k(d.id,C.NEWS),u=["historyWar","current"];let b="none",p="none",_="none",y="none",g="none",w="none",f="none",h="none",P="none",I="none",A="none",q="none",M="none",S="none";if(n&&(f="block",h="block",P="block",I="block",A="block",M="block",S="block"),a){const e=await k(d.id,"casual"),t=await k(d.id,"current"),a=await k(d.id,"contacts"),n=await k(d.id,"historyWar"),i=await k(d.id,"files"),s=[e,a,t,i,n].reduce((e,t)=>t?e+1:e,0);0===s?(p="block",_="block",y="block",g="block",w="block"):1===s?(e&&(f="block",P="block",I="block",A="block"),t&&(f="block",A="block",h="block"),a&&(f="block",A="block",u.push("files","casual")),n&&(P="block",I="block",A="block",q="block"),i&&(f="block",I="block",u.push("contacts","casual"))):s>1&&(q="block",e?(f="block",P="block",I="block",A="block",p="block",t&&(y="block"),a&&(g="block"),n&&(_="block"),i&&(w="block")):n?(P="block",I="block",A="block",_="block",t&&(y="block"),a&&(g="block"),i&&(w="block")):t?(f="block",A="block",h="block",y="block",a&&(g="block"),i&&(w="block")):a&&i&&(f="block",A="block",g="block",w="block",u.push("files","casual")))}n&&a&&(b="block");const T={displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayContentPage:"none",displayTypes:b,displayLinksTab:f,displayMainPhotoTab:h,displaySliderTab:P,displayFilesTab:I,displayCPOtherTab:q,displayNewsCategoryTab:M,displayNewsOtherTab:S,displayWysiwyg:A,displayPageSubclassCPCasual:p,displayPageSubclassCPCurrent:y,displayPageSubclassCPContacts:g,displayPageSubclassCPHistoryWar:_,displayPageSubclassCPFiles:w,action:"create"},W=await i.find().select({_id:0,anchor_label:1}).distinct("anchor_label");T.historyWarLabelsList=W;const N=await c.find().select({_id:1,title_ua:2});T.usefulLinks={list:N,selectedIds:[]};const U=await i.find({page_type:"content_page",public_status:"active",page_subclass:{$nin:u}}).select({_id:1,page_title:2,page_subclass:3}).lean();if(T.usefulPages={list:U,selectedIds:[]},O){L=Date.now().toString();const a=t.join(__dirname,"../../uploads/images",L);e.mkdir(a,e=>{e&&console.error(e),O=!1})}else{const e=await r.findOne({base_url:"/images/".concat(L,"/")}).select({_id:0,name:1});if(e){const t="/images/".concat(L,"/middlesize/").concat(e.name);T.mainPhotoCurrent=t,T.displayMainPhotoCurrent="block"}else T.displayMainPhotoCurrent="none";const t=await o.findOne({base_url:"/images/".concat(L,"/")}).select({_id:1,names:2});if(t){const e=t.names.map(e=>({url:"/images/".concat(L,"/sliders/").concat(e),id:t.id,filename:e}));T.sliderCurrent=e,T.displaySliderCurrent="block"}else T.displaySliderCurrent="none";const a=await l.findOne({base_url:"/images/".concat(L,"/")}).select({_id:1,names:2});if(a){const e=a.names.map(e=>({id:a.id,filename:e}));T.filesCurrent=e,T.displayFilesCurrent="block"}else T.displayFilesCurrent="none"}T.folder_path="/images/".concat(L,"/"),T.content_folder=L,T.categories=await m(),T.userid=d.id,s.render("wysiwyg",T)}},module.exports.postNewContent=async(a,s)=>{const o=await n.findById(h.getId(a));if(await k(o.id,C.CONTENT)){const{page_title:n,description:l,content_folder:c,page_type:r,news_type:u,contentPage_type:b,generated_category_link:p,keywords:y,html_body:k,lang:g,time_to_publish:w,historyWarLinkLabel:f,historyWarLinkLabelNew:m}=a.body,h={content_baseUrl:"/images/".concat(c,"/"),content_folder:c,page_type:r,description:l,page_title:n,keywords:y,lang:g,html_body:k,user_id:o.id};if("news"===r)switch("no_change"!==p&&"unlink"!==p&&(h.generated_category_link=p),u){case"casual":h.page_subclass=_.CASUAL;break;case"main":h.page_subclass=_.MAIN;break;case"current":h.page_subclass=_.CURRENT}else if("content_page"===r)switch(h.public_status="deffered",h.page_subclass=b,b){case"historyWar":{let e;f?e=f.trim():m&&(e=m.trim()),e&&(h.anchor_label=e)}}const C=await new i(h).save();if("news"===r){await W(C,w);const a="<item>\n        <title>".concat(n,"</title>\n        <link>http://").concat(I,"</link>\n        <description>").concat(l,"</description>\n        <guid>").concat(Date.now(),"</guid>\n      </item>\n    </channel>\n  </rss>"),i=t.join(__dirname,"../..","public","rss.xml");e.readFile(i,(t,n)=>{if(t)throw t;const s=n.indexOf("</channel>");e.open(i,"r+",666,(t,n)=>{e.write(n,a,s,"utf-8",()=>{e.close(n)})})})}return O=!0,"news"===r?(await new d({type_content:"Новина",operation:"Додавання новини ".concat(n),user:o.login}).save(),s.redirect("news/1")):"content_page"===r?(await new d({type_content:"Cторінка",operation:"Додавання cторінки ".concat(n),user:o.login}).save(),s.redirect("pages/1")):s.redirect("main")}return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.postEditedContent=async(e,t)=>{const a=await n.findById(h.getId(e)),{content_id:s,page_title:o,description:l,keywords:c,html_body:r,lang:u,time_to_publish:b,historyWarLinkLabel:p,historyWarLinkLabelNew:_,generated_category_link:y}=e.body,k=await i.findById(s);if(!k)return t.status(400).render("infopage",{info:"Некоректні дані. Даного запису не існує!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const e={description:l,page_title:o,keywords:c,lang:u,html_body:r};switch(k.page_type){case"news":"unlink"===y?e.generated_category_link=null:"no_change"!==y&&(e.generated_category_link=y),await W(k,b);try{await new d({type_content:"Новина",operation:"Редагування новини ".concat(o),user:a.login}).save()}catch(g){console.error(g)}break;case"content_page":switch(e.public_status="deffered",k.page_subclass){case"historyWar":{let t;p?t=p.trim():_&&(t=_.trim()),t&&(e.anchor_label=t)}}}if(await i.findByIdAndUpdate(s,e),"news"===k.page_type)return t.redirect("news/1");if("content_page"===k.page_type)return t.redirect("pages/1")}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id})},module.exports.getEditContentForm=async(e,t)=>{const a=await n.findById(h.getId(e));if(!0===await P(e.session,a.id,t)){const n=await i.findById(e.params.id);let s="none",d="none",u="none",b="none",p="none",_="none",k="none",g="none",w="none";switch(n.page_type){case"news":d="block",u="block",b="block",p="block",_="block",g="block",w="block";break;case"content_page":switch(n.page_subclass){case"casual":d="block",b="block",p="block",_="block";break;case"current":d="block",_="block",u="block";break;case"contacts":d="block",_="block";break;case"historyWar":b="block",p="block",_="block",k="block";break;case"files":d="block",p="block"}}const f={folder_path:n.content_baseUrl,categories:await m(),userid:a.id,page_title:n.page_title,description:n.description,keywords:n.keywords,html_body:n.html_body,content_id:n.id,displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayTypes:s,displayLinksTab:d,displayMainPhotoTab:u,displaySliderTab:b,displayFilesTab:p,displayWysiwyg:_,displayCPOtherTab:k,displayNewsCategoryTab:g,displayNewsOtherTab:w,current_category:n.generated_category_link,current_page_subclass:n.page_subclass,action:"edit",timeToPublish:n.date},h=await i.find().select({_id:0,anchor_label:1}).distinct("anchor_label");f.historyWarLabelsList=h;const C=await c.find().select({_id:1,title_ua:2}),P=await T.findOne({base_url:n.content_baseUrl}).lean();let q,M;if(P){const{links:{contacts:e,pages:t,directLink:a}}=P;q=e||[],M=t||[],f.directLink=a}f.usefulLinks={list:C,selectedIds:q};const S=["historyWar","current"],L={page_type:"content_page",public_status:"active",_id:{$ne:n.id},page_subclass:{$nin:S}};if("content_page"===n.page_type)switch(n.page_subclass){case"contacts":S.push("files","casual");break;case"files":S.push("contacts","casual")}const O=await i.find(L).select({_id:1,page_title:2}).lean();f.usefulPages={list:O,selectedIds:M},"content_page"===n.page_type&&n.page_subclass===y.HISTORY_WAR&&(f.currentHistoryWarLinkLabel=n.anchor_label);const W=await r.findOne({base_url:n.content_baseUrl}).select({_id:0,name:1});if(W){const e="http://".concat(I,":").concat(A).concat(n.content_baseUrl,"middlesize/").concat(W.name);f.mainPhotoCurrent=e,f.displayMainPhotoCurrent="block"}else f.displayMainPhotoCurrent="none";const N=await o.findOne({base_url:n.content_baseUrl}).select({_id:1,names:2});if(N){const e=N.names.map(e=>({url:"http://".concat(I,":").concat(A).concat(n.content_baseUrl,"sliders/").concat(e),id:N.id,filename:e}));f.sliderCurrent=e,f.displaySliderCurrent="block"}else f.displaySliderCurrent="none";const U=await l.findOne({base_url:n.content_baseUrl}).select({_id:1,names:2});if(U){const e=U.names.map(e=>({id:U.id,filename:e}));f.filesCurrent=e,f.displayFilesCurrent="block"}else f.displayFilesCurrent="none";return t.render("wysiwyg",f)}return null===await P(e.session,a.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})};