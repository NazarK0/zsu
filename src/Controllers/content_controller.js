"use strict";const e=require("fs"),a=require("path"),t=require("moment"),n=require("../Models/User"),i=require("../Models/Content"),s=require("../Models/Sidemenu"),o=require("../Models/SliderNames"),c=require("../Models/FileNames"),l=require("../Models/Link"),r=require("../Models/MainPhoto"),d=require("../Models/History"),u=require("../Models/Submenu"),b=require("../Models/ChildSub"),p=require("../Models/PublishTime"),k=require("../API/constants/typeNews"),_=require("../API/constants/typeContentPage"),y=require("../API/userAPI/hasAccess"),{updateContent:g}=require("../API/childSubApi/update"),f=require("../API/sideMenuApi/getAllSideMenu"),h=require("../API/MainMenuApi/getAllMenu"),w=require("../API/getAllCategories"),m=require("../API/getAdminid"),C=require("../API/op_categories"),{ValidSession:P}=require("../API/Session/session"),{host:S,port:I}=require("../../settings.json"),{time:A}=require("console"),{HISTORY_WAR:M}=require("../API/constants/typeContentPage"),q=require("../API/userAPI/enabledIds"),L=require("../Models/ContentLinks");let T,O=!0;async function W(e,a){if(a){const n=t(a,"DD.MM.YYYY, HH:mm").valueOf();let s="active";if(n>=t().valueOf()){s="deffered";const a=await p.findOne({news_id:e.id}),i=t(n).startOf("minutes").valueOf();a?await p.findByIdAndUpdate(a.id,{timestamp:i}):await new p({timestamp:i,news_id:e.id}).save()}await i.findByIdAndUpdate(e.id,{date:t(n).toISOString(),public_status:s})}else await i.findByIdAndUpdate(e.id,{date:t().toISOString(),public_status:"active"})}module.exports.getEditor=async(t,s)=>{const d=await n.findById(m.getId(t));if(!(await y(d.id,C.CONTENT)))return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});{const t=await y(d.id,C.PAGES),n=await y(d.id,C.NEWS),u=["historyWar","current"];let b="none",p="none",k="none",_="none",g="none",f="none",h="none",m="none",P="none",S="none",I="none",A="none",M="none",q="none",L="none",W="",N="",U="",F="",H="";if(n&&(h="block",m="block",P="block",S="block",I="block",M="block",q="block"),t){const e=await y(d.id,"casual"),a=await y(d.id,"current"),t=await y(d.id,"contacts"),n=await y(d.id,"historyWar"),i=await y(d.id,"files"),s=[e,t,a,i,n].reduce((e,a)=>a?e+1:e,0);0===s?(W="checked",p="block",k="block",_="block",g="block",f="block"):1===s?(e&&(h="block",P="block",S="block",I="block",W="checked"),a&&(h="block",I="block",m="block",U="checked"),t&&(h="block",I="block",u.push("files","casual"),F="checked"),n&&(P="block",S="block",I="block",A="block",L="block",N="checked"),i&&(h="block",S="block",u.push("contacts","casual"),H="checked")):s>1&&(A="block",L="none",W="",N="",U="",F="",H="",e?(h="block",P="block",S="block",I="block",p="block",W="checked",a&&(_="block"),t&&(g="block"),n&&(k="block"),i&&(f="block")):n?(P="block",S="block",I="block",k="block",L="block",N="checked",a&&(_="block"),t&&(g="block"),i&&(f="block")):a?(h="block",I="block",m="block",_="block",U="checked",t&&(g="block"),i&&(f="block")):t&&i&&(h="block",I="block",g="block",f="block",u.push("files","casual"),F="checked"))}n&&t&&(b="block");const v={displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayContentPage:"none",displayHWLabel:L,displayTypes:b,displayLinksTab:h,displayMainPhotoTab:m,displaySliderTab:P,displayFilesTab:S,displayCPOtherTab:A,displayNewsCategoryTab:M,displayNewsOtherTab:q,displayWysiwyg:I,displayPageSubclassCPCasual:p,displayPageSubclassCPCurrent:_,displayPageSubclassCPContacts:g,displayPageSubclassCPHistoryWar:k,displayPageSubclassCPFiles:f,pageSubclassCPCasualChecked:W,pageSubclassCPHistoryWarChecked:N,pageSubclassCPCurrentChecked:U,pageSubclassCPContactsChecked:F,pageSubclassCPFilesChecked:H,action:"create"},x=await i.find().select({_id:0,anchor_label:1}).distinct("anchor_label");v.historyWarLabelsList=x;const B=await l.find().select({_id:1,title_ua:2});v.usefulLinks={list:B,selectedIds:[]};const Y=await i.find({page_type:"content_page",public_status:"active",page_subclass:{$nin:u}}).select({_id:1,page_title:2,page_subclass:3}).lean();if(v.usefulPages={list:Y,selectedIds:[]},O){T=Date.now().toString();const t=a.join(__dirname,"../../uploads/images",T);e.mkdir(t,e=>{e&&console.error(e),O=!1})}else{const e=await r.findOne({base_url:"/images/".concat(T,"/")}).select({_id:0,name:1});if(e){const a="/images/".concat(T,"/middlesize/").concat(e.name);v.mainPhotoCurrent=a,v.displayMainPhotoCurrent="block"}else v.displayMainPhotoCurrent="none";const a=await o.findOne({base_url:"/images/".concat(T,"/")}).select({_id:1,names:2});if(a){const e=a.names.map(e=>({url:"/images/".concat(T,"/sliders/").concat(e),id:a.id,filename:e}));v.sliderCurrent=e,v.displaySliderCurrent="block"}else v.displaySliderCurrent="none";const t=await c.findOne({base_url:"/images/".concat(T,"/")}).select({_id:1,names:2});if(t){const e=t.names.map(e=>({id:t.id,filename:e}));v.filesCurrent=e,v.displayFilesCurrent="block"}else v.displayFilesCurrent="none"}v.folder_path="/images/".concat(T,"/"),v.content_folder=T,v.categories=await w(),v.userid=d.id,s.render("wysiwyg",v)}},module.exports.postNewContent=async(t,s)=>{const o=await n.findById(m.getId(t));if(await y(o.id,C.CONTENT)){const{page_title:n,description:c,content_folder:l,page_type:r,news_type:u,contentPage_type:b,generated_category_link:p,keywords:_,html_body:y,lang:g,time_to_publish:f,historyWarLinkLabel:h,historyWarLinkLabelNew:w}=t.body,m={content_baseUrl:"/images/".concat(l,"/"),content_folder:l,page_type:r,description:c,page_title:n,keywords:_,lang:g,html_body:y,user_id:o.id};if("news"===r)switch("no_change"!==p&&"unlink"!==p&&(m.generated_category_link=p),u){case"casual":m.page_subclass=k.CASUAL;break;case"main":m.page_subclass=k.MAIN;break;case"current":m.page_subclass=k.CURRENT}else if("content_page"===r)switch(m.public_status="deffered",m.page_subclass=b,b){case"historyWar":{let e;h?e=h.trim():w&&(e=w.trim()),e&&(m.anchor_label=e)}}const C=await new i(m).save();if("news"===r){await W(C,f);const t="<item>\n        <title>".concat(n,"</title>\n        <link>http://").concat(S,"</link>\n        <description>").concat(c,"</description>\n        <guid>").concat(Date.now(),"</guid>\n      </item>\n    </channel>\n  </rss>"),i=a.join(__dirname,"../..","public","rss.xml");e.readFile(i,(a,n)=>{if(a)throw a;const s=n.indexOf("</channel>");e.open(i,"r+",666,(a,n)=>{e.write(n,t,s,"utf-8",()=>{e.close(n)})})})}return O=!0,"news"===r?(await new d({type_content:"Новина",operation:"Додавання новини ".concat(n),user:o.login}).save(),s.redirect("news/1")):"content_page"===r?(await new d({type_content:"Cторінка",operation:"Додавання cторінки ".concat(n),user:o.login}).save(),s.redirect("pages/1")):s.redirect("main")}return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.postEditedContent=async(e,a)=>{const t=await n.findById(m.getId(e)),{content_id:s,page_title:o,description:c,keywords:l,html_body:r,lang:u,time_to_publish:b,historyWarLinkLabel:p,historyWarLinkLabelNew:k,generated_category_link:_}=e.body,y=await i.findById(s);if(!y)return a.status(400).render("infopage",{info:"Некоректні дані. Даного запису не існує!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});{const e={description:c,page_title:o,keywords:l,lang:u,html_body:r};switch(y.page_type){case"news":"unlink"===_?e.generated_category_link=null:"no_change"!==_&&(e.generated_category_link=_),await W(y,b);try{await new d({type_content:"Новина",operation:"Редагування новини ".concat(o),user:t.login}).save()}catch(g){console.error(g)}break;case"content_page":switch(e.public_status="deffered",y.page_subclass){case"historyWar":{let a;p?a=p.trim():k&&(a=k.trim()),a&&(e.anchor_label=a)}}}if(await i.findByIdAndUpdate(s,e),"news"===y.page_type)return a.redirect("news/1");if("content_page"===y.page_type)return a.redirect("pages/1")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id})},module.exports.getEditContentForm=async(e,a)=>{const s=await n.findById(m.getId(e));if(!0===await P(e.session,s.id,a)){const n=await i.findById(e.params.id),d="none";let u="none",b="none",p="none",k="none",y="none",g="none",f="none",h="none",m="none",C="",P="",A="",M="",q="";switch(n.page_type){case"news":u="block",b="block",p="block",k="block",y="block",f="block",h="block";break;case"content_page":switch(n.page_subclass){case"casual":u="block",p="block",k="block",y="block",m="none";break;case"current":u="block",y="block",b="block",m="none";break;case"contacts":u="block",y="block",m="none";break;case"historyWar":p="block",k="block",y="block",g="block",m="block";break;case"files":u="block",k="block",m="none"}}const T=t(n.date).format("DD.MM.YYYY, HH:mm"),O={folder_path:n.content_baseUrl,categories:await w(),userid:s.id,page_title:n.page_title,description:n.description,keywords:n.keywords,html_body:n.html_body,content_id:n.id,timeToPublish:T,displayMainPhotoCurrent:"none",displaySliderCurrent:"none",displayFilesCurrent:"none",displayHWLabel:m,displayTypes:d,displayLinksTab:u,displayMainPhotoTab:b,displaySliderTab:p,displayFilesTab:k,displayWysiwyg:y,displayCPOtherTab:g,displayNewsCategoryTab:f,displayNewsOtherTab:h,pageSubclassCPCasualChecked:C,pageSubclassCPHistoryWarChecked:P,pageSubclassCPCurrentChecked:A,pageSubclassCPContactsChecked:M,pageSubclassCPFilesChecked:q,current_category:n.generated_category_link,current_page_subclass:n.page_subclass,action:"edit"},W=await i.find().select({_id:0,anchor_label:1}).distinct("anchor_label");O.historyWarLabelsList=W;const N=await l.find().select({_id:1,title_ua:2}),U=await L.findOne({base_url:n.content_baseUrl}).lean();let F,H;if(U){const{links:{contacts:e,pages:a,directLink:t}}=U;F=e||[],H=a||[],O.directLink=t}O.usefulLinks={list:N,selectedIds:F};const v=["historyWar","current"],x={page_type:"content_page",public_status:"active",_id:{$ne:n.id},page_subclass:{$nin:v}};if("content_page"===n.page_type)switch(n.page_subclass){case"contacts":v.push("files","casual");break;case"files":v.push("contacts","casual")}const B=await i.find(x).select({_id:1,page_title:2}).lean();O.usefulPages={list:B,selectedIds:H},"content_page"===n.page_type&&n.page_subclass===_.HISTORY_WAR&&(O.currentHistoryWarLinkLabel=n.anchor_label);const Y=await r.findOne({base_url:n.content_baseUrl}).select({_id:0,name:1});if(Y){const e="http://".concat(S,":").concat(I).concat(n.content_baseUrl,"middlesize/").concat(Y.name);O.mainPhotoCurrent=e,O.displayMainPhotoCurrent="block"}else O.displayMainPhotoCurrent="none";const E=await o.findOne({base_url:n.content_baseUrl}).select({_id:1,names:2});if(E){const e=E.names.map(e=>({url:"http://".concat(S,":").concat(I).concat(n.content_baseUrl,"sliders/").concat(e),id:E.id,filename:e}));O.sliderCurrent=e,O.displaySliderCurrent="block"}else O.displaySliderCurrent="none";const D=await c.findOne({base_url:n.content_baseUrl}).select({_id:1,names:2});if(D){const e=D.names.map(e=>({id:D.id,filename:e}));O.filesCurrent=e,O.displayFilesCurrent="block"}else O.displayFilesCurrent="none";return a.render("wysiwyg",O)}return null===await P(e.session,s.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})};