"use strict";const e=require("../Models/Sidemenu"),t=require("../Models/Content"),i=require("../Models/User"),n=require("../Models/History"),d=require("../API/getAdminid"),a=require("../API/op_categories"),r=require("../API/Converter"),{ValidSession:s}=require("../API/Session/session"),o=require("../API/userAPI/hasAccess");module.exports.getSidemenuList=async(t,n)=>{const l=await i.findById(d.getId(t));if(!0===await s(t.session,l.id,n)){if(!(await o(l.id,a.SIDEMENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${l.id}/main`,url_text:"Повернутися до Головного Меню",user:l.id});try{const i=await e.find();let{page:d}=t.params;const a=l.settings.recordsPerPage.sidemenu,s=Math.ceil(i.length/a);(d<1||d>s)&&(d=1);const o=i.slice(a*(d-1),d*a);return n.render("main_menu_side",{user:l.id,sidemenu:await r.getSidemenuConverted(o),pages:s,current_page:d})}catch(u){console.error(u)}}return null===await s(t.session,l.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:l.id})},module.exports.getEditSidemenu=async(n,r)=>{const l=await i.findById(d.getId(n));if(!0===await s(n.session,l.id,r)){if(!(await o(l.id,a.SIDEMENU)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${l.id}/main`,url_text:"Повернутися до Головного Меню",user:l.id});{const{id:i}=n.params;try{const{title:n,content_id:d}=await e.findById(i),a=await t.find().where({page_type:"content_page"}).select({_id:1,page_title:2,lang:3});let s;try{s=a.filter(e=>e.id===d)}catch(u){s=[]}return r.status(200).render("edit_side",{action_type:"edit/"+i,content_page_list:a,title:n,content_title:s?s.page_title:"Відсутній",userid:l.id,parameter:"visible",id:i})}catch(c){console.error(c)}}}return null===await s(n.session,l.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:l.id})},module.exports.postEditedSidemenu=async(r,l)=>{const u=await i.findById(d.getId(r));if(!0===await s(r.session,u.id,l)){if(!(await o(u.id,a.SIDEMENU)))return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id});{const{title:i,content_id:d,lang:a}=r.body;let s;try{if("null"!==d&&"unlink"!==d&&d)await e.updateMany({content_id:d},{content_id:null}),await t.findByIdAndUpdate(d,{generated_sidemenu_link:r.params.id}),s=await e.findByIdAndUpdate(r.params.id,{title:i,content_id:d,lang:a,user_id:u.id});else if("unlink"===d){const i=await e.findById(r.params.id);s=await e.findByIdAndUpdate(i.id,{content_id:null}),"null"!==i.content_id&&i.content_id&&await t.findByIdAndUpdate(i.content_id,{generated_sidemenu_link:null})}else s=await e.findByIdAndUpdate(r.params.id,{title:i,lang:a,user_id:u.id});const o=new n({type_content:"Бокове Меню",operation:"Редагування Бокового Меню "+i,user:u.login});return await o.save(),d!==s.content_id&&"null"!==d&&await t.findByIdAndUpdate(s.content_id,{generated_sidemenu_link:null}),l.status(200).redirect("../1")}catch(c){console.error(c)}}}return null===await s(r.session,u.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.deleteSidemenu=async(r,l)=>{const u=await i.findById(d.getId(r));if(!0===await s(r.session,u.id,l)){if(!(await o(u.id,a.SIDEMENU)))return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id});{const{id:i}=r.params;try{const d=await e.findByIdAndDelete(i);"null"!==d.content_id&&d.content_id&&await t.findByIdAndUpdate(d.content_id,{generated_sidemenu_link:null});const a=new n({type_content:"Бокове Меню",operation:"Видалення пункту Бокового Меню "+d.title,user:u.login});return await a.save(),l.status(200).redirect("../1")}catch(c){console.error(c)}}}return null===await s(r.session,u.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getAddSidemenu=async(e,n)=>{const r=await i.findById(d.getId(e));if(!0===await s(e.session,r.id,n)){if(await o(r.id,a.SIDEMENU)){const e=await t.find({page_type:"content_page"}).select({_id:1,page_title:2,lang:3});return n.status(200).render("edit_side",{action_type:"add",content_page_list:e,userid:r.id,parameter:"hidden"})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id})}return null===await s(e.session,r.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.postAddedSidemenu=async(r,s)=>{const l=await i.findById(d.getId(r));if(!(await o(l.id,a.SIDEMENU)))return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${l.id}/main`,url_text:"Повернутися до Головного Меню",user:l.id});{const{title:i,content_id:a,lang:o}=r.body;let c;"null"!==a&&"unlink"!==a&&a?(await e.updateMany({content_id:a},{content_id:null}),c=new e({title:i,content_id:a,lang:o,user_id:d.getId(r)})):c=new e({title:i,lang:o,content_id:null,user_id:d.getId(r)});try{await c.save(),"null"!==a&&"unlink"!==a&&a&&await t.findByIdAndUpdate(a,{generated_sidemenu_link:c.id});const e=new n({type_content:"Бокове Меню",operation:"Додавання пункту Бокового Меню "+i,user:l.login});return await e.save(),s.status(200).redirect("./1")}catch(u){console.error(u)}}};