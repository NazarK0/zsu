"use strict";const e=require("../Models/Sidemenu"),t=require("../Models/Content"),n=require("../Models/User"),i=require("../Models/History"),d=require("../API/getAdminid"),a=require("../API/op_categories"),r=require("../API/Converter"),{ValidSession:s}=require("../API/Session/session"),o=require("../API/userAPI/hasAccess");module.exports.getSidemenuList=async(t,i)=>{const l=await n.findById(d.getId(t));if(!0===await s(t.session,l.id,i)){if(!(await o(l.id,a.SIDEMENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id});try{const n=await e.find();let{page:d}=t.params;const a=l.settings.recordsPerPage.sidemenu,s=Math.ceil(n.length/a);(d<1||d>s)&&(d=1);const o=n.slice(a*(d-1),d*a);return i.render("main_menu_side",{user:l.id,sidemenu:await r.getSidemenuConverted(o),pages:s,current_page:d})}catch(u){console.error(u)}}return null===await s(t.session,l.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:l.id})},module.exports.getEditSidemenu=async(i,r)=>{const l=await n.findById(d.getId(i));if(!0===await s(i.session,l.id,r)){if(!(await o(l.id,a.SIDEMENU)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id});{const{id:n}=i.params;try{const{title:i,content_id:d}=await e.findById(n),a=await t.find().where({page_type:"content_page"}).select({_id:1,page_title:2,lang:3});let s;try{s=a.filter(e=>e.id===d)}catch(u){s=[]}return r.status(200).render("edit_side",{action_type:"edit/".concat(n),content_page_list:a,title:i,content_title:s?s.page_title:"Відсутній",userid:l.id,parameter:"visible",id:n})}catch(c){console.error(c)}}}return null===await s(i.session,l.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:l.id})},module.exports.postEditedSidemenu=async(r,l)=>{const u=await n.findById(d.getId(r));if(!0===await s(r.session,u.id,l)){if(!(await o(u.id,a.SIDEMENU)))return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id});{const{title:n,content_id:d,lang:a}=r.body;let s;try{if("null"!==d&&"unlink"!==d&&d)await e.updateMany({content_id:d},{content_id:null}),await t.findByIdAndUpdate(d,{generated_sidemenu_link:r.params.id}),s=await e.findByIdAndUpdate(r.params.id,{title:n,content_id:d,lang:a,user_id:u.id});else if("unlink"===d){const n=await e.findById(r.params.id);s=await e.findByIdAndUpdate(n.id,{content_id:null}),"null"!==n.content_id&&n.content_id&&await t.findByIdAndUpdate(n.content_id,{generated_sidemenu_link:null})}else s=await e.findByIdAndUpdate(r.params.id,{title:n,lang:a,user_id:u.id});const o=new i({type_content:"Бокове Меню",operation:"Редагування Бокового Меню ".concat(n),user:u.login});return await o.save(),d!==s.content_id&&"null"!==d&&await t.findByIdAndUpdate(s.content_id,{generated_sidemenu_link:null}),l.status(200).redirect("../1")}catch(c){console.error(c)}}}return null===await s(r.session,u.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.deleteSidemenu=async(r,l)=>{const u=await n.findById(d.getId(r));if(!0===await s(r.session,u.id,l)){if(!(await o(u.id,a.SIDEMENU)))return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id});{const{id:n}=r.params;try{const d=await e.findByIdAndDelete(n);"null"!==d.content_id&&d.content_id&&await t.findByIdAndUpdate(d.content_id,{generated_sidemenu_link:null});const a=new i({type_content:"Бокове Меню",operation:"Видалення пункту Бокового Меню ".concat(d.title),user:u.login});return await a.save(),l.status(200).redirect("../1")}catch(c){console.error(c)}}}return null===await s(r.session,u.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getAddSidemenu=async(e,i)=>{const r=await n.findById(d.getId(e));if(!0===await s(e.session,r.id,i)){if(await o(r.id,a.SIDEMENU)){const e=await t.find({page_type:"content_page"}).select({_id:1,page_title:2,lang:3});return i.status(200).render("edit_side",{action_type:"add",content_page_list:e,userid:r.id,parameter:"hidden"})}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id})}return null===await s(e.session,r.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.postAddedSidemenu=async(r,s)=>{const l=await n.findById(d.getId(r));if(!(await o(l.id,a.SIDEMENU)))return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id});{const{title:n,content_id:a,lang:o}=r.body;let c;"null"!==a&&"unlink"!==a&&a?(await e.updateMany({content_id:a},{content_id:null}),c=new e({title:n,content_id:a,lang:o,user_id:d.getId(r)})):c=new e({title:n,lang:o,content_id:null,user_id:d.getId(r)});try{await c.save(),"null"!==a&&"unlink"!==a&&a&&await t.findByIdAndUpdate(a,{generated_sidemenu_link:c.id});const e=new i({type_content:"Бокове Меню",operation:"Додавання пункту Бокового Меню ".concat(n),user:l.login});return await e.save(),s.status(200).redirect("./1")}catch(u){console.error(u)}}};