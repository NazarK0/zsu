"use strict";const e=require("fs"),t=require("path"),i=require("moment"),n=require("../Models/News"),a=require("../Models/Page"),s=require("../Models/History"),r=require("../API/getAdminid"),d=require("../API/op_categories"),o=require("../API/display/news"),c=require("../Models/User"),{ValidSession:l}=require("../API/Session/session"),u=require("../API/constants/typeNews"),w=require("../API/userAPI/hasAccess"),p=require("../API/userAPI/enabledIds"),{publishNews:g,cancelPublishNews:y}=require("../API/Content/publishOperation"),m=require("../API/news/addToDeffered"),{host:f}=require("../../settings.json"),_=require("../API/getAllCategories"),I=require("../API/deleteNewsTrash");module.exports.getCreateNews=async(e,t)=>{const i=await c.findById(r.getId(e));if(!(await w(i.id,d.NEWS)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const e={mode:"add"},n=await a.find({public_status:"active",isMain:!0}).select({_id:1,title:2,language:3,type:4}).lean();e.pages={list:n,selectedIds:[]},e.categories={list:await _("news")},e.userid=i.id,t.render("wysiwygNews",e)}},module.exports.postCreatedNews=async(i,a)=>{const o=await c.findById(r.getId(i));if(await w(o.id,d.NEWS)){const{title:r,description:d,type:c,categoryFK:l,keywords:w,html_body:p,language:g,publishDate:y}=i.body;let _,{newsId:I}=i.body;const h={type:c,description:d,title:r,keywords:w,language:g,html_body:p,user_id:o.id};switch("no_change"!==l&&"unlink"!==l&&(h.categoryFK=l),c){case"casual":h.type=u.CASUAL;break;case"main":h.type=u.MAIN}I?(_=await n.findByIdAndUpdate(I,h),await m(I,y)):(_=await new n(h).save(),await m(_.id,y),I=_.id);const A="  <item>\n      <title>\n        <![CDATA[".concat(r,"]]>\n      </title>\n      <description>\n        <![CDATA[").concat(d,"]]>\n      </description>\n      <category>Новини</category>\n      <link>https://").concat(f,"/content_page/").concat(I,"</link>\n      <pubDate>").concat(_.publishDate,"</pubDate>\n      <fulltext>\n        <![CDATA[").concat(_.html_body,"]]>\n      </fulltext>\n      <guid>").concat(Date.now(),"</guid>\n    </item>\n  </channel>\n</rss>"),b=t.join(__dirname,"../..","public","rss.xml");return e.readFile(b,(t,i)=>{if(t)throw t;const n=i.indexOf("</channel>");e.open(b,"r+",666,(t,i)=>{e.write(i,A,n,"utf-8",()=>{e.close(i)})})}),await new s({type_content:"Новина",operation:"Додавання новини ".concat(r),user:o.login}).save(),a.redirect("1")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.getEditNews=async(e,t)=>{const s=await c.findById(r.getId(e));if(!0===await l(e.session,s.id,t)){const{id:r}=e.params,d=await n.findById(r),o=i(d.publishDate).format("DD.MM.YYYY, HH:mm"),c={categories:{list:await _("news"),selectedId:d.categoryFK},userid:s.id,title:d.title,description:d.description,keywords:d.keywords,type:d.type,html_body:d.html_body,newsId:d.id,publishDate:o,sliderCurrent:d.slider,filesCurrent:d.files,mode:"edit"};d.mainPhoto&&(c.mainPhotoCurrent="/image/".concat(d.mainPhoto,"?height=200&width=300"));const l=await a.find({public_status:"active",isMain:!0}).select({_id:1,title:2,language:3,type:4}).lean();return c.linkPages={list:l,selectedIds:d.links},t.render("wysiwygNews",c)}return null===await l(e.session,s.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})},module.exports.postEditedNews=async(i,a)=>{const o=await c.findById(r.getId(i));if(await w(o.id,d.NEWS)){const{id:r}=i.params,{title:d,description:c,categoryFK:l,keywords:u,html_body:w,language:p,publishDate:g}=i.body,y={description:c,title:d,keywords:u,language:p,html_body:w,user_id:o.id};"unlink"===l?y.categoryFK=null:"no_change"!==l&&(y.categoryFK=l),await n.findByIdAndUpdate(r,y),await m(r,g);const _="<item>\n      <title>".concat(d,"</title>\n      <link>https://").concat(f,"</link>\n      <description>").concat(c,"</description>\n      <guid>").concat(Date.now(),"</guid>\n    </item>\n  </channel>\n</rss>"),I=t.join(__dirname,"../..","public","rss.xml");return e.readFile(I,(t,i)=>{if(t)throw t;const n=i.indexOf("</channel>");e.open(I,"r+",666,(t,i)=>{e.write(i,_,n,"utf-8",()=>{e.close(i)})})}),await new s({type_content:"Новина",operation:"Редагування новини ".concat(d),user:o.login}).save(),a.redirect("../1")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.postCancelPublicNews=async(e,t)=>{const i=r.getId(e),n=await c.findById(i);try{const i=await y(e.params.id_news);return await new s({type_content:"Новини",operation:"Скасування публікації Новини:  ".concat(i),user:n.login}).save(),t.redirect("../news/1")}catch(a){console.error(a)}},module.exports.postPublicNews=async(e,t)=>{const i=r.getId(e),n=await c.findById(i);try{const a=await g(e.params.id_news);return await new s({type_content:"Новини",operation:" Публікація Новини:  ".concat(a),user:n.login}).save(),t.redirect("/admin/".concat(i,"/news-cancel/1"))}catch(a){console.error(a)}},module.exports.getAllCancelNews=async(e,t)=>{const i=await c.findById(r.getId(e));if(!0===await l(e.session,i.id,t)){if(await w(i.id,d.NEWS)){let n;await I();const a=await p(i.id,d.NEWS),s=await o(a,["cancel","deffered"]);n="system_user"===i.type;const c=[{value:u.ALL,id:"all"},{value:u.CASUAL,id:"casual"},{value:u.MAIN,id:"main"}];return t.render("main_cancel_news",{status:n,user:r.getId(e),news:s,news_type_constant:c,current_page:1})}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id})}return null===await l(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.getAllNews=async(e,t)=>{const i=await c.findById(r.getId(e));if(!0===await l(e.session,i.id,t)){if(!(await w(i.id,d.NEWS)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const a=[{value:u.ALL,id:"all"},{value:u.CASUAL,id:"casual"},{value:u.MAIN,id:"main"}];await I();try{let n;const s=await p(i.id,d.NEWS),c=await o(s,"active");return c.reverse(),n="system_user"===i.type,t.render("main_menu_news",{status:n,news_type_constant:a,user:r.getId(e),news:c,current_page:1})}catch(n){console.error(n)}}}return null===await l(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.deleteNews=async(e,t)=>{const i=await c.findById(r.getId(e));if(!0===await l(e.session,i.id,t)){if(await w(i.id,d.NEWS)){const a=await n.findByIdAndDelete(e.params.id);return await new s({type_content:"Новини",operation:"Видалення Новини:  ".concat(a.title),user:i.login}).save(),t.redirect("../1")}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id})}return null===await l(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})};