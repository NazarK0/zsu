"use strict";const e=require("fs"),t=require("path"),i=require("moment"),{Feed:a}=require("feed"),n=require("../Models/News"),s=require("../Models/Page"),r=require("../Models/History"),d=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/display/news"),l=require("../Models/User"),{ValidSession:c}=require("../API/Session/session"),w=require("../API/constants/typeNews"),p=require("../API/userAPI/hasAccess"),g=require("../API/userAPI/enabledIds"),{publishNews:y,cancelPublishNews:m}=require("../API/Content/publishOperation"),f=require("../API/news/addToDeffered"),{host:I,rssMaxFeeds:_}=require("../../settings.json"),{updateRss:A}=require("../API/rss"),h=require("../API/getAllCategories"),N=require("../API/deleteNewsTrash");module.exports.getCreateNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(!(await p(i.id,o.NEWS)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const e={mode:"add"},a=await s.find({public_status:"active",isMain:!0}).select({_id:1,title:2,language:3,type:4}).lean();e.pages={list:a,selectedIds:[]},e.categories={list:await h("news")},e.userid=i.id,t.render("wysiwygNews",e)}},module.exports.postCreatedNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(await p(i.id,o.NEWS)){const{title:a,description:s,type:d,categoryFK:o,keywords:u,html_body:l,language:c,publishDate:p}=e.body;let{newsId:g}=e.body;const y={type:d,description:s,title:a,keywords:u,language:c,html_body:l,user_id:i.id};switch("no_change"!==o&&"unlink"!==o&&(y.categoryFK=o),d){case"casual":y.type=w.CASUAL;break;case"main":y.type=w.MAIN}if(g)await n.findByIdAndUpdate(g,y),await f(g,p);else{const e=await new n(y).save();await f(e.id,p),g=e.id}return await A(),await new r({type_content:"Новина",operation:"Додавання новини ".concat(a),user:i.login}).save(),t.redirect("1")}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.getEditNews=async(e,t)=>{const a=await l.findById(d.getId(e));if(!0===await c(e.session,a.id,t)){const{id:r}=e.params,d=await n.findById(r),o=i(d.publishDate).format("DD.MM.YYYY, HH:mm"),u={categories:{list:await h("news"),selectedId:d.categoryFK},userid:a.id,title:d.title,description:d.description,keywords:d.keywords,type:d.type,html_body:d.html_body,newsId:d.id,publishDate:o,sliderCurrent:d.slider,filesCurrent:d.files,mode:"edit"};d.mainPhoto&&(u.mainPhotoCurrent="/image/".concat(d.mainPhoto,"?height=200&width=300"));const l=await s.find({public_status:"active",isMain:!0}).select({_id:1,title:2,language:3,type:4}).lean();return u.linkPages={list:l,selectedIds:d.links},t.render("wysiwygNews",u)}return null===await c(e.session,a.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postEditedNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(await p(i.id,o.NEWS)){const{id:a}=e.params,{title:s,description:d,categoryFK:o,keywords:u,html_body:l,language:c,publishDate:w}=e.body,p={description:d,title:s,keywords:u,language:c,html_body:l,user_id:i.id};return"unlink"===o?p.categoryFK=null:"no_change"!==o&&(p.categoryFK=o),await n.findByIdAndUpdate(a,p),await f(a,w),await A(),await new r({type_content:"Новина",operation:"Редагування новини ".concat(s),user:i.login}).save(),t.redirect("../1")}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postCancelPublicNews=async(e,t)=>{const i=d.getId(e),a=await l.findById(i);try{const i=await m(e.params.id_news);return await new r({type_content:"Новини",operation:"Скасування публікації Новини:  ".concat(i),user:a.login}).save(),t.redirect("../news/1")}catch(n){console.error(n)}},module.exports.postPublicNews=async(e,t)=>{const i=d.getId(e),a=await l.findById(i);try{const n=await y(e.params.id_news);return await new r({type_content:"Новини",operation:" Публікація Новини:  ".concat(n),user:a.login}).save(),t.redirect("/admin/".concat(i,"/news-cancel/1"))}catch(n){console.error(n)}},module.exports.getAllCancelNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(!0===await c(e.session,i.id,t)){if(await p(i.id,o.NEWS)){let a;await N();const n=await g(i.id,o.NEWS),s=await u(n,["cancel","deffered"]);a="system_user"===i.type;const r=[{value:w.ALL,id:"all"},{value:w.CASUAL,id:"casual"},{value:w.MAIN,id:"main"}];return t.render("main_cancel_news",{status:a,user:d.getId(e),news:s,news_type_constant:r,current_page:1})}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id})}return null===await c(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.getAllNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(!0===await c(e.session,i.id,t)){if(!(await p(i.id,o.NEWS)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const n=[{value:w.ALL,id:"all"},{value:w.CASUAL,id:"casual"},{value:w.MAIN,id:"main"}];await N();try{let a;const s=await g(i.id,o.NEWS),r=await u(s,"active");return r.reverse(),a="system_user"===i.type,t.render("main_menu_news",{status:a,news_type_constant:n,user:d.getId(e),news:r,current_page:1})}catch(a){console.error(a)}}}return null===await c(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.deleteNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(!0===await c(e.session,i.id,t)){if(await p(i.id,o.NEWS)){const a=await n.findByIdAndDelete(e.params.id);return await A(),await new r({type_content:"Новини",operation:"Видалення Новини:  ".concat(a.title),user:i.login}).save(),t.redirect("../1")}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id})}return null===await c(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})};