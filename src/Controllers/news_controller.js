"use strict";const e=require("fs"),t=require("path"),i=require("moment"),{Feed:a}=require("feed"),s=require("../Models/News"),n=require("../Models/Page"),r=require("../Models/History"),d=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/display/news"),l=require("../Models/User"),{ValidSession:c}=require("../API/Session/session"),w=require("../API/constants/typeNews"),p=require("../API/userAPI/hasAccess"),g=require("../API/userAPI/enabledIds"),{publishNews:y,cancelPublishNews:m}=require("../API/Content/publishOperation"),f=require("../API/news/addToDeffered"),{updateRss:I}=require("../API/rss"),_=require("../API/getAllCategories"),A=require("../API/deleteNewsTrash");module.exports.getCreateNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(!(await p(i.id,o.NEWS)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id});{const e={mode:"add"},a=await n.find({public_status:"active",isMain:!0}).select({_id:1,title:2,language:3,type:4}).lean();e.pages={list:a,selectedIds:[]},e.categories={list:await _("news")},e.userid=i.id,t.render("wysiwygNews",e)}},module.exports.postCreatedNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(await p(i.id,o.NEWS)){const{title:a,description:n,type:d,categoryFK:o,keywords:u,html_body:l,language:c,publishDate:p}=e.body;let{newsId:g}=e.body;const y={type:d,description:n,title:a,keywords:u,language:c,html_body:l,user_id:i.id};switch("no_change"!==o&&"unlink"!==o&&(y.categoryFK=o),d){case"casual":y.type=w.CASUAL;break;case"main":y.type=w.MAIN}if(g)await s.findByIdAndUpdate(g,y),await f(g,p);else{const e=await new s(y).save();await f(e.id,p),g=e.id}return await I(),await new r({type_content:"Новина",operation:"Додавання новини "+a,user:i.login}).save(),t.redirect("1")}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.getEditNews=async(e,t)=>{const a=await l.findById(d.getId(e));if(!0===await c(e.session,a.id,t)){const{id:r}=e.params,d=await s.findById(r),o=i(d.publishDate).format("DD.MM.YYYY, HH:mm"),u={categories:{list:await _("news"),selectedId:d.categoryFK},userid:a.id,title:d.title,description:d.description,keywords:d.keywords,type:d.type,html_body:d.html_body,newsId:d.id,publishDate:o,sliderCurrent:d.slider,filesCurrent:d.files,mode:"edit"};d.mainPhoto&&(u.mainPhotoCurrent=`/image/${d.mainPhoto}?height=200&width=300`);const l=await n.find({public_status:"active",isMain:!0}).select({_id:1,title:2,language:3,type:4}).lean();return u.linkPages={list:l,selectedIds:d.links},t.render("wysiwygNews",u)}return null===await c(e.session,a.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postEditedNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(await p(i.id,o.NEWS)){const{id:a}=e.params,{title:n,description:d,categoryFK:o,keywords:u,html_body:l,language:c,publishDate:w}=e.body,p={description:d,title:n,keywords:u,language:c,html_body:l,user_id:i.id};return"unlink"===o?p.categoryFK=null:"no_change"!==o&&(p.categoryFK=o),await s.findByIdAndUpdate(a,p),await f(a,w),await I(),await new r({type_content:"Новина",operation:"Редагування новини "+n,user:i.login}).save(),t.redirect("../1")}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.postCancelPublicNews=async(e,t)=>{const i=d.getId(e),a=await l.findById(i);try{const i=await m(e.params.id_news);return await new r({type_content:"Новини",operation:"Скасування публікації Новини:  "+i,user:a.login}).save(),t.redirect("../news/1")}catch(s){console.error(s)}},module.exports.postPublicNews=async(e,t)=>{const i=d.getId(e),a=await l.findById(i);try{const s=await y(e.params.id_news);return await new r({type_content:"Новини",operation:" Публікація Новини:  "+s,user:a.login}).save(),t.redirect(`/admin/${i}/news-cancel/1`)}catch(s){console.error(s)}},module.exports.getAllCancelNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(!0===await c(e.session,i.id,t)){if(await p(i.id,o.NEWS)){let a;await A();const s=await g(i.id,o.NEWS),n=await u(s,["cancel","deffered"]);a="system_user"===i.type;const r=[{value:w.ALL,id:"all"},{value:w.CASUAL,id:"casual"},{value:w.MAIN,id:"main"}];return t.render("main_cancel_news",{status:a,user:d.getId(e),news:n,news_type_constant:r,current_page:1})}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})}return null===await c(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.getAllNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(!0===await c(e.session,i.id,t)){if(!(await p(i.id,o.NEWS)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id});{const s=[{value:w.ALL,id:"all"},{value:w.CASUAL,id:"casual"},{value:w.MAIN,id:"main"}];await A();try{let a;const n=await g(i.id,o.NEWS),r=await u(n,"active");return r.reverse(),a="system_user"===i.type,t.render("main_menu_news",{status:a,news_type_constant:s,user:d.getId(e),news:r,current_page:1})}catch(a){console.error(a)}}}return null===await c(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.deleteNews=async(e,t)=>{const i=await l.findById(d.getId(e));if(!0===await c(e.session,i.id,t)){if(await p(i.id,o.NEWS)){const a=await s.findByIdAndDelete(e.params.id);return await I(),await new r({type_content:"Новини",operation:"Видалення Новини:  "+a.title,user:i.login}).save(),t.redirect("../1")}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})}return null===await c(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})};