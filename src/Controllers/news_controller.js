"use strict";const e=require("fs"),t=require("path"),n=require("moment"),a=require("../Models/Content"),i=require("../Models/History"),s=require("../Models/SliderNames"),r=require("../Models/FileNames"),o=require("../Models/MainPhoto"),d=require("../API/getAdminid"),l=require("../API/op_categories"),u=require("../Models/User"),c=require("../API/Converter"),{ValidSession:p}=require("../API/Session/session"),m=require("../API/constants/typeNews"),_=require("../API/userAPI/hasAccess"),w=require("../API/userAPI/enabledIds"),f=require("../Models/ContentLinks");module.exports.postCancelPublicNews=async function(e,t){const n=d.getId(e),a=await u.findById(n);try{const s=await require("../API/Content/publishOperation").CancelPublish(e.params.id_news);return await new i({type_content:"Новини",operation:"Скасування публікації Новини:  ".concat(s),user:a.login}).save(),t.redirect("/admin/".concat(n,"/news/1"))}catch(s){console.error(s)}},module.exports.postPublicNews=async function(e,t){const n=d.getId(e),a=await u.findById(n);try{const s=await require("../API/Content/publishOperation").Publish(e.params.id_news);return await new i({type_content:"Новини",operation:" Публікація Новини:  ".concat(s),user:a.login}).save(),t.redirect("/admin/".concat(n,"/news-cancel/1"))}catch(s){console.error(s)}},module.exports.getAllCancelNews=async(e,t)=>{const i=await u.findById(d.getId(e));if(!0===await p(e.session,i.id,t)){if(await _(i.id,l.NEWS)){let s;const r=await w(i.id,l.NEWS);let o={page_type:"news",$or:[{public_status:"cancel"},{public_status:"deffered"}]};if(r.length){o={...{...o},_id:{$in:r}}}const u=JSON.parse(JSON.stringify(await a.find(o).select({_id:1,page_title:2,lang:3,page_subclass:4,date:5,public_status:6,keywords:7}))),p=u.map(e=>({date:n(e.date).format("DD-MM-YYYY"),time:n(e.date).format("HH:mm")}));for(let e=0;e<u.length;e++)"cancel"===u[e].public_status&&(u[e].public_status="Скасована Новина"),"deffered"===u[e].public_status&&(u[e].public_status="Відкладена Новина"),u[e].date=p[e].date,u[e].time=p[e].time;s="system_user"===i.type;const _=[{value:m.ALL,id:"all"},{value:m.CASUAL,id:"casual"},{value:m.CURRENT,id:"curent"},{value:m.MAIN,id:"main"}];return t.render("main_cancel_news",{status:s,user:d.getId(e),news:c.getConvert(u),news_type_constant:_,current_page:1})}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id})}return null===await p(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.getAllNews=async(e,t)=>{const i=await u.findById(d.getId(e));if(!0===await p(e.session,i.id,t)){if(!(await _(i.id,l.NEWS)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const r=[{value:m.ALL,id:"all"},{value:m.CASUAL,id:"casual"},{value:m.MAIN,id:"main"}];try{let s;const o=await w(i.id,l.NEWS);let u={page_type:"news",public_status:"active"};if(o.length){u={...{...u},_id:{$in:o}}}const p=await a.find(u).select({_id:1,page_title:2,lang:3,page_subclass:4,date:5,keywords:6}).lean(),m=p.map(e=>({date:n(e.date).format("DD-MM-YYYY"),time:n(e.date).format("HH:mm")}));for(let e=0;e<p.length;e++)p[e].date=m[e].date,p[e].time=m[e].time;return p.reverse(),s="system_user"===i.type,t.render("main_menu_news",{status:s,news_type_constant:r,user:d.getId(e),news:c.getConvert(p),current_page:1})}catch(s){console.error(s)}}}return null===await p(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.deleteNews=async(n,c)=>{const m=await u.findById(d.getId(n));if(!0===await p(n.session,m.id,c)){if(await _(m.id,l.NEWS)){const d=await a.findByIdAndDelete(n.params.id);try{await o.findOneAndDelete({base_url:d.content_baseUrl}),await s.deleteMany({base_url:d.content_baseUrl}),await r.deleteMany({base_url:d.content_baseUrl}),await f.findOneAndRemove({base_url:d.content_baseUrl});const e=new i({type_content:"Новини",operation:"Видалення Новини:  ".concat(d.title),user:m.login});await e.save()}catch(w){}return e.rmdirSync(t.join(__dirname,"../..","uploads/images/".concat(d.content_folder)),{recursive:!0}),c.redirect("../1")}return c.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(m.id,"/main"),url_text:"Повернутися до Головного Меню",user:m.id})}return null===await p(n.session,m.id,c)?c.redirect("/admin/login"):c.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:m.id})};