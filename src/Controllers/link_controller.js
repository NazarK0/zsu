"use strict";const i=require("path"),e=require("fs"),t=require("../Models/Link"),n=require("../Models/History"),r=require("../Models/User"),a=require("../API/link_categories"),s=require("../API/getAdminid"),d=require("../API/op_categories"),o=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),u=require("../API/userAPI/hasAccess"),c=require("../API/userAPI/enabledIds"),{imgOriginFolderPath:g,imgCompressedFolderPath:p}=require("../API/constants/uploadPaths");module.exports.getLinks=async(n,a)=>{const g=await r.findById(s.getId(n));if(!0===await l(n.session,g.id,a)){if(!(await u(g.id,d.LINKS)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${g.id}/main`,url_text:"Повернутися до Головного Меню",user:g.id});try{const r=await c(g.id,d.LINKS);let s={};r.length&&(s={_id:{$in:r}});const l=await t.find(s);(await t.find({title_ua:void 0}).lean()).forEach(({img:t})=>{if(t)try{e.unlinkSync(i.join(p,t))}catch(n){console.error(n)}}),await t.deleteMany({title_ua:void 0});let{page:u}=n.params;const m=g.settings.recordsPerPage.links,f=Math.ceil(l.length/m);(u<1||u>f)&&(u=1);const _=l.slice(m*(u-1),u*m);return a.render("main_menu_links",{user:g.id,links:o.getConvert(_),pages:f,current_page:u})}catch(m){console.error(m)}}return null===await l(n.session,g.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:g.id})},module.exports.AddingForm=async(i,e)=>{const t=await r.findById(s.getId(i));if(!0===await l(i.session,t.id,e)){if(!(await u(t.id,d.LINKS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});try{return e.render("edit_links",{action_type:"add",userid:t.id,categoriesList:[...Object.values(a)],parameter:"hidden"})}catch(n){console.error(n)}}return null===await l(i.session,t.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.EditForm=async(i,e)=>{const n=await r.findById(s.getId(i));if(!0===await l(i.session,n.id,e)){if(!(await u(n.id,d.LINKS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${n.id}/main`,url_text:"Повернутися до Головного Меню",user:n.id});try{const{id:r,title_ua:s,title_en:d,type:o,link:l,description:u,img:c}=await t.findById(i.params.id);return e.render("edit_links",{title_ua:s,title_en:d,description:u,imgSrc:c?`/image/${c}?width=300&height=200`:null,type:o,link:l,linkid:r,userid:n.id,parameter:"visible",action_type:"edit/"+r,categoriesList:[...Object.values(a)]})}catch(o){console.error(o)}}return null===await l(i.session,n.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.Addlink=async(i,e)=>{const a=await r.findById(s.getId(i));if(!0===await l(i.session,a.id,e)){if(!(await u(a.id,d.LINKS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{title_ua:r,title_en:d,type:l,link:u,description:c,link_id:g}=i.body;g?await t.findByIdAndUpdate(g,{title_ua:r,title_en:d,type:l,description:c,link:u,user_id:s.getId(i)}):await new t({title_ua:r,title_en:d,type:l,description:c,link:u,user_id:s.getId(i)}).save();const p=new n({type_content:" Посилання",operation:`Додавання посилання ${r}[${l}]`,user:a.login});try{return await p.save(),e.redirect("./1")}catch(o){console.error(o)}}}return null===await l(i.session,a.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.EditLinks=async(i,e)=>{const a=await r.findById(s.getId(i));if(!0===await l(i.session,a.id,e)){if(!(await u(a.id,d.LINKS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{title_ua:r,title_en:s,type:d,link:l,description:u}=i.body;try{await t.findByIdAndUpdate(i.params.id,{title_ua:r,title_en:s,description:u,type:d,link:l,user_id:a.id});return new n({type_content:" Посилання",operation:"Редагування посилання "+r,user:a.login}).save(),e.redirect("../1")}catch(o){console.error(o)}}}return null===await l(i.session,a.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.removeLink=async(a,o)=>{const c=await r.findById(s.getId(a));if(!0===await l(a.session,c.id,o)){if(!(await u(c.id,d.LINKS)))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${c.id}/main`,url_text:"Повернутися до Головного Меню",user:c.id});{const{id:r}=a.params;try{const a=await t.findByIdAndDelete(r);a.img&&(e.unlinkSync(i.join(g,a.img)),e.unlinkSync(i.join(p,a.img)));return new n({type_content:" Посилання",operation:"Видалення посилання"+a.title_ua,user:c.login}).save(),o.redirect("../1")}catch(m){console.error(m)}}}return null===await l(a.session,c.id,o)?o.redirect("/admin/login"):o.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:c.id})};