"use strict";const e=require("path"),i=require("fs"),t=require("../Models/Link"),n=require("../Models/History"),r=require("../Models/User"),a=require("../API/link_categories"),s=require("../API/getAdminid"),d=require("../API/op_categories"),o=require("../API/Converter"),{ValidSession:u}=require("../API/Session/session"),l=require("../API/userAPI/hasAccess"),c=require("../API/userAPI/enabledIds"),g=require("../API/isExistHelper");module.exports.getLinks=async(e,i)=>{const n=await r.findById(s.getId(e));if(!0===await u(e.session,n.id,i)){if(!(await l(n.id,d.LINKS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});try{const r=await c(n.id,d.LINKS);let a={};r.length&&(a={_id:{$in:r}});const s=await t.find(a);let{page:u}=e.params;const l=n.settings.recordsPerPage.links,g=Math.ceil(s.length/l);(u<1||u>g)&&(u=1);const p=s.slice(l*(u-1),u*l);return i.render("main_menu_links",{user:n.id,links:o.getConvert(p),pages:g,current_page:u})}catch(a){console.error(a)}}return null===await u(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.AddingForm=async(e,i)=>{const t=await r.findById(s.getId(e));if(!0===await u(e.session,t.id,i)){if(!(await l(t.id,d.LINKS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});try{return i.render("edit_links",{action_type:"add",userid:t.id,categoriesList:[...Object.values(a)],parameter:"hidden"})}catch(n){console.error(n)}}return null===await u(e.session,t.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.EditForm=async(e,i)=>{const n=await r.findById(s.getId(e));if(!0===await u(e.session,n.id,i)){if(!(await l(n.id,d.LINKS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});try{const{id:r,title_ua:s,title_en:d,type:o,link:u,description:l,img:c}=await t.findById(e.params.id);return i.render("edit_links",{title_ua:s,title_en:d,description:l,imgSrc:c?"/link-img/".concat(c):null,type:o,link:u,linkid:r,userid:n.id,parameter:"visible",action_type:"edit/".concat(r),categoriesList:[...Object.values(a)]})}catch(o){console.error(o)}}return null===await u(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.Addlink=async(e,i)=>{const a=await r.findById(s.getId(e));if(!0===await u(e.session,a.id,i)){if(!(await l(a.id,d.LINKS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{title_ua:r,title_en:d,type:u,link:l,description:c,link_id:g}=e.body;g?await t.findByIdAndUpdate(g,{title_ua:r,title_en:d,type:u,description:c,link:l,user_id:s.getId(e)}):await new t({title_ua:r,title_en:d,type:u,description:c,link:l,user_id:s.getId(e)}).save();const p=new n({type_content:" Посилання",operation:"Додавання посилання ".concat(r,"[").concat(u,"]"),user:a.login});try{return await p.save(),i.redirect("./1")}catch(o){console.error(o)}}}return null===await u(e.session,a.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.EditLinks=async(e,i)=>{const a=await r.findById(s.getId(e));if(!0===await u(e.session,a.id,i)){if(!(await l(a.id,d.LINKS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{title_ua:r,title_en:s,type:d,link:u,description:l}=e.body;try{await t.findByIdAndUpdate(e.params.id,{title_ua:r,title_en:s,description:l,type:d,link:u,user_id:a.id});return new n({type_content:" Посилання",operation:"Редагування посилання ".concat(r),user:a.login}).save(),i.redirect("../1")}catch(o){console.error(o)}}}return null===await u(e.session,a.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.removeLink=async(a,o)=>{const c=await r.findById(s.getId(a));if(!0===await u(a.session,c.id,o)){if(!(await l(c.id,d.LINKS)))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(c.id,"/main"),url_text:"Повернутися до Головного Меню",user:c.id});{const r=e.join(__dirname,"../..","uploads","/images/links"),{id:s}=a.params;try{const{isImgExist:a,filename:d}=g(s,r);a&&i.unlinkSync(e.join(r,d));const u=await t.findByIdAndDelete(s);return new n({type_content:" Посилання",operation:"Видалення посилання".concat(u.title_ua),user:c.login}).save(),o.redirect("../1")}catch(p){console.error(p)}}}return null===await u(a.session,c.id,o)?o.redirect("/admin/login"):o.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:c.id})};