"use strict";const e=require("../Models/Link"),i=require("../Models/History"),t=require("../Models/User"),n=require("../API/link_categories"),r=require("../API/getAdminid"),s=require("../API/op_categories"),a=require("../API/Converter"),{ValidSession:d}=require("../API/Session/session");module.exports.getLinks=async(i,n)=>{const o=await t.findById(r.getId(i));if(!0===await d(i.session,o.id,n)){if(!o.operation.includes(s.LINKS))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{const t=await e.find();let{page:r}=i.params;const s=o.settings.recordsPerPage.links,d=Math.ceil(t.length/s);(r<1||r>d)&&(r=1);const l=t.slice(s*(r-1),r*s);return n.render("main_menu_links",{user:o.id,links:a.getConvert(l),pages:d,current_page:r})}catch(l){console.log(l)}}return null===await d(i.session,o.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.AddingForm=async(e,i)=>{const a=await t.findById(r.getId(e));if(!0===await d(e.session,a.id,i)){if(!a.operation.includes(s.LINKS))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});try{return i.render("edit_links",{action_type:"add",userid:a.id,categoriesList:[...Object.values(n)],parameter:"hidden"})}catch(o){console.log(o)}}return null===await d(e.session,a.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.EditForm=async(i,a)=>{const o=await t.findById(r.getId(i));if(!0===await d(i.session,o.id,a)){if(!o.operation.includes(s.LINKS))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{const{id:t,title:r,type:s,link:d}=await e.findById(i.params.id);return a.render("edit_links",{title:r,type:s,link:d,linkid:t,userid:o.id,parameter:"visible",action_type:"edit/"+t,categoriesList:[...Object.values(n)]})}catch(l){console.log(l)}}return null===await d(i.session,o.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.Addlink=async(n,a)=>{const o=await t.findById(r.getId(n));if(!0===await d(n.session,o.id,a)){if(!o.operation.includes(s.LINKS))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});{const{title:t,type:s,link:d}=n.body,u=new e({title:t,type:s,link:d,user_id:r.getId(n)}),c=new i({type_content:" Посилання",operation:`Додавання посилання ${t}[${s}]`,user:o.login});try{return await c.save(),await u.save(),a.redirect("./1")}catch(l){console.log(l)}}}return null===await d(n.session,o.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.EditLinks=async(n,a)=>{const o=await t.findById(r.getId(n));if(!0===await d(n.session,o.id,a)){if(!o.operation.includes(s.LINKS))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});{const{title:t,type:r,link:s}=n.body;try{await e.findByIdAndUpdate(n.params.id,{title:t,type:r,link:s,user_id:o.id});return new i({type_content:" Посилання",operation:"Редагування посилання "+t,user:o.login}).save(),a.redirect("../1")}catch(l){console.log(l)}}}return null===await d(n.session,o.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.removeLink=async(n,a)=>{const o=await t.findById(r.getId(n));if(!0===await d(n.session,o.id,a)){if(!o.operation.includes(s.LINKS))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{const t=await e.findByIdAndDelete(n.params.id);return new i({type_content:" Посилання",operation:"Видалення посилання"+t.title,user:o.login}).save(),a.redirect("../1")}catch(l){console.log(l)}}return null===await d(n.session,o.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})};