"use strict";const e=require("path"),i=require("fs"),n=require("../Models/Corps"),t=require("../Models/CorpsSign"),r=require("../Models/CorpsBackground"),a=require("../Models/History"),s=require("../Models/User"),d=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session");module.exports.getCorpsList=async(e,i)=>{const t=await s.findById(d.getId(e));if(!0===await l(e.session,t.id,i)){if(!t.operation.includes(o.CORPS))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});try{const r=await n.find().select({_id:1,title_ua:2,title_en:3,sign_id:4});let{page:a}=e.params;const s=t.settings.recordsPerPage.corps,d=Math.ceil(r.length/s);(a<1||a>d)&&(a=1);const o=r.slice(s*(a-1),a*s);return i.render("main_menu_corps",{user:t.id,corps:await u.getCorpsConverted(o),pages:d,current_page:a})}catch(r){console.log(r)}}return null===await l(e.session,t.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.getAddCorps=async(e,i)=>{const n=await s.findById(d.getId(e));if(!0===await l(e.session,n.id,i)){if(!n.operation.includes(o.CORPS))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${n.id}/main`,url_text:"Повернутися до Головного Меню",user:n.id});try{return i.render("edit_corps",{action_type:"add",sign:await t.find(),background:await r.find(),userid:n.id,parameter:"hidden"})}catch(a){console.log(a)}}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.getEditCorps=async(e,i)=>{const a=await s.findById(d.getId(e));if(!0===await l(e.session,a.id,i)){if(!a.operation.includes(o.CORPS))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});try{const{id:s,title_ua:d,title_en:o,link:l,sign_id:c,bg_id:g}=await n.findById(e.params.id);let p,f;try{p=await t.findById(c)}catch(u){p=null}try{f=await r.findById(g)}catch(u){f=null}return i.render("edit_corps",{title_ua:d,title_en:o,link:l,corpsid:s,current_bg_id:f?f.id:null,current_bg_base64:f?f.base64:null,current_bg_name:f?f.name:null,current_sign_id:p?p.id:null,current_sign_base64:p?p.base64:null,current_sign_name:p?p.name:null,sign:await t.find(),background:await r.find(),userid:a.id,parameter:"visible",action_type:"edit/"+s})}catch(c){console.log(c)}}return null===await l(e.session,a.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postAddedCorps=async(e,i)=>{const t=await s.findById(d.getId(e));if(!t.operation.includes(o.CORPS))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});{const{title_ua:s,title_en:o,link:u,sign_id:l,bg_id:c}=e.body,g=new n({title_ua:s,title_en:o,link:u,sign_id:l,bg_id:c,user_id:d.getId(e)}),p=new a({type_content:" Види/роди військ",operation:"Додавання виду/роду військ "+title,user:t.login});try{await p.save(),await g.save(),i.status(200).redirect("./1")}catch(r){console.log(r)}}},module.exports.postEditedCorps=async(e,i)=>{const t=await s.findById(d.getId(e));if(!t.operation.includes(o.CORPS))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});{const{title_ua:s,title_en:d,link:o,sign_id:u,bg_id:l,current_sign_id:c,current_bg_id:g}=e.body;try{await n.findByIdAndUpdate(e.params.id,{title_ua:s,title_en:d,link:o,sign_id:u||c,bg_id:l||g,user_id:t.id});new a({type_content:" Види/роди військ",operation:"Редагування виду/роду військ "+title,user:t.login}).save(),i.redirect("../1")}catch(r){console.log(r)}}},module.exports.deleteCorps=async(e,i)=>{const t=await s.findById(d.getId(e));if(!0===await l(e.session,t.id,i)){if(!t.operation.includes(o.CORPS))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});try{const r=await n.findByIdAndDelete(e.params.id);return new a({type_content:" Види/роди військ",operation:"Видалення виду/роду військ "+r.title,user:t.login}).save(),i.redirect("../1")}catch(r){console.log(r)}}return null===await l(e.session,t.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.sendCorpsSign=async(n,r)=>{const a=await s.findById(d.getId(n));if(!a.operation.includes(o.CORPS))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const a=e.join(__dirname,"../..","uploads/images/corps/sign");if(i.existsSync(a)||i.mkdirSync(a,{recursive:!0}),n.files)return await n.files.map(n=>{const r=`${Date.now()}-${n.originalname}`;i.renameSync(e.join(__dirname,"../../uploads/images/temp",n.filename),e.join(a,r)),new t({name:r,url:e.join(a,r),base64:i.readFileSync(e.join(a,r),"base64")}).save()}),r.status(200)}},module.exports.sendCorpsBackground=async(n,t)=>{const a=await s.findById(d.getId(n));if(!a.operation.includes(o.CORPS))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const a=e.join(__dirname,"../..","uploads/images/corps/bg");if(i.existsSync(a)||i.mkdirSync(a,{recursive:!0}),n.files)return await n.files.map(n=>{const t=`${Date.now()}-${n.originalname}`;i.renameSync(e.join(__dirname,"../../uploads/images/temp",n.filename),e.join(a,t)),new r({name:t,url:e.join(a,t),base64:i.readFileSync(e.join(a,t),"base64")}).save()}),t.status(200)}},module.exports.deleteCorpsSign=async(r,a)=>{const u=await s.findById(d.getId(r));if(!0===await l(r.session,u.id,a)){if(u.operation.includes(o.CORPS)){const r=await t.find();for(let e=0;e<r.length;e++)await t.findByIdAndDelete(r[e].id),await n.updateMany({sign_id:r[e].id},{sign_id:null});const s=e.join(__dirname,"../..","uploads/images/corps/sign"),d=i.readdirSync(s);for(let n=0;n<d.length;n++)"default.jpg"!==d[n]&&i.unlinkSync(e.join(s,d[n]));return a.status(200).redirect("..")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id})}},module.exports.deleteCorpsBackground=async(t,a)=>{const u=await s.findById(d.getId(t));if(!0===await l(t.session,u.id,a)){if(u.operation.includes(o.CORPS)){const t=await r.find();for(let e=0;e<t.length;e++)await r.findByIdAndDelete(t[e].id),await n.updateMany({bg_id:t[e].id},{bg_id:null});const s=e.join(__dirname,"../..","uploads/images/corps/bg"),d=i.readdirSync(s);for(let n=0;n<d.length;n++)i.unlinkSync(e.join(s,d[n]));return a.status(200).redirect("..")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",user:u.id})}return null===await l(t.session,u.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getPhotoEditor=async(e,i)=>{const n=await s.findById(d.getId(e));if(!0===await l(e.session,n.id,i)){if(n.operation.includes(o.CORPS)){const e=u.getConvert(await r.find()),a=u.getConvert(await t.find());return i.status(200).render("corps_photo_editor",{backgrounds:e,signs:a,user:n.id})}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",user:n.id})}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.postDeleteBackgroundOne=async(n,t)=>{const u=await s.findById(d.getId(n));if(!0===await l(n.session,u.id,t)){if(!u.operation.includes(o.CORPS))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id});{const{id:s}=n.params;try{const n=await r.findByIdAndDelete(s);if(n)try{i.unlinkSync(e.join(__dirname,"../..","uploads/images/corps/bg",n.name))}catch(c){console.log(c)}return new a({type_content:" Види/роди військ",operation:`Видалення фонового зображення ${n.name} для виду/роду військ `,user:u.login}).save(),t.redirect("../../photo-editor")}catch(c){console.log(c)}}}return null===await l(n.session,u.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.postDeleteSignOne=async(n,r)=>{const u=await s.findById(d.getId(n));if(!0===await l(n.session,u.id,r)){if(!u.operation.includes(o.CORPS))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id});{const{id:s}=n.params;try{const n=await t.findByIdAndDelete(s);if(n)try{i.unlinkSync(e.join(__dirname,"../..","uploads/images/corps/sign",n.name))}catch(c){console.log(c)}return new a({type_content:" Види/роди військ",operation:`Видалення емблеми ${n.name} для виду/роду військ `,user:u.login}).save(),r.redirect("../../photo-editor")}catch(c){console.log(c)}}}return null===await l(n.session,u.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})};