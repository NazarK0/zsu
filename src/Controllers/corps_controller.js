"use strict";const i=require("path"),e=require("fs"),t=require("../Models/Corps"),n=require("../Models/CorpsSign"),r=require("../Models/CorpsBackground"),a=require("../Models/History"),d=require("../Models/User"),s=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),c=require("../API/userAPI/hasAccess"),g=require("../API/userAPI/enabledIds");module.exports.getCorpsList=async(i,e)=>{const n=await d.findById(s.getId(i));if(!0===await l(i.session,n.id,e)){if(!(await c(n.id,o.CORPS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});try{const r=await g(n.id,o.CORPS);let a={};r.length&&(a={_id:{$in:r}});const d=await t.find(a).select({_id:1,title_ua:2,title_en:3,sign_id:4});let{page:s}=i.params;const l=n.settings.recordsPerPage.corps,c=Math.ceil(d.length/l);(s<1||s>c)&&(s=1);const _=d.slice(l*(s-1),s*l);return e.render("main_menu_corps",{user:n.id,corps:await u.getCorpsConverted(_),pages:c,current_page:s})}catch(r){console.error(r)}}return null===await l(i.session,n.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.getAddCorps=async(i,e)=>{const t=await d.findById(s.getId(i));if(!0===await l(i.session,t.id,e)){if(!(await c(t.id,o.CORPS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});try{return e.render("edit_corps",{action_type:"add",sign:await n.find(),background:await r.find(),userid:t.id,parameter:"hidden"})}catch(a){console.error(a)}}return null===await l(i.session,t.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.getEditCorps=async(i,e)=>{const a=await d.findById(s.getId(i));if(!0===await l(i.session,a.id,e)){if(!(await c(a.id,o.CORPS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});try{const{id:d,title_ua:s,title_en:o,link:l,sign_id:c,bg_id:g}=await t.findById(i.params.id);let _,f;try{_=await n.findById(c)}catch(u){_=null}try{f=await r.findById(g)}catch(u){f=null}return e.render("edit_corps",{title_ua:s,title_en:o,link:l,corpsid:d,current_bg_id:f?f.id:null,current_bg_base64:f?f.base64:null,current_bg_name:f?f.name:null,current_sign_id:_?_.id:null,current_sign_base64:_?_.base64:null,current_sign_name:_?_.name:null,sign:await n.find(),background:await r.find(),userid:a.id,parameter:"visible",action_type:"edit/".concat(d)})}catch(g){console.error(g)}}return null===await l(i.session,a.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postAddedCorps=async(i,e)=>{const n=await d.findById(s.getId(i));if(!(await c(n.id,o.CORPS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});{const{title_ua:d,title_en:o,link:u,sign_id:l,bg_id:c}=i.body,g=new t({title_ua:d,title_en:o,link:u,sign_id:l,bg_id:c,user_id:s.getId(i)}),_=new a({type_content:" Види/роди військ",operation:"Додавання виду/роду військ ".concat(d,"/").concat(o),user:n.login});try{await _.save(),await g.save(),e.status(200).redirect("./1")}catch(r){console.error(r)}}},module.exports.postEditedCorps=async(i,e)=>{const n=await d.findById(s.getId(i));if(!(await c(n.id,o.CORPS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});{const{title_ua:d,title_en:s,link:o,sign_id:u,bg_id:l,current_sign_id:c,current_bg_id:g}=i.body;try{await t.findByIdAndUpdate(i.params.id,{title_ua:d,title_en:s,link:o,sign_id:u||c,bg_id:l||g,user_id:n.id});new a({type_content:" Види/роди військ",operation:"Редагування виду/роду військ ".concat(d,"/").concat(s),user:n.login}).save(),e.redirect("../1")}catch(r){console.error(r)}}},module.exports.deleteCorps=async(i,e)=>{const n=await d.findById(s.getId(i));if(!0===await l(i.session,n.id,e)){if(!(await c(n.id,o.CORPS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});try{const r=await t.findByIdAndDelete(i.params.id);return new a({type_content:" Види/роди військ",operation:"Видалення виду/роду військ ".concat(r.title),user:n.login}).save(),e.redirect("../1")}catch(r){console.error(r)}}return null===await l(i.session,n.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.deleteCorpsSign=async(r,a)=>{const u=await d.findById(s.getId(r));if(!0===await l(r.session,u.id,a)){if(await c(u.id,o.CORPS)){const r=await n.find();for(let i=0;i<r.length;i++)await n.findByIdAndDelete(r[i].id),await t.updateMany({sign_id:r[i].id},{sign_id:null});const d=i.join(__dirname,"../..","uploads/images/corps/sign"),s=e.readdirSync(d);for(let t=0;t<s.length;t++)"default.jpg"!==s[t]&&e.unlinkSync(i.join(d,s[t]));return a.status(200).redirect("..")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id})}},module.exports.deleteCorpsBackground=async(n,a)=>{const u=await d.findById(s.getId(n));if(!0===await l(n.session,u.id,a)){if(await c(u.id,o.CORPS)){const n=await r.find();for(let i=0;i<n.length;i++)await r.findByIdAndDelete(n[i].id),await t.updateMany({bg_id:n[i].id},{bg_id:null});const d=i.join(__dirname,"../..","uploads/images/corps/bg"),s=e.readdirSync(d);for(let t=0;t<s.length;t++)e.unlinkSync(i.join(d,s[t]));return a.status(200).redirect("..")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",user:u.id})}return null===await l(n.session,u.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getPhotoEditor=async(i,e)=>{const t=await d.findById(s.getId(i));if(!0===await l(i.session,t.id,e)){if(await c(t.id,o.CORPS)){const i=u.getConvert(await r.find()),a=u.getConvert(await n.find());return e.status(200).render("corps_photo_editor",{backgrounds:i,signs:a,user:t.id})}return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",user:t.id})}return null===await l(i.session,t.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})};