"use strict";const e=require("path"),i=require("fs"),t=require("../Models/Corps"),r=require("../Models/CorpsSign"),n=require("../Models/CorpsBackground"),a=require("../Models/History"),s=require("../Models/User"),d=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),c=require("../API/userAPI/hasAccess"),g=require("../API/userAPI/enabledIds");module.exports.getCorpsList=async(e,i)=>{const r=await s.findById(d.getId(e));if(!0===await l(e.session,r.id,i)){if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id});try{const n=await g(r.id,o.CORPS);let a={};n.length&&(a={_id:{$in:n}});const s=await t.find(a).select({_id:1,title_ua:2,title_en:3,signImg:4}).lean(),d=s.map(e=>{const i={...e};return e.signImg?i.signUrl="/image/".concat(e.signImg,"?width=60&height=60"):i.signUrl="",i});let{page:u}=e.params;const l=r.settings.recordsPerPage.corps,c=Math.ceil(s.length/l);(u<1||u>c)&&(u=1);const p=d.slice(l*(u-1),u*l);return i.render("main_menu_corps",{user:r.id,corps:p,pages:c,current_page:u})}catch(n){console.error(n)}}return null===await l(e.session,r.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.getAddCorps=async(e,i)=>{const t=await s.findById(d.getId(e));return!0===await l(e.session,t.id,i)?await c(t.id,o.CORPS)?i.render("edit_corps",{mode:"add",userid:t.id}):i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id}):null===await l(e.session,t.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.getEditCorps=async(e,i)=>{const r=await s.findById(d.getId(e));if(!0===await l(e.session,r.id,i)){if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id});try{const{id:n}=e.params,{title_ua:a,title_en:s,link:d,signImg:o}=await t.findById(n).lean(),u=o?"/image/".concat(o,"?height=200&width=300"):"";return i.render("edit_corps",{title_ua:a,title_en:s,link:d,corpsId:n,userid:r.id,mode:"edit",corpsSignCurrent:u})}catch(n){console.error(n)}}return null===await l(e.session,r.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.postAddedCorps=async(e,i)=>{const r=await s.findById(d.getId(e));if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id});{const{title_ua:n,title_en:s,link:o,corpsId:u}=e.body,l={title_ua:n,title_en:s,link:o,user_id:d.getId(e)};u?await t.findByIdAndUpdate(u,l):await new t(l).save(),await new a({type_content:" Види/роди військ",operation:"Додавання виду/роду військ ".concat(n,"/").concat(s),user:r.login}).save(),i.status(200).redirect("./1")}},module.exports.postEditedCorps=async(e,i)=>{const r=await s.findById(d.getId(e));if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id});{const{title_ua:s,title_en:d,link:o,corpsId:u}=e.body;try{await t.findByIdAndUpdate(u,{title_ua:s,title_en:d,link:o,user_id:r.id}),await new a({type_content:" Види/роди військ",operation:"Редагування виду/роду військ ".concat(s,"/").concat(d),user:r.login}).save(),i.redirect("../1")}catch(n){console.error(n)}}},module.exports.deleteCorps=async(e,i)=>{const r=await s.findById(d.getId(e));if(!0===await l(e.session,r.id,i)){if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id});try{const n=await t.findByIdAndDelete(e.params.id);return await new a({type_content:" Види/роди військ",operation:"Видалення виду/роду військ ".concat(n.title_ua),user:r.login}).save(),i.redirect("../1")}catch(n){console.error(n)}}return null===await l(e.session,r.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})};