"use strict";const e=require("path"),i=require("fs"),t=require("../Models/Corps"),r=require("../Models/CorpsSign"),n=require("../Models/CorpsBackground"),s=require("../Models/History"),a=require("../Models/User"),d=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),c=require("../API/userAPI/hasAccess"),g=require("../API/userAPI/enabledIds");module.exports.getCorpsList=async(e,i)=>{const r=await a.findById(d.getId(e));if(!0===await l(e.session,r.id,i)){if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});try{const n=await g(r.id,o.CORPS);let s={};n.length&&(s={_id:{$in:n}});const a=await t.find(s).select({_id:1,title_ua:2,title_en:3,signImg:4}).lean(),d=a.map(e=>{const i={...e};return e.signImg?i.signUrl=`/image/${e.signImg}?width=60&height=60`:i.signUrl="",i});let{page:u}=e.params;const l=r.settings.recordsPerPage.corps,c=Math.ceil(a.length/l);(u<1||u>c)&&(u=1);const p=d.slice(l*(u-1),u*l);return i.render("main_menu_corps",{user:r.id,corps:p,pages:c,current_page:u})}catch(n){console.error(n)}}return null===await l(e.session,r.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.getAddCorps=async(e,i)=>{const t=await a.findById(d.getId(e));return!0===await l(e.session,t.id,i)?await c(t.id,o.CORPS)?i.render("edit_corps",{mode:"add",userid:t.id}):i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id}):null===await l(e.session,t.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.getEditCorps=async(e,i)=>{const r=await a.findById(d.getId(e));if(!0===await l(e.session,r.id,i)){if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});try{const{id:n}=e.params,{title_ua:s,title_en:a,link:d,signImg:o}=await t.findById(n).lean(),u=o?`/image/${o}?height=200&width=300`:"";return i.render("edit_corps",{title_ua:s,title_en:a,link:d,corpsId:n,userid:r.id,mode:"edit",corpsSignCurrent:u})}catch(n){console.error(n)}}return null===await l(e.session,r.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.postAddedCorps=async(e,i)=>{const r=await a.findById(d.getId(e));if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});{const{title_ua:n,title_en:a,link:o,corpsId:u}=e.body,l={title_ua:n,title_en:a,link:o,user_id:d.getId(e)};u?await t.findByIdAndUpdate(u,l):await new t(l).save(),await new s({type_content:" Види/роди військ",operation:`Додавання виду/роду військ ${n}/${a}`,user:r.login}).save(),i.status(200).redirect("./1")}},module.exports.postEditedCorps=async(e,i)=>{const r=await a.findById(d.getId(e));if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});{const{title_ua:a,title_en:d,link:o,corpsId:u}=e.body;try{await t.findByIdAndUpdate(u,{title_ua:a,title_en:d,link:o,user_id:r.id}),await new s({type_content:" Види/роди військ",operation:`Редагування виду/роду військ ${a}/${d}`,user:r.login}).save(),i.redirect("../1")}catch(n){console.error(n)}}},module.exports.deleteCorps=async(e,i)=>{const r=await a.findById(d.getId(e));if(!0===await l(e.session,r.id,i)){if(!(await c(r.id,o.CORPS)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});try{const n=await t.findByIdAndDelete(e.params.id);return await new s({type_content:" Види/роди військ",operation:"Видалення виду/роду військ "+n.title_ua,user:r.login}).save(),i.redirect("../1")}catch(n){console.error(n)}}return null===await l(e.session,r.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})};