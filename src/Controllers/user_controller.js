"use strict";const e=require("../Models/User"),i=require("../Models/Content"),s=require("../Models/Command"),a=require("../Models/Corps"),t=require("../Models/Link"),r=require("../API/hashing_password"),d=require("../Models/History"),n=require("../API/getAdminid"),u=require("../API/op_categories"),{setAllOperation:o,getOperation:l}=require("../API/checkUserOperation"),c=require("../API/userAPI/hasAccess"),p=require("../API/MainMenuApi/getAllMenu"),{ValidSession:_}=require("../API/Session/session"),{checkEditPermission:m,checkNameMatching:w}=require("../API/userAPI/validatonUserPermission"),{NormaLizeUserList:g}=require("../API/userAPI/UserList"),{COMMAND:S,MESSAGE:I}=require("../API/op_categories"),f=require("../API/userAPI/enabledIds"),E=require("../Models/Contact");module.exports.getAllUser=async(i,s)=>{const a=await e.findById(n.getId(i));if(!0===await _(i.session,a.id,s))try{let e;const t=await f(a.id,u.USER),r=await g(t);e="system_user"===a.type;let{page:d}=i.params;const o=a.settings.recordsPerPage.users,l=Math.ceil(r.length/o);(d<1||d>l)&&(d=1);const c=r.slice(o*(d-1),d*o);return s.render("main_menu_users",{status:e,user:n.getId(i),users:c,pages:l,current_page:d})}catch(t){console.error(t)}return null===await _(i.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.editUser=async(i,s)=>{const a=await e.findById(n.getId(i));if(!0===await _(i.session,a.id,s)){if(!0!==await m(i.params.iduser,a.id,0))return s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id});{if(a.id===i.params.iduser&&"system_user"!==a.type){const a=await e.findOne({_id:i.params.iduser});await e.findByIdAndUpdate(i.params.iduser,{login:i.body.login,email:i.body.email,description_user:i.body.description_user});const t=await e.findById({_id:n.getId(i)});return new d({type_content:"Користувач",operation:"Редагування користувача: ".concat(a.login," "),user:t.login}).save(),s.redirect("../1")}const r=await e.findOne({_id:i.params.iduser}),{USER:u,PAGES:c,HISTORY:p,MAIN_MENU:_,NEWS:m,SIDEMENU:w,LINKS:g,CONTENT:S,CORPS:I,COMMAND:f,MESSAGE:E,CONTACTS:N,user_pages:A,user_news:y,user_menu:M,user_links:C,user_corps:O,user_command:U,user_users:T,user_contacts:P,selectUserCategories:v}=i.body,h={user_pages:A,user_news:y,user_menu:M,user_links:C,user_corps:O,user_command:U,user_users:T,user_contacts:P};let D=[],R=[];switch(v){case"all":D=o();break;case"setup":R=[{name:"USER",value:u},{name:"PAGES",value:c},{name:"HISTORY",value:p},{name:"MAIN_MENU",value:_},{name:"NEWS",value:m},{name:"SIDEMENU",value:w},{name:"LINKS",value:g},{name:"CONTENT",value:S},{name:"CORPS",value:I},{name:"COMMAND",value:f},{name:"MESSAGE",value:E},{name:"CONTACTS",value:N}],D=l(R,h)}try{await e.findByIdAndUpdate(i.params.iduser,{login:i.body.login,email:i.body.email,description_user:i.body.description_user,operation:D,auth_status:!1,session:null});const a=await e.findById({_id:n.getId(i)});return new d({type_content:"Користувач",operation:"Редагування користувача: ".concat(r.login," "),user:a.login}).save(),s.redirect("../1")}catch(t){console.error(t)}}}return null===await _(i.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.getEditUser=async(r,d)=>{const o=await e.findById(n.getId(r));if(!0===await _(r.session,o.id,d)){if(!0===await m(r.params.iduser,o.id,0)){const n=await e.findOne({_id:r.params.iduser});let l=!1;const c=n.operation.map(e=>e.category),p={USER:!0===c.includes(u.USER)?"checked":"default",PAGES:!0===c.includes(u.PAGES)?"checked":"default",HISTORY:!0===c.includes(u.HISTORY)?"checked":"default",MAIN_MENU:!0===c.includes(u.MAIN_MENU)?"checked":"default",NEWS:!0===c.includes(u.NEWS)?"checked":"default",SIDEMENU:!0===c.includes(u.SIDEMENU)?"checked":"default",LINKS:!0===c.includes(u.LINKS)?"checked":"default",CONTENT:!0===c.includes(u.CONTENT)?"checked":"default",CORPS:!0===c.includes(u.CORPS)?"checked":"default",COMMAND:!0===c.includes(u.COMMAND)?"checked":"default",MESSAGE:!0===c.includes(u.MESSAGE)?"checked":"default",CONTACTS:!0===c.includes(u.CONTACTS)?"checked":"default"};let _;_=o.type&&"system_user"===o.type?await e.find({_id:{$ne:o.id}}).select({_id:1}).lean():await e.find({creator:{id:o.id,login:o.login}}).select({_id:1}).lean();const m=_.map(e=>e._id.toString());m.includes(r.params.iduser)&&(l=!0);const w=await i.find({page_type:"content_page"}).select({_id:1,page_title:2}),g=await i.find({page_type:"news"}).select({_id:1,page_title:2}),S=await s.find().select({_id:1,title_ua:2}),I=await a.find().select({_id:1,title_ua:2}),N=await t.find().select({_id:1,title_ua:2}),A=await E.find().select({_id:1,title:2}),y=await e.find({$and:[{_id:{$nin:[o.id,r.params.iduser]}},{_id:{$in:m}}]}).select({_id:1,login:2});let M,C,O,U,T,P,v;for(let e=0;e<c.length;e++)switch(c[e]){case u.PAGES:M=await f(n.id,u.PAGES);break;case u.NEWS:C=await f(n.id,u.NEWS);break;case u.COMMAND:O=await f(n.id,u.COMMAND);break;case u.CORPS:U=await f(n.id,u.CORPS);break;case u.LINKS:T=await f(n.id,u.LINKS);break;case u.CONTACTS:P=await f(n.id,u.CONTACTS);break;case u.USER:v=await f(n.id,u.USER)}return d.render("edit_user",{login:n.login,email:n.email,password:n.password,type:n.type,description_user:n.description_user,operation:n.operation,userid:o.id,USER:p.USER,PAGES:p.PAGES,HISTORY:p.HISTORY,MAIN_MENU:p.MAIN_MENU,NEWS:p.NEWS,SIDEMENU:p.SIDEMENU,LINKS:p.LINKS,CONTENT:p.CONTENT,CORPS:p.CORPS,COMMAND:p.COMMAND,MESSAGE:p.MESSAGE,CONTACTS:p.CONTACTS,action_type:"edit/".concat(r.params.iduser),edited_userid:r.params.iduser,id_news:r.params.iduser,parameter:"visible",pass_visible:"visible",edit:l,pagesData:{list:w,selectedIds:M},newsData:{list:g,selectedIds:C},commandData:{list:S,selectedIds:O},corpsData:{list:I,selectedIds:U},linksData:{list:N,selectedIds:T},userData:{list:y,selectedIds:v},contactsData:{list:A,selectedIds:P}})}return d.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(o.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:o.id})}return null===await _(r.session,o.id,d)?d.redirect("/admin/login"):d.status(400).json("Час сесії минув, авторизуйтесь знову!")},module.exports.getAddForm=async(r,d)=>{const o=await e.findById(n.getId(r));try{if(!0===await _(r.session,o.id,d)){if(await c(o.id,u.USER)){const u=(await e.find({_id:{$ne:o.id}}).select({_id:1}).lean()).map(e=>e._id.toString()),l=await i.find({page_type:"content_page"}).select({_id:1,page_title:2}),c=await i.find({page_type:"news"}).select({_id:1,page_title:2}),p=await s.find().select({_id:1,title_ua:2}),_=await a.find().select({_id:1,title_ua:2}),m=await t.find().select({_id:1,title_ua:2}),w=await E.find().select({_id:1,title:2}),g=await e.find({$and:[{_id:{$nin:[o.id,r.params.iduser]}},{_id:{$in:u}}]}).select({_id:1,login:2});return d.render("edit_user",{parameter:"hidden",userid:n.getId(r),action_type:"add",pass_visible:"visible",edit:!0,pagesData:{list:l,selectedIds:[]},newsData:{list:c,selectedIds:[]},commandData:{list:p,selectedIds:[]},corpsData:{list:_,selectedIds:[]},linksData:{list:m,selectedIds:[]},userData:{list:g,selectedIds:[]},contactsData:{list:w,selectedIds:[]}})}return d.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:"/admin/".concat(o.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:o.id})}return null===await _(r.session,o.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})}catch(l){console.error(l)}},module.exports.addUser=async(i,s)=>{const a=await e.findById(n.getId(i));if(await c(a.id,u.USER)){const t=n.getId(i),{USER:u,PAGES:c,HISTORY:p,MAIN_MENU:_,NEWS:m,SIDEMENU:g,LINKS:I,CONTENT:f,CORPS:E,MESSAGE:N,CONTACTS:A,selectUserCategories:y,user_pages:M,user_news:C,user_menu:O,user_links:U,user_corps:T,user_command:P,user_users:v,user_contacts:h}=i.body,D={user_pages:M,user_news:C,user_menu:O,user_links:U,user_corps:T,user_command:P,user_users:v,user_contacts:h};let R=[],b=[];switch(y){case"all":R=o();break;case"setup":b=[{name:"USER",value:u},{name:"PAGES",value:c},{name:"HISTORY",value:p},{name:"MAIN_MENU",value:_},{name:"NEWS",value:m},{name:"SIDEMENU",value:g},{name:"LINKS",value:I},{name:"CONTENT",value:f},{name:"CORPS",value:E},{name:"COMMAND",value:S},{name:"MESSAGE",value:N},{name:"CONTACTS",value:A}],R=l(b,D)}if(!1===await w(i.body.login)){if(""!==i.body.password){const n=new e({login:i.body.login,email:i.body.email,password:r.hashpassword(i.body.password),type:i.body.type,operation:R,creator:{id:a.id,login:a.login},description_user:i.body.description_user});await n.save();const u=await e.findById({_id:t}),o=new d({type_content:"Користувач",operation:"Створення користувача: ".concat(n.login),user:u.login});return await o.save(),s.redirect("./1")}return s.status(400).render("infopage",{info:"Для створення користувача обов'язковий Пароль!!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id})}return s.status(400).render("infopage",{info:"Користувач з цим логіном вже зареєстрвано, виберіть інший Логін",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id})}return s.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id})},module.exports.removeUser=async(i,s)=>{const a=await e.findById(n.getId(i)),t=n.getId(i);if(!0!==await m(i.params.iduser,a.id,1))return null===await m(i.params.iduser,a.id,1)?s.status(400).render("infopage",{info:"Неможливо видалити поточного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id}):s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id});try{const a=await e.findByIdAndRemove(i.params.iduser),r=await e.findById(t);return new d({type_content:"Користувач",operation:"Видалення користувача ".concat(a.login),user:r.login}).save(),s.redirect("../1")}catch(r){console.error(r)}},module.exports.getEditUserPassword=async(i,s)=>{const a=await e.findById(n.getId(i));return!0===await _(i.session,a.id,s)?!0===await m(i.params.iduser,a.id,0)?s.render("edit_password",{edited_userid:i.params.iduser,userid:a.id}):s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id}):null===await _(i.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postEditUserPassword=async(i,s)=>{const a=await e.findById(n.getId(i)),t=i.params.iduser;if(!0===await _(i.session,a.id,s)){if(!0===await m(t,a.id,0)){const{old_password:n,new_password1:u,new_password2:o}=i.body,l=await e.findById(t).select({_id:1,password:2});return r.hashpassword(n)===l.password?u===o?(await e.findByIdAndUpdate(l.id,{password:r.hashpassword(u)}),await new d({type_content:"Користувач",operation:"Редагування паролю для користувача: ".concat(l.login),user:a.login}).save(),s.redirect("../../1")):s.render("edit_password",{old_password:n,edited_userid:l.id,userid:a.id}):s.redirect("./password")}return s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id})}return null===await _(i.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})};