"use strict";const e=require("../Models/User"),i=require("../Models/Page"),a=require("../Models/News"),s=require("../Models/Command"),t=require("../Models/Corps"),n=require("../Models/Link"),d=require("../API/hashing_password"),r=require("../Models/History"),u=require("../API/getAdminid"),l=require("../API/op_categories"),{setAllOperation:o,getOperation:c}=require("../API/checkUserOperation"),_=require("../API/userAPI/hasAccess"),p=require("../API/MainMenuApi/getAllMenu"),{ValidSession:m}=require("../API/Session/session"),{checkEditPermission:g,checkNameMatching:w}=require("../API/userAPI/validatonUserPermission"),{NormaLizeUserList:f}=require("../API/userAPI/UserList"),{COMMAND:I,MESSAGE:E}=require("../API/op_categories"),S=require("../API/userAPI/enabledIds"),N=require("../Models/Contact");module.exports.getAllUser=async(i,a)=>{const s=await e.findById(u.getId(i));if(!0===await m(i.session,s.id,a))try{let e;const t=await S(s.id,l.USER),n=await f(t);e="system_user"===s.type;let{page:d}=i.params;const r=s.settings.recordsPerPage.users,o=Math.ceil(n.length/r);(d<1||d>o)&&(d=1);const c=n.slice(r*(d-1),d*r);return a.render("main_menu_users",{status:e,user:u.getId(i),users:c,pages:o,current_page:d})}catch(t){console.error(t)}return null===await m(i.session,s.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})},module.exports.editUser=async(i,a)=>{const s=await e.findById(u.getId(i));if(!0===await m(i.session,s.id,a)){if(!0!==await g(i.params.iduser,s.id,0))return a.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(s.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:s.id});{if(s.id===i.params.iduser&&"system_user"!==s.type){const s=await e.findOne({_id:i.params.iduser});await e.findByIdAndUpdate(i.params.iduser,{login:i.body.login,email:i.body.email,description_user:i.body.description_user});const t=await e.findById({_id:u.getId(i)});return new r({type_content:"Користувач",operation:"Редагування користувача: ".concat(s.login," "),user:t.login}).save(),a.redirect("../1")}const n=await e.findOne({_id:i.params.iduser}),{USER:d,PAGES:l,HISTORY:_,MAIN_MENU:p,NEWS:m,SIDEMENU:g,LINKS:w,CONTENT:f,CORPS:I,COMMAND:E,MESSAGE:S,CONTACTS:N,GALERY:A,VIDEO:M,user_pages:y,user_news:O,user_menu:C,user_links:h,user_corps:v,user_command:U,user_users:T,user_contacts:P,selectUserCategories:D}=i.body,R={user_pages:y,user_news:O,user_menu:C,user_links:h,user_corps:v,user_command:U,user_users:T,user_contacts:P};let b=[],k=[];switch(D){case"all":b=o();break;case"setup":k=[{name:"USER",value:d},{name:"PAGES",value:l},{name:"HISTORY",value:_},{name:"MAIN_MENU",value:p},{name:"NEWS",value:m},{name:"SIDEMENU",value:g},{name:"LINKS",value:w},{name:"CONTENT",value:f},{name:"CORPS",value:I},{name:"COMMAND",value:E},{name:"MESSAGE",value:S},{name:"CONTACTS",value:N},{name:"GALERY",value:A},{name:"VIDEO",value:M}],b=c(k,R)}try{await e.findByIdAndUpdate(i.params.iduser,{login:i.body.login,email:i.body.email,description_user:i.body.description_user,operation:b,auth_status:!1,session:null});const s=await e.findById({_id:u.getId(i)});return new r({type_content:"Користувач",operation:"Редагування користувача: ".concat(n.login," "),user:s.login}).save(),a.redirect("../1")}catch(t){console.error(t)}}}return null===await m(i.session,s.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})},module.exports.getEditUser=async(d,r)=>{const o=await e.findById(u.getId(d));if(!0===await m(d.session,o.id,r)){if(!0===await g(d.params.iduser,o.id,0)){const u=await e.findOne({_id:d.params.iduser});let c=!1;const _=u.operation.map(e=>e.category),p={USER:!0===_.includes(l.USER)?"checked":"default",PAGES:!0===_.includes(l.PAGES)?"checked":"default",HISTORY:!0===_.includes(l.HISTORY)?"checked":"default",MAIN_MENU:!0===_.includes(l.MAIN_MENU)?"checked":"default",NEWS:!0===_.includes(l.NEWS)?"checked":"default",SIDEMENU:!0===_.includes(l.SIDEMENU)?"checked":"default",LINKS:!0===_.includes(l.LINKS)?"checked":"default",CONTENT:!0===_.includes(l.CONTENT)?"checked":"default",CORPS:!0===_.includes(l.CORPS)?"checked":"default",COMMAND:!0===_.includes(l.COMMAND)?"checked":"default",MESSAGE:!0===_.includes(l.MESSAGE)?"checked":"default",CONTACTS:!0===_.includes(l.CONTACTS)?"checked":"default",GALERY:!0===_.includes(l.GALERY)?"checked":"default",VIDEO:!0===_.includes(l.VIDEO)?"checked":"default"};let m;m=o.type&&"system_user"===o.type?await e.find({_id:{$ne:o.id}}).select({_id:1}).lean():await e.find({creator:{id:o.id,login:o.login}}).select({_id:1}).lean();const g=m.map(e=>e._id.toString());g.includes(d.params.iduser)&&(c=!0);const w=await i.find({public_status:"active",isMain:!0}).select({_id:1,title:2,language:3}).lean(),f=await a.find({public_status:"active"}).select({_id:1,title:2,language:3}).lean(),I=await s.find().select({_id:1,title_ua:2}),E=await t.find().select({_id:1,title_ua:2}),A=await n.find().select({_id:1,title_ua:2}),M=await N.find().select({_id:1,title:2}),y=await e.find({$and:[{_id:{$nin:[o.id,d.params.iduser]}},{_id:{$in:g}}]}).select({_id:1,login:2});let O,C,h,v,U,T,P;w.unshift({_id:"ua",title:"Мова: українська",language:"ua"}),w.unshift({_id:"en",title:"Мова: англійська",language:"en"}),f.unshift({_id:"ua",title:"Мова: українська",language:"ua"}),f.unshift({_id:"en",title:"Мова: англійська",language:"en"});for(let e=0;e<_.length;e++)switch(_[e]){case l.PAGES:O=await S(u.id,l.PAGES);break;case l.NEWS:C=await S(u.id,l.NEWS);break;case l.COMMAND:h=await S(u.id,l.COMMAND);break;case l.CORPS:v=await S(u.id,l.CORPS);break;case l.LINKS:U=await S(u.id,l.LINKS);break;case l.CONTACTS:T=await S(u.id,l.CONTACTS);break;case l.USER:P=await S(u.id,l.USER)}return r.render("edit_user",{login:u.login,email:u.email,password:u.password,type:u.type,description_user:u.description_user,operation:u.operation,userid:o.id,USER:p.USER,PAGES:p.PAGES,HISTORY:p.HISTORY,MAIN_MENU:p.MAIN_MENU,NEWS:p.NEWS,SIDEMENU:p.SIDEMENU,LINKS:p.LINKS,CONTENT:p.CONTENT,CORPS:p.CORPS,COMMAND:p.COMMAND,MESSAGE:p.MESSAGE,CONTACTS:p.CONTACTS,GALERY:p.GALERY,VIDEO:p.VIDEO,action_type:"edit/".concat(d.params.iduser),edited_userid:d.params.iduser,id_news:d.params.iduser,parameter:"visible",pass_visible:"visible",edit:c,pagesData:{list:w,selectedIds:O},newsData:{list:f,selectedIds:C},commandData:{list:I,selectedIds:h},corpsData:{list:E,selectedIds:v},linksData:{list:A,selectedIds:U},userData:{list:y,selectedIds:P},contactsData:{list:M,selectedIds:T}})}return r.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(o.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:o.id})}return null===await m(d.session,o.id,r)?r.redirect("/admin/login"):r.status(400).json("Час сесії минув, авторизуйтесь знову!")},module.exports.getAddForm=async(d,r)=>{const o=await e.findById(u.getId(d));try{if(!0===await m(d.session,o.id,r)){if(await _(o.id,l.USER)){const l=(await e.find({_id:{$ne:o.id}}).select({_id:1}).lean()).map(e=>e._id.toString()),c=await i.find({public_status:"active",isMain:!0}).select({_id:1,title:2,language:3}).lean(),_=await a.find({public_status:"active"}).select({_id:1,title:2,language:3}).lean(),p=await s.find().select({_id:1,title_ua:2}),m=await t.find().select({_id:1,title_ua:2}),g=await n.find().select({_id:1,title_ua:2}),w=await N.find().select({_id:1,title:2}),f=await e.find({$and:[{_id:{$nin:[o.id,d.params.iduser]}},{_id:{$in:l}}]}).select({_id:1,login:2});return c.unshift({_id:"ua",title:"Мова: українська",language:"ua"}),c.unshift({_id:"en",title:"Мова: англійська",language:"en"}),_.unshift({_id:"ua",title:"Мова: українська",language:"ua"}),_.unshift({_id:"en",title:"Мова: англійська",language:"en"}),r.render("edit_user",{parameter:"hidden",userid:u.getId(d),action_type:"add",pass_visible:"visible",edit:!0,pagesData:{list:c,selectedIds:[]},newsData:{list:_,selectedIds:[]},commandData:{list:p,selectedIds:[]},corpsData:{list:m,selectedIds:[]},linksData:{list:g,selectedIds:[]},userData:{list:f,selectedIds:[]},contactsData:{list:w,selectedIds:[]}})}return r.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:"/admin/".concat(o.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:o.id})}return null===await m(d.session,o.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})}catch(c){console.error(c)}},module.exports.addUser=async(i,a)=>{const s=await e.findById(u.getId(i));if(await _(s.id,l.USER)){const t=u.getId(i),{USER:n,PAGES:l,HISTORY:_,MAIN_MENU:p,NEWS:m,SIDEMENU:g,LINKS:f,CONTENT:E,CORPS:S,MESSAGE:N,CONTACTS:A,GALERY:M,VIDEO:y,selectUserCategories:O,user_pages:C,user_news:h,user_menu:v,user_links:U,user_corps:T,user_command:P,user_users:D,user_contacts:R}=i.body,b={user_pages:C,user_news:h,user_menu:v,user_links:U,user_corps:T,user_command:P,user_users:D,user_contacts:R};let k=[],G=[];switch(O){case"all":k=o();break;case"setup":G=[{name:"USER",value:n},{name:"PAGES",value:l},{name:"HISTORY",value:_},{name:"MAIN_MENU",value:p},{name:"NEWS",value:m},{name:"SIDEMENU",value:g},{name:"LINKS",value:f},{name:"CONTENT",value:E},{name:"CORPS",value:S},{name:"COMMAND",value:I},{name:"MESSAGE",value:N},{name:"CONTACTS",value:A},{name:"GALERY",value:M},{name:"VIDEO",value:y}],k=c(G,b)}if(!1===await w(i.body.login)){if(""!==i.body.password){const n=new e({login:i.body.login,email:i.body.email,password:d.hashpassword(i.body.password),type:i.body.type,operation:k,creator:{id:s.id,login:s.login},description_user:i.body.description_user});await n.save();const u=await e.findById({_id:t}),l=new r({type_content:"Користувач",operation:"Створення користувача: ".concat(n.login),user:u.login});return await l.save(),a.redirect("./1")}return a.status(400).render("infopage",{info:"Для створення користувача обов'язковий Пароль!!",url:"/admin/".concat(s.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:s.id})}return a.status(400).render("infopage",{info:"Користувач з цим логіном вже зареєстрвано, виберіть інший Логін",url:"/admin/".concat(s.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:s.id})}return a.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:"/admin/".concat(s.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:s.id})},module.exports.removeUser=async(i,a)=>{const s=await e.findById(u.getId(i)),t=u.getId(i);if(!0!==await g(i.params.iduser,s.id,1))return null===await g(i.params.iduser,s.id,1)?a.status(400).render("infopage",{info:"Неможливо видалити поточного користувача!",url:"/admin/".concat(s.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:s.id}):a.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(s.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:s.id});try{const s=await e.findByIdAndRemove(i.params.iduser),n=await e.findById(t);return new r({type_content:"Користувач",operation:"Видалення користувача ".concat(s.login),user:n.login}).save(),a.redirect("../1")}catch(n){console.error(n)}},module.exports.getEditUserPassword=async(i,a)=>{const s=await e.findById(u.getId(i));return!0===await m(i.session,s.id,a)?!0===await g(i.params.iduser,s.id,0)?a.render("edit_password",{edited_userid:i.params.iduser,userid:s.id}):a.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(s.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:s.id}):null===await m(i.session,s.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})},module.exports.postEditUserPassword=async(i,a)=>{const s=await e.findById(u.getId(i)),t=i.params.iduser;if(!0===await m(i.session,s.id,a)){if(!0===await g(t,s.id,0)){const{old_password:n,new_password1:u,new_password2:l}=i.body,o=await e.findById(t).select({_id:1,password:2});return d.hashpassword(n)===o.password?u===l?(await e.findByIdAndUpdate(o.id,{password:d.hashpassword(u)}),await new r({type_content:"Користувач",operation:"Редагування паролю для користувача: ".concat(o.login),user:s.login}).save(),a.redirect("../../1")):a.render("edit_password",{old_password:n,edited_userid:o.id,userid:s.id}):a.redirect("./password")}return a.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(s.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:s.id})}return null===await m(i.session,s.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})},module.exports.getMainPage=async(i,a)=>{const s=await e.findById(u.getId(i));return!0===await m(i.session,s.id,a)?a.render("start_main_menu",{user:s.id,nameuser:s.login}):null===await m(i.session,s.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})};