"use strict";const e=require("../Models/User"),i=require("../API/hashing_password"),a=require("../Models/History"),s=require("../API/getAdminid"),r=require("../API/op_categories"),d=require("../API/checkUserOperation"),{ValidSession:t}=require("../API/Session/session"),{checkEditPermission:n,checkNameMatching:o}=require("../API/userAPI/validatonUserPermission"),{NormaLizeUserList:u}=require("../API/userAPI/UserList"),{COMMAND:l}=require("../API/op_categories");module.exports.getAllUser=async(i,a)=>{const r=await e.findById(s.getId(i));if(!0===await t(i.session,r.id,a))try{let e;const d=await u();e="system_user"===r.type;let{page:t}=i.params;const n=r.settings.recordsPerPage.users,o=Math.ceil(d.length/n);(t<1||t>o)&&(t=1);const l=d.slice(n*(t-1),t*n);return a.render("main_menu_users",{status:e,user:s.getId(i),users:l,pages:o,current_page:t})}catch(d){console.log(d)}return null===await t(i.session,r.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.editUser=async(r,o)=>{const u=await e.findById(s.getId(r));if(!0===await t(r.session,u.id,o)){if(!0!==await n(r.params.iduser,u.id))return o.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${u.id}/user/1`,url_text:"Повернутися до списку користувачів",user:u.id});if(u.id===r.params.iduser&&"system_user"!==u.type){const d=await e.findOne({_id:r.params.iduser});await e.findByIdUpdate(r.params.iduser,{login:r.body.login,email:r.body.email,password:r.body.password===d.password?r.body.password:i.hashpassword(r.body.password),auth_status:!1,session:null});const t=await e.findById({_id:s.getId(r)});return new a({type_content:"Користувач",operation:`Редагування користувача: ${d.login} `,user:t.login}).save(),o.redirect("../1")}{const i=await e.findOne({_id:r.params.iduser}),{USER:t,PAGES:n,HISTORY:u,MAIN_MENU:p,NEWS:c,SIDEMENU:m,LINKS:g,CONTENT:w,CORPS:f,COMMAND:I,ALL:N}=r.body,y=[{name:"ALL",value:N},{name:"USER",value:t},{name:"PAGES",value:n},{name:"HISTORY",value:u},{name:"MAIN_MENU",value:p},{name:"NEWS",value:c},{name:"SIDEMENU",value:m},{name:"LINKS",value:g},{name:"CONTENT",value:w},{name:"CORPS",value:f},{name:"COMMAND",value:I}];try{await e.findByIdAndUpdate(r.params.iduser,{login:r.body.login,email:r.body.email,operation:d.getOperation(y),auth_status:!1,session:null});const t=await e.findById({_id:s.getId(r)});return new a({type_content:"Користувач",operation:`Редагування користувача: ${i.login} `,user:t.login}).save(),o.redirect("../1")}catch(l){console.log(l)}}}return null===await t(r.session,u.id,o)?o.redirect("/admin/login"):o.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getEditUser=async(i,a)=>{const d=await e.findById(s.getId(i));if(!0===await t(i.session,d.id,a)){if(!0===await n(i.params.iduser,d.id)){const s=await e.findOne({_id:i.params.iduser});let t=!0;const n={USER:!0===s.operation.includes(r.USER)?"checked":"default",PAGES:!0===s.operation.includes(r.PAGES)?"checked":"default",HISTORY:!0===s.operation.includes(r.HISTORY)?"checked":"default",MAIN_MENU:!0===s.operation.includes(r.MAIN_MENU)?"checked":"default",NEWS:!0===s.operation.includes(r.NEWS)?"checked":"default",SIDEMENU:!0===s.operation.includes(r.SIDEMENU)?"checked":"default",LINKS:!0===s.operation.includes(r.LINKS)?"checked":"default",CONTENT:!0===s.operation.includes(r.CONTENT)?"checked":"default",CORPS:!0===s.operation.includes(r.CORPS)?"checked":"default",COMMAND:!0===s.operation.includes(r.COMMAND)?"checked":"default"};return d.id===i.params.iduser&&"system_user"!==d.type&&(t=!1),a.render("edit_user",{login:s.login,email:s.email,password:s.password,type:s.type,operation:s.operation,userid:d.id,USER:n.USER,PAGES:n.PAGES,HISTORY:n.HISTORY,MAIN_MENU:n.MAIN_MENU,NEWS:n.NEWS,SIDEMENU:n.SIDEMENU,LINKS:n.LINKS,CONTENT:n.CONTENT,CORPS:n.CORPS,COMMAND:n.COMMAND,action_type:"edit/"+i.params.iduser,edited_userid:i.params.iduser,id_news:i.params.iduser,parameter:"visible",pass_visible:"visible",edit:t})}return a.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${d.id}/user/1`,url_text:"Повернутися до списку користувачів",user:d.id})}return null===await t(i.session,d.id,a)?a.redirect("/admin/login"):a.status(400).json("Час сесії минув, авторизуйтесь знову!")},module.exports.getAddForm=async(i,a)=>{const d=await e.findById(s.getId(i));try{return!0===await t(i.session,d.id,a)?d.operation.includes(r.USER)?a.render("edit_user",{parameter:"hidden",userid:s.getId(i),action_type:"add",pass_visible:"visible",edit:!0}):a.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:`/admin/${d.id}/user/1`,url_text:"Повернутися до списку користувачів",user:d.id}):null===await t(i.session,d.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}catch(n){console.log(n)}},module.exports.addUser=async(t,n)=>{const{USER:u,PAGES:p,HISTORY:c,MAIN_MENU:m,NEWS:g,SIDEMENU:w,LINKS:f,CONTENT:I,CORPS:N,ALL:y}=t.body,E=[{name:"ALL",value:y},{name:"USER",value:u},{name:"PAGES",value:p},{name:"HISTORY",value:c},{name:"MAIN_MENU",value:m},{name:"NEWS",value:g},{name:"SIDEMENU",value:w},{name:"LINKS",value:f},{name:"CONTENT",value:I},{name:"CORPS",value:N},{name:"COMMAND",value:l}],_=await e.findById(s.getId(t));if(_.operation.includes(r.USER)){const r=s.getId(t);if(!1===await o(t.body.login)){if(""!==t.body.password){const s=new e({login:t.body.login,email:t.body.email,password:i.hashpassword(t.body.password),type:t.body.type,operation:d.getOperation(E),creator:{id:_.id,login:_.login}});await s.save();const o=await e.findById({_id:r}),u=new a({type_content:"Користувач",operation:"Створення користувача: "+s.login,user:o.login});return await u.save(),n.redirect("./1")}return n.status(400).render("infopage",{info:"Для створення користувача обов'язковий Пароль!!",url:`/admin/${_.id}/user/1`,url_text:"Повернутися до списку користувачів",user:_.id})}return n.status(400).render("infopage",{info:"Користувач з цим логіном вже зареєстрвано, виберіть інший Логін",url:`/admin/${_.id}/user/1`,url_text:"Повернутися до списку користувачів",user:_.id})}return n.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:`/admin/${_.id}/user/1`,url_text:"Повернутися до списку користувачів",user:_.id})},module.exports.removeUser=async(i,r)=>{const d=await e.findById(s.getId(i)),t=s.getId(i),o=await e.findOne({_id:i.params.iduser});if(!0!==await n(i.params.iduser,d.id))return r.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${d.id}/user/1`,url_text:"Повернутися до списку користувачів",user:d.id});try{await e.findByIdAndRemove(i.params.iduser);const s=await e.findById(t);return new a({type_content:"Користувач",operation:"Видалення користувача "+o.login,user:s.login}).save(),r.redirect("../1")}catch(u){console.log(u)}},module.exports.getEditUserPassword=async(i,a)=>{const r=await e.findById(s.getId(i));return!0===await t(i.session,r.id,a)?!0===await n(i.params.iduser,r.id)?a.render("edit_password",{edited_userid:i.params.iduser,userid:r.id}):a.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${r.id}/user/1`,url_text:"Повернутися до списку користувачів",user:r.id}):null===await t(i.session,r.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.postEditUserPassword=async(r,d)=>{const o=await e.findById(s.getId(r)),u=r.params.iduser;if(!0===await t(r.session,o.id,d)){if(!0===await n(u,o.id)){const{old_password:s,new_password1:t,new_password2:n}=r.body,l=await e.findById(u).select({_id:1,password:2});if(i.hashpassword(s)===l.password){if(t===n){await e.findByIdAndUpdate(l.id,{password:i.hashpassword(t)});new a({type_content:"Користувач",operation:"Редагування паролю для користувача: "+l.login,user:o.login});return d.redirect("../../1")}return d.render("edit_password",{old_password:s,edited_userid:l.id,userid:o.id})}return d.redirect("./password")}return d.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${o.id}/user/1`,url_text:"Повернутися до списку користувачів",user:o.id})}return null===await t(r.session,o.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})};