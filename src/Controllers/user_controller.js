"use strict";const e=require("../Models/User"),i=require("../API/hashing_password"),a=require("../Models/History"),r=require("../API/getAdminid"),s=require("../API/op_categories"),d=require("../API/checkUserOperation"),{ValidSession:n}=require("../API/Session/session"),{checkEditPermission:t,checkNameMatching:o}=require("../API/userAPI/validatonUserPermission"),{NormaLizeUserList:u}=require("../API/userAPI/UserList"),{COMMAND:l,MESSAGE:p}=require("../API/op_categories");module.exports.getAllUser=async(i,a)=>{const s=await e.findById(r.getId(i));if(!0===await n(i.session,s.id,a))try{let e;const d=await u();e="system_user"===s.type;let{page:n}=i.params;const t=s.settings.recordsPerPage.users,o=Math.ceil(d.length/t);(n<1||n>o)&&(n=1);const l=d.slice(t*(n-1),n*t);return a.render("main_menu_users",{status:e,user:r.getId(i),users:l,pages:o,current_page:n})}catch(d){console.log(d)}return null===await n(i.session,s.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})},module.exports.editUser=async(i,s)=>{const o=await e.findById(r.getId(i));if(!0===await n(i.session,o.id,s)){if(!0!==await t(i.params.iduser,o.id,0))return s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${o.id}/user/1`,url_text:"Повернутися до списку користувачів",user:o.id});if(o.id===i.params.iduser&&"system_user"!==o.type){const d=await e.findOne({_id:i.params.iduser});await e.findByIdAndUpdate(i.params.iduser,{login:i.body.login,email:i.body.email});const n=await e.findById({_id:r.getId(i)});return new a({type_content:"Користувач",operation:`Редагування користувача: ${d.login} `,user:n.login}).save(),s.redirect("../1")}{const n=await e.findOne({_id:i.params.iduser}),{USER:t,PAGES:o,HISTORY:l,MAIN_MENU:p,NEWS:c,SIDEMENU:m,LINKS:g,CONTENT:E,CORPS:S,COMMAND:f,MESSAGE:w,ALL:I}=i.body,N=[{name:"ALL",value:I},{name:"USER",value:t},{name:"PAGES",value:o},{name:"HISTORY",value:l},{name:"MAIN_MENU",value:p},{name:"NEWS",value:c},{name:"SIDEMENU",value:m},{name:"LINKS",value:g},{name:"CONTENT",value:E},{name:"CORPS",value:S},{name:"COMMAND",value:f},{name:"MESSAGE",value:w}];try{await e.findByIdAndUpdate(i.params.iduser,{login:i.body.login,email:i.body.email,operation:d.getOperation(N),auth_status:!1,session:null});const t=await e.findById({_id:r.getId(i)});return new a({type_content:"Користувач",operation:`Редагування користувача: ${n.login} `,user:t.login}).save(),s.redirect("../1")}catch(u){console.log(u)}}}return null===await n(i.session,o.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.getEditUser=async(i,a)=>{const d=await e.findById(r.getId(i));if(!0===await n(i.session,d.id,a)){if(!0===await t(i.params.iduser,d.id,0)){const r=await e.findOne({_id:i.params.iduser});let n=!0;const t={USER:!0===r.operation.includes(s.USER)?"checked":"default",PAGES:!0===r.operation.includes(s.PAGES)?"checked":"default",HISTORY:!0===r.operation.includes(s.HISTORY)?"checked":"default",MAIN_MENU:!0===r.operation.includes(s.MAIN_MENU)?"checked":"default",NEWS:!0===r.operation.includes(s.NEWS)?"checked":"default",SIDEMENU:!0===r.operation.includes(s.SIDEMENU)?"checked":"default",LINKS:!0===r.operation.includes(s.LINKS)?"checked":"default",CONTENT:!0===r.operation.includes(s.CONTENT)?"checked":"default",CORPS:!0===r.operation.includes(s.CORPS)?"checked":"default",COMMAND:!0===r.operation.includes(s.COMMAND)?"checked":"default",MESSAGE:!0===r.operation.includes(s.MESSAGE)?"checked":"default"};return d.id===i.params.iduser&&"system_user"!==d.type&&(n=!1),a.render("edit_user",{login:r.login,email:r.email,password:r.password,type:r.type,operation:r.operation,userid:d.id,USER:t.USER,PAGES:t.PAGES,HISTORY:t.HISTORY,MAIN_MENU:t.MAIN_MENU,NEWS:t.NEWS,SIDEMENU:t.SIDEMENU,LINKS:t.LINKS,CONTENT:t.CONTENT,CORPS:t.CORPS,COMMAND:t.COMMAND,MESSAGE:t.MESSAGE,action_type:"edit/"+i.params.iduser,edited_userid:i.params.iduser,id_news:i.params.iduser,parameter:"visible",pass_visible:"visible",edit:n})}return a.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${d.id}/user/1`,url_text:"Повернутися до списку користувачів",user:d.id})}return null===await n(i.session,d.id,a)?a.redirect("/admin/login"):a.status(400).json("Час сесії минув, авторизуйтесь знову!")},module.exports.getAddForm=async(i,a)=>{const d=await e.findById(r.getId(i));try{return!0===await n(i.session,d.id,a)?d.operation.includes(s.USER)?a.render("edit_user",{parameter:"hidden",userid:r.getId(i),action_type:"add",pass_visible:"visible",edit:!0}):a.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:`/admin/${d.id}/user/1`,url_text:"Повернутися до списку користувачів",user:d.id}):null===await n(i.session,d.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}catch(t){console.log(t)}},module.exports.addUser=async(n,t)=>{const{USER:u,PAGES:p,HISTORY:c,MAIN_MENU:m,NEWS:g,SIDEMENU:E,LINKS:S,CONTENT:f,CORPS:w,ALL:I,MESSAGE:N}=n.body,_=[{name:"ALL",value:I},{name:"USER",value:u},{name:"PAGES",value:p},{name:"HISTORY",value:c},{name:"MAIN_MENU",value:m},{name:"NEWS",value:g},{name:"SIDEMENU",value:E},{name:"LINKS",value:S},{name:"CONTENT",value:f},{name:"CORPS",value:w},{name:"COMMAND",value:l},{name:"MESSAGE",value:N}],y=await e.findById(r.getId(n));if(y.operation.includes(s.USER)){const s=r.getId(n);if(!1===await o(n.body.login)){if(""!==n.body.password){const r=new e({login:n.body.login,email:n.body.email,password:i.hashpassword(n.body.password),type:n.body.type,operation:d.getOperation(_),creator:{id:y.id,login:y.login}});await r.save();const o=await e.findById({_id:s}),u=new a({type_content:"Користувач",operation:"Створення користувача: "+r.login,user:o.login});return await u.save(),t.redirect("./1")}return t.status(400).render("infopage",{info:"Для створення користувача обов'язковий Пароль!!",url:`/admin/${y.id}/user/1`,url_text:"Повернутися до списку користувачів",user:y.id})}return t.status(400).render("infopage",{info:"Користувач з цим логіном вже зареєстрвано, виберіть інший Логін",url:`/admin/${y.id}/user/1`,url_text:"Повернутися до списку користувачів",user:y.id})}return t.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:`/admin/${y.id}/user/1`,url_text:"Повернутися до списку користувачів",user:y.id})},module.exports.removeUser=async(i,s)=>{const d=await e.findById(r.getId(i)),n=r.getId(i),o=await e.findOne({_id:i.params.iduser});if(!0!==await t(i.params.iduser,d.id,1))return null===await t(i.params.iduser,d.id,1)?s.status(400).render("infopage",{info:"Неможливо видалити поточного користувача!",url:`/admin/${d.id}/user/1`,url_text:"Повернутися до списку користувачів",user:d.id}):s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${d.id}/user/1`,url_text:"Повернутися до списку користувачів",user:d.id});try{await e.findByIdAndRemove(i.params.iduser);const r=await e.findById(n);return new a({type_content:"Користувач",operation:"Видалення користувача "+o.login,user:r.login}).save(),s.redirect("../1")}catch(u){console.log(u)}},module.exports.getEditUserPassword=async(i,a)=>{const s=await e.findById(r.getId(i));return!0===await n(i.session,s.id,a)?!0===await t(i.params.iduser,s.id,0)?a.render("edit_password",{edited_userid:i.params.iduser,userid:s.id}):a.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${s.id}/user/1`,url_text:"Повернутися до списку користувачів",user:s.id}):null===await n(i.session,s.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})},module.exports.postEditUserPassword=async(s,d)=>{const o=await e.findById(r.getId(s)),u=s.params.iduser;if(!0===await n(s.session,o.id,d)){if(!0===await t(u,o.id,0)){const{old_password:r,new_password1:n,new_password2:t}=s.body,l=await e.findById(u).select({_id:1,password:2});if(i.hashpassword(r)===l.password){if(n===t){await e.findByIdAndUpdate(l.id,{password:i.hashpassword(n)});new a({type_content:"Користувач",operation:"Редагування паролю для користувача: "+l.login,user:o.login});return d.redirect("../../1")}return d.render("edit_password",{old_password:r,edited_userid:l.id,userid:o.id})}return d.redirect("./password")}return d.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:`/admin/${o.id}/user/1`,url_text:"Повернутися до списку користувачів",user:o.id})}return null===await n(s.session,o.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})};