"use strict";const e=require("../Models/User"),i=require("../Models/Content"),s=require("../Models/Command"),a=require("../Models/Corps"),t=require("../Models/Link"),r=require("../API/hashing_password"),d=require("../Models/History"),n=require("../API/getAdminid"),u=require("../API/op_categories"),{setAllOperation:o,getOperation:l}=require("../API/checkUserOperation"),c=require("../API/userAPI/hasAccess"),_=require("../API/MainMenuApi/getAllMenu"),{ValidSession:p}=require("../API/Session/session"),{checkEditPermission:m,checkNameMatching:g}=require("../API/userAPI/validatonUserPermission"),{NormaLizeUserList:w}=require("../API/userAPI/UserList"),{COMMAND:f,MESSAGE:S}=require("../API/op_categories"),I=require("../API/userAPI/enabledIds"),E=require("../Models/Contact");module.exports.getAllUser=async(i,s)=>{const a=await e.findById(n.getId(i));if(!0===await p(i.session,a.id,s))try{let e;const t=await I(a.id,u.USER),r=await w(t);e="system_user"===a.type;let{page:d}=i.params;const o=a.settings.recordsPerPage.users,l=Math.ceil(r.length/o);(d<1||d>l)&&(d=1);const c=r.slice(o*(d-1),d*o);return s.render("main_menu_users",{status:e,user:n.getId(i),users:c,pages:l,current_page:d})}catch(t){console.error(t)}return null===await p(i.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.editUser=async(i,s)=>{const a=await e.findById(n.getId(i));if(!0===await p(i.session,a.id,s)){if(!0!==await m(i.params.iduser,a.id,0))return s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id});{if(a.id===i.params.iduser&&"system_user"!==a.type){const a=await e.findOne({_id:i.params.iduser});await e.findByIdAndUpdate(i.params.iduser,{login:i.body.login,email:i.body.email,description_user:i.body.description_user});const t=await e.findById({_id:n.getId(i)});return new d({type_content:"Користувач",operation:"Редагування користувача: ".concat(a.login," "),user:t.login}).save(),s.redirect("../1")}const r=await e.findOne({_id:i.params.iduser}),{USER:u,PAGES:c,HISTORY:_,MAIN_MENU:p,NEWS:m,SIDEMENU:g,LINKS:w,CONTENT:f,CORPS:S,COMMAND:I,MESSAGE:E,CONTACTS:N,user_pages:y,user_news:A,user_menu:M,user_links:C,user_corps:O,user_command:h,user_users:U,user_contacts:T,selectUserCategories:P}=i.body,v={user_pages:y,user_news:A,user_menu:M,user_links:C,user_corps:O,user_command:h,user_users:U,user_contacts:T};let b=[],D=[];switch(P){case"all":b=o();break;case"setup":D=[{name:"USER",value:u},{name:"PAGES",value:c},{name:"HISTORY",value:_},{name:"MAIN_MENU",value:p},{name:"NEWS",value:m},{name:"SIDEMENU",value:g},{name:"LINKS",value:w},{name:"CONTENT",value:f},{name:"CORPS",value:S},{name:"COMMAND",value:I},{name:"MESSAGE",value:E},{name:"CONTACTS",value:N}],b=l(D,v)}try{await e.findByIdAndUpdate(i.params.iduser,{login:i.body.login,email:i.body.email,description_user:i.body.description_user,operation:b,auth_status:!1,session:null});const a=await e.findById({_id:n.getId(i)});return new d({type_content:"Користувач",operation:"Редагування користувача: ".concat(r.login," "),user:a.login}).save(),s.redirect("../1")}catch(t){console.error(t)}}}return null===await p(i.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.getEditUser=async(r,d)=>{const o=await e.findById(n.getId(r));if(!0===await p(r.session,o.id,d)){if(!0===await m(r.params.iduser,o.id,0)){const n=await e.findOne({_id:r.params.iduser});let l=!1;const c=n.operation.map(e=>e.category),_={USER:!0===c.includes(u.USER)?"checked":"default",PAGES:!0===c.includes(u.PAGES)?"checked":"default",HISTORY:!0===c.includes(u.HISTORY)?"checked":"default",MAIN_MENU:!0===c.includes(u.MAIN_MENU)?"checked":"default",NEWS:!0===c.includes(u.NEWS)?"checked":"default",SIDEMENU:!0===c.includes(u.SIDEMENU)?"checked":"default",LINKS:!0===c.includes(u.LINKS)?"checked":"default",CONTENT:!0===c.includes(u.CONTENT)?"checked":"default",CORPS:!0===c.includes(u.CORPS)?"checked":"default",COMMAND:!0===c.includes(u.COMMAND)?"checked":"default",MESSAGE:!0===c.includes(u.MESSAGE)?"checked":"default",CONTACTS:!0===c.includes(u.CONTACTS)?"checked":"default"};let p;p=o.type&&"system_user"===o.type?await e.find({_id:{$ne:o.id}}).select({_id:1}).lean():await e.find({creator:{id:o.id,login:o.login}}).select({_id:1}).lean();const m=p.map(e=>e._id.toString());m.includes(r.params.iduser)&&(l=!0);const g=await i.find({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2}),w=await i.find({page_type:"news"}).select({_id:1,page_title:2}),f=await s.find().select({_id:1,title_ua:2}),S=await a.find().select({_id:1,title_ua:2}),N=await t.find().select({_id:1,title_ua:2}),y=await E.find().select({_id:1,title:2}),A=await e.find({$and:[{_id:{$nin:[o.id,r.params.iduser]}},{_id:{$in:m}}]}).select({_id:1,login:2});let M,C,O,h,U,T,P;g.unshift({_id:"contacts",page_title:"Контакти"}),g.unshift({_id:"files",page_title:"Нормативно-правова база"}),g.unshift({_id:"current",page_title:"Актуальне"}),g.unshift({_id:"historyWar",page_title:"Історія Війни"}),g.unshift({_id:"casual",page_title:"Звичайна"});for(let e=0;e<c.length;e++)switch(c[e]){case u.PAGES:M=await I(n.id,u.PAGES);break;case u.NEWS:C=await I(n.id,u.NEWS);break;case u.COMMAND:O=await I(n.id,u.COMMAND);break;case u.CORPS:h=await I(n.id,u.CORPS);break;case u.LINKS:U=await I(n.id,u.LINKS);break;case u.CONTACTS:T=await I(n.id,u.CONTACTS);break;case u.USER:P=await I(n.id,u.USER)}return d.render("edit_user",{login:n.login,email:n.email,password:n.password,type:n.type,description_user:n.description_user,operation:n.operation,userid:o.id,USER:_.USER,PAGES:_.PAGES,HISTORY:_.HISTORY,MAIN_MENU:_.MAIN_MENU,NEWS:_.NEWS,SIDEMENU:_.SIDEMENU,LINKS:_.LINKS,CONTENT:_.CONTENT,CORPS:_.CORPS,COMMAND:_.COMMAND,MESSAGE:_.MESSAGE,CONTACTS:_.CONTACTS,action_type:"edit/".concat(r.params.iduser),edited_userid:r.params.iduser,id_news:r.params.iduser,parameter:"visible",pass_visible:"visible",edit:l,pagesData:{list:g,selectedIds:M},newsData:{list:w,selectedIds:C},commandData:{list:f,selectedIds:O},corpsData:{list:S,selectedIds:h},linksData:{list:N,selectedIds:U},userData:{list:A,selectedIds:P},contactsData:{list:y,selectedIds:T}})}return d.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(o.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:o.id})}return null===await p(r.session,o.id,d)?d.redirect("/admin/login"):d.status(400).json("Час сесії минув, авторизуйтесь знову!")},module.exports.getAddForm=async(r,d)=>{const o=await e.findById(n.getId(r));try{if(!0===await p(r.session,o.id,d)){if(await c(o.id,u.USER)){const u=(await e.find({_id:{$ne:o.id}}).select({_id:1}).lean()).map(e=>e._id.toString()),l=await i.find({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2}).lean(),c=await i.find({page_type:"news"}).select({_id:1,page_title:2}),_=await s.find().select({_id:1,title_ua:2}),p=await a.find().select({_id:1,title_ua:2}),m=await t.find().select({_id:1,title_ua:2}),g=await E.find().select({_id:1,title:2}),w=await e.find({$and:[{_id:{$nin:[o.id,r.params.iduser]}},{_id:{$in:u}}]}).select({_id:1,login:2});return l.unshift({_id:"contacts",page_title:"Контакти"}),l.unshift({_id:"files",page_title:"Нормативно-правова база"}),l.unshift({_id:"current",page_title:"Актуальне"}),l.unshift({_id:"historyWar",page_title:"Історія Війни"}),d.render("edit_user",{parameter:"hidden",userid:n.getId(r),action_type:"add",pass_visible:"visible",edit:!0,pagesData:{list:l,selectedIds:[]},newsData:{list:c,selectedIds:[]},commandData:{list:_,selectedIds:[]},corpsData:{list:p,selectedIds:[]},linksData:{list:m,selectedIds:[]},userData:{list:w,selectedIds:[]},contactsData:{list:g,selectedIds:[]}})}return d.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:"/admin/".concat(o.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:o.id})}return null===await p(r.session,o.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})}catch(l){console.error(l)}},module.exports.addUser=async(i,s)=>{const a=await e.findById(n.getId(i));if(await c(a.id,u.USER)){const t=n.getId(i),{USER:u,PAGES:c,HISTORY:_,MAIN_MENU:p,NEWS:m,SIDEMENU:w,LINKS:S,CONTENT:I,CORPS:E,MESSAGE:N,CONTACTS:y,selectUserCategories:A,user_pages:M,user_news:C,user_menu:O,user_links:h,user_corps:U,user_command:T,user_users:P,user_contacts:v}=i.body,b={user_pages:M,user_news:C,user_menu:O,user_links:h,user_corps:U,user_command:T,user_users:P,user_contacts:v};let D=[],R=[];switch(A){case"all":D=o();break;case"setup":R=[{name:"USER",value:u},{name:"PAGES",value:c},{name:"HISTORY",value:_},{name:"MAIN_MENU",value:p},{name:"NEWS",value:m},{name:"SIDEMENU",value:w},{name:"LINKS",value:S},{name:"CONTENT",value:I},{name:"CORPS",value:E},{name:"COMMAND",value:f},{name:"MESSAGE",value:N},{name:"CONTACTS",value:y}],D=l(R,b)}if(!1===await g(i.body.login)){if(""!==i.body.password){const n=new e({login:i.body.login,email:i.body.email,password:r.hashpassword(i.body.password),type:i.body.type,operation:D,creator:{id:a.id,login:a.login},description_user:i.body.description_user});await n.save();const u=await e.findById({_id:t}),o=new d({type_content:"Користувач",operation:"Створення користувача: ".concat(n.login),user:u.login});return await o.save(),s.redirect("./1")}return s.status(400).render("infopage",{info:"Для створення користувача обов'язковий Пароль!!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id})}return s.status(400).render("infopage",{info:"Користувач з цим логіном вже зареєстрвано, виберіть інший Логін",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id})}return s.status(400).render("infopage",{info:"Вам заборонено створювати нових користувачів!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id})},module.exports.removeUser=async(i,s)=>{const a=await e.findById(n.getId(i)),t=n.getId(i);if(!0!==await m(i.params.iduser,a.id,1))return null===await m(i.params.iduser,a.id,1)?s.status(400).render("infopage",{info:"Неможливо видалити поточного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id}):s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id});try{const a=await e.findByIdAndRemove(i.params.iduser),r=await e.findById(t);return new d({type_content:"Користувач",operation:"Видалення користувача ".concat(a.login),user:r.login}).save(),s.redirect("../1")}catch(r){console.error(r)}},module.exports.getEditUserPassword=async(i,s)=>{const a=await e.findById(n.getId(i));return!0===await p(i.session,a.id,s)?!0===await m(i.params.iduser,a.id,0)?s.render("edit_password",{edited_userid:i.params.iduser,userid:a.id}):s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id}):null===await p(i.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postEditUserPassword=async(i,s)=>{const a=await e.findById(n.getId(i)),t=i.params.iduser;if(!0===await p(i.session,a.id,s)){if(!0===await m(t,a.id,0)){const{old_password:n,new_password1:u,new_password2:o}=i.body,l=await e.findById(t).select({_id:1,password:2});return r.hashpassword(n)===l.password?u===o?(await e.findByIdAndUpdate(l.id,{password:r.hashpassword(u)}),await new d({type_content:"Користувач",operation:"Редагування паролю для користувача: ".concat(l.login),user:a.login}).save(),s.redirect("../../1")):s.render("edit_password",{old_password:n,edited_userid:l.id,userid:a.id}):s.redirect("./password")}return s.status(400).render("infopage",{info:"Вам заборонено редагувати даного користувача!",url:"/admin/".concat(a.id,"/user/1"),url_text:"Повернутися до списку користувачів",user:a.id})}return null===await p(i.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})};