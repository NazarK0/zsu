"use strict";const e=require("../Models/History"),r=require("../API/op_categories"),t=require("../Models/User"),i=require("../API/getAdminid"),s=require("../API/Converter"),{ValidSession:n}=require("../API/Session/session"),a=require("../API/constants/typeCategoryEdited"),o=require("../API/userAPI/hasAccess"),u=[{value:a.history},{value:a.news},{value:a.side},{value:a.sub},{value:a.commamnd},{value:a.user},{value:a.link},{value:a.troops}];module.exports.getAllHistory=async(a,d)=>{const l=await t.find(),c=await t.findById(i.getId(a));let g;if(!0===await n(a.session,c.id,d)){if(!(await o(c.id,r.HISTORY)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(c.id,"/main"),url_text:"Повернутися до Головного Меню",user:c.id});try{g="system_user"===c.type;let r=await e.find();if(0==r.length){const t=new e({type_content:"Історія",operation:"Очищення історії",user:c.login});await t.save(),r=await e.find()}r.reverse();let{page:t}=a.params;const n=c.settings.recordsPerPage.history,o=Math.ceil(r.length/n);(t<1||t>o)&&(t=1);r.slice(n*(t-1),t*n);return d.render("main_menu_history",{status:g,user:i.getId(a),users:JSON.parse(JSON.stringify(l)),history:s.getConvert(r),category:u,current_page:t})}catch(y){console.error(y)}}return null===await n(a.session,c.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:c.id})},module.exports.deleteHistory=async(r,s)=>{const a=await t.findById(i.getId(r));if(!0===await n(r.session,a.id,s)){if("system_user"!==a.type)return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});try{return await e.remove({}),s.redirect("./1")}catch(o){return s.status(400).json({message:"Error"})}}return null===await n(r.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})};