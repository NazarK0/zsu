"use strict";const e=require("../Models/History"),r=require("../API/op_categories"),t=require("../Models/User"),i=require("../API/getAdminid"),s=require("../API/Converter"),{ValidSession:n}=require("../API/Session/session");module.exports.getAllHistory=async(a,o)=>{const d=await t.findById(i.getId(a));let u;if(!0===await n(a.session,d.id,o)){if(!d.operation.includes(r.HISTORY))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{u="system_user"===d.type;let r=await e.find();if(0==r.length){const t=new e({type_content:"Історія",operation:"Очищення історії",user:d.login});await t.save(),r=await e.find()}r.reverse();let{page:t}=a.params;const n=d.settings.recordsPerPage.history,l=Math.ceil(r.length/n);(t<1||t>l)&&(t=1);const g=r.slice(n*(t-1),t*n);return o.render("main_menu_history",{status:u,user:i.getId(a),history:s.getConvert(g),pages:l,current_page:t})}catch(l){console.log(l)}}return null===await n(a.session,d.id,o)?o.redirect("/admin/login"):o.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})},module.exports.deleteHistory=async(r,s)=>{const a=await t.findById(i.getId(r));if(!0===await n(r.session,a.id,s)){if("system_user"!=a.type)return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});try{return await e.remove({}),s.redirect("./1")}catch(o){return s.status(400).json({message:"Error"})}}return null===await n(r.session,a.id,s)?s.redirect("/admin/login"):s.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})};