"use strict";const e=require("moment"),r=require("../Models/History"),t=require("../API/op_categories"),i=require("../Models/User"),s=require("../API/getAdminid"),a=require("../API/Converter"),{ValidSession:n}=require("../API/Session/session"),o=require("../API/constants/typeCategoryEdited"),u=require("../API/userAPI/hasAccess"),d=[{value:o.history},{value:o.news},{value:o.side},{value:o.sub},{value:o.commamnd},{value:o.user},{value:o.link},{value:o.troops}];module.exports.getAllHistory=async(a,o)=>{const l=await i.find(),c=await i.findById(s.getId(a));let m;if(!0===await n(a.session,c.id,o)){if(!(await u(c.id,t.HISTORY)))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(c.id,"/main"),url_text:"Повернутися до Головного Меню",user:c.id});try{m="system_user"===c.type;let t=await r.find().lean();0==t.length&&(await new r({type_content:"Історія",operation:"Очищення історії",user:c.login}).save(),t=await r.find().lean()),t.reverse();const i=t.map(({create_date:r,...t})=>{const i={...t};return i.create_date=e(r).format("DD.MM.YYYY:HH.mm"),i});let{page:n}=a.params;const u=c.settings.recordsPerPage.history,g=Math.ceil(t.length/u);(n<1||n>g)&&(n=1);t.slice(u*(n-1),n*u);return o.render("main_menu_history",{status:m,user:s.getId(a),users:JSON.parse(JSON.stringify(l)),history:i,category:d,current_page:n})}catch(g){console.error(g)}}return null===await n(a.session,c.id,o)?o.redirect("/admin/login"):o.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:c.id})},module.exports.deleteHistory=async(e,t)=>{const a=await i.findById(s.getId(e));if(!0===await n(e.session,a.id,t)){if("system_user"!==a.type)return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});try{return await r.remove({}),t.redirect("./1")}catch(o){return t.status(400).json({message:"Error"})}}return null===await n(e.session,a.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})};