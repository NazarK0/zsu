"use strict";const t=require("../Models/Contact"),e=require("../Models/History"),n=require("../Models/User"),i=require("../API/getAdminid"),a=require("../API/op_categories"),r=require("../API/Converter"),o=require("../API/constants/typeContact"),{ValidSession:d}=require("../API/Session/session"),s=require("../API/userAPI/hasAccess"),c=require("../API/userAPI/enabledIds");module.exports.getContactList=async(e,o)=>{const u=await n.findById(i.getId(e));if(!0===await d(e.session,u.id,o)){if(!(await s(u.id,a.CONTACTS)))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id});try{const n=await c(u.id,a.CONTACTS);let i={};n.length&&(i={_id:{$in:n}});const d=await t.find(i);let{page:s}=e.params;const l=u.settings.recordsPerPage.contacts,p=Math.ceil(d.length/l);(s<1||s>p)&&(s=1);const y=d.slice(l*(s-1),s*l);return o.render("main_menu_contacts",{user:u.id,contacts:r.getConvert(y),pages:p,current_page:s})}catch(l){console.log(l)}}return null===await d(e.session,u.id,o)?o.redirect("/admin/login"):o.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getAddContact=async(t,e)=>{const r=await n.findById(i.getId(t));if(!(await s(r.id,a.CONTACTS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id});{const t=[{value:o.EMAIL},{value:o.PHONE},{value:o.ADDRESS}];try{e.render("edit_contact",{action_type:"add",typesContact:t,userid:r.id,parameter:"hidden"})}catch(d){console.error(d)}}},module.exports.getEditContact=async(e,r)=>{const d=await n.findById(i.getId(e));if(!(await s(d.id,a.CONTACTS)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});{const n=[{value:o.EMAIL},{value:o.PHONE},{value:o.ADDRESS}];try{const{id:i,title:a,contact:o}=await t.findById(e.params.id);r.render("edit_contact",{title:a,contact:o,contactid:i,typesContact:n,userid:d.id,parameter:"visible",action_type:"edit/".concat(i)})}catch(c){console.error(c)}}},module.exports.postAddedContact=async(r,o)=>{const d=await n.findById(i.getId(r));if(!(await s(d.id,a.CONTACTS)))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});{const{title:n,contact:a,type:s}=r.body,u=new t({title:n,contact:a,type:s,user_id:i.getId(r)}),l=new e({type_content:" Контакт",operation:"Додавання контакту ".concat(n,"[").concat(a,"]"),user:d.login});try{await l.save(),await u.save(),o.status(200),o.redirect("./1")}catch(c){console.error(c)}}},module.exports.postEditedContact=async(r,o)=>{const d=await n.findById(i.getId(r));if(!(await s(d.id,a.CONTACTS)))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});{const{title:n,contact:i,type:a}=r.body;try{await t.findByIdAndUpdate(r.params.id,{title:n,contact:i,type:a,user_id:d.id});return new e({type_content:"Контакт",operation:"Редагування контакту ".concat(n),user:d.login}).save(),o.redirect("../1")}catch(c){console.error(c)}}},module.exports.deleteContact=async(r,o)=>{const d=await n.findById(i.getId(r));if(!(await s(d.id,a.CONTACTS)))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});try{const n=await t.findByIdAndDelete(r.params.id);return new e({type_content:"Контакт",operation:"Видалення контакту".concat(n.title),user:d.login}).save(),o.redirect("../1")}catch(c){console.error(c)}};