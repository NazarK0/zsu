"use strict";const t=require("../Models/Contact"),e=require("../Models/History"),n=require("../Models/User"),i=require("../API/getAdminid"),a=require("../API/op_categories"),r=require("../API/Converter"),d=require("../API/constants/typeContact"),{ValidSession:o}=require("../API/Session/session"),s=require("../API/userAPI/hasAccess"),c=require("../API/userAPI/enabledIds"),u=require("../API/constants/typeContact");module.exports.getContactList=async(e,d)=>{const u=await n.findById(i.getId(e));if(!0===await o(e.session,u.id,d)){if(!(await s(u.id,a.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id});try{const n=await c(u.id,a.CONTACTS);let i={};n.length&&(i={_id:{$in:n}});const o=await t.find(i);let{page:s}=e.params;const l=u.settings.recordsPerPage.contacts,p=Math.ceil(o.length/l);(s<1||s>p)&&(s=1);const y=o.slice(l*(s-1),s*l);return d.render("main_menu_contacts",{user:u.id,contacts:r.getConvert(y),pages:p,current_page:s})}catch(l){console.log(l)}}return null===await o(e.session,u.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getAddContact=async(t,e)=>{const r=await n.findById(i.getId(t));if(!(await s(r.id,a.CONTACTS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});{const t=[{value:d.EMAIL},{value:d.PHONE},{value:d.ADDRESS}];try{e.render("edit_contact",{action_type:"add",typesContact:t,userid:r.id,parameter:"hidden"})}catch(o){console.error(o)}}},module.exports.getEditContact=async(e,r)=>{const o=await n.findById(i.getId(e));if(!(await s(o.id,a.CONTACTS)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});{const n=[{value:d.EMAIL},{value:d.PHONE},{value:d.ADDRESS}];try{const{id:i,title:a,contact:d}=await t.findById(e.params.id);r.render("edit_contact",{title:a,contact:d,contactid:i,typesContact:n,userid:o.id,parameter:"visible",action_type:"edit/"+i})}catch(c){console.error(c)}}},module.exports.postAddedContact=async(r,d)=>{const o=await n.findById(i.getId(r));if(!(await s(o.id,a.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});{const{title:n,contact:a,type:s}=r.body,u=new t({title:n,contact:a,type:s,user_id:i.getId(r)}),l=new e({type_content:" Контакт",operation:`Додавання контакту ${n}[${a}]`,user:o.login});try{await l.save(),await u.save(),d.status(200),d.redirect("./1")}catch(c){console.error(c)}}},module.exports.postEditedContact=async(r,d)=>{const o=await n.findById(i.getId(r));if(!(await s(o.id,a.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});{const{title:n,contact:i,type:a}=r.body;try{await t.findByIdAndUpdate(r.params.id,{title:n,contact:i,type:a,user_id:o.id});return new e({type_content:"Контакт",operation:"Редагування контакту "+n,user:o.login}).save(),d.redirect("../1")}catch(c){console.error(c)}}},module.exports.deleteContact=async(r,d)=>{const o=await n.findById(i.getId(r));if(!(await s(o.id,a.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{const n=await t.findByIdAndDelete(r.params.id);return new e({type_content:"Контакт",operation:"Видалення контакту"+n.title,user:o.login}).save(),d.redirect("../1")}catch(c){console.error(c)}},module.exports.getContacts=async(e,r)=>{const d=await n.findById(i.getId(e));if(!(await s(d.id,a.CONTACTS)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{const e=await t.findOne({type:u.PHONE}),n=await t.findOne({type:u.EMAIL}),i=await t.findOne({type:u.ADDRESS}),a={user:d.id};return e&&(a.phone=e.contact),n&&(a.email=n.contact),i&&(a.address=i.contact),r.render("main_menu_contacts",a)}catch(o){console.error(o)}},module.exports.postSendContact=async(r,d)=>{const o=await n.findById(i.getId(r));if(!(await s(o.id,a.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{const{phone:n,email:i,address:a}=r.body,s=await t.findOne({type:u.PHONE}),c=await t.findOne({type:u.EMAIL}),l=await t.findOne({type:u.ADDRESS});s?await t.findByIdAndUpdate(s.id,{contact:n}):await new t({contact:n,type:u.PHONE,user_id:o.id}).save(),c?await t.findByIdAndUpdate(c.id,{contact:i}):await new t({contact:i,type:u.EMAIL,user_id:o.id}).save(),l?await t.findByIdAndUpdate(l.id,{contact:a}):await new t({contact:a,type:u.ADDRESS,user_id:o.id}).save();return new e({type_content:"Контакт",operation:"Оновлено контакти",user:o.login}).save(),d.redirect("./show")}catch(c){console.error(c)}};