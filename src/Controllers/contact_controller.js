"use strict";const t=require("../Models/Contact"),e=require("../Models/History"),n=require("../Models/User"),i=require("../API/getAdminid"),r=require("../API/op_categories"),a=require("../API/Converter"),{ValidSession:o}=require("../API/Session/session");module.exports.getContactList=async(e,d)=>{const s=await n.findById(i.getId(e));if(!0===await o(e.session,s.id,d)){if(!s.operation.includes(r.LINKS))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${s.id}/main`,url_text:"Повернутися до Головного Меню",user:s.id});try{const n=await t.find();let{page:i}=e.params;const r=s.settings.recordsPerPage.contacts,o=Math.ceil(n.length/r);(i<1||i>o)&&(i=1);const c=n.slice(r*(i-1),i*r);return d.render("main_menu_contacts",{user:s.id,contacts:a.getConvert(c),pages:o,current_page:i})}catch(c){console.log(c)}}return null===await o(e.session,s.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:s.id})},module.exports.getAddContact=async(t,e)=>{const a=await n.findById(i.getId(t));if(!a.operation.includes(r.LINKS))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});try{e.render("edit_contact",{action_type:"add",userid:a.id,parameter:"hidden"})}catch(o){console.log(o)}},module.exports.getEditContact=async(e,a)=>{const o=await n.findById(i.getId(e));if(!o.operation.includes(r.LINKS))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id});try{const{id:n,title:i,contact:r}=await t.findById(e.params.id);a.render("edit_contact",{title:i,contact:r,contactid:n,userid:o.id,parameter:"visible",action_type:"edit/"+n})}catch(d){console.log(d)}},module.exports.postAddedContact=async(a,o)=>{const d=await n.findById(i.getId(a));if(!d.operation.includes(r.LINKS))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});{const{title:n,contact:r}=a.body,c=new t({title:n,contact:r,user_id:i.getId(a)}),u=new e({type_content:" Контакт",operation:`Додавання контакту ${n}[${r}]`,user:d.login});try{await u.save(),await c.save(),o.status(200),o.redirect("./1")}catch(s){console.log(s)}}},module.exports.postEditedContact=async(a,o)=>{const d=await n.findById(i.getId(a));if(!d.operation.includes(r.LINKS))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});{const{title:n,contact:i}=a.body;try{await t.findByIdAndUpdate(a.params.id,{title:n,contact:i,user_id:d.id});return new e({type_content:"Контакт",operation:"Редагування контакту "+n,user:d.login}).save(),o.redirect("../1")}catch(s){console.log(s)}}},module.exports.deleteContact=async(a,o)=>{const d=await n.findById(i.getId(a));if(!d.operation.includes(r.LINKS))return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{const n=await t.findByIdAndDelete(a.params.id);return new e({type_content:"Контакт",operation:"Видалення контакту"+n.title,user:d.login}).save(),o.redirect("../1")}catch(s){console.log(s)}};