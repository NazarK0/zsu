"use strict";const t=require("../Models/Contact"),e=require("../Models/History"),n=require("../Models/User"),a=require("../API/getAdminid"),i=require("../API/op_categories"),r=require("../API/Converter"),d=require("../API/constants/typeContact"),{ValidSession:o}=require("../API/Session/session"),c=require("../API/userAPI/hasAccess"),s=require("../API/userAPI/enabledIds"),u=require("../API/constants/typeContact");module.exports.getContactList=async(e,d)=>{const u=await n.findById(a.getId(e));if(!0===await o(e.session,u.id,d)){if(!(await c(u.id,i.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id});try{const n=await s(u.id,i.CONTACTS);let a={};n.length&&(a={_id:{$in:n}});const o=await t.find(a);let{page:c}=e.params;const l=u.settings.recordsPerPage.contacts,p=Math.ceil(o.length/l);(c<1||c>p)&&(c=1);const y=o.slice(l*(c-1),c*l);return d.render("main_menu_contacts",{user:u.id,contacts:r.getConvert(y),pages:p,current_page:c})}catch(l){console.log(l)}}return null===await o(e.session,u.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getAddContact=async(t,e)=>{const r=await n.findById(a.getId(t));if(!(await c(r.id,i.CONTACTS)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id});{const t=[{value:d.EMAIL},{value:d.PHONE},{value:d.ADDRESS}];try{e.render("edit_contact",{action_type:"add",typesContact:t,userid:r.id,parameter:"hidden"})}catch(o){console.error(o)}}},module.exports.getEditContact=async(e,r)=>{const o=await n.findById(a.getId(e));if(!(await c(o.id,i.CONTACTS)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});{const n=[{value:d.EMAIL},{value:d.PHONE},{value:d.ADDRESS}];try{const{id:a,title:i,contact:d}=await t.findById(e.params.id);r.render("edit_contact",{title:i,contact:d,contactid:a,typesContact:n,userid:o.id,parameter:"visible",action_type:"edit/".concat(a)})}catch(s){console.error(s)}}},module.exports.postAddedContact=async(r,d)=>{const o=await n.findById(a.getId(r));if(!(await c(o.id,i.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});{const{title:n,contact:i,type:c}=r.body,u=new t({title:n,contact:i,type:c,user_id:a.getId(r)}),l=new e({type_content:" Контакт",operation:"Додавання контакту ".concat(n,"[").concat(i,"]"),user:o.login});try{await l.save(),await u.save(),d.status(200),d.redirect("./1")}catch(s){console.error(s)}}},module.exports.postEditedContact=async(r,d)=>{const o=await n.findById(a.getId(r));if(!(await c(o.id,i.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});{const{title:n,contact:a,type:i}=r.body;try{await t.findByIdAndUpdate(r.params.id,{title:n,contact:a,type:i,user_id:o.id});return new e({type_content:"Контакт",operation:"Редагування контакту ".concat(n),user:o.login}).save(),d.redirect("../1")}catch(s){console.error(s)}}},module.exports.deleteContact=async(r,d)=>{const o=await n.findById(a.getId(r));if(!(await c(o.id,i.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});try{const n=await t.findByIdAndDelete(r.params.id);return new e({type_content:"Контакт",operation:"Видалення контакту".concat(n.title),user:o.login}).save(),d.redirect("../1")}catch(s){console.error(s)}},module.exports.getContacts=async(e,r)=>{const d=await n.findById(a.getId(e));if(!(await c(d.id,i.CONTACTS)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});try{const e=await t.findOne({type:u.PHONE}),n=await t.findOne({type:u.EMAIL}),a=await t.findOne({type:u.ADDRESS}),i={user:d.id};return e&&(i.phone=e.contact),n&&(i.email=n.contact),a&&(i.address=a.contact),r.render("main_menu_contacts",i)}catch(o){console.error(o)}},module.exports.postSendContact=async(r,d)=>{const o=await n.findById(a.getId(r));if(!(await c(o.id,i.CONTACTS)))return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});try{const{phone:n,email:a,address:i}=r.body,c=await t.findOne({type:u.PHONE}),s=await t.findOne({type:u.EMAIL}),l=await t.findOne({type:u.ADDRESS});c?await t.findByIdAndUpdate(c.id,{contact:n}):await new t({contact:n,type:u.PHONE,user_id:o.id}).save(),s?await t.findByIdAndUpdate(s.id,{contact:a}):await new t({contact:a,type:u.EMAIL,user_id:o.id}).save(),l?await t.findByIdAndUpdate(l.id,{contact:i}):await new t({contact:i,type:u.ADDRESS,user_id:o.id}).save();return new e({type_content:"Контакт",operation:"Оновлено контакти",user:o.login}).save(),d.redirect("./show")}catch(s){console.error(s)}};