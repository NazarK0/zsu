"use strict";const e=require("lodash"),n=require("../Models/Menu"),t=require("../Models/Page"),a=require("../Models/ChildSub"),i=require("../Models/History"),d=require("../Models/User"),r=require("../API/getAdminid"),l=require("../API/op_categories"),{ValidSession:u}=require("../API/Session/session"),{getAll:s}=require("../API/getAllChildSub"),{getBody:o}=require("../API/childSubApi/getBody"),{updateChildSub:p,deleteChildSub:g}=require("../API/childSubApi/edit"),c=require("../API/userAPI/hasAccess"),{userFind:m}=require("../API/userAPI/findUser"),f=require("../Models/Link");module.exports.getMenu=async(e,t)=>{const a=await d.findById(r.getId(e));if(!(await c(a.id,l.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{language:i,submenuId:d=null}=e.params,r="ua"===i?"en":"ua";let l=await n.find({parentFK:d,language:i}).lean();l.sort((e,n)=>e.number-n.number);const u={langCurrent:i,langOther:r,menu:l,user:a.id};if(d){const{parentFK:e=null}=await n.findById(d).select({_id:0,parentFK:1}).lean();e&&(u.grandParent=e),u.parent=d}t.render("main_menu_menu",u)}},module.exports.getAddMenuItem=async(e,n)=>{const a=await d.findById(r.getId(e));if(!(await c(a.id,l.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{language:i,parent:d=null}=e.params,r={mode:"add",language:i,pagesList:await t.find({public_status:"active",isMain:!0,language:i,bindedToMenu:!1}).select({_id:1,title:2}).lean(),linksList:await f.find().lean(),user:a.id};d&&(r.parent=d),n.render("edit_menu",r)}},module.exports.postAddedMenuItem=async(e,a)=>{const u=await d.findById(r.getId(e));if(!(await c(u.id,l.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id});{const{language:d,parent:r=null}=e.params,{title:l,linkType:s,linkUrl:o=null,content__id:p=null}=e.body,g={title:l,language:d,parentFK:r,user_id:u.id,linkUrl:null,pageFK:null};switch(g.number=(await n.find({parentFK:r,language:d}).lean()).length+1,s){case"directLink":o&&o.trim().toLowerCase().startsWith("http")&&(g.linkUrl=o.trim());break;case"content":if(p){const e="photo-galery"===p||"video"===p;"null"!==p&&"unlink"!==p&&"photo-galery"!==p&&"video"!==p?(g.pageFK=p,await t.findByIdAndUpdate(p,{bindedToMenu:!0})):e&&(g.pageFK=p)}}const c=await new n(g).save();await new i({type_content:"Головне меню",operation:"Додавання пункту головного меню "+c.title,user:u.login}).save();const m=r?"../show/"+r:"./show";a.redirect(m)}},module.exports.getEditMenuItem=async(e,a)=>{const i=await d.findById(r.getId(e));if(!(await c(i.id,l.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id});{const{language:d,id:r}=e.params,l=await t.find({public_status:"active",isMain:!0,language:d,bindedToMenu:!1}).select({_id:1,title:2}).lean(),u=await f.find().lean(),s=await n.findById(r).lean(),o={mode:"edit",language:d,pagesList:l,linksList:u,user:i.id,id:r,title:s.title};if(s.linkUrl)o.currentContent=s.linkUrl;else if(s.pageFK){if("photo-galery"===s.pageFK||"video"===s.pageFK)switch(s.pageFK){case"photo-galery":o.currentContent="Фотогалерея";break;case"video":o.currentContent="Відео"}else{const e=await t.findById(s.pageFK).select({_id:0,title:1}).lean();o.currentContent=e.title}}else o.currentContent="Відсутній";s.parentFK&&(o.parent=s.parentFK),a.render("edit_menu",o)}},module.exports.postEditedMenuItem=async(e,a)=>{const u=await d.findById(r.getId(e));if(!(await c(u.id,l.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id});{const{id:d}=e.params,{title:r,linkType:l,linkUrl:s=null,content__id:o=null}=e.body,p={title:r,user_id:u.id},g=await n.findById(d).lean();switch(l){case"noLink":p.linkUrl=null,p.pageFK=null,g.pageFK&&"video"!==g.pageFK&&"photo-galery"!==g.pageFK&&await t.findByIdAndUpdate(g.pageFK,{bindedToMenu:!1});break;case"directLink":s&&s.trim().toLowerCase().startsWith("http")&&(p.linkUrl=s.trim());break;case"content":if(o){const e="unlink"===o,n="photo-galery"===o||"video"===o;"null"!==o&&"unlink"!==o&&"photo-galery"!==o&&"video"!==o?(p.pageFK=o,g.pageFK&&await t.findByIdAndUpdate(g.pageFK,{bindedToMenu:!1}),await t.findByIdAndUpdate(o,{bindedToMenu:!0})):e?(p.pageFK=null,g.pageFK&&"video"!==g.pageFK&&"photo-galery"!==g.pageFK&&await t.findByIdAndUpdate(g.pageFK,{bindedToMenu:!1})):n&&(p.pageFK=o,g.pageFK&&"video"!==g.pageFK&&"photo-galery"!==g.pageFK&&await t.findByIdAndUpdate(g.pageFK,{bindedToMenu:!1}))}}const c=await n.findByIdAndUpdate(d,p);await new i({type_content:"Головне меню",operation:"Редагування пункту головного меню "+c.title,user:u.login}).save();const m=c.parentFK?"../show/"+c.parentFK:"../show";a.redirect(m)}},module.exports.deleteMenuItem=async(e,a)=>{const u=await d.findById(r.getId(e));if(await c(u.id,l.MAIN_MENU)){const{id:d}=e.params,r=await n.findByIdAndDelete(d);r.pageFK&&"photo-galery"!==r.pageFK&&"video"!==r.pageFK&&t.findByIdAndUpdate(r.pageFK,{bindedToMenu:!1});let l=await n.find().where({language:r.language,parentFK:r.parentFK}).lean();l.sort((e,n)=>e.number-n.number);for(let e=0;e<l.length;e++)await n.findByIdAndUpdate(l[e]._id,{number:e+1});await new i({type_content:"Головне меню",operation:`Видалення пункту головного меню ${r.title} та всіх його підпунктів`,user:u.login}).save();const s=r.parentFK?"../show/"+r.parentFK:"../show";return a.redirect(s)}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id})},module.exports.setDown=async(e,t)=>{const a=await d.findById(r.getId(e));if(!(await c(a.id,l.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{id:a}=e.params,i=await n.findById(a).lean();null!=await n.findOneAndUpdate({number:i.number+1,parentFK:i.parentFK,language:i.language},{number:i.number})&&await n.findByIdAndUpdate(i._id,{$set:{number:i.number+1}});const d=i.parentFK?"../show/"+i.parentFK:"../show";t.redirect(d)}},module.exports.setUp=async(e,t)=>{const a=await d.findById(r.getId(e));if(!(await c(a.id,l.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{id:a}=e.params,i=await n.findById(a).lean();null!=await n.findOneAndUpdate({number:i.number-1,parentFK:i.parentFK,language:i.language},{number:i.number})&&await n.findByIdAndUpdate(i._id,{$set:{number:i.number-1}});const d=i.parentFK?"../show/"+i.parentFK:"../show";t.redirect(d)}};