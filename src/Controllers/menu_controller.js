"use strict";const e=require("lodash"),n=require("../Models/Menu"),t=require("../Models/Page"),a=require("../Models/ChildSub"),i=require("../Models/History"),d=require("../Models/User"),r=require("../API/getAdminid"),o=require("../API/op_categories"),{ValidSession:s}=require("../API/Session/session"),{getAll:u}=require("../API/getAllChildSub"),{getBody:l}=require("../API/childSubApi/getBody"),{updateChildSub:p,deleteChildSub:c}=require("../API/childSubApi/edit"),g=require("../API/userAPI/hasAccess"),{userFind:m}=require("../API/userAPI/findUser"),f=require("../Models/Link");module.exports.getMenu=async(e,t)=>{const a=await d.findById(r.getId(e));if(!(await g(a.id,o.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{language:i,submenuId:d=null}=e.params,r={langCurrent:i,langOther:"ua"===i?"en":"ua",menu:await n.find({parentFK:d,language:i}).sort({number:1}).lean(),user:a.id};if(d){const{parentFK:e=null}=await n.findById(d).select({_id:0,parentFK:1}).lean();e&&(r.grandParent=e),r.parent=d}t.render("main_menu_menu",r)}},module.exports.getAddMenuItem=async(e,n)=>{const a=await d.findById(r.getId(e));if(!(await g(a.id,o.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{language:i,parent:d=null}=e.params,r={mode:"add",language:i,pagesList:await t.find({public_status:"active",isMain:!0,language:i,bindedToMenu:!1}).select({_id:1,title:2}).lean(),linksList:await f.find().lean(),user:a.id};d&&(r.parent=d),n.render("edit_menu",r)}},module.exports.postAddedMenuItem=async(e,a)=>{const s=await d.findById(r.getId(e));if(!(await g(s.id,o.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(s.id,"/main"),url_text:"Повернутися до Головного Меню",user:s.id});{const{language:d,parent:r=null}=e.params,{title:o,linkType:u,linkUrl:l=null,content__id:p=null}=e.body,c={title:o,language:d,parentFK:r,user_id:s.id,linkUrl:null,pageFK:null};switch(c.number=(await n.find({parentFK:r}).lean()).length+1,u){case"directLink":l&&l.trim().toLowerCase().startsWith("http")&&(c.linkUrl=l.trim());break;case"content":if(p){const e="photo-galery"===p||"video"===p;"null"!==p&&"unlink"!==p&&"photo-galery"!==p&&"video"!==p?(c.pageFK=p,await t.findByIdAndUpdate(p,{bindedToMenu:!0})):e&&(c.pageFK=p)}}const g=await new n(c).save();await new i({type_content:"Головне меню",operation:"Додавання пункту головного меню ".concat(g.title),user:s.login}).save();const m=r?"../show/".concat(r):"./show";a.redirect(m)}},module.exports.getEditMenuItem=async(e,a)=>{const i=await d.findById(r.getId(e));if(!(await g(i.id,o.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const{language:d,id:r}=e.params,o=await t.find({public_status:"active",isMain:!0,language:d,bindedToMenu:!1}).select({_id:1,title:2}).lean(),s=await f.find().lean(),u=await n.findById(r).lean(),l={mode:"edit",language:d,pagesList:o,linksList:s,user:i.id,id:r,title:u.title};if(u.linkUrl)l.currentContent=u.linkUrl;else if(u.pageFK){if("photo-galery"===u.pageFK||"video"===u.pageFK)switch(u.pageFK){case"photo-galery":l.currentContent="Фотогалерея";break;case"video":l.currentContent="Відео"}else{const e=await t.findById(u.pageFK).select({_id:0,title:1}).lean();l.currentContent=e.title}}else l.currentContent="Відсутній";u.parentFK&&(l.parent=u.parentFK),a.render("edit_menu",l)}},module.exports.postEditedMenuItem=async(e,a)=>{const s=await d.findById(r.getId(e));if(!(await g(s.id,o.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(s.id,"/main"),url_text:"Повернутися до Головного Меню",user:s.id});{const{id:d}=e.params,{title:r,linkType:o,linkUrl:u=null,content__id:l=null}=e.body,p={title:r,user_id:s.id},c=await n.findById(d).lean();switch(o){case"noLink":p.linkUrl=null,p.pageFK=null,c.pageFK&&"video"!==c.pageFK&&"photo-galery"!==c.pageFK&&await t.findByIdAndUpdate(c.pageFK,{bindedToMenu:!1});break;case"directLink":u&&u.trim().toLowerCase().startsWith("http")&&(p.linkUrl=u.trim());break;case"content":if(l){const e="unlink"===l,n="photo-galery"===l||"video"===l;"null"!==l&&"unlink"!==l&&"photo-galery"!==l&&"video"!==l?(p.pageFK=l,c.pageFK&&await t.findByIdAndUpdate(c.pageFK,{bindedToMenu:!1}),await t.findByIdAndUpdate(l,{bindedToMenu:!0})):e?(p.pageFK=null,c.pageFK&&"video"!==c.pageFK&&"photo-galery"!==c.pageFK&&await t.findByIdAndUpdate(c.pageFK,{bindedToMenu:!1})):n&&(p.pageFK=l,c.pageFK&&"video"!==c.pageFK&&"photo-galery"!==c.pageFK&&await t.findByIdAndUpdate(c.pageFK,{bindedToMenu:!1}))}}const g=await n.findByIdAndUpdate(d,p);await new i({type_content:"Головне меню",operation:"Редагування пункту головного меню ".concat(g.title),user:s.login}).save();const m=g.parentFK?"../show/".concat(g.parentFK):"../show";a.redirect(m)}},module.exports.deleteMenuItem=async(e,a)=>{const s=await d.findById(r.getId(e));if(await g(s.id,o.MAIN_MENU)){const{id:d}=e.params,r=await n.findByIdAndDelete(d);r.pageFK&&"photo-galery"!==r.pageFK&&"video"!==r.pageFK&&t.findByIdAndUpdate(r.pageFK,{bindedToMenu:!1}),await new i({type_content:"Головне меню",operation:"Видалення пункту головного меню ".concat(r.title," та всіх його підпунктів"),user:s.login}).save();const o=r.parentFK?"../show/".concat(r.parentFK):"../show";return a.redirect(o)}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(s.id,"/main"),url_text:"Повернутися до Головного Меню",user:s.id})},module.exports.setDown=async(e,t)=>{const a=await d.findById(r.getId(e));if(!(await g(a.id,o.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{id:a}=e.params,i=await n.findById(a).lean(),d=1,r=(await n.find({parentFK:i.parentFK}).lean()).length;i.number>=d&&i.number<r&&(await n.findOneAndUpdate({parentFK:i.parentFK,number:i.number+1},{number:i.number}),await n.findByIdAndUpdate(a,{number:i.number+1}));const o=i.parentFK?"../show/".concat(i.parentFK):"../show";t.redirect(o)}},module.exports.setUp=async(e,t)=>{const a=await d.findById(r.getId(e));if(!(await g(a.id,o.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{id:a}=e.params,i=await n.findById(a).lean(),d=1,r=(await n.find({parentFK:i.parentFK}).lean()).length;i.number>d&&i.number<=r&&(await n.findOneAndUpdate({parentFK:i.parentFK,number:i.number-1},{number:i.number}),await n.findByIdAndUpdate(a,{number:i.number-1}));const o=i.parentFK?"../show/".concat(i.parentFK):"../show";t.redirect(o)}};