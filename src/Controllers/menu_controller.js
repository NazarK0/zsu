"use strict";const e=require("lodash"),n=require("../Models/Menu"),t=require("../Models/Page"),a=require("../Models/ChildSub"),i=require("../Models/History"),d=require("../Models/User"),r=require("../API/getAdminid"),o=require("../API/op_categories"),{ValidSession:l}=require("../API/Session/session"),{getAll:u}=require("../API/getAllChildSub"),{getBody:s}=require("../API/childSubApi/getBody"),{updateChildSub:p,deleteChildSub:c}=require("../API/childSubApi/edit"),g=require("../API/userAPI/hasAccess"),{userFind:f}=require("../API/userAPI/findUser"),m=require("../Models/Link");module.exports.getMenu=async(e,t)=>{const a=await d.findById(r.getId(e));if(!(await g(a.id,o.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{language:i,submenuId:d=null}=e.params,r={langCurrent:i,langOther:"ua"===i?"en":"ua",menu:await n.find({parentFK:d,language:i}).sort({number:1}).lean(),user:a.id};if(d){const{parentFK:e=null}=await n.findById(d).select({_id:0,parentFK:1}).lean();e&&(r.grandParent=e),r.parent=d}t.render("main_menu_menu",r)}},module.exports.getAddMenuItem=async(e,n)=>{const a=await d.findById(r.getId(e));if(!(await g(a.id,o.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{language:i,parent:d=null}=e.params,r={mode:"add",language:i,pagesList:await t.find({public_status:"active",isMain:!0,language:i,bindedToMenu:!1}).select({_id:1,title:2}).lean(),linksList:await m.find().lean(),user:a.id};d&&(r.parent=d),n.render("edit_menu",r)}},module.exports.postAddedMenuItem=async(e,a)=>{const l=await d.findById(r.getId(e));if(!(await g(l.id,o.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id});{const{language:d,parent:r=null}=e.params,{title:o,linkType:u,linkUrl:s=null,content__id:p=null}=e.body,c={title:o,language:d,parentFK:r,user_id:l.id,linkUrl:null,pageFK:null};switch(c.number=(await n.find({parentFK:r,language:d}).lean()).length+1,u){case"directLink":s&&s.trim().toLowerCase().startsWith("http")&&(c.linkUrl=s.trim());break;case"content":if(p){const e="photo-galery"===p||"video"===p;"null"!==p&&"unlink"!==p&&"photo-galery"!==p&&"video"!==p?(c.pageFK=p,await t.findByIdAndUpdate(p,{bindedToMenu:!0})):e&&(c.pageFK=p)}}const g=await new n(c).save();await new i({type_content:"Головне меню",operation:"Додавання пункту головного меню ".concat(g.title),user:l.login}).save();const f=r?"../show/".concat(r):"./show";a.redirect(f)}},module.exports.getEditMenuItem=async(e,a)=>{const i=await d.findById(r.getId(e));if(!(await g(i.id,o.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const{language:d,id:r}=e.params,o=await t.find({public_status:"active",isMain:!0,language:d,bindedToMenu:!1}).select({_id:1,title:2}).lean(),l=await m.find().lean(),u=await n.findById(r).lean(),s={mode:"edit",language:d,pagesList:o,linksList:l,user:i.id,id:r,title:u.title};if(u.linkUrl)s.currentContent=u.linkUrl;else if(u.pageFK){if("photo-galery"===u.pageFK||"video"===u.pageFK)switch(u.pageFK){case"photo-galery":s.currentContent="Фотогалерея";break;case"video":s.currentContent="Відео"}else{const e=await t.findById(u.pageFK).select({_id:0,title:1}).lean();s.currentContent=e.title}}else s.currentContent="Відсутній";u.parentFK&&(s.parent=u.parentFK),a.render("edit_menu",s)}},module.exports.postEditedMenuItem=async(e,a)=>{const l=await d.findById(r.getId(e));if(!(await g(l.id,o.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id});{const{id:d}=e.params,{title:r,linkType:o,linkUrl:u=null,content__id:s=null}=e.body,p={title:r,user_id:l.id},c=await n.findById(d).lean();switch(o){case"noLink":p.linkUrl=null,p.pageFK=null,c.pageFK&&"video"!==c.pageFK&&"photo-galery"!==c.pageFK&&await t.findByIdAndUpdate(c.pageFK,{bindedToMenu:!1});break;case"directLink":u&&u.trim().toLowerCase().startsWith("http")&&(p.linkUrl=u.trim());break;case"content":if(s){const e="unlink"===s,n="photo-galery"===s||"video"===s;"null"!==s&&"unlink"!==s&&"photo-galery"!==s&&"video"!==s?(p.pageFK=s,c.pageFK&&await t.findByIdAndUpdate(c.pageFK,{bindedToMenu:!1}),await t.findByIdAndUpdate(s,{bindedToMenu:!0})):e?(p.pageFK=null,c.pageFK&&"video"!==c.pageFK&&"photo-galery"!==c.pageFK&&await t.findByIdAndUpdate(c.pageFK,{bindedToMenu:!1})):n&&(p.pageFK=s,c.pageFK&&"video"!==c.pageFK&&"photo-galery"!==c.pageFK&&await t.findByIdAndUpdate(c.pageFK,{bindedToMenu:!1}))}}const g=await n.findByIdAndUpdate(d,p);await new i({type_content:"Головне меню",operation:"Редагування пункту головного меню ".concat(g.title),user:l.login}).save();const f=g.parentFK?"../show/".concat(g.parentFK):"../show";a.redirect(f)}},module.exports.deleteMenuItem=async(e,a)=>{const l=await d.findById(r.getId(e));if(await g(l.id,o.MAIN_MENU)){const{id:d}=e.params,r=await n.findByIdAndDelete(d);r.pageFK&&"photo-galery"!==r.pageFK&&"video"!==r.pageFK&&t.findByIdAndUpdate(r.pageFK,{bindedToMenu:!1});let o=await n.find().where({language:r.language,parentFK:r.parentFK}).sort({number:1}).lean();for(let e=0;e<o.length;e++)await n.findByIdAndUpdate(o[e]._id,{number:e+1});await new i({type_content:"Головне меню",operation:"Видалення пункту головного меню ".concat(r.title," та всіх його підпунктів"),user:l.login}).save();const u=r.parentFK?"../show/".concat(r.parentFK):"../show";return a.redirect(u)}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id})},module.exports.setDown=async(e,t)=>{const a=await d.findById(r.getId(e));if(!(await g(a.id,o.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{id:a}=e.params,i=await n.findById(a).lean();null!=await n.findOneAndUpdate({number:i.number+1,parentFK:i.parentFK,language:i.language},{number:i.number})&&await n.findByIdAndUpdate(i._id,{$set:{number:i.number+1}});const d=i.parentFK?"../show/".concat(i.parentFK):"../show";t.redirect(d)}},module.exports.setUp=async(e,t)=>{const a=await d.findById(r.getId(e));if(!(await g(a.id,o.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});{const{id:a}=e.params,i=await n.findById(a).lean();null!=await n.findOneAndUpdate({number:i.number-1,parentFK:i.parentFK,language:i.language},{number:i.number})&&await n.findByIdAndUpdate(i._id,{$set:{number:i.number-1}});const d=i.parentFK?"../show/".concat(i.parentFK):"../show";t.redirect(d)}};