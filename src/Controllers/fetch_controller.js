"use strict";const e=require("path"),n=require("fs"),t=require("image-size"),i=require("sharp"),a=require("moment"),s=require("jimp"),{default:d}=require("convert-size"),o=require("../Models/News"),l=require("../Models/Page"),r=require("../Models/Category"),c=require("../Models/MediaCategory"),p=require("../Models/Link"),y=require("../Models/Command"),u=require("../Models/Corps"),f=require("../Models/CommandSign"),m=require("../Models/CommandBackground"),w=require("../Models/Content"),g=require("../API/isExistHelper"),I=require("../Models/ActualContent"),h=require("../API/initUploadFolders"),S=require("../API/filenameProcessor"),{imgFolderPath:B,tmpFolderPath:b,filesFolderPath:k}=require("../API/constants/uploadPaths"),{all:_}=require("../Routes/fetch_router");module.exports.postUploadMainPhoto=async(t,i)=>{const{file:a}=await t;let{contentId:s}=await t.body;const{contentType:r}=await t.body;if(h(),a){const{filename:t,originalname:c}=a,p=S(c);if(d(a.size,"MB")>5)return i.sendStatus(413);if(n.renameSync(e.join(b,t),e.join(B,p)),s)switch(r){case"news":await o.findByIdAndUpdate(s,{mainPhoto:p});break;case"page":await l.findByIdAndUpdate(s,{mainPhoto:p})}else{let e;switch(r){case"news":e=await new o({public_status:"uncomplete",mainPhoto:p}).save(),s=e.id;break;case"page":e=await new l({public_status:"uncomplete",mainPhoto:p}).save(),s=e.id}}return i.send(JSON.stringify({filename:p,contentId:s}))}return i.sendStatus(503)},module.exports.postDeleteMainPhoto=async(t,i)=>{const{contentId:a,contentType:s}=t.body;switch(s){case"news":{const{mainPhoto:t}=await o.findById(a).select({_id:0,mainPhoto:1}).lean();n.unlinkSync(e.join(B,t)),await o.findByIdAndUpdate(a,{mainPhoto:""})}break;case"page":{const{mainPhoto:t}=await l.findById(a).select({_id:0,mainPhoto:1}).lean();n.unlinkSync(e.join(B,t)),await l.findByIdAndUpdate(a,{mainPhoto:""})}}return i.sendStatus(200)},module.exports.postUploadSlider=async(t,i)=>{const{files:a}=await t;let{contentId:s}=await t.body;const{contentType:r}=await t.body,c=[],p=[];if(a.length)if(h(),a.forEach(t=>{const{filename:i,originalname:a}=t,s=S(a);d(t.size,"MB")>5?p.push(a):(n.renameSync(e.join(b,i),e.join(B,s)),c.push(s))}),s)switch(r){case"news":await o.findByIdAndUpdate(s,{slider:c});break;case"page":await l.findByIdAndUpdate(s,{slider:c})}else{let e;switch(r){case"news":e=await new o({public_status:"uncomplete",slider:c}).save(),s=e.id;break;case"page":e=await new l({public_status:"uncomplete",slider:c}).save(),s=e.id}}return i.send(JSON.stringify({filenames:c,contentId:s,oversize:p}))},module.exports.postAddSlider=async(t,i)=>{const{files:a}=await t,{contentId:s,contentType:r}=await t.body,c=[],p=[];switch(r){case"news":{const e=await o.findById(s).select({_id:0,slider:1});c.push(...e.slider)}break;case"page":{const e=await l.findById(s).select({_id:0,slider:1});c.push(...e.slider)}}if(a.length)switch(h(),a.forEach(t=>{const{filename:i,originalname:a}=t,s=S(a);d(t.size,"MB")>5?p.push(a):(n.renameSync(e.join(b,i),e.join(B,s)),c.push(s))}),r){case"news":await o.findByIdAndUpdate(s,{slider:c});break;case"page":await l.findByIdAndUpdate(s,{slider:c})}return i.send(JSON.stringify({filenames:c,oversize:p}))},module.exports.postDeleteSliderImage=async(t,i)=>{const{contentId:a,contentType:s,filename:d}=t.body;let r=[];switch(s){case"news":{const{slider:t}=await o.findById(a).select({_id:0,slider:1}).lean();n.unlinkSync(e.join(B,d));const i=t.indexOf(d);i>-1?(r=[...t.slice(0,i),...t.slice(i+1)],await o.findByIdAndUpdate(a,{slider:r})):r=t}break;case"page":{const{slider:t}=await l.findById(a).select({_id:0,slider:1}).lean();n.unlinkSync(e.join(B,d));const i=t.indexOf(d);i>-1?(r=[...t.slice(0,i),...t.slice(i+1)],await l.findByIdAndUpdate(a,{slider:r})):r=t}}return i.send(JSON.stringify({filenames:r}))},module.exports.postUploadFiles=async(t,i)=>{const{files:a}=await t;let{contentId:s}=await t.body;const{contentType:d}=await t.body,r=[];if(a.length)if(h(),a.forEach(t=>{const{filename:i,originalname:a}=t,s=S(a);n.renameSync(e.join(b,i),e.join(k,s)),r.push(s)}),s)switch(d){case"news":await o.findByIdAndUpdate(s,{files:r});break;case"page":await l.findByIdAndUpdate(s,{files:r})}else{let e;switch(d){case"news":e=await new o({public_status:"uncomplete",files:r}).save(),s=e.id;break;case"page":e=await new l({public_status:"uncomplete",files:r}).save(),s=e.id}}return i.send(JSON.stringify({filenames:r,contentId:s}))},module.exports.postAddFiles=async(t,i)=>{const{files:a}=await t,{contentId:s,contentType:d}=await t.body,r=[];switch(d){case"news":{const e=await o.findById(s).select({_id:0,files:1});r.push(...e.files)}break;case"page":{const e=await l.findById(s).select({_id:0,files:1});r.push(...e.files)}}if(a.length)switch(h(),a.forEach(t=>{const{filename:i,originalname:a}=t,s=S(a);n.renameSync(e.join(b,i),e.join(k,s)),r.push(s)}),d){case"news":await o.findByIdAndUpdate(s,{files:r});break;case"page":await l.findByIdAndUpdate(s,{files:r})}return i.send(JSON.stringify({filenames:r}))},module.exports.postDeleteFile=async(t,i)=>{const{contentId:a,contentType:s,filename:d}=t.body;let r=[];switch(s){case"news":{const{files:t}=await o.findById(a).select({_id:0,files:1}).lean();n.unlinkSync(e.join(k,d));const i=t.indexOf(d);i>-1?(r=[...t.slice(0,i),...t.slice(i+1)],await o.findByIdAndUpdate(a,{files:r})):r=t}break;case"page":{const{files:t}=await l.findById(a).select({_id:0,files:1}).lean();n.unlinkSync(e.join(k,d));const i=t.indexOf(d);i>-1?(r=[...t.slice(0,i),...t.slice(i+1)],await l.findByIdAndUpdate(a,{files:r})):r=t}}return i.send(JSON.stringify({filenames:r}))},module.exports.postUploadCategoryPhoto=async(t,i)=>{const{file:a}=await t;let{categoryId:s}=await t.body;if(h(),a){const{filename:t,originalname:d}=a,o=S(d);if(n.renameSync(e.join(b,t),e.join(B,o)),s)await r.findByIdAndUpdate(s,{img:o});else{s=(await new r({img:o}).save()).id}return i.send(JSON.stringify({filename:o,categoryId:s}))}return i.sendStatus(505)},module.exports.postDeleteCategoryPhoto=async(t,i)=>{const{categoryId:a}=t.body;try{const t=await r.findById(a).lean();await r.findByIdAndUpdate(a,{img:""}),n.unlinkSync(e.join(B,t.img))}catch(s){console.error(s)}return i.sendStatus(200)},module.exports.Update=async(e,n)=>{JSON.parse(JSON.stringify(await w.find())).forEach(async e=>{await w.findByIdAndUpdate({_id:e._id},{$set:{public_status:"active"}})}),n.json(!0)},module.exports.postSetLinkImg=async(t,i)=>{const a=await t.file;let s,{linkId:o}=t.body;if(a){const{filename:t,originalname:l}=a,r=S(l);return d(a.size,"MB")>5?i.sendStatus(413):(n.renameSync(e.join(b,t),e.join(B,r)),o?await p.findByIdAndUpdate(o,{img:r}):(s=await new p({img:r}).save(),o=s.id),i.send(JSON.stringify({img:r,id:o})))}return i.sendStatus(404)},module.exports.postDeleteLinkImg=async(t,i)=>{const{id:a}=t.params,s=await p.findById(a).lean();s.img&&(n.unlinkSync(e.join(B,s.img)),await p.findByIdAndUpdate(a,{img:""})),i.sendStatus(200)},module.exports.getLinkPicture=async(e,n,t)=>{console.error("Change link picture url"),n.sendStatus(504)},module.exports.postUploadActualContentImg=async(t,i)=>{const{file:a}=await t;let{actualContentId:s}=await t.body;if(h(),a){const{filename:t,originalname:o}=a,l=S(o);if(d(a.size,"MB")>5)return i.sendStatus(413);if(n.renameSync(e.join(b,t),e.join(B,l)),s)await I.findByIdAndUpdate(s,{img:l});else{s=(await new I({img:l}).save()).id}return i.send(JSON.stringify({filename:l,actualContentId:s}))}return i.sendStatus(505)},module.exports.postDeleteActualContentImg=async(t,i)=>{const{actualContentId:a}=t.body,s=await I.findById(a).lean();return await I.findByIdAndUpdate(a,{img:""}),n.unlinkSync(e.join(B,s.img)),i.sendStatus(200)},module.exports.postSaveContentLinks=async(e,n)=>{let{contentId:t}=await e.body;const{contentType:i,user_pages:a=[]}=await e.body;if(t)switch(i){case"news":await o.findByIdAndUpdate(t,{links:a});break;case"page":await l.findByIdAndUpdate(t,{links:a})}else{let e;switch(i){case"news":e=await new o({public_status:"uncomplete",links:a}).save(),t=e.id;break;case"page":e=await new l({public_status:"uncomplete",links:a}).save(),t=e.id}}return n.send(JSON.stringify({contentId:t}))},module.exports.setMigrarion=async(e,n)=>{(await w.find().where({page_type:"content_page"}).lean()).forEach(async e=>{const{page_title:n,description:t,content_folder:i,content_baseUrl:s,keywords:d,categoryFK:o,html_body:r,lang:c,date:p,user_id:y}=e;await new l({title:n,description:t,keywords:d,html_body:r,language:c,user_id:y,public_status:"active",publishDate:a(p).toISOString(),slider:[],files:[],links:[]}).save()});(await w.find().where({page_type:"news"}).lean()).forEach(async e=>{const{page_title:n,description:t,keywords:i,lang:s,html_body:d,user_id:l,generated_category_link:r,page_subclass:c,date:p}=e;await new o({title:n,description:t,categoryFK:r,type:c,keywords:i,html_body:d,language:s,user_id:l,publishDate:a(p).toISOString(),slider:[],files:[],links:[]}).save()}),n.json("true")},module.exports.postUploadGalery=async(t,i)=>{const{files:a}=await t;let{categoryId:s}=await t.body;const o=[],l=[];return a.length&&(h(),a.forEach(t=>{const{filename:i,originalname:a}=t,s=S(a);d(t.size,"MB")>5?l.push(a):(n.renameSync(e.join(b,i),e.join(B,s)),o.push(s))}),s?await c.findByIdAndUpdate(s,{photos:o}):(category=await new c({photos:o}).save(),s=category.id)),i.send(JSON.stringify({filenames:o,categoryId:s,oversize:l}))},module.exports.postAddGalery=async(t,i)=>{const{files:a}=await t,{categoryId:s}=await t.body,o=[],l=[],r=await c.findById(s).select({_id:0,photos:1});return o.push(...r.photos),a.length&&(h(),a.forEach(t=>{const{filename:i,originalname:a}=t,s=S(a);d(t.size,"MB")>5?l.push(a):(n.renameSync(e.join(b,i),e.join(B,s)),o.push(s))}),await c.findByIdAndUpdate(s,{photos:o})),i.send(JSON.stringify({filenames:o,oversize:l}))},module.exports.postDeleteGaleryImage=async(t,i)=>{const{categoryId:a,filename:s}=t.body;let d=[];const{photos:o}=await c.findById(a).select({_id:0,photos:1}).lean();n.unlinkSync(e.join(B,s));const l=o.indexOf(s);return l>-1?(d=[...o.slice(0,l),...o.slice(l+1)],await c.findByIdAndUpdate(a,{photos:d})):d=o,i.send(JSON.stringify({filenames:d}))},module.exports.postUploadCorpsSign=async(t,i)=>{const{file:a}=await t;let{corpsId:s}=t.body;if(h(),a){const{filename:t,originalname:o}=a,l=S(o);if(d(a.size,"MB")>5)return i.sendStatus(413);if(n.renameSync(e.join(b,t),e.join(B,l)),s)await u.findByIdAndUpdate(s,{signImg:l});else{let e;e=await new u({signImg:l}).save(),s=e.id}return i.send(JSON.stringify({filename:l,corpsId:s}))}return i.sendStatus(503)},module.exports.postDeleteCorpsSign=async(t,i)=>{const{corpsId:a}=t.body,{signImg:s}=await u.findById(a).select({_id:0,signImg:1}).lean();return n.unlinkSync(e.join(B,s)),await u.findByIdAndUpdate(a,{signImg:""}),i.sendStatus(200)},module.exports.postUploadCommandSign=async(t,i)=>{const{file:a}=await t;let{commandId:s}=t.body;if(h(),a){const{filename:t,originalname:o}=a,l=S(o);if(d(a.size,"MB")>5)return i.sendStatus(413);if(n.renameSync(e.join(b,t),e.join(B,l)),s)await y.findByIdAndUpdate(s,{signImg:l});else{let e;e=await new y({signImg:l}).save(),s=e.id}return i.send(JSON.stringify({filename:l,commandId:s}))}return i.sendStatus(503)},module.exports.postDeleteCommandSign=async(t,i)=>{const{commandId:a}=t.body,{signImg:s}=await y.findById(a).select({_id:0,signImg:1}).lean();return n.unlinkSync(e.join(B,s)),await y.findByIdAndUpdate(a,{signImg:""}),i.sendStatus(200)};