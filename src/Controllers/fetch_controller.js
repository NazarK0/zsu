"use strict";const e=require("path"),n=require("fs"),i=require("moment"),{default:t}=require("convert-size"),a=require("../Models/News"),s=require("../Models/Page"),o=require("../Models/Category"),d=require("../Models/MediaCategory"),l=require("../Models/Link"),c=require("../Models/Command"),r=require("../Models/Corps"),p=require("../Models/Content"),y=require("../Models/ActualContent"),u=require("../API/initUploadFolders"),f=require("../API/filenameProcessor"),{imgOriginFolderPath:w,imgCompressedFolderPath:m,tmpFolderPath:g,filesFolderPath:I,iconsFolderPath:h}=require("../API/constants/uploadPaths"),{compressImages:S}=require("../API/cropImage");module.exports.postUploadMainPhoto=async(i,o)=>{const{file:d}=await i;let{contentId:l}=await i.body;const{contentType:c}=await i.body;if(u(),d){const{filename:i,originalname:r}=d,p=f(r);if(t(d.size,"MB")>5)return o.sendStatus(413);n.renameSync(e.join(g,i),e.join(w,p));const y=await S([e.join(w,p)],m);if(l)switch(c){case"news":await a.findByIdAndUpdate(l,{mainPhoto:y[0]});break;case"page":await s.findByIdAndUpdate(l,{mainPhoto:y[0]})}else{let e;switch(c){case"news":e=await new a({public_status:"uncomplete",mainPhoto:y[0]}).save(),l=e.id;break;case"page":e=await new s({public_status:"uncomplete",mainPhoto:y[0]}).save(),l=e.id}}return o.send(JSON.stringify({filename:y[0],contentId:l}))}return o.sendStatus(503)},module.exports.postDeleteMainPhoto=async(i,t)=>{const{contentId:o,contentType:d}=i.body;switch(d){case"news":{const{mainPhoto:i}=await a.findById(o).select({_id:0,mainPhoto:1}).lean();n.unlinkSync(e.join(m,i)),await a.findByIdAndUpdate(o,{mainPhoto:""})}break;case"page":{const{mainPhoto:i}=await s.findById(o).select({_id:0,mainPhoto:1}).lean();n.unlinkSync(e.join(m,i)),n.unlinkSync(e.join(h,i)),await s.findByIdAndUpdate(o,{mainPhoto:""})}}return t.sendStatus(200)},module.exports.postUploadSlider=async(i,o)=>{const{files:d}=await i;let{contentId:l}=await i.body;const{contentType:c}=await i.body,r=[],p=[],y=[];if(d.length){u(),d.forEach(i=>{const{filename:a,originalname:s}=i,o=f(s);t(i.size,"MB")>5?p.push(s):(n.renameSync(e.join(g,a),e.join(w,o)),y.push(e.join(w,o)))});const i=await S(y,m);if(i&&r.push(...i),l)switch(c){case"news":await a.findByIdAndUpdate(l,{slider:r});break;case"page":await s.findByIdAndUpdate(l,{slider:r})}else{let e;switch(c){case"news":e=await new a({public_status:"uncomplete",slider:r}).save(),l=e.id;break;case"page":e=await new s({public_status:"uncomplete",slider:r}).save(),l=e.id}}}return o.send(JSON.stringify({filenames:r,contentId:l,oversize:p}))},module.exports.postAddSlider=async(i,o)=>{const{files:d}=await i,{contentId:l,contentType:c}=await i.body,r=[],p=[],y=[];switch(c){case"news":{const e=await a.findById(l).select({_id:0,slider:1});p.push(...e.slider)}break;case"page":{const e=await s.findById(l).select({_id:0,slider:1});p.push(...e.slider)}}if(d.length){u(),d.forEach(i=>{const{filename:a,originalname:s}=i,o=f(s);t(i.size,"MB")>5?y.push(s):(n.renameSync(e.join(g,a),e.join(w,o)),r.push(e.join(w,o)))});const i=await S(r,m);switch(i&&p.push(...i),c){case"news":await a.findByIdAndUpdate(l,{slider:p});break;case"page":await s.findByIdAndUpdate(l,{slider:p})}}return o.send(JSON.stringify({filenames:p,oversize:y}))},module.exports.postDeleteSliderImage=async(i,t)=>{const{contentId:o,contentType:d,filename:l}=i.body;let c=[];switch(d){case"news":{const{slider:i}=await a.findById(o).select({_id:0,slider:1}).lean();n.unlinkSync(e.join(m,l)),n.unlinkSync(e.join(h,l));const t=i.indexOf(l);t>-1?(c=[...i.slice(0,t),...i.slice(t+1)],await a.findByIdAndUpdate(o,{slider:c})):c=i}break;case"page":{const{slider:i}=await s.findById(o).select({_id:0,slider:1}).lean();n.unlinkSync(e.join(m,l)),n.unlinkSync(e.join(h,l));const t=i.indexOf(l);t>-1?(c=[...i.slice(0,t),...i.slice(t+1)],await s.findByIdAndUpdate(o,{slider:c})):c=i}}return t.send(JSON.stringify({filenames:c}))},module.exports.postUploadFiles=async(i,t)=>{const{files:o}=await i;let{contentId:d}=await i.body;const{contentType:l}=await i.body,c=[];if(o.length)if(u(),o.forEach(i=>{const{filename:t,originalname:a}=i,s=f(a);n.renameSync(e.join(g,t),e.join(I,s)),c.push(s)}),d)switch(l){case"news":await a.findByIdAndUpdate(d,{files:c});break;case"page":await s.findByIdAndUpdate(d,{files:c})}else{let e;switch(l){case"news":e=await new a({public_status:"uncomplete",files:c}).save(),d=e.id;break;case"page":e=await new s({public_status:"uncomplete",files:c}).save(),d=e.id}}return t.send(JSON.stringify({filenames:c,contentId:d}))},module.exports.postAddFiles=async(i,t)=>{const{files:o}=await i,{contentId:d,contentType:l}=await i.body,c=[];switch(l){case"news":{const e=await a.findById(d).select({_id:0,files:1});c.push(...e.files)}break;case"page":{const e=await s.findById(d).select({_id:0,files:1});c.push(...e.files)}}if(o.length)switch(u(),o.forEach(i=>{const{filename:t,originalname:a}=i,s=f(a);n.renameSync(e.join(g,t),e.join(I,s)),c.push(s)}),l){case"news":await a.findByIdAndUpdate(d,{files:c});break;case"page":await s.findByIdAndUpdate(d,{files:c})}return t.send(JSON.stringify({filenames:c}))},module.exports.postDeleteFile=async(i,t)=>{const{contentId:o,contentType:d,filename:l}=i.body;let c=[];switch(d){case"news":{const{files:i}=await a.findById(o).select({_id:0,files:1}).lean();n.unlinkSync(e.join(I,l));const t=i.indexOf(l);t>-1?(c=[...i.slice(0,t),...i.slice(t+1)],await a.findByIdAndUpdate(o,{files:c})):c=i}break;case"page":{const{files:i}=await s.findById(o).select({_id:0,files:1}).lean();n.unlinkSync(e.join(I,l));const t=i.indexOf(l);t>-1?(c=[...i.slice(0,t),...i.slice(t+1)],await s.findByIdAndUpdate(o,{files:c})):c=i}}return t.send(JSON.stringify({filenames:c}))},module.exports.postUploadCategoryPhoto=async(i,t)=>{const{file:a}=await i;let{categoryId:s}=await i.body;if(u(),a){const{filename:i,originalname:d}=a,l=f(d);n.renameSync(e.join(g,i),e.join(w,l));const c=await S([e.join(w,l)],m);if(s)await o.findByIdAndUpdate(s,{img:c[0]});else{s=(await new o({img:c[0]}).save()).id}return t.send(JSON.stringify({filename:c[0],categoryId:s}))}return t.sendStatus(505)},module.exports.postDeleteCategoryPhoto=async(i,t)=>{const{categoryId:a}=i.body;try{const i=await o.findById(a).lean();await o.findByIdAndUpdate(a,{img:""}),n.unlinkSync(e.join(m,i.img)),n.unlinkSync(e.join(h,i.img))}catch(s){console.error(s)}return t.sendStatus(200)},module.exports.Update=async(e,n)=>{JSON.parse(JSON.stringify(await p.find())).forEach(async e=>{await p.findByIdAndUpdate({_id:e._id},{$set:{public_status:"active"}})}),n.json(!0)},module.exports.postSetLinkImg=async(i,a)=>{const s=await i.file;let o,{linkId:d}=i.body;if(s){const{filename:i,originalname:c}=s,r=f(c);if(t(s.size,"MB")>5)return a.sendStatus(413);n.renameSync(e.join(g,i),e.join(w,r));const p=await S([e.join(w,r)],m);return d?await l.findByIdAndUpdate(d,{img:p[0]}):(o=await new l({img:p[0]}).save(),d=o.id),a.send(JSON.stringify({img:p[0],id:d}))}return a.sendStatus(404)},module.exports.postDeleteLinkImg=async(i,t)=>{const{id:a}=i.params,s=await l.findById(a).lean();s.img&&(n.unlinkSync(e.join(m,s.img)),n.unlinkSync(e.join(h,s.img)),await l.findByIdAndUpdate(a,{img:""})),t.sendStatus(200)},module.exports.getLinkPicture=async(e,n)=>{console.error("Change link picture url"),n.sendStatus(504)},module.exports.postUploadActualContentImg=async(i,a)=>{const{file:s}=await i;let{actualContentId:o}=await i.body;if(u(),s){const{filename:i,originalname:d}=s,l=f(d);if(t(s.size,"MB")>5)return a.sendStatus(413);n.renameSync(e.join(g,i),e.join(w,l));const c=await S([e.join(w,l)],m);if(o)await y.findByIdAndUpdate(o,{img:c[0]});else{o=(await new y({img:c[0]}).save()).id}return a.send(JSON.stringify({filename:c[0],actualContentId:o}))}return a.sendStatus(505)},module.exports.postDeleteActualContentImg=async(i,t)=>{const{actualContentId:a}=i.body,s=await y.findById(a).lean();return await y.findByIdAndUpdate(a,{img:""}),n.unlinkSync(e.join(m,s.img)),n.unlinkSync(e.join(h,s.img)),t.sendStatus(200)},module.exports.postSaveContentLinks=async(e,n)=>{let{contentId:i}=await e.body;const{contentType:t,user_pages:o=[]}=await e.body;if(i)switch(t){case"news":await a.findByIdAndUpdate(i,{links:o});break;case"page":await s.findByIdAndUpdate(i,{links:o})}else{let e;switch(t){case"news":e=await new a({public_status:"uncomplete",links:o}).save(),i=e.id;break;case"page":e=await new s({public_status:"uncomplete",links:o}).save(),i=e.id}}return n.send(JSON.stringify({contentId:i}))},module.exports.setMigrarion=async(e,n)=>{(await p.find().where({page_type:"content_page"}).lean()).forEach(async e=>{const{page_title:n,description:t,keywords:a,html_body:o,lang:d,date:l,user_id:c}=e;await new s({title:n,description:t,keywords:a,html_body:o,language:d,user_id:c,public_status:"active",publishDate:i(l).toISOString(),slider:[],files:[],links:[]}).save()});(await p.find().where({page_type:"news"}).lean()).forEach(async e=>{const{page_title:n,description:t,keywords:s,lang:o,html_body:d,user_id:l,generated_category_link:c,page_subclass:r,date:p}=e;await new a({title:n,description:t,categoryFK:c,type:r,keywords:s,html_body:d,language:o,user_id:l,publishDate:i(p).toISOString(),slider:[],files:[],links:[]}).save()}),n.json("true")},module.exports.postUploadGalery=async(i,a)=>{const{files:s}=await i;let{categoryId:o}=await i.body;const l=[],c=[],r=[];if(s.length){u(),s.forEach(i=>{const{filename:a,originalname:s}=i,o=f(s);t(i.size,"MB")>5?r.push(s):(n.renameSync(e.join(g,a),e.join(w,o)),l.push(e.join(w,o)))});const i=await S(l,m);if(i&&c.push(...i),o)await d.findByIdAndUpdate(o,{photos:c});else{o=(await new d({photos:c}).save()).id}}return a.send(JSON.stringify({filenames:c,categoryId:o,oversize:r}))},module.exports.postAddGalery=async(i,a)=>{const{files:s}=await i,{categoryId:o}=await i.body,l=[],c=[],r=[],p=await d.findById(o).select({_id:0,photos:1});if(c.push(...p.photos),s.length){u(),s.forEach(i=>{const{filename:a,originalname:s}=i,o=f(s);t(i.size,"MB")>5?r.push(s):(n.renameSync(e.join(g,a),e.join(w,o)),l.push(e.join(w,o)))});const i=await S(l,m);i&&c.push(...i),await d.findByIdAndUpdate(o,{photos:c})}return a.send(JSON.stringify({filenames:c,oversize:r}))},module.exports.postDeleteGaleryImage=async(i,t)=>{const{categoryId:a,filename:s}=i.body;let o=[];const{photos:l}=await d.findById(a).select({_id:0,photos:1}).lean();n.unlinkSync(e.join(m,s)),n.unlinkSync(e.join(h,s));const c=l.indexOf(s);return c>-1?(o=[...l.slice(0,c),...l.slice(c+1)],await d.findByIdAndUpdate(a,{photos:o})):o=l,t.send(JSON.stringify({filenames:o}))},module.exports.postUploadCorpsSign=async(i,a)=>{const{file:s}=await i;let{corpsId:o}=i.body;if(u(),s){const{filename:i,originalname:d}=s,l=f(d);if(t(s.size,"MB")>5)return a.sendStatus(413);n.renameSync(e.join(g,i),e.join(w,l));const c=await S([e.join(w,l)],m);if(o)await r.findByIdAndUpdate(o,{signImg:c[0]});else{o=(await new r({signImg:c[0]}).save()).id}return a.send(JSON.stringify({filename:c[0],corpsId:o}))}return a.sendStatus(503)},module.exports.postDeleteCorpsSign=async(i,t)=>{const{corpsId:a}=i.body,{signImg:s}=await r.findById(a).select({_id:0,signImg:1}).lean();return n.unlinkSync(e.join(m,s)),n.unlinkSync(e.join(h,s)),await r.findByIdAndUpdate(a,{signImg:""}),t.sendStatus(200)},module.exports.postUploadCommandSign=async(i,a)=>{const{file:s}=await i;let{commandId:o}=i.body;if(u(),s){const{filename:i,originalname:d}=s,l=f(d);if(t(s.size,"MB")>5)return a.sendStatus(413);n.renameSync(e.join(g,i),e.join(w,l));const r=await S([e.join(w,l)],m);if(o)await c.findByIdAndUpdate(o,{signImg:r[0]});else{o=(await new c({signImg:r[0]}).save()).id}return a.send(JSON.stringify({filename:r[0],commandId:o}))}return a.sendStatus(503)},module.exports.postDeleteCommandSign=async(i,t)=>{const{commandId:a}=i.body,{signImg:s}=await c.findById(a).select({_id:0,signImg:1}).lean();return n.unlinkSync(e.join(m,s)),n.unlinkSync(e.join(h,s)),await c.findByIdAndUpdate(a,{signImg:""}),t.sendStatus(200)};