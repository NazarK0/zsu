"use strict";const n=require("lodash"),e=require("../Models/Submenu"),i=require("../Models/Main_Menu"),t=require("../Models/Page"),a=require("../Models/ChildSub"),d=require("../Models/History"),r=require("../API/getAdminid"),u=require("../API/op_categories"),{ValidSession:s}=require("../API/Session/session"),{getAll:l}=require("../API/getAllChildSub"),{getBody:o}=require("../API/childSubApi/getBody"),{updateChildSub:c,deleteChildSub:m}=require("../API/childSubApi/edit"),_=require("../API/userAPI/hasAccess"),{userFind:p}=require("../API/userAPI/findUser"),w=require("../Models/Link");module.exports.getSubmenu=async(n,t)=>{const a=await p(r.getId(n));if(!0===await s(n.session,a.id,t)){if(!(await _(a.id,u.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});try{const{mainmenu_id:a}=n.params,d=await i.findById(a),u=await e.find().where({parent_main:n.params.mainmenu_id}).sort({number:1}).lean();return t.render("submenu_list",{user:r.getId(n),submenu:u,mainmenu_id:a,name_of_parent:d.title,language:d.lang})}catch(d){console.error(d)}}return null===await s(n.session,a.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.getEditSubmenuItem=async(n,a)=>{const d=await p(r.getId(n));if(!0===await s(n.session,d.id,a)){if(!(await _(d.id,u.MAIN_MENU)))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});{const{id:r,mainmenu_id:u}=n.params;try{const n=await e.findById(r),s=await i.findById(u),l=await w.find().lean(),o=await t.find({public_status:"active",isMain:!0,language:s.lang,bindedToMenu:!1}).select({_id:1,title:2}).lean(),c={title:n.title,language:n.lang,userid:d.id,mode:"edit",id:r,mainmenu_id:u,link_list:l,pagesList:o};if(n.content_id){const{title:e}=await t.findById(n.content_id).select({_id:0,title:1}).lean();c.currentContent=e}else n.link?c.currentContent=n.link:c.currentContent="Відсутній";return a.status(200).render("edit_submenu",c)}catch(l){console.error(l)}}}return null===await s(n.session,d.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})},module.exports.postEditedSubmenuItem=async(n,l)=>{const o=await p(r.getId(n));if(!0===await s(n.session,o.id,l)){if(await _(o.id,u.MAIN_MENU)){const{id:r}=n.params,{title:u,content__id:s,link_id:c}=n.body,m=await e.findById(r);return s&&"null"!==s&&"unlink"!==s?(await e.findByIdAndUpdate(r,{title:u,content_id:s,link:null}),await t.findByIdAndUpdate(s,{bindedToMenu:!0}),await t.findByIdAndUpdate(m.content_id,{bindedToMenu:!1}),await i.updateMany({content_id:s},{content_id:null}),await a.updateMany({content_id:s},{content_id:null})):"unlink"===s?(await e.findByIdAndUpdate(r,{title:u,content_id:null,link:"null"!==c?c:null}),await t.findByIdAndUpdate(m.content_id,{bindedToMenu:!1})):"null"===s&&"null"!==c&&(await e.findByIdAndUpdate(r,{title:u,content_id:null,link:c}),await t.findByIdAndUpdate(m.content_id,{bindedToMenu:!1})),await new d({type_content:"Під Меню",operation:"Редагування під пункту Головного Меню: ".concat(m.title),user:o.login}).save(),l.redirect("..")}return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id})}return null===await s(n.session,o.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.deleteSubmenuItem=async(i,l)=>{const o=await p(r.getId(i));if(!0===await s(i.session,o.id,l)){if(!(await _(o.id,u.MAIN_MENU)))return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});{const{id:r}=i.params,u=await e.findById(r);try{const i=await e.findByIdAndDelete(r),s=await e.find({parent_main:i.parent_main}).sort({number:1}).lean();for(let n=0;n<s.length;n++)await e.findByIdAndUpdate(s[n]._id,{number:n+1});u.content_id&&await t.findByIdAndUpdate(u.content_id,{bindedToMenu:!1});const c=await a.find({parent_sub:i.id}).select({_id:1});let m=[];for(let n=0;n<c.length;n++)m.push(await a.find({parent_sub:c[n].id}).select({_id:1}));m=n.flattenDeep(m);let _=[];for(let n=0;n<m.length;n++)_.push(await a.find({parent_sub:m[n].id}).select({_id:1}));_=n.flattenDeep(_);const p=n.concat(c,m,_);for(let n=0;n<p.length;n++)await a.findByIdAndDelete(p[n].id),p[n].content_id&&await t.findByIdAndUpdate(p[n].content_id,{bindedToMenu:!1});const w=new d({type_content:"Підменю",operation:"Видалення підпункту ".concat(u.title," Головного Меню "),user:o.login});return await w.save(),l.status(200).redirect("..")}catch(c){console.error(c)}}}return null===await s(i.session,o.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.getAddSubmenuItem=async(n,e)=>{const a=await p(r.getId(n));if(!0===await s(n.session,a.id,e)){if(await _(a.id,u.MAIN_MENU)){const{mainmenu_id:d}=n.params,r=await i.findById(d),u=await t.find({public_status:"active",isMain:!0,language:r.lang,bindedToMenu:!1}).select({_id:1,title:2}).lean(),s=await w.find().lean();return e.render("edit_submenu",{userid:a.id,mode:"add",link_list:s,mainmenu_id:d,pagesList:u,language:r.lang})}return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id})}return null===await s(n.session,a.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postAddedSubmenuItem=async(n,s)=>{const l=await p(r.getId(n));if(await _(l.id,u.MAIN_MENU)){const{title:u,content__id:o,link_id:c}=n.body,{mainmenu_id:m}=n.params,_=await i.findById(m),p={title:u,parent_main:m,user_id:r.getId(n),link:"null"!==c?c:null,lang:_.lang};p.number=(await e.find({parent_main:m})).length+1,o&&"null"!==o&&"unlink"!==o?(await i.findOneAndUpdate({content_id:o},{content_id:null}),await e.findOneAndUpdate({content_id:o},{content_id:null}),await a.findOneAndUpdate({content_id:o},{content_id:null}),p.content_id=o,await t.findByIdAndUpdate(o,{bindedToMenu:!0})):p.content_id=null;const w=await new e(p).save();return await new d({type_content:"Під Меню",operation:"Додавання підпункту Головного Меню ".concat(w.title),user:l.login}).save(),s.redirect(".")}return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id})},module.exports.getChildSubmenu=async(n,i)=>{const t=await p(r.getId(n)),{submenu_id:d}=n.params,u=await e.findById(d).lean();if(!0===await s(n.session,t.id,i)){const n=await l(d),e=await a.findById(d);let r;return null===u&&(r=await a.findById(d)),i.render("submenu_childlist",{redirect_link:null!==u?"/admin/".concat(t.id,"/all/").concat(u.parent_main,"/submenu?"):"/admin/".concat(t.id,"/all/submenu/").concat(e.parent_sub,"/child"),childlist:n.sort((n,e)=>n.number-e.number),user:t.id,submenu_id:d,name_of_parent:null!==u?u.title:r.title})}return null===await s(n.session,t.id,i)?i.redirect("/admin/login"):i.status(400).json("Час сесії минув, авторизуйтесь знову!")},module.exports.getAddChildSubmenu=async(n,i)=>{const d=await p(r.getId(n));if(!0===await s(n.session,d.id,i)){const{submenu_id:r}=n.params;let u=await e.findById(r).lean();u||(u=await a.findById(r).lean());const s=await w.find().lean(),l=await t.find({public_status:"active",isMain:!0,language:u.lang,bindedToMenu:!1}).select({_id:1,title:2}).lean();return i.render("edit_child",{userid:d.id,submenu_id:r,link_list:s,mode:"add",pagesList:l})}if(null===await s(n.session,d.id,i))return i.redirect("/admin/login");i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})},module.exports.postAddChildSubmenu=async(n,s)=>{const l=await p(r.getId(n));if(await _(l.id,u.MAIN_MENU)){const{title:r,content__id:u,link_id:o}=n.body,{submenu_id:c}=n.params;let m=await e.findById(c).lean();m||(m=await a.findById(c).lean());const _={title:r,parent_sub:c,user_id:l.id,link:"null"!==o?o:null,lang:m.lang};_.number=(await a.find().where({parent_sub:c})).length+1,u&&"null"!==u&&"unlink"!==u?(await i.findOneAndUpdate({content_id:u},{content_id:null}),await e.findOneAndUpdate({content_id:u},{content_id:null}),await a.findOneAndUpdate({content_id:u},{content_id:null}),_.content_id=u,await t.findByIdAndUpdate(u,{bindedToMenu:!0})):_.content_id=null;const p=await new a(_).save();return await new d({type_content:"Під Меню",operation:"Додавання підпункту Головного Меню ".concat(p.title),user:l.login}).save(),s.redirect(".")}return s.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(l.id,"/main"),url_text:"Повернутися до Головного Меню",user:l.id})},module.exports.getEditChildSubmenu=async(n,i)=>{const{id:d,submenu_id:u}=n.params,s=await o(d),{title:l,lang:c}=s,m=await w.find().lean(),_=e.findById(u).lean(),p=await t.find({public_status:"active",isMain:!0,language:_.lang,bindedToMenu:!1}).select({_id:1,title:2}).lean();let f="visible";(await a.find().where({parent_sub:d})).length>0&&(f="hidden");const b={userid:r.getId(n),submenu_id:u,link_list:m,pagesList:p,parameter:"visible",mode:"edit",id:d,title:l,lang:c,vis:f},g=await Content.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});b.content_page_list=g,i.render("edit_child",b)},module.exports.postEditChildSubmenu=async(n,e)=>(await c(n),e.redirect("..")),module.exports.postRemoveChildSubmenu=async(n,e)=>(await m(n),e.status(200).redirect("..")),module.exports.SubmenuSetUp=async(n,i)=>{const t=await p(r.getId(n)),a=await e.findById(n.params.id),d=await e.findOne().where({parent_main:a.parent_main,number:a.number-1});return null!==d&&(await e.findByIdAndUpdate({_id:n.params.id},{$set:{number:a.number-1}}),await e.findByIdAndUpdate({_id:d._id},{$set:{number:d.number+1}})),i.redirect("/admin/".concat(t.id,"/all/").concat(a.parent_main,"/submenu"))},module.exports.SubmenuSetDown=async(n,i)=>{const t=await p(r.getId(n)),a=await e.findById(n.params.id),d=await e.findOne().where({parent_main:a.parent_main,number:a.number+1});return null!==d&&(await e.findByIdAndUpdate({_id:n.params.id},{$set:{number:a.number+1}}),await e.findByIdAndUpdate({_id:d._id},{$set:{number:d.number-1}})),i.redirect("/admin/".concat(t.id,"/all/").concat(a.parent_main,"/submenu"))},module.exports.setUpChildSub=async(n,e)=>{const i=await p(r.getId(n)),t=await a.findById(n.params.id).lean(),d=await a.findOne().where({parent_sub:n.params.submenu_id,number:t.number-1});return null!==d&&(await a.findByIdAndUpdate({_id:t._id},{number:t.number-1}),await a.findByIdAndUpdate({_id:d._id},{number:d.number+1})),e.redirect("/admin/".concat(i.id,"/all/submenu/").concat(n.params.submenu_id,"/child"))},module.exports.setDownChildSub=async(n,e)=>{const i=await p(r.getId(n)),t=await a.findById(n.params.id).lean(),d=await a.findOne().where({parent_sub:n.params.submenu_id,number:t.number+1});return null!==d&&(await a.findByIdAndUpdate({_id:t._id},{number:t.number+1}),await a.findByIdAndUpdate({_id:d._id},{number:d.number-1})),e.redirect("/admin/".concat(i.id,"/all/submenu/").concat(n.params.submenu_id,"/child"))};