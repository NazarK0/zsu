"use strict";const e=require("lodash"),n=require("../Models/Submenu"),t=require("../Models/Main_Menu"),i=require("../Models/Content"),a=require("../Models/ChildSub"),d=require("../Models/History"),r=require("../API/getAdminid"),s=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),{getAll:o}=require("../API/getAllChildSub"),{addSubChild:c}=require("../API/childSubApi/add"),{getBody:m}=require("../API/childSubApi/getBody"),{updateChildSub:_,deleteChildSub:p}=require("../API/childSubApi/edit"),{updateSubmenu:w}=require("../API/SubMenuAPI/updateSubmenu"),b=require("../API/userAPI/hasAccess"),{userFind:g}=require("../API/userAPI/findUser"),f=require("../Models/Link"),{link:y}=require("fs");module.exports.getSubmenu=async(e,i)=>{const a=await g(r.getId(e));if(!0===await l(e.session,a.id,i)){if(!(await b(a.id,s.MAIN_MENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});try{const{mainmenu_id:a}=e.params,d=await t.findById(a);let s=await n.find().where({parent_main:e.params.mainmenu_id}).sort({number:1}).lean();return i.render("submenu_list",{user:r.getId(e),submenu:s,mainmenu_id:a,name_of_parent:d.title})}catch(d){console.error(d)}}return null===await l(e.session,a.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.getEditSubmenuItem=async(e,t)=>{const d=await g(r.getId(e));if(!0===await l(e.session,d.id,t)){if(!(await b(d.id,s.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});{const{id:r,mainmenu_id:s}=e.params;let l="visible";try{const e=await n.findById(r);(await a.find().where({parent_sub:e.id})).length>0&&(l="hidden");const u=await f.find().lean(),o={title:e.title,lang:e.lang,userid:d.id,action_type:"edit/".concat(r),id:r,mainmenu_id:s,link_list:u,parameter:"visible",vis:l,child_have:l,Info:"Редагування пункту Меню: ".concat(e.title)};switch(e.content_id){case"historyWar":o.currentContent="Історія війни";break;case"files":o.currentContent="Нормативно-правова база";break;case"contact":o.currentContent="Контакти";break;case"commander":o.currentContent="Командування";break;default:{const n=await i.findById(e.content_id).select({_id:0,page_title:1}).lean();o.currentContent=n?n.page_title:""}}const c=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files","commander"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});return o.content_page_list=c,t.status(200).render("edit_submenu",o)}catch(u){console.error(u)}}}return null===await l(e.session,d.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})},module.exports.postEditedSubmenuItem=async(e,t)=>{const i=await g(r.getId(e)),{id:a}=e.params,u=await n.findById(a);if(!0===await l(e.session,i.id,t)){if(!(await b(i.id,s.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});try{await w(a,e);const n=new d({type_content:"Під Меню",operation:"Редагування під пункту Головного Меню: ".concat(u.title),user:i.login});return await n.save(),t.redirect("..")}catch(o){console.error(o)}}return null===await l(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.deleteSubmenuItem=async(t,u)=>{const o=await g(r.getId(t));if(!0===await l(t.session,o.id,u)){if(!(await b(o.id,s.MAIN_MENU)))return u.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});{const{id:r}=t.params,s=await n.findById(r);try{const t=await n.findByIdAndDelete(r);let l=await n.find().sort({number:1}).lean();for(let e=0;e<l.length;e++)await n.findByIdAndUpdate({_id:l[e]._id},{$set:{number:e+1}});"null"!==s.content_id&&s.content_id&&"historyWar"!==s.content_id&&"files"!==s.content_id&&"contacts"!==s.content_id&&"actual"!==s.content_id&&"commander"!==s.content_id&&await i.findByIdAndUpdate(s.content_id,{generated_menu_link:null});const c=await a.find({parent_sub:t.id}).select({_id:1});let m=[];for(let e=0;e<c.length;e++)m.push(await a.find({parent_sub:c[e].id}).select({_id:1}));m=e.flattenDeep(m);let _=[];for(let e=0;e<m.length;e++)_.push(await a.find({parent_sub:m[e].id}).select({_id:1}));_=e.flattenDeep(_);const p=e.concat(c,m,_);for(let e=0;e<p.length;e++)await a.findByIdAndDelete(p[e].id),await i.findOneAndUpdate({generated_menu_link:p[e]},{generated_menu_link:null});const w=new d({type_content:"Підменю",operation:"Видалення підпункту ".concat(s.title," Головного Меню "),user:o.login});return await w.save(),u.status(200).redirect("..")}catch(c){console.error(c)}}}return null===await l(t.session,o.id,u)?u.redirect("/admin/login"):u.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.getAddSubmenuItem=async(e,n)=>{const t=await g(r.getId(e)),{mainmenu_id:a}=e.params,d=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files","commander"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6}),u=await f.find().lean();return!0===await l(e.session,t.id,n)?await b(t.id,s.MAIN_MENU)?n.status(200).render("edit_submenu",{userid:t.id,action_type:"add",parameter:"hidden",link_list:u,mainmenu_id:a,content_page_list:d,vis:"visible",Info:"Cтворення нового пункту меню"}):n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id}):null===await l(e.session,t.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.postAddedSubmenuItem=async(e,t)=>{const u=await g(r.getId(e));if(!(await b(u.id,s.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id});{const{title:s,lang:o,content_id:c,link_id:m}=e.body,{mainmenu_id:_}=e.params;let p;"null"!==c&&"unlink"!==c&&c?(await n.findOneAndUpdate({content_id:c},{content_id:null}),await a.findOneAndUpdate({content_id:c},{content_id:null}),p=new n({title:s,parent_main:_,child_sub:null,user_id:r.getId(e),link:"null"!==m?m:null,content_id:c,number:(await n.find().where({parent_main:_})).length+1,lang:o})):p=new n({title:s,parent_main:_,child_sub:null,link:"null"!==m?m:null,user_id:r.getId(e),content_id:null,number:(await n.find().where({parent_main:_})).length+1,lang:o});try{await p.save(),"null"!==c&&c&&await i.findByIdAndUpdate(c,{generated_menu_link:p.id});const e=new d({type_content:"Під Меню",operation:"Додавання підпункту Головного Меню ".concat(p.title),user:u.login});return await e.save(),t.redirect(".")}catch(l){console.error(l)}}},module.exports.getChildSubmenu=async(e,t)=>{const i=await g(r.getId(e)),{submenu_id:d}=e.params,s=await n.findById(d).lean();if(!0===await l(e.session,i.id,t)){const e=await o(d),n=await a.findById(d);let r;return null===s&&(r=await a.findById(d)),t.render("submenu_childlist",{redirect_link:null!==s?"/admin/".concat(i.id,"/all/").concat(s.parent_main,"/submenu?"):"/admin/".concat(i.id,"/all/submenu/").concat(n.parent_sub,"/child"),childlist:e.sort((e,n)=>e.number-n.number),user:i.id,submenu_id:d,name_of_parent:null!==s?s.title:r.title})}return null===await l(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).json("Час сесії минув, авторизуйтесь знову!")},module.exports.getAddChildSubmenu=async(e,n)=>{const t=await g(r.getId(e));if(!0===await l(e.session,t.id,n)){const a=await f.find().lean(),d=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});return n.render("edit_child",{userid:t.id,submenu_id:e.params.submenu_id,link_list:a,parameter:"hidden",action_type:"add",content_page_list:d})}if(null===await l(e.session,t.id,n))return n.redirect("/admin/login");n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.postAddChildSubmenu=async(e,n)=>(await c(e,r.getId(e)),n.redirect(".")),module.exports.getEditChildSubmenu=async(e,n)=>{const{id:t,submenu_id:d}=e.params,s=await m(t),{title:u,lang:l}=s,o=await f.find().lean();let c="visible";(await a.find().where({parent_sub:t})).length>0&&(c="hidden");const _={userid:r.getId(e),submenu_id:d,link_list:o,parameter:"visible",action_type:"edit/".concat(t),id:t,title:u,lang:l,vis:c};switch(s.content_id){case"historyWar":_.currentContent="Історія війни";break;case"files":_.currentContent="Нормативно-правова база";break;case"contact":_.currentContent="Контакти";break;case"commander":_.currentContent="Командування";break;default:{const e=await i.findById(s.content_id).select({_id:0,page_title:1}).lean();_.currentContent=e?e.page_title:""}}const p=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files","commander"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});_.content_page_list=p,n.render("edit_child",_)},module.exports.postEditChildSubmenu=async(e,n)=>(await _(e),n.redirect("..")),module.exports.postRemoveChildSubmenu=async(e,n)=>(await p(e),n.status(200).redirect("..")),module.exports.SubmenuSetUp=async(e,t)=>{const i=await g(r.getId(e));let a=await n.findById(e.params.id),d=await n.findOne().where({parent_main:a.parent_main,number:a.number-1});return null!==d&&(await n.findByIdAndUpdate({_id:e.params.id},{$set:{number:a.number-1}}),await n.findByIdAndUpdate({_id:d._id},{$set:{number:d.number+1}})),t.redirect("/admin/".concat(i.id,"/all/").concat(a.parent_main,"/submenu"))},module.exports.SubmenuSetDown=async(e,t)=>{const i=await g(r.getId(e));let a=await n.findById(e.params.id),d=await n.findOne().where({parent_main:a.parent_main,number:a.number+1});return null!==d&&(await n.findByIdAndUpdate({_id:e.params.id},{$set:{number:a.number+1}}),await n.findByIdAndUpdate({_id:d._id},{$set:{number:d.number-1}})),t.redirect("/admin/".concat(i.id,"/all/").concat(a.parent_main,"/submenu"))},module.exports.setUpChildSub=async(e,n)=>{const t=await g(r.getId(e));let i=await a.findById(e.params.id).lean(),d=await a.findOne().where({parent_sub:e.params.submenu_id,number:i.number-1});return null!==d&&(await a.findByIdAndUpdate({_id:i._id},{number:i.number-1}),await a.findByIdAndUpdate({_id:d._id},{number:d.number+1})),n.redirect("/admin/".concat(t.id,"/all/submenu/").concat(e.params.submenu_id,"/child"))},module.exports.setDownChildSub=async(e,n)=>{const t=await g(r.getId(e));let i=await a.findById(e.params.id).lean(),d=await a.findOne().where({parent_sub:e.params.submenu_id,number:i.number+1});return null!==d&&(await a.findByIdAndUpdate({_id:i._id},{number:i.number+1}),await a.findByIdAndUpdate({_id:d._id},{number:d.number-1})),n.redirect("/admin/".concat(t.id,"/all/submenu/").concat(e.params.submenu_id,"/child"))};