"use strict";const e=require("lodash"),t=require("../Models/Submenu"),n=require("../Models/Main_Menu"),i=require("../Models/Content"),a=require("../Models/ChildSub"),r=require("../Models/History"),d=require("../API/getAdminid"),s=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),{getAll:o}=require("../API/getAllChildSub"),{addSubChild:c}=require("../API/childSubApi/add"),{getBody:_}=require("../API/childSubApi/getBody"),{updateChildSub:m,deleteChildSub:p}=require("../API/childSubApi/edit"),{updateSubmenu:g}=require("../API/SubMenuAPI/updateSubmenu"),w=require("../API/userAPI/hasAccess"),{userFind:f}=require("../API/userAPI/findUser");module.exports.getSubmenu=async(e,i)=>{const a=await f(d.getId(e));if(!0===await l(e.session,a.id,i)){if(!(await w(a.id,s.MAIN_MENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(a.id,"/main"),url_text:"Повернутися до Головного Меню",user:a.id});try{const{mainmenu_id:a}=e.params,r=await n.findById(a),s=await t.find().where({parent_main:e.params.mainmenu_id});return i.render("submenu_list",{user:d.getId(e),submenu:await u.getConvert(JSON.parse(JSON.stringify(s))),mainmenu_id:a,name_of_parent:r.title})}catch(r){console.error(r)}}return null===await l(e.session,a.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.getEditSubmenuItem=async(e,n)=>{const r=await f(d.getId(e));if(!0===await l(e.session,r.id,n)){if(!(await w(r.id,s.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(r.id,"/main"),url_text:"Повернутися до Головного Меню",user:r.id});{const{id:d,mainmenu_id:s}=e.params;let l="visible";try{const e=await t.findById(d);(await a.find().where({parent_sub:e.id})).length>0&&(l="hidden");const u={title:e.title,lang:e.lang,userid:r.id,action_type:"edit/".concat(d),id:d,mainmenu_id:s,parameter:"visible",vis:l,child_have:l,Info:"Редагування пункту Меню: ".concat(e.title)};switch(e.content_id){case"historyWar":u.currentContent="Історія війни";break;case"files":u.currentContent="Нормативно-правова база";break;case"contact":u.currentContent="Контакти";break;default:{const t=await i.findById(e.content_id).select({_id:0,page_title:1}).lean();u.currentContent=t?t.page_title:""}}const o=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});return u.content_page_list=o,n.status(200).render("edit_submenu",u)}catch(u){console.error(u)}}}return null===await l(e.session,r.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.postEditedSubmenuItem=async(e,n)=>{const i=await f(d.getId(e)),{id:a}=e.params,u=await t.findById(a);if(!0===await l(e.session,i.id,n)){if(!(await w(i.id,s.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});try{await g(a,e);const t=new r({type_content:"Під Меню",operation:"Редагування під пункту Головного Меню: ".concat(u.title),user:i.login});return await t.save(),n.redirect("..")}catch(o){console.error(o)}}return null===await l(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.deleteSubmenuItem=async(n,u)=>{const o=await f(d.getId(n));if(!0===await l(n.session,o.id,u)){if(!(await w(o.id,s.MAIN_MENU)))return u.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});{const{id:d}=n.params,s=await t.findById(d);try{const n=await t.findByIdAndDelete(d);"null"!==s.content_id&&s.content_id&&await i.findByIdAndUpdate(s.content_id,{generated_menu_link:null});const l=await a.find({parent_sub:n.id}).select({_id:1});let c=[];for(let e=0;e<l.length;e++)c.push(await a.find({parent_sub:l[e].id}).select({_id:1}));c=e.flattenDeep(c);let _=[];for(let e=0;e<c.length;e++)_.push(await a.find({parent_sub:c[e].id}).select({_id:1}));_=e.flattenDeep(_);const m=e.concat(l,c,_);for(let e=0;e<m.length;e++)await a.findByIdAndDelete(m[e].id),await i.findOneAndUpdate({generated_menu_link:m[e]},{generated_menu_link:null});const p=new r({type_content:"Підменю",operation:"Видалення підпункту ".concat(s.title," Головного Меню "),user:o.login});return await p.save(),u.status(200).redirect("..")}catch(c){console.error(c)}}}return null===await l(n.session,o.id,u)?u.redirect("/admin/login"):u.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.getAddSubmenuItem=async(e,t)=>{const n=await f(d.getId(e)),{mainmenu_id:a}=e.params,r=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});return!0===await l(e.session,n.id,t)?await w(n.id,s.MAIN_MENU)?t.status(200).render("edit_submenu",{userid:n.id,action_type:"add",parameter:"hidden",mainmenu_id:a,content_page_list:r,vis:"visible",Info:"Cтворення нового пункту меню"}):t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id}):null===await l(e.session,n.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.postAddedSubmenuItem=async(e,n)=>{const u=await f(d.getId(e));if(!(await w(u.id,s.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id});{const{title:s,lang:o,content_id:c}=e.body,{mainmenu_id:_}=e.params;let m;"null"!==c&&"unlink"!==c&&c?(await t.findOneAndUpdate({content_id:c},{content_id:null}),await a.findOneAndUpdate({content_id:c},{content_id:null}),m=new t({title:s,parent_main:_,child_sub:null,user_id:d.getId(e),content_id:c,lang:o})):m=new t({title:s,parent_main:_,child_sub:null,user_id:d.getId(e),content_id:null,lang:o});try{await m.save(),"null"!==c&&c&&await i.findByIdAndUpdate(c,{generated_menu_link:m.id});const e=new r({type_content:"Під Меню",operation:"Додавання підпункту Головного Меню ".concat(m.title),user:u.login});return await e.save(),n.redirect(".")}catch(l){console.error(l)}}},module.exports.getChildSubmenu=async(e,n)=>{const i=await f(d.getId(e)),{submenu_id:r}=e.params;if(!0===await l(e.session,i.id,n)){const e=await o(r),d=await t.findById(r);let s;return null===d&&(s=await a.findById(r)),n.render("submenu_childlist",{childlist:e,user:i.id,submenu_id:r,name_of_parent:null!==d?d.title:s.title})}return null===await l(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).json("Час сесії минув, авторизуйтесь знову!")},module.exports.getAddChildSubmenu=async(e,t)=>{const n=await f(d.getId(e));if(!0===await l(e.session,n.id,t)){const a=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});return t.render("edit_child",{userid:n.id,submenu_id:e.params.submenu_id,parameter:"hidden",action_type:"add",content_page_list:a})}if(null===await l(e.session,n.id,t))return t.redirect("/admin/login");t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.postAddChildSubmenu=async(e,t)=>(await c(e,d.getId(e)),t.redirect(".")),module.exports.getEditChildSubmenu=async(e,t)=>{const{id:n,submenu_id:r}=e.params,s=await _(n),{title:u,lang:l}=s;let o="visible";(await a.find().where({parent_sub:n})).length>0&&(o="hidden");const c={userid:d.getId(e),submenu_id:r,parameter:"visible",action_type:"edit/".concat(n),id:n,title:u,lang:l,vis:o};switch(s.content_id){case"historyWar":c.currentContent="Історія війни";break;case"files":c.currentContent="Нормативно-правова база";break;case"contact":c.currentContent="Контакти";break;default:{const e=await i.findById(s.content_id).select({_id:0,page_title:1}).lean();c.currentContent=e?e.page_title:""}}const m=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});c.content_page_list=m,t.render("edit_child",c)},module.exports.postEditChildSubmenu=async(e,t)=>(await m(e),t.redirect("..")),module.exports.postRemoveChildSubmenu=async(e,t)=>(await p(e),t.status(200).redirect(".."));