"use strict";const e=require("path"),i=require("fs"),t=require("../Models/Command"),n=require("../Models/CommandSign"),d=require("../Models/CommandBackground"),a=require("../Models/History"),r=require("../Models/User"),s=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),m=require("../API/userAPI/hasAccess"),c=require("../API/userAPI/enabledIds");module.exports.getCommandList=async(e,i)=>{const n=await r.findById(s.getId(e));if(!0===await l(e.session,n.id,i)){if(!(await m(n.id,o.COMMAND)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${n.id}/main`,url_text:"Повернутися до Головного Меню",user:n.id});try{const d=await c(n.id,o.COMMAND);let a={};d.length&&(a={_id:{$in:d}});const r=await t.find(a).select({_id:1,title_ua:2,title_en:3,signImg:4}).lean(),s=r.map(e=>{const i={...e};return e.signImg?i.signUrl=`/image/${e.signImg}?width=60&height=60`:i.signUrl="",i});let{page:u}=e.params;const l=n.settings.recordsPerPage.command,m=Math.ceil(r.length/l);(u<1||u>m)&&(u=1);const g=s.slice(l*(u-1),u*l);return i.render("main_menu_command",{user:n.id,command:g,pages:m,current_page:u})}catch(d){console.error(d)}}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.getAddCommand=async(e,i)=>{const t=await r.findById(s.getId(e));return!0===await l(e.session,t.id,i)?await m(t.id,o.COMMAND)?i.render("edit_command",{mode:"add",userid:t.id}):i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id}):null===await l(e.session,t.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.getEditCommand=async(e,i)=>{const n=await r.findById(s.getId(e));if(!0===await l(e.session,n.id,i)){if(!(await m(n.id,o.COMMAND)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${n.id}/main`,url_text:"Повернутися до Головного Меню",user:n.id});try{const{id:d}=e.params,{title_ua:a,title_en:r,link:s,signImg:o}=await t.findById(d).lean(),u=o?`/image/${o}?height=200&width=300`:"";return i.render("edit_command",{title_ua:a,title_en:r,link:s,commandId:d,userid:n.id,mode:"edit",commandSignCurrent:u})}catch(d){console.log(d)}}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.postAddedCommand=async(e,i)=>{const n=await r.findById(s.getId(e));if(!(await m(n.id,o.COMMAND)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${n.id}/main`,url_text:"Повернутися до Головного Меню",user:n.id});{const{title_ua:d,title_en:r,link:o,commandId:u}=e.body,l={title_ua:d,title_en:r,link:o,user_id:s.getId(e)};u?await t.findByIdAndUpdate(u,l):await new t(l).save(),await new a({type_content:" Командування",operation:`Додавання командування ${d}/${r}`,user:n.login}).save(),i.status(200).redirect("./1")}},module.exports.postEditedCommand=async(e,i)=>{const n=await r.findById(s.getId(e));if(!(await m(n.id,o.COMMAND)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${n.id}/main`,url_text:"Повернутися до Головного Меню",user:n.id});{const{title_ua:r,title_en:s,link:o,commandId:u}=e.body;try{await t.findByIdAndUpdate(u,{title_ua:r,title_en:s,link:o,user_id:n.id}),await new a({type_content:" Командування",operation:`Редагування командування ${r}/${s}`,user:n.login}).save(),i.redirect("../1")}catch(d){console.log(d)}}},module.exports.deleteCommand=async(e,i)=>{const n=await r.findById(s.getId(e));if(!0===await l(e.session,n.id,i)){if(!(await m(n.id,o.COMMAND)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${n.id}/main`,url_text:"Повернутися до Головного Меню",user:n.id});try{const d=await t.findByIdAndDelete(e.params.id);return new a({type_content:" Командування",operation:"Видалення командування "+d.title_ua,user:n.login}).save(),i.redirect("../1")}catch(d){console.log(d)}}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})};