"use strict";const e=require("path"),i=require("fs"),n=require("../Models/Command"),t=require("../Models/CommandSign"),a=require("../Models/CommandBackground"),r=require("../Models/History"),d=require("../Models/User"),s=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session");module.exports.getCommandList=async(e,i)=>{const t=await d.findById(s.getId(e));if(!0===await l(e.session,t.id,i)){if(!t.operation.includes(o.COMMAND))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});try{const a=await n.find().select({_id:1,title:2,sign_id:3});let{page:r}=e.params;const d=t.settings.recordsPerPage.command,s=Math.ceil(a.length/d);(r<1||r>s)&&(r=1);const o=a.slice(d*(r-1),r*d);return i.render("main_menu_command",{user:t.id,command:await u.getCommandConverted(o),pages:s,current_page:r})}catch(a){console.log(a)}}return null===await l(e.session,t.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.getAddCommand=async(e,i)=>{const n=await d.findById(s.getId(e));if(!0===await l(e.session,n.id,i)){if(!n.operation.includes(o.COMMAND))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${n.id}/main`,url_text:"Повернутися до Головного Меню",user:n.id});try{return i.render("edit_command",{action_type:"add",sign:await t.find(),background:await a.find(),userid:n.id,parameter:"hidden"})}catch(r){console.log(r)}}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.getEditCommand=async(e,i)=>{const r=await d.findById(s.getId(e));if(!0===await l(e.session,r.id,i)){if(!r.operation.includes(o.COMMAND))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});try{const{id:d,title:s,link:o,sign_id:l,bg_id:c}=await n.findById(e.params.id);let m,g;try{m=await t.findById(l)}catch(u){m=null}try{g=await a.findById(c)}catch(u){g=null}return i.render("edit_command",{title:s,link:o,commandid:d,current_bg_id:g?g.id:null,current_bg_base64:g?g.base64:null,current_bg_name:g?g.name:null,current_sign_id:m?m.id:null,current_sign_base64:m?m.base64:null,current_sign_name:m?m.name:null,sign:await t.find(),background:await a.find(),userid:r.id,parameter:"visible",action_type:"edit/"+d})}catch(c){console.log(c)}}return null===await l(e.session,r.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.postAddedCommand=async(e,i)=>{const t=await d.findById(s.getId(e));if(!t.operation.includes(o.COMMAND))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});{const{title:d,link:o,sign_id:u,bg_id:l}=e.body,c=new n({title:d,link:o,sign_id:u,bg_id:l,user_id:s.getId(e)}),m=new r({type_content:" Командування",operation:"Додавання командування "+d,user:t.login});try{await m.save(),await c.save(),i.status(200).redirect("./1")}catch(a){console.log(a)}}},module.exports.postEditedCommand=async(e,i)=>{const t=await d.findById(s.getId(e));if(!t.operation.includes(o.COMMAND))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});{const{title:d,link:s,sign_id:o,bg_id:u,current_sign_id:l,current_bg_id:c}=e.body;try{await n.findByIdAndUpdate(e.params.id,{title:d,link:s,sign_id:o||l,bg_id:u||c,user_id:t.id});new r({type_content:" Командування",operation:"Редагування командування "+d,user:t.login}).save(),i.redirect("../1")}catch(a){console.log(a)}}},module.exports.deleteCommand=async(e,i)=>{const t=await d.findById(s.getId(e));if(!0===await l(e.session,t.id,i)){if(!t.operation.includes(o.COMMAND))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});try{const a=await n.findByIdAndDelete(e.params.id);return new r({type_content:" Командування",operation:"Видалення командування "+a.title,user:t.login}).save(),i.redirect("../1")}catch(a){console.log(a)}}return null===await l(e.session,t.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.sendCommandSign=async(n,a)=>{const r=await d.findById(s.getId(n));if(!r.operation.includes(o.COMMAND))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});{const r=e.join(__dirname,"../..","uploads/images/command/sign");if(i.existsSync(r)||i.mkdirSync(r,{recursive:!0}),n.files)return await n.files.map(n=>{const a=`${Date.now()}-${n.originalname}`;i.renameSync(e.join(__dirname,"../../uploads/images/temp",n.filename),e.join(r,a)),new t({name:a,url:e.join(r,a),base64:i.readFileSync(e.join(r,a),"base64")}).save()}),a.status(200)}},module.exports.sendCommandBackground=async(n,t)=>{const r=await d.findById(s.getId(n));if(!r.operation.includes(o.COMMAND))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});{const r=e.join(__dirname,"../..","uploads/images/command/bg");if(i.existsSync(r)||i.mkdirSync(r,{recursive:!0}),n.files)return await n.files.map(n=>{const t=`${Date.now()}-${n.originalname}`;i.renameSync(e.join(__dirname,"../../uploads/images/temp",n.filename),e.join(r,t)),new a({name:t,url:e.join(r,t),base64:i.readFileSync(e.join(r,t),"base64")}).save()}),t.status(200)}},module.exports.deleteCommandSign=async(a,r)=>{const u=await d.findById(s.getId(a));if(!0===await l(a.session,u.id,r)){if(u.operation.includes(o.COMMAND)){const a=await t.find();for(let e=0;e<a.length;e++)await t.findByIdAndDelete(a[e].id),await n.updateMany({sign_id:a[e].id},{sign_id:null});const d=e.join(__dirname,"../..","uploads/images/command/sign"),s=i.readdirSync(d);for(let n=0;n<s.length;n++)"default.jpg"!==s[n]&&i.unlinkSync(e.join(d,s[n]));return r.status(200).redirect("..")}return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id})}},module.exports.deleteCommandBackground=async(t,r)=>{const u=await d.findById(s.getId(t));if(!0===await l(t.session,u.id,r)){if(u.operation.includes(o.COMMAND)){const t=await a.find();for(let e=0;e<t.length;e++)await a.findByIdAndDelete(t[e].id),await n.updateMany({bg_id:t[e].id},{bg_id:null});const d=e.join(__dirname,"../..","uploads/images/command/bg"),s=i.readdirSync(d);for(let n=0;n<s.length;n++)i.unlinkSync(e.join(d,s[n]));return r.status(200).redirect("..")}return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",user:u.id})}return null===await l(t.session,u.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getPhotoEditor=async(e,i)=>{const n=await d.findById(s.getId(e));if(!0===await l(e.session,n.id,i)){if(n.operation.includes(o.COMMAND)){const e=u.getConvert(await a.find()),r=u.getConvert(await t.find());return i.status(200).render("command_photo_editor",{backgrounds:e,signs:r,user:n.id})}return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",user:n.id})}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.postDeleteBackgroundOne=async(n,t)=>{const u=await d.findById(s.getId(n));if(!0===await l(n.session,u.id,t)){if(!u.operation.includes(o.COMMAND))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id});{const{id:d}=n.params;try{const n=await a.findByIdAndDelete(d);if(n)try{i.unlinkSync(e.join(__dirname,"../..","uploads/images/command/bg",n.name))}catch(c){console.log(c)}return new r({type_content:" Командування",operation:`Видалення фонового зображення ${n.name} для командування `,user:u.login}).save(),t.redirect("../../photo-editor")}catch(c){console.log(c)}}}return null===await l(n.session,u.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.postDeleteSignOne=async(n,a)=>{const u=await d.findById(s.getId(n));if(!0===await l(n.session,u.id,a)){if(!u.operation.includes(o.COMMAND))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id});{const{id:d}=n.params;try{const n=await t.findByIdAndDelete(d);if(n)try{i.unlinkSync(e.join(__dirname,"../..","uploads/images/command/sign",n.name))}catch(c){console.log(c)}return new r({type_content:" Командування",operation:`Видалення емблеми ${n.name} для командування `,user:u.login}).save(),a.redirect("../../photo-editor")}catch(c){console.log(c)}}}return null===await l(n.session,u.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})};