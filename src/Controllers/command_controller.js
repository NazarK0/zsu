"use strict";const i=require("path"),e=require("fs"),n=require("../Models/Command"),t=require("../Models/CommandSign"),a=require("../Models/CommandBackground"),d=require("../Models/History"),r=require("../Models/User"),s=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),c=require("../API/userAPI/hasAccess"),g=require("../API/userAPI/enabledIds");module.exports.getCommandList=async(i,e)=>{const t=await r.findById(s.getId(i));if(!0===await l(i.session,t.id,e)){if(!(await c(t.id,o.COMMAND)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});try{const a=await g(t.id,o.COMMAND);let d={};a.length&&(d={_id:{$in:a}});const r=await n.find(d).select({_id:1,title_ua:2,title_en:3,sign_id:4});let{page:s}=i.params;const l=t.settings.recordsPerPage.command,c=Math.ceil(r.length/l);(s<1||s>c)&&(s=1);const m=r.slice(l*(s-1),s*l);return e.render("main_menu_command",{user:t.id,command:await u.getCommandConverted(m),pages:c,current_page:s})}catch(a){console.error(a)}}return null===await l(i.session,t.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.getAddCommand=async(i,e)=>{const n=await r.findById(s.getId(i));if(!0===await l(i.session,n.id,e)){if(!(await c(n.id,o.COMMAND)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});try{return e.render("edit_command",{action_type:"add",sign:await t.find(),background:await a.find(),userid:n.id,parameter:"hidden"})}catch(d){console.log(d)}}return null===await l(i.session,n.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.getEditCommand=async(i,e)=>{const d=await r.findById(s.getId(i));if(!0===await l(i.session,d.id,e)){if(!(await c(d.id,o.COMMAND)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});try{const{id:r,title_ua:s,title_en:o,link:l,sign_id:c,bg_id:g}=await n.findById(i.params.id);let m,_;try{m=await t.findById(c)}catch(u){m=null}try{_=await a.findById(g)}catch(u){_=null}return e.render("edit_command",{title_ua:s,title_en:o,link:l,commandid:r,current_bg_id:_?_.id:null,current_bg_base64:_?_.base64:null,current_bg_name:_?_.name:null,current_sign_id:m?m.id:null,current_sign_base64:m?m.base64:null,current_sign_name:m?m.name:null,sign:await t.find(),background:await a.find(),userid:d.id,parameter:"visible",action_type:"edit/".concat(r)})}catch(g){console.log(g)}}return null===await l(i.session,d.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})},module.exports.postAddedCommand=async(i,e)=>{const t=await r.findById(s.getId(i));if(!(await c(t.id,o.COMMAND)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});{const{title_ua:r,title_en:o,link:u,sign_id:l,bg_id:c}=i.body,g=new n({title_ua:r,title_en:o,link:u,sign_id:l,bg_id:c,user_id:s.getId(i)}),m=new d({type_content:" Командування",operation:"Додавання командування ".concat(r,"/").concat(o),user:t.login});try{await m.save(),await g.save(),e.status(200).redirect("./1")}catch(a){console.log(a)}}},module.exports.postEditedCommand=async(i,e)=>{const t=await r.findById(s.getId(i));if(!(await c(t.id,o.COMMAND)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});{const{title_ua:r,title_en:s,link:o,sign_id:u,bg_id:l,current_sign_id:c,current_bg_id:g}=i.body;try{await n.findByIdAndUpdate(i.params.id,{title_ua:r,title_en:s,link:o,sign_id:u||c,bg_id:l||g,user_id:t.id});new d({type_content:" Командування",operation:"Редагування командування ".concat(r,"/").concat(s),user:t.login}).save(),e.redirect("../1")}catch(a){console.log(a)}}},module.exports.deleteCommand=async(i,e)=>{const t=await r.findById(s.getId(i));if(!0===await l(i.session,t.id,e)){if(!(await c(t.id,o.COMMAND)))return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id});try{const a=await n.findByIdAndDelete(i.params.id);return new d({type_content:" Командування",operation:"Видалення командування ".concat(a.title_ua),user:t.login}).save(),e.redirect("../1")}catch(a){console.log(a)}}return null===await l(i.session,t.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.deleteCommandSign=async(a,d)=>{const u=await r.findById(s.getId(a));if(!0===await l(a.session,u.id,d)){if(await c(u.id,o.COMMAND)){const a=await t.find();for(let i=0;i<a.length;i++)await t.findByIdAndDelete(a[i].id),await n.updateMany({sign_id:a[i].id},{sign_id:null});const r=i.join(__dirname,"../..","uploads/images/command/sign"),s=e.readdirSync(r);for(let n=0;n<s.length;n++)"default.jpg"!==s[n]&&e.unlinkSync(i.join(r,s[n]));return d.status(200).redirect("..")}return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id})}},module.exports.deleteCommandBackground=async(t,d)=>{const u=await r.findById(s.getId(t));if(!0===await l(t.session,u.id,d)){if(await c(u.id,o.COMMAND)){const t=await a.find();for(let i=0;i<t.length;i++)await a.findByIdAndDelete(t[i].id),await n.updateMany({bg_id:t[i].id},{bg_id:null});const r=i.join(__dirname,"../..","uploads/images/command/bg"),s=e.readdirSync(r);for(let n=0;n<s.length;n++)e.unlinkSync(i.join(r,s[n]));return d.status(200).redirect("..")}return d.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",user:u.id})}return null===await l(t.session,u.id,d)?d.redirect("/admin/login"):d.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.getPhotoEditor=async(i,e)=>{const n=await r.findById(s.getId(i));if(!0===await l(i.session,n.id,e)){if(await c(n.id,o.COMMAND)){const i=u.getConvert(await a.find()),d=u.getConvert(await t.find());return e.status(200).render("command_photo_editor",{backgrounds:i,signs:d,user:n.id})}return e.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",user:n.id})}return null===await l(i.session,n.id,e)?e.redirect("/admin/login"):e.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})};