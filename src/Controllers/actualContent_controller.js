"use strict";const t=require("fs"),n=require("path"),e=require("../Models/ActualContent"),i=require("../Models/Page"),a=require("../Models/User"),r=require("../Models/History"),d=require("../API/getAdminid"),s=require("../API/op_categories"),{ValidSession:u}=require("../API/Session/session"),o=require("../API/userAPI/hasAccess"),{imgFolderPath:l}=require("../API/constants/uploadPaths"),c="/content_page/";module.exports.getActualContentList=async(t,n)=>{const i=await a.findById(d.getId(t));if(!0===await u(t.session,i.id,n)){if(!(await o(i.id,s.ACTUAL_CONTENT)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id});try{const t=(await e.find().lean()).map(t=>{const n={...t};return t.published?n.published="Опубліковано":n.published="Не Опубліковано",t.img?n.img=`/image/${t.img}?width=300&height=200`:n.img="",n}),a={user:i.id,contentList:t};return n.render("main_menu_actualContent",a)}catch(r){console.error(r)}}return null===await u(t.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.getEditActualContent=async(t,n)=>{const r=await a.findById(d.getId(t));if(!0===await u(t.session,r.id,n)){if(!(await o(r.id,s.ACTUAL_CONTENT)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});{const{id:a}=t.params;try{const{title_ua:t,title_en:d,url_ua:s,url_en:u,hasUaContent:o,hasEnContent:l,hasDirectLinkUa:_,hasDirectLinkEn:g,img:f}=await e.findById(a).lean(),h={mode:"edit",title_ua:t,title_en:d,userid:r.id,id:a,currentUrlUA:"Відсутня",currentUrlEN:"Відсутня"};if(o){const t=s.substring(c.length),{title:n}=await i.findById(t).select({_id:0,title:1});h.currentUrlUA=`сторінка "${n}"`}if(l){const t=u.substring(c.length),{title:n}=await i.findById(t).select({_id:0,title:1});h.currentUrlEN=`сторінка "${n}"`}return _&&(h.currentUrlUA=s),g&&(h.currentUrlEN=u),h.contentPageListUA=await i.find({language:"ua",public_status:"active",bindedToActualContent:!1,isMain:!0}).select({_id:1,title:2}),h.contentPageListEN=await i.find({language:"en",public_status:"active",bindedToActualContent:!1,isMain:!0}).select({_id:1,title:2}),f&&(h.imgSrc=`/image/${f}?width=300&height=200`),n.status(200).render("edit_actualContent",h)}catch(l){console.error(l)}}}return null===await u(t.session,r.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.postEditedActualContent=async(t,n)=>{const l=await a.findById(d.getId(t));if(!0===await u(t.session,l.id,n)){if(await o(l.id,s.ACTUAL_CONTENT)){const{title_ua:a,title_en:d,content_ua_id:s,content_en_id:u,linkType:o,url_ua:g,url_en:f}=t.body,{id:h}=t.params,p=await e.findById(h).lean(),A={title_ua:a,title_en:d,published:!1,user_id:l.id};switch(o){case"noLink":if(A.hasUaContent=!1,A.hasEnContent=!1,A.hasDirectLinkEn=!1,A.hasDirectLinkUa=!1,p.hasUaContent){const t=p.url_ua.substring(c.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}if(p.hasEnContent){const t=p.url_en.substring(c.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}break;case"directLink":if(A.hasUaContent=!1,A.hasEnContent=!1,g.trim().toLowerCase().startsWith("http")&&(A.url_ua=g.trim(),A.hasDirectLinkUa=!0),f.trim().toLowerCase().startsWith("http")&&(A.url_en=f.trim(),A.hasDirectLinkEn=!0),p.hasUaContent){const t=p.url_ua.substring(c.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}if(p.hasEnContent){const t=p.url_en.substring(c.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}break;case"content":if(A.hasDirectLinkEn=!1,A.hasDirectLinkUa=!1,s&&"null"!==s)try{if(A.url_ua=`${c}${s}`,await i.findByIdAndUpdate(s,{bindedToActualContent:!0}),A.hasUaContent=!0,p.hasUaContent){const t=p.url_ua.substring(c.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}}catch(_){A.url_ua="",console.error(_)}else A.url_ua="";if(u&&"null"!==u)try{if(A.url_en=`${c}${u}`,await i.findByIdAndUpdate(u,{bindedToActualContent:!0}),A.hasEnContent=!0,p.hasEnContent){const t=p.url_en.substring(c.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}}catch(_){A.url_en="",console.error(_)}else A.url_en=""}await e.findByIdAndUpdate(h,A);const w=new r({type_content:"Актуальний контент",operation:`Редагування Актуального Контенту "${a}"`,user:l.login});return await w.save(),n.status(200).redirect("..")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${l.id}/main`,url_text:"Повернутися до Головного Меню",user:l.id})}return null===await u(t.session,l.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:l.id})},module.exports.deleteActualContent=async(_,g)=>{const f=await a.findById(d.getId(_));if(!0===await u(_.session,f.id,g)){if(await o(f.id,s.ACTUAL_CONTENT)){const{id:a}=_.params,d=await e.findByIdAndDelete(a);if(d.hasUaContent){const t=d.url_ua.substring(c.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}if(d.hasEnContent){const t=d.url_en.substring(c.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}return d.img&&(t.unlinkSync(n.join(l,d.img)),await e.findByIdAndUpdate(a,{img:""})),new r({type_content:"Актуальний контент",operation:`Видалення пункту Актуального Контенту "${d.title_ua}"`,user:f.login}).save(),g.redirect("..")}return g.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${f.id}/main`,url_text:"Повернутися до Головного Меню",user:f.id})}return null===await u(_.session,f.id,g)?g.redirect("/admin/login"):g.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:f.id})},module.exports.getAddActualContent=async(t,n)=>{const e=await a.findById(d.getId(t));if(!0===await u(t.session,e.id,n)){if(await o(e.id,s.SIDEMENU)){const t=await i.find({language:"ua",public_status:"active",bindedToActualContent:!1,isMain:!0}).select({_id:1,title:2}),a=await i.find({language:"en",public_status:"active",bindedToActualContent:!1,isMain:!0}).select({_id:1,title:2});return n.status(200).render("edit_actualContent",{mode:"add",contentPageListUA:t,contentPageListEN:a,userid:e.id})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${e.id}/main`,url_text:"Повернутися до Головного Меню",user:e.id})}return null===await u(t.session,e.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:e.id})},module.exports.postAddedActualContent=async(t,n)=>{const u=await a.findById(d.getId(t));if(await o(u.id,s.ACTUAL_CONTENT)){const{title_ua:a,title_en:d,linkType:s,url_ua:o,url_en:_,content_ua_id:g,content_en_id:f,actualContentId:h}=t.body,p={title_ua:a,title_en:d,published:!1,hasUaContent:!1,hasEnContent:!1,hasDirectLinkUa:!1,hasDirectLinkEn:!1,user_id:u.id};if("content"===s){if(g&&"null"!==g)try{p.url_ua=`${c}${g}`,await i.findByIdAndUpdate(g,{bindedToActualContent:!0}),p.hasUaContent=!0}catch(l){p.url_ua="",console.error(l)}else p.url_ua="";if(f&&"null"!==f)try{p.url_en=`${c}${f}`,await i.findByIdAndUpdate(f,{bindedToActualContent:!0}),p.hasEnContent=!0}catch(l){p.url_en="",console.error(l)}else p.url_en=""}else"directLink"===s&&(o.toLowerCase().startsWith("http")&&(p.url_ua=o,p.hasDirectLinkUa=!0),_.toLowerCase().startsWith("http")&&(p.url_en=_,p.hasDirectLinkEn=!0));h?await e.findByIdAndUpdate(h,p):await new e(p).save();const A=new r({type_content:"Актуальний контент",operation:"Додавання Актуального контенту "+a,user:u.login});return await A.save(),n.status(200).redirect(".")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id})},module.exports.postChangeActualContentStatus=async(t,n)=>{const i=await a.findById(d.getId(t));if(await o(i.id,s.ACTUAL_CONTENT)){const{id:a}=t.params,d=await e.findById(a).lean();await e.findByIdAndUpdate(a,{published:!d.published});const s=new r({type_content:"Актуальний контент",operation:"Зміна статусу Актуального контенту "+d.title_ua,user:i.login});return await s.save(),n.status(200).redirect("..")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})};