"use strict";const t=require("fs"),n=require("path"),e=require("../Models/ActualContent"),i=require("../Models/Page"),a=require("../Models/User"),r=require("../Models/History"),d=require("../API/getAdminid"),s=require("../API/op_categories"),{ValidSession:u}=require("../API/Session/session"),o=require("../API/userAPI/hasAccess"),l="/content_page/";module.exports.getActualContentList=async(t,n)=>{const i=await a.findById(d.getId(t));if(!0===await u(t.session,i.id,n)){if(!(await o(i.id,s.ACTUAL_CONTENT)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id});try{const t=(await e.find().lean()).map(t=>{const n={...t};return t.published?n.published="Опубліковано":n.published="Не Опубліковано",t.img?n.img=`/image/${t.img}?width=300&height=200`:n.img="",n}),a={user:i.id,contentList:t};return n.render("main_menu_actualContent",a)}catch(r){console.error(r)}}return null===await u(t.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.getEditActualContent=async(t,n)=>{const r=await a.findById(d.getId(t));if(!0===await u(t.session,r.id,n)){if(!(await o(r.id,s.ACTUAL_CONTENT)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${r.id}/main`,url_text:"Повернутися до Головного Меню",user:r.id});{const{id:a}=t.params;try{const{title_ua:t,title_en:d,url_ua:s,url_en:u,hasUaContent:o,hasEnContent:c,hasDirectLinkUa:_,hasDirectLinkEn:f,img:g}=await e.findById(a).lean(),h={mode:"edit",title_ua:t,title_en:d,userid:r.id,id:a,currentUrlUA:"Відсутня",currentUrlEN:"Відсутня"};if(o){const t=s.substring(l.length),{title:n}=await i.findById(t).select({_id:0,title:1});h.currentUrlUA=`сторінка "${n}"`}if(c){const t=u.substring(l.length),{title:n}=await i.findById(t).select({_id:0,title:1});h.currentUrlEN=`сторінка "${n}"`}return _&&(h.currentUrlUA=s),f&&(h.currentUrlEN=u),h.contentPageListUA=await i.find({language:"ua",public_status:"active",bindedToActualContent:!1,isMain:!0}).select({_id:1,title:2}),h.contentPageListEN=await i.find({language:"en",public_status:"active",bindedToActualContent:!1,isMain:!0}).select({_id:1,title:2}),g&&(h.imgSrc=`/image/${g}?width=300&height=200`),n.status(200).render("edit_actualContent",h)}catch(c){console.error(c)}}}return null===await u(t.session,r.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:r.id})},module.exports.postEditedActualContent=async(t,n)=>{const c=await a.findById(d.getId(t));if(!0===await u(t.session,c.id,n)){if(await o(c.id,s.ACTUAL_CONTENT)){const{title_ua:a,title_en:d,content_ua_id:s,content_en_id:u,linkType:o,url_ua:f,url_en:g}=t.body,{id:h}=t.params,p=await e.findById(h).lean(),w={title_ua:a,title_en:d,published:!1,user_id:c.id};switch(o){case"noLink":if(w.hasUaContent=!1,w.hasEnContent=!1,w.hasDirectLinkEn=!1,w.hasDirectLinkUa=!1,p.hasUaContent){const t=p.url_ua.substring(l.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}if(p.hasEnContent){const t=p.url_en.substring(l.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}break;case"directLink":if(w.hasUaContent=!1,w.hasEnContent=!1,f.trim().toLowerCase().startsWith("http")&&(w.url_ua=f.trim(),w.hasDirectLinkUa=!0),g.trim().toLowerCase().startsWith("http")&&(w.url_en=g.trim(),w.hasDirectLinkEn=!0),p.hasUaContent){const t=p.url_ua.substring(l.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}if(p.hasEnContent){const t=p.url_en.substring(l.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}break;case"content":if(w.hasDirectLinkEn=!1,w.hasDirectLinkUa=!1,s&&"null"!==s)try{if(w.url_ua=`${l}${s}`,await i.findByIdAndUpdate(s,{bindedToActualContent:!0}),w.hasUaContent=!0,p.hasUaContent){const t=p.url_ua.substring(l.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}}catch(_){w.url_ua="",console.error(_)}else w.url_ua="";if(u&&"null"!==u)try{if(w.url_en=`${l}${u}`,await i.findByIdAndUpdate(u,{bindedToActualContent:!0}),w.hasEnContent=!0,p.hasEnContent){const t=p.url_en.substring(l.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}}catch(_){w.url_en="",console.error(_)}else w.url_en=""}await e.findByIdAndUpdate(h,w);const A=new r({type_content:"Актуальний контент",operation:`Редагування Актуального Контенту "${a}"`,user:c.login});return await A.save(),n.status(200).redirect("..")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${c.id}/main`,url_text:"Повернутися до Головного Меню",user:c.id})}return null===await u(t.session,c.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:c.id})},module.exports.deleteActualContent=async(t,n)=>{const c=await a.findById(d.getId(t));if(!0===await u(t.session,c.id,n)){if(await o(c.id,s.ACTUAL_CONTENT)){const{id:a}=t.params,d=await e.findByIdAndDelete(a);if(d.hasUaContent){const t=d.url_ua.substring(l.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}if(d.hasEnContent){const t=d.url_en.substring(l.length);await i.findByIdAndUpdate(t,{bindedToActualContent:!1})}return new r({type_content:"Актуальний контент",operation:`Видалення пункту Актуального Контенту "${d.title_ua}"`,user:c.login}).save(),n.redirect("..")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${c.id}/main`,url_text:"Повернутися до Головного Меню",user:c.id})}return null===await u(t.session,c.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:c.id})},module.exports.getAddActualContent=async(t,n)=>{const e=await a.findById(d.getId(t));if(!0===await u(t.session,e.id,n)){if(await o(e.id,s.SIDEMENU)){const t=await i.find({language:"ua",public_status:"active",bindedToActualContent:!1,isMain:!0}).select({_id:1,title:2}),a=await i.find({language:"en",public_status:"active",bindedToActualContent:!1,isMain:!0}).select({_id:1,title:2});return n.status(200).render("edit_actualContent",{mode:"add",contentPageListUA:t,contentPageListEN:a,userid:e.id})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${e.id}/main`,url_text:"Повернутися до Головного Меню",user:e.id})}return null===await u(t.session,e.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:e.id})},module.exports.postAddedActualContent=async(t,n)=>{const u=await a.findById(d.getId(t));if(await o(u.id,s.ACTUAL_CONTENT)){const{title_ua:a,title_en:d,linkType:s,url_ua:o,url_en:_,content_ua_id:f,content_en_id:g,actualContentId:h}=t.body,p={title_ua:a,title_en:d,published:!1,hasUaContent:!1,hasEnContent:!1,hasDirectLinkUa:!1,hasDirectLinkEn:!1,user_id:u.id};if("content"===s){if(f&&"null"!==f)try{p.url_ua=`${l}${f}`,await i.findByIdAndUpdate(f,{bindedToActualContent:!0}),p.hasUaContent=!0}catch(c){p.url_ua="",console.error(c)}else p.url_ua="";if(g&&"null"!==g)try{p.url_en=`${l}${g}`,await i.findByIdAndUpdate(g,{bindedToActualContent:!0}),p.hasEnContent=!0}catch(c){p.url_en="",console.error(c)}else p.url_en=""}else"directLink"===s&&(o.toLowerCase().startsWith("http")&&(p.url_ua=o,p.hasDirectLinkUa=!0),_.toLowerCase().startsWith("http")&&(p.url_en=_,p.hasDirectLinkEn=!0));h?await e.findByIdAndUpdate(h,p):await new e(p).save();const w=new r({type_content:"Актуальний контент",operation:"Додавання Актуального контенту "+a,user:u.login});return await w.save(),n.status(200).redirect(".")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${u.id}/main`,url_text:"Повернутися до Головного Меню",user:u.id})},module.exports.postChangeActualContentStatus=async(t,n)=>{const i=await a.findById(d.getId(t));if(await o(i.id,s.ACTUAL_CONTENT)){const{id:a}=t.params,d=await e.findById(a).lean();await e.findByIdAndUpdate(a,{published:!d.published});const s=new r({type_content:"Актуальний контент",operation:"Зміна статусу Актуального контенту "+d.title_ua,user:i.login});return await s.save(),n.status(200).redirect("..")}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})};