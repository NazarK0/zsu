"use strict";const e=require("nodemailer"),i=require("../Models/Message"),r=require("../Models/MessageArchive"),t=require("../Models/User"),{ValidSession:a}=require("../API/Session/session"),s=require("../API/getAdminid"),n=require("../API/op_categories"),{MailSender:d}=require("../API/Mailer"),{FullDate:o}=require("../API/getDate"),u=require("../API/userAPI/hasAccess");async function l(e,r){const d=await t.findById(s.getId(e));if(!0===await a(e.session,d.id,r)){if(!(await u(d.id,n.MESSAGE)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});try{const t=JSON.parse(JSON.stringify(await(await i.find()).reverse()));let{page:a}=e.params;const s=d.settings.recordsPerPage.message,n=Math.ceil(t.length/s);(a<1||a>n)&&(a=1);const o=t.slice(s*(a-1),a*s);return r.render("main_menu_feedback",{message:o,user:d.id,pages:n,current_page:a})}catch(o){throw new Error(o)}}return null===await a(e.session,d.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}async function c(e,r){const d=await t.findById(s.getId(e));if(!0===await a(e.session,d.id,r)){if(!(await u(d.id,n.MESSAGE)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(d.id,"/main"),url_text:"Повернутися до Головного Меню",user:d.id});try{const{id:t}=e.params,a=JSON.parse(JSON.stringify(await i.findById(t)));return r.render("viewMessage",{userid:d.id,email:a.email,text:a.text,id:t,email_current_user:d.email})}catch(o){throw new Error(o)}}return null===await a(e.session,d.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}const g=async(e,l)=>{const c=await t.findById(s.getId(e));if(!0===await a(e.session,c.id,l)){if(!(await u(c.id,n.MESSAGE)))return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(c.id,"/main"),url_text:"Повернутися до Головного Меню",user:c.id});{const t=await i.findById(e.params.id),{text_response:a,email_password:s}=e.body;try{await d(t.text,t.email,s,c.email,a,l,c),await i.findByIdAndRemove(t.id);const{email:e,text:n,date:u}=t;return await new r({email:e,text:n,date:u,login_response:c.login,text_response:a,date_response:o()}).save(),l.status(200).render("infopage",{info:"Повідомлення успішно відправлене, та збережено до архіву!!",url:"/admin/".concat(c.id,"/message/1"),url_text:"Повернутися до Вхідних Повідомлень",user:c.id})}catch(g){return l.status(400).render("infopage",{info:"Виникли проблеми при відправці, перевірте дані поштового акаунту та спробуйте знову!!",url:"/admin/".concat(c.id,"/message/1"),url_text:"Повернутися до Вхідних Повідомлень",user:c.id})}}}return null===await a(e.session,c.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:c.id})},m=async(e,i)=>{};module.exports={getEmailAdd:m,getAllMessage:l,ViewMessage:c,postSendMessage:g};