"use strict";const e=require("nodemailer"),i=require("../Models/Message"),r=require("../Models/MessageArchive"),t=require("../Models/User"),{ValidSession:s}=require("../API/Session/session"),a=require("../API/getAdminid"),n=require("../API/op_categories"),{MailSender:d}=require("../API/Mailer"),{FullDate:o}=require("../API/getDate"),u=require("../API/userAPI/hasAccess");async function l(e,r){const d=await t.findById(a.getId(e));if(!0===await s(e.session,d.id,r)){if(!(await u(d.id,n.MESSAGE)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{const t=JSON.parse(JSON.stringify(await(await i.find()).reverse()));let{page:s}=e.params;const a=d.settings.recordsPerPage.message,n=Math.ceil(t.length/a);(s<1||s>n)&&(s=1);const o=t.slice(a*(s-1),s*a);return r.render("main_menu_feedback",{message:o,user:d.id,pages:n,current_page:s})}catch(o){throw new Error(o)}}return null===await s(e.session,d.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}async function g(e,r){const d=await t.findById(a.getId(e));if(!0===await s(e.session,d.id,r)){if(!(await u(d.id,n.MESSAGE)))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{const{id:t}=e.params,s=JSON.parse(JSON.stringify(await i.findById(t)));return r.render("viewMessage",{userid:d.id,email:s.email,text:s.text,id:t,email_current_user:d.email})}catch(o){throw new Error(o)}}return null===await s(e.session,d.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}const c=async(e,l)=>{const g=await t.findById(a.getId(e));if(!0===await s(e.session,g.id,l)){if(!(await u(g.id,n.MESSAGE)))return l.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${g.id}/main`,url_text:"Повернутися до Головного Меню",user:g.id});{const t=await i.findById(e.params.id),{text_response:s,email_password:a}=e.body;try{await d(t.text,t.email,a,g.email,s,l,g),await i.findByIdAndRemove(t.id);const{email:e,text:n,date:u}=t;return await new r({email:e,text:n,date:u,login_response:g.login,text_response:s,date_response:o()}).save(),l.status(200).render("infopage",{info:"Повідомлення успішно відправлене, та збережено до архіву!!",url:`/admin/${g.id}/message/1`,url_text:"Повернутися до Вхідних Повідомлень",user:g.id})}catch(c){return l.status(400).render("infopage",{info:"Виникли проблеми при відправці, перевірте дані поштового акаунту та спробуйте знову!!",url:`/admin/${g.id}/message/1`,url_text:"Повернутися до Вхідних Повідомлень",user:g.id})}}}return null===await s(e.session,g.id,l)?l.redirect("/admin/login"):l.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:g.id})},m=async(e,i)=>{};module.exports={getEmailAdd:m,getAllMessage:l,ViewMessage:g,postSendMessage:c};