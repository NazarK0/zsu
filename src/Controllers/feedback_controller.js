"use strict";const e=require("nodemailer"),i=require("../Models/Message"),r=require("../Models/MessageArchive"),t=require("../Models/User"),{ValidSession:s}=require("../API/Session/session"),n=require("../API/getAdminid"),a=require("../API/op_categories"),{MailSender:d}=require("../API/Mailer"),{FullDate:o}=require("../API/getDate");async function u(e,r){const d=await t.findById(n.getId(e));if(!0===await s(e.session,d.id,r)){if(!d.operation.includes(a.MESSAGE))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{const t=JSON.parse(JSON.stringify(await(await i.find()).reverse()));let{page:s}=e.params;const n=d.settings.recordsPerPage.message,a=Math.ceil(t.length/n);(s<1||s>a)&&(s=1);const o=t.slice(n*(s-1),s*n);return r.render("main_menu_feedback",{message:o,user:d.id,pages:a,current_page:s})}catch(o){throw new Error(o)}}return null===await s(e.session,d.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}async function l(e,r){const d=await t.findById(n.getId(e));if(!0===await s(e.session,d.id,r)){if(!d.operation.includes(a.MESSAGE))return r.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{const{id:t}=e.params,s=JSON.parse(JSON.stringify(await i.findById(t)));return r.render("viewMessage",{userid:d.id,email:s.email,text:s.text,id:t,email_current_user:d.email})}catch(o){throw new Error(o)}}return null===await s(e.session,d.id,r)?r.redirect("/admin/login"):r.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}const g=async(e,u)=>{const l=await t.findById(n.getId(e));if(!0===await s(e.session,l.id,u)){if(!l.operation.includes(a.MESSAGE))return u.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${l.id}/main`,url_text:"Повернутися до Головного Меню",user:l.id});{let t=await i.findById(e.params.id);const{email_user:s,text:n,text_response:a,email_password:c}=e.body;try{await d(t.text,t.email,c,l.email,a,u,l),await i.findByIdAndRemove(t.id);const{email:e,text:s,date:n}=t;return await new r({email:e,text:s,date:n,login_response:l.login,text_response:a,date_response:o()}).save(),u.status(200).render("infopage",{info:"Повідомлення успішно відправлене, та збережено до архіву!!",url:`/admin/${l.id}/message/1`,url_text:"Повернутися до Вхідних Повідомлень",user:l.id})}catch(g){return u.status(400).render("infopage",{info:"Виникли проблеми при відправці, перевірте дані поштового акаунту та спробуйте знову!!",url:`/admin/${l.id}/message/1`,url_text:"Повернутися до Вхідних Повідомлень",user:l.id})}}}return null===await s(e.session,l.id,u)?u.redirect("/admin/login"):u.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:l.id})},c=async(e,i)=>{};module.exports={getEmailAdd:c,getAllMessage:u,ViewMessage:l,postSendMessage:g};