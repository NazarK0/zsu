"use strict";const e=require("nodemailer"),i=require("../Models/Message"),t=require("../Models/User"),{ValidSession:r}=require("../API/Session/session"),s=require("../API/getAdminid"),n=require("../API/op_categories");async function a(e,a){const d=await t.findById(s.getId(e));if(!0===await r(e.session,d.id,a)){if(!d.operation.includes(n.MESSAGE))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{const t=JSON.parse(JSON.stringify(await i.find()));let{page:r}=e.params;const s=d.settings.recordsPerPage.message,n=Math.ceil(t.length/s);(r<1||r>n)&&(r=1);const o=t.slice(s*(r-1),r*s);return a.render("main_menu_feedback",{message:o,user:d.id,pages:n,current_page:r})}catch(o){throw new Error(o)}}return null===await r(e.session,d.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}async function d(e,a){const d=await t.findById(s.getId(e));if(!0===await r(e.session,d.id,a)){if(!d.operation.includes(n.MESSAGE))return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id});try{const{id:t}=e.params,r=JSON.parse(JSON.stringify(await i.findById(t)));return a.render("viewMessage",{userid:d.id,email:r.email,text:r.text,id:t})}catch(o){throw new Error(o)}}return null===await r(e.session,d.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})}const o=async(i,a)=>{const d=await t.findById(s.getId(i));if(!0===await r(i.session,d.id,a)){if(d.operation.includes(n.MESSAGE)){const{email_user:t,text:r,text_response:s,email_password:n}=i.body;let d=e.createTransport({host:"smtp.ukr.net",port:2525,secure:!1,auth:{user:"staticman999@ukr.net",pass:n},from:"staticman999@ukr.net"});await d.sendMail({from:"Офіційний портал ЗСУ, staticman999@ukr.net",to:t,subject:"Відповідь на запит",text:s});return a.status(200).redirect("..")}return a.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${d.id}/main`,url_text:"Повернутися до Головного Меню",user:d.id})}return null===await r(i.session,d.id,a)?a.redirect("/admin/login"):a.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:d.id})},u=async(e,i)=>{};module.exports={getEmailAdd:u,getAllMessage:a,ViewMessage:d,postSendMessage:o};