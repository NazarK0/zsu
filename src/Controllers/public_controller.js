"use strict";const e=require("path"),t=require("moment"),s=require("../Models/Message"),a=require("../Models/Menu"),n=require("../Models/Content"),o=require("../Models/Link"),i=require("../Models/Contact"),r=require("../Models/News"),l=require("../Models/Page"),u=require("../Models/Video"),d=require("../Models/VideoCategory"),c=require("../Models/MediaCategory"),g=require("../Models/Category"),{getOneElementBody:m,getSideMenu:p,getNews:y,getResultForTroops:w,getResultForCommand:h,getSlidersPhotoPath:j,getFiltersNews:A,getActual:f,getOneActual:M}=require("../API/publicAPI/public"),q=require("../API/cropImage"),{getMenu:C}=require("../API/MainMenuApi/getAllMenu"),_=t();module.exports.getMainMenu=async(e,t)=>{try{const[e,s]=await Promise.all([await C("ua"),await C("en")]);t.json({ua:e,en:s})}catch(s){t.status(504).json(s)}},module.exports.getNewsALL=async(e,t)=>{try{const{lang:s,stepindex:a}=e.params,n=await y(s,a);t.set("Access-Control-Allow-Origin","*"),t.status(200).json(n)}catch(s){t.status(504).json(s)}},module.exports.getFilterNews=async(e,t)=>{try{const{category:s,date:a}=e.query,{lang:n}=e.params,o={category:s,date:a,lang:n},i=await A(o);return t.json(i)}catch(s){t.status(504).json(s)}},module.exports.getSocialLinks=async(e,t)=>{t.set("Access-Control-Allow-Origin","*");try{const e=await o.find().lean();t.status(200).json(e)}catch(s){t.status(504).json(s)}},module.exports.getAllTroops=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await w();t.status(200).json(e)}catch(s){t.status(504).json(s)}},module.exports.getContacts=async(e,t)=>{try{const e=(await i.find().select({_id:1,title:2,contact:3,type:4}).lean()).map(({_id:e,title:t,contact:s,type:a})=>{let n="";switch(a){case"mail":n="Пошта";break;case"phone":n="Телефон";break;case"address":n="Адреса";break;default:n=a}return{_id:e,title:t,contact:s,type:n}});t.set("Access-Control-Allow-Origin","*"),t.status(200).json(e)}catch(s){t.status(504).json(s)}},module.exports.getAllCommand=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await h();t.status(200).json(e)}catch(s){t.status(504).json(s)}},module.exports.getRss=async(t,s)=>{try{return s.status(200).sendFile(e.join(__dirname,"../..","public","rss.xml"))}catch(a){return s.status(504).json(a)}},module.exports.getActualContent=async(e,t)=>{try{const s=await f(e.params.lang);return t.json(s)}catch(s){return t.status(504).json(s)}},module.exports.getContentPage=async(e,t)=>{try{if("video"===e.params.id){const e=await d.find().lean(),s=[];e.forEach(e=>{s.push(u.find({categoryId:e._id}).lean())});const a=await Promise.all(s),n=e.map((e,t)=>({...e,videos:a[t]}));return t.json(n)}if("photo-galery"===e.params.id){const e=await c.find().lean();return t.json(e)}let s,a=await l.findById(e.params.id),n=await r.findById(e.params.id),o=null;if(null===a&&null==n)return s=null,t.json(s);null!==a&&(s=a),null!==n&&(s=n);let i=[];if(0!==s.links.length){const{links:e,categoryFK:t}=s;null!==t&&(o=await g.findById(t));for(let s=0;s<e.length;s++){let t=await l.findById(e[s]).lean();const{title:a,_id:n}=t;let r={id:n,title:a,imgCategory:null!==o&&""!==o.img?o.img:null};i.push(r)}}let{title:m,description:p,keywords:y,html_body:w,language:h,slider:j,files:A,publishDate:f,type:M,views:q,mainPhoto:C}=s;return void 0!==M?await r.findByIdAndUpdate(s._id,{views:++q}):await l.findByIdAndUpdate(s._id,{views:++q}),t.json({title:m,description:p,publishDate:f,keywords:y,html_body:w,language:h,slider:j,files:A,shared_pages:i,views:q,mainPhoto:C})}catch(s){console.log(s)}},module.exports.getImage=async(t,s)=>{const{name:a}=t.params;let n=Number.parseInt(t.query.width,10),o=Number.parseInt(t.query.height,10);(Number.isNaN(n)||n<0)&&(n=0),(Number.isNaN(o)||o<0)&&(o=0);const i=e.join(__dirname,"../..","uploads/images",a),r=await q(n,o,i);s.send(r)},module.exports.getFile=async(t,s)=>{const{name:a}=t.params;console.log(t.params);const n=e.join(__dirname,"../..","uploads/files",a);s.sendFile(n)};