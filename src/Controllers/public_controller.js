"use strict";const e=require("path"),t=require("moment"),s=require("../Models/Message"),n=require("../Models/Menu"),a=require("../Models/Content"),o=require("../Models/Link"),r=require("../Models/Contact"),l=require("../Models/News"),i=require("../Models/Page"),c=require("../Models/Video"),d=require("../Models/MediaCategory"),u=require("../Models/Category"),{getOneElementBody:m,getSideMenu:g,getNews:p,getResultForTroops:w,getResultForCommand:y,getSlidersPhotoPath:h,getFiltersNews:_,getActual:f,getOneActual:b}=require("../API/publicAPI/public"),A=require("../API/cropImage"),x=t();module.exports.getMainMenu=async(e,t)=>{try{let e=await n.find().where({parentFK:null,language:"ua"}).sort({number:1}).lean();for(let t=0;t<e.length;t++){let s=await n.find().where({parentFK:e[t]._id}).sort({number:1}).lean();if(e[t].child_sub=s.length>0?s:null,null!==e[t].child_sub)for(let a=0;a<e[t].child_sub.length;a++){let s=await(await n.find().sort({number:1}).where({parentFK:e[t].child_sub[a]._id}));e[t].child_sub[a].child_sub=s.length>0?s:null}}let s=await n.find().where({parentFK:null,language:"en"}).sort({number:1}).lean();for(let t=0;t<s.length;t++){let e=await n.find().where({parentFK:s[t]._id}).sort({number:1}).lean();if(s[t].child_sub=e.length>0?e:null,null!==s[t].child_sub)for(let a=0;a<s[t].child_sub.length;a++){let e=await(await n.find().sort({number:1}).where({parentFK:s[t].child_sub[a]._id}));s[t].child_sub[a].child_sub=e.length>0?e:null}}t.json({ua:e,en:s})}catch(s){console.error(s)}},module.exports.getSideMenu=async(e,t)=>{try{const s=await g(e.params.lang);t.set("Access-Control-Allow-Origin","*"),t.status(200).json(s)}catch(s){throw new Error(s)}},module.exports.getNewsALL=async(e,t)=>{try{const s=await p(e.params.lang,e.params.stepindex);t.set("Access-Control-Allow-Origin","*"),t.status(200).json(s)}catch(s){throw new Error(s)}},module.exports.getFilterNews=async(e,t)=>{try{console.log("in");const{category:s,date:n}=e.query,{lang:a}=e.params,o={category:s,date:n,lang:a},r=await _(o);return t.json(r)}catch(s){t.status(500)}},module.exports.getElementMenuBody=async(e,t)=>{t.set("Access-Control-Allow-Origin","*");try{const s=await m(e.params.id);t.status(200).json(s)}catch(s){throw console.log(s),new Error(s)}},module.exports.getElementSideMenu=async(e,t)=>{t.set("Access-Control-Allow-Origin","*");const s={...JSON.parse(JSON.stringify(await a.findOne().where({generated_sidemenu_link:e.params.id})))},n=await h(e,2);s.photo=n,t.status(200).json(s)},module.exports.getNewsOne=async(e,t)=>{},module.exports.getSocialLinks=async(e,t)=>{t.set("Access-Control-Allow-Origin","*"),console.log("in");const s=await o.find();t.status(200).json(s)},module.exports.getAllTroops=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await w();t.status(200).json(e)}catch(s){throw new Error(s)}},module.exports.getContacts=async(e,t)=>{try{const e=(await r.find().select({_id:1,title:2,contact:3,type:4}).lean()).map(({_id:e,title:t,contact:s,type:n})=>{let a="";switch(n){case"mail":a="Пошта";break;case"phone":a="Телефон";break;case"address":a="Адреса";break;default:a=n}return{_id:e,title:t,contact:s,type:a}});t.set("Access-Control-Allow-Origin","*"),t.status(200).json(e)}catch(s){console.error(s)}},module.exports.getAllCommand=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await y();t.status(200).json(e)}catch(s){throw new Error(s)}},module.exports.getContentPicture=async(t,s)=>{const{content:n,type:a,img:o}=t.params,r=e.join(__dirname,"../..","uploads/images",n,a,o);return s.sendFile(r)},module.exports.getCorpsImg=async(t,s,n)=>{const{type:a,name:o}=t.params,r={filename:e.join(__dirname,"../..","uploads/images/corps",a,o)};s.sendFile(o,r,e=>{if(e)try{n(e)}catch(t){}})},module.exports.getCommandImg=async(t,s,n)=>{const{type:a,name:o}=t.params,r={filename:e.join(__dirname,"../..","uploads/images/command",a,o)};s.sendFile(o,r,e=>{if(e)try{n(e)}catch(t){}})},module.exports.getContentFile=async(t,s,n)=>{s.set("Access-Control-Allow-Origin","*");const{content:a,name:o,type:r}=t.params;console.log(a,o);const l={root:e.join(__dirname,"../..","uploads/images",a,"files")};s.sendFile(o,l,e=>{e&&n(e)})},module.exports.getRss=async(t,s)=>s.status(200).sendFile(e.join(__dirname,"../..","public","rss.xml")),module.exports.SaveMessage=async(e,t)=>{const{email:n,text:a}=e.body;return await new s({email:n,text:a,date:x.format("DD-MM-YYYY:HH-mm")}).save(),t.status(200).json({Message:"Good"})},module.exports.getActualContent=async(e,t)=>{try{const s=await f(e.params.lang);return t.json(s)}catch(s){console.error(s),t.status(500).json("Public Exception, Wrong actual content")}},module.exports.getOneActualContent=async(e,t)=>{try{const s=await b(e.params.id);t.json(s)}catch(s){console.error(s),t.status(500).json("Server Error")}},module.exports.getContentPage=async(e,t)=>{try{if("video"===e.params.id){let e=await c.find().sort({date:1}).lean();return t.json(e)}if("photo-galery"===e.params.id){let e=await d.find().lean();return t.json(e)}let s,n=await i.findById(e.params.id),a=await l.findById(e.params.id),o=null;if(null===n&&null==a)return s=null,t.json(s);null!==n&&(s=n),null!==a&&(s=a);let r=[];if(0!==s.links.length){const{links:e,categoryFK:t}=s;null!==t&&(o=await u.findById(t));for(let s=0;s<e.length;s++){let t=await i.findById(e[s]).lean();const{title:n,_id:a}=t;let l={id:a,title:n,imgCategory:null!==o&&""!==o.img?o.img:null};r.push(l)}}let{title:m,description:g,keywords:p,html_body:w,language:y,slider:h,files:_,publishDate:f,type:b,views:A,mainPhoto:x}=s;return void 0!==b?await l.findByIdAndUpdate(s._id,{views:++A}):await i.findByIdAndUpdate(s._id,{views:++A}),t.json({title:m,description:g,publishDate:f,keywords:p,html_body:w,language:y,slider:h,files:_,shared_pages:r,views:A,mainPhoto:x})}catch(s){console.log(s)}},module.exports.getImage=async(t,s)=>{const{name:n}=t.params;let a=Number.parseInt(t.query.width,10),o=Number.parseInt(t.query.height,10);(Number.isNaN(a)||a<0)&&(a=0),(Number.isNaN(o)||o<0)&&(o=0);const r=e.join(__dirname,"../..","uploads/images",n),l=await A(a,o,r);s.send(l)},module.exports.getFile=async(t,s)=>{const{name:n}=t.params;console.log(t.params);const a=e.join(__dirname,"../..","uploads/files",n);s.sendFile(a)};