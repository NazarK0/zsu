"use strict";const e=require("path"),t=require("moment"),n=require("../Models/Message"),s=require("../Models/Menu"),a=require("../Models/Content"),o=require("../Models/Link"),r=require("../Models/Contact"),l=require("../Models/News"),i=require("../Models/Page"),c=require("../Models/Video"),d=require("../Models/VideoCategory"),u=require("../Models/MediaCategory"),m=require("../Models/Category"),{getOneElementBody:g,getSideMenu:p,getNews:w,getResultForTroops:y,getResultForCommand:h,getSlidersPhotoPath:_,getFiltersNews:f,getActual:b,getOneActual:A}=require("../API/publicAPI/public"),x=require("../API/cropImage"),j=t();module.exports.getMainMenu=async(e,t)=>{try{let e=await s.find().where({parentFK:null,language:"ua"}).lean();e.sort((e,t)=>e.number-t.number);for(let t=0;t<e.length;t++){let n=await s.find().where({parentFK:e[t]._id}).lean();if(n.sort((e,t)=>e.number-t.number),e[t].child_sub=n.length>0?n:null,null!==e[t].child_sub)for(let a=0;a<e[t].child_sub.length;a++){let n=await s.find().where({parentFK:e[t].child_sub[a]._id});n.sort((e,t)=>e.number-t.number),e[t].child_sub[a].child_sub=n.length>0?n:null}}let n=await s.find().where({parentFK:null,language:"en"}).lean();n.sort((e,t)=>e.number-t.number);for(let t=0;t<n.length;t++){let e=await s.find().where({parentFK:n[t]._id}).lean();if(e.sort((e,t)=>e.number-t.number),n[t].child_sub=e.length>0?e:null,null!==n[t].child_sub)for(let a=0;a<n[t].child_sub.length;a++){let e=await(await s.find().where({parentFK:n[t].child_sub[a]._id}));e.sort((e,t)=>e.number-t.number),n[t].child_sub[a].child_sub=e.length>0?e:null}}t.json({ua:e,en:n})}catch(n){console.error(n)}},module.exports.getSideMenu=async(e,t)=>{try{const n=await p(e.params.lang);t.set("Access-Control-Allow-Origin","*"),t.status(200).json(n)}catch(n){throw new Error(n)}},module.exports.getNewsALL=async(e,t)=>{try{const n=await w(e.params.lang,e.params.stepindex);t.set("Access-Control-Allow-Origin","*"),t.status(200).json(n)}catch(n){throw new Error(n)}},module.exports.getFilterNews=async(e,t)=>{try{console.log("in");const{category:n,date:s}=e.query,{lang:a}=e.params,o={category:n,date:s,lang:a},r=await f(o);return t.json(r)}catch(n){t.status(500)}},module.exports.getElementMenuBody=async(e,t)=>{t.set("Access-Control-Allow-Origin","*");try{const n=await g(e.params.id);t.status(200).json(n)}catch(n){throw console.log(n),new Error(n)}},module.exports.getElementSideMenu=async(e,t)=>{t.set("Access-Control-Allow-Origin","*");const n={...JSON.parse(JSON.stringify(await a.findOne().where({generated_sidemenu_link:e.params.id})))},s=await _(e,2);n.photo=s,t.status(200).json(n)},module.exports.getNewsOne=async(e,t)=>{},module.exports.getSocialLinks=async(e,t)=>{t.set("Access-Control-Allow-Origin","*"),console.log("in");const n=await o.find();t.status(200).json(n)},module.exports.getAllTroops=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await y();t.status(200).json(e)}catch(n){throw new Error(n)}},module.exports.getContacts=async(e,t)=>{try{const e=(await r.find().select({_id:1,title:2,contact:3,type:4}).lean()).map(({_id:e,title:t,contact:n,type:s})=>{let a="";switch(s){case"mail":a="Пошта";break;case"phone":a="Телефон";break;case"address":a="Адреса";break;default:a=s}return{_id:e,title:t,contact:n,type:a}});t.set("Access-Control-Allow-Origin","*"),t.status(200).json(e)}catch(n){console.error(n)}},module.exports.getAllCommand=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await h();t.status(200).json(e)}catch(n){throw new Error(n)}},module.exports.getContentPicture=async(t,n)=>{const{content:s,type:a,img:o}=t.params,r=e.join(__dirname,"../..","uploads/images",s,a,o);return n.sendFile(r)},module.exports.getCorpsImg=async(t,n,s)=>{const{type:a,name:o}=t.params,r={filename:e.join(__dirname,"../..","uploads/images/corps",a,o)};n.sendFile(o,r,e=>{if(e)try{s(e)}catch(t){}})},module.exports.getCommandImg=async(t,n,s)=>{const{type:a,name:o}=t.params,r={filename:e.join(__dirname,"../..","uploads/images/command",a,o)};n.sendFile(o,r,e=>{if(e)try{s(e)}catch(t){}})},module.exports.getContentFile=async(t,n,s)=>{n.set("Access-Control-Allow-Origin","*");const{content:a,name:o,type:r}=t.params;console.log(a,o);const l={root:e.join(__dirname,"../..","uploads/images",a,"files")};n.sendFile(o,l,e=>{e&&s(e)})},module.exports.getRss=async(t,n)=>n.status(200).sendFile(e.join(__dirname,"../..","public","rss.xml")),module.exports.SaveMessage=async(e,t)=>{const{email:s,text:a}=e.body;return await new n({email:s,text:a,date:j.format("DD-MM-YYYY:HH-mm")}).save(),t.status(200).json({Message:"Good"})},module.exports.getActualContent=async(e,t)=>{try{const n=await b(e.params.lang);return t.json(n)}catch(n){console.error(n),t.status(500).json("Public Exception, Wrong actual content")}},module.exports.getOneActualContent=async(e,t)=>{try{const n=await A(e.params.id);t.json(n)}catch(n){console.error(n),t.status(500).json("Server Error")}},module.exports.getContentPage=async(e,t)=>{try{if("video"===e.params.id){let e=await d.find().lean();for(let t=0;t<e.length;t++){let n=await c.find().where({categoryId:e[t]._id});e[t].videos=n}return t.json(e)}if("photo-galery"===e.params.id){let e=await u.find().lean();return t.json(e)}let n,s=await i.findById(e.params.id),a=await l.findById(e.params.id),o=null;if(null===s&&null==a)return n=null,t.json(n);null!==s&&(n=s),null!==a&&(n=a);let r=[];if(0!==n.links.length){const{links:e,categoryFK:t}=n;null!==t&&(o=await m.findById(t));for(let n=0;n<e.length;n++){let t=await i.findById(e[n]).lean();const{title:s,_id:a}=t;let l={id:a,title:s,imgCategory:null!==o&&""!==o.img?o.img:null};r.push(l)}}let{title:g,description:p,keywords:w,html_body:y,language:h,slider:_,files:f,publishDate:b,type:A,views:x,mainPhoto:j}=n;return void 0!==A?await l.findByIdAndUpdate(n._id,{views:++x}):await i.findByIdAndUpdate(n._id,{views:++x}),t.json({title:g,description:p,publishDate:b,keywords:w,html_body:y,language:h,slider:_,files:f,shared_pages:r,views:x,mainPhoto:j})}catch(n){console.log(n)}},module.exports.getImage=async(t,n)=>{const{name:s}=t.params;let a=Number.parseInt(t.query.width,10),o=Number.parseInt(t.query.height,10);(Number.isNaN(a)||a<0)&&(a=0),(Number.isNaN(o)||o<0)&&(o=0);const r=e.join(__dirname,"../..","uploads/images",s),l=await x(a,o,r);n.send(l)},module.exports.getFile=async(t,n)=>{const{name:s}=t.params;console.log(t.params);const a=e.join(__dirname,"../..","uploads/files",s);n.sendFile(a)};