"use strict";const e=require("path"),t=require("moment"),s=require("../Models/Message"),a=require("../Models/Menu"),n=require("../Models/Content"),o=require("../Models/Link"),r=require("../Models/Contact"),l=require("../Models/News"),i=require("../Models/Page"),c=require("../Models/Video"),d=require("../Models/MediaCategory"),u=require("../Models/Category"),{getOneElementBody:m,getSideMenu:g,getNews:p,getResultForTroops:y,getResultForCommand:w,getSlidersPhotoPath:h,getFiltersNews:f,getActual:_,getOneActual:A}=require("../API/publicAPI/public"),x=require("../API/cropImage"),j=t();module.exports.getMainMenu=async(e,t)=>{try{let s=await a.find().where({parentFK:null,language:e.params.lang}).sort({number:1}).lean();for(let e=0;e<s.length;e++){let t=await a.find().where({parentFK:s[e]._id}).sort({number:1}).lean();if(s[e].child_sub=t.length>0?t:null,null!==s[e].child_sub)for(let n=0;n<s[e].child_sub.length;n++){let t=await(await a.find().sort({number:1}).where({parentFK:s[e].child_sub[n]._id}));s[e].child_sub[n].child_sub=t.length>0?t:null}}t.json(s)}catch(s){console.error(s)}},module.exports.getSideMenu=async(e,t)=>{try{const s=await g(e.params.lang);t.set("Access-Control-Allow-Origin","*"),t.status(200).json(s)}catch(s){throw new Error(s)}},module.exports.getNewsALL=async(e,t)=>{try{const s=await p(e.params.lang,e.params.stepindex);t.set("Access-Control-Allow-Origin","*"),t.status(200).json(s)}catch(s){throw new Error(s)}},module.exports.getFilterNews=async(e,t)=>{try{console.log("in");const{category:s,date:a}=e.query,{lang:n}=e.params,o={category:s,date:a,lang:n},r=await f(o);return t.json(r)}catch(s){t.status(500)}},module.exports.getElementMenuBody=async(e,t)=>{t.set("Access-Control-Allow-Origin","*");try{const s=await m(e.params.id);t.status(200).json(s)}catch(s){throw console.log(s),new Error(s)}},module.exports.getElementSideMenu=async(e,t)=>{t.set("Access-Control-Allow-Origin","*");const s={...JSON.parse(JSON.stringify(await n.findOne().where({generated_sidemenu_link:e.params.id})))},a=await h(e,2);s.photo=a,t.status(200).json(s)},module.exports.getNewsOne=async(e,t)=>{},module.exports.getSocialLinks=async(e,t)=>{t.set("Access-Control-Allow-Origin","*");const s=await o.find();t.status(200).json(s)},module.exports.getAllTroops=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await y();t.status(200).json(e)}catch(s){throw new Error(s)}},module.exports.getContacts=async(e,t)=>{try{const e=(await r.find().select({_id:1,title:2,contact:3,type:4}).lean()).map(({_id:e,title:t,contact:s,type:a})=>{let n="";switch(a){case"mail":n="Пошта";break;case"phone":n="Телефон";break;case"address":n="Адреса";break;default:n=a}return{_id:e,title:t,contact:s,type:n}});t.set("Access-Control-Allow-Origin","*"),t.status(200).json(e)}catch(s){console.error(s)}},module.exports.getAllCommand=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await w();t.status(200).json(e)}catch(s){throw new Error(s)}},module.exports.getContentPicture=async(t,s)=>{const{content:a,type:n,img:o}=t.params,r=e.join(__dirname,"../..","uploads/images",a,n,o);return s.sendFile(r)},module.exports.getCorpsImg=async(t,s,a)=>{const{type:n,name:o}=t.params,r={filename:e.join(__dirname,"../..","uploads/images/corps",n,o)};s.sendFile(o,r,e=>{if(e)try{a(e)}catch(t){}})},module.exports.getCommandImg=async(t,s,a)=>{const{type:n,name:o}=t.params,r={filename:e.join(__dirname,"../..","uploads/images/command",n,o)};s.sendFile(o,r,e=>{if(e)try{a(e)}catch(t){}})},module.exports.getContentFile=async(t,s,a)=>{s.set("Access-Control-Allow-Origin","*");const{content:n,name:o,type:r}=t.params;console.log(n,o);const l={root:e.join(__dirname,"../..","uploads/images",n,"files")};s.sendFile(o,l,e=>{e&&a(e)})},module.exports.getRss=async(t,s)=>s.status(200).sendFile(e.join(__dirname,"../..","public","rss.xml")),module.exports.SaveMessage=async(e,t)=>{const{email:a,text:n}=e.body;return await new s({email:a,text:n,date:j.format("DD-MM-YYYY:HH-mm")}).save(),t.status(200).json({Message:"Good"})},module.exports.getActualContent=async(e,t)=>{try{const s=await _(e.params.lang);return t.json(s)}catch(s){console.error(s),t.status(500).json("Public Exception, Wrong actual content")}},module.exports.getOneActualContent=async(e,t)=>{try{const s=await A(e.params.id);t.json(s)}catch(s){console.error(s),t.status(500).json("Server Error")}},module.exports.getContentPage=async(e,t)=>{try{if("video"===e.params.id){let e=await c.find().sort({date:1}).lean();return t.json(e)}if("photo-galery"===e.params.id){let e=await d.find().lean();return t.json(e)}let s,a=await i.findById(e.params.id),n=await l.findById(e.params.id),o=null;if(null===a&&null==n)return s=null,t.json(s);null!==a&&(s=a),null!==n&&(s=n);let r=[];if(0!==s.links.length){const{links:e,categoryFK:t}=s;null!==t&&(o=await u.findById(t));for(let s=0;s<e.length;s++){let t=await i.findById(e[s]).lean();const{title:a,_id:n}=t;let l={id:n,title:a,imgCategory:null!==o&&""!==o.img?o.img:null};r.push(l)}}let{title:m,description:g,keywords:p,html_body:y,language:w,slider:h,files:f,publishDate:_,type:A,views:x,mainPhoto:j}=s;return void 0!==A?await l.findByIdAndUpdate(s._id,{views:++x}):await i.findByIdAndUpdate(s._id,{views:++x}),t.json({title:m,description:g,publishDate:_,keywords:p,html_body:y,language:w,slider:h,files:f,shared_pages:r,views:x,mainPhoto:j})}catch(s){console.log(s)}},module.exports.getImage=async(t,s)=>{const{name:a}=t.params;let n=Number.parseInt(t.query.width,10),o=Number.parseInt(t.query.height,10);(Number.isNaN(n)||n<0)&&(n=0),(Number.isNaN(o)||o<0)&&(o=0);const r=e.join(__dirname,"../..","uploads/images",a),l=await x(n,o,r);s.send(l)},module.exports.getFile=async(t,s)=>{const{name:a}=t.params;console.log(t.params);const n=e.join(__dirname,"../..","uploads/files",a);s.sendFile(n)};