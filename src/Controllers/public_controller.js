"use strict";const e=require("path"),t=require("moment"),s=require("../Models/Link"),a=require("../Models/Contact"),n=require("../Models/News"),o=require("../Models/Page"),r=require("../Models/Video"),i=require("../Models/VideoCategory"),l=require("../Models/MediaCategory"),c=require("../Models/Category"),{getNews:u,getResultForTroops:d,getResultForCommand:m,getFiltersNews:g,getActual:p}=require("../API/publicAPI/public"),{cropImage:y,makeIcon:w}=require("../API/cropImage"),{iconsFolderPath:h,imgCompressedFolderPath:j,filesFolderPath:A}=require("../API/constants/uploadPaths"),{getMenu:f}=require("../API/MainMenuApi/getAllMenu");module.exports.getMainMenu=async(e,t)=>{try{const[e,s]=await Promise.all([await f("ua"),await f("en")]);t.json({ua:e,en:s})}catch(s){t.status(504).json(s)}},module.exports.getNewsALL=async(e,t)=>{try{const{lang:s,stepindex:a}=e.params,n=await u(s,a);t.set("Access-Control-Allow-Origin","*"),t.status(200).json(n)}catch(s){t.status(504).json(s)}},module.exports.getFilterNews=async(e,t)=>{try{const{category:s,date:a}=e.query,{lang:n}=e.params,o={category:s,date:a,lang:n},r=await g(o);return t.json(r)}catch(s){t.status(504).json(s)}},module.exports.getSocialLinks=async(e,t)=>{t.set("Access-Control-Allow-Origin","*");try{const e=await s.find().lean();t.status(200).json(e)}catch(a){t.status(504).json(a)}},module.exports.getAllTroops=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await d();t.status(200).json(e)}catch(s){t.status(504).json(s)}},module.exports.getContacts=async(e,t)=>{try{const e=(await a.find().select({_id:1,title:2,contact:3,type:4}).lean()).map(({_id:e,title:t,contact:s,type:a})=>{let n="";switch(a){case"mail":n="Пошта";break;case"phone":n="Телефон";break;case"address":n="Адреса";break;default:n=a}return{_id:e,title:t,contact:s,type:n}});t.set("Access-Control-Allow-Origin","*"),t.status(200).json(e)}catch(s){t.status(504).json(s)}},module.exports.getAllCommand=async(e,t)=>{try{t.set("Access-Control-Allow-Origin","*");const e=await m();t.status(200).json(e)}catch(s){t.status(504).json(s)}},module.exports.getRss=async(t,s)=>{try{return s.status(200).sendFile(e.join(__dirname,"../..","public","rss.xml"))}catch(a){return s.status(504).json(a)}},module.exports.getActualContent=async(e,t)=>{try{const s=await p(e.params.lang);return t.json(s)}catch(s){return t.status(504).json(s)}},module.exports.getContentPage=async(e,t)=>{try{if("video"===e.params.id){const e=await i.find().lean(),s=[];e.forEach(e=>{s.push(r.find({categoryId:e._id}).lean())});const a=await Promise.all(s),n=e.map((e,t)=>({...e,videos:a[t]}));return t.json(n)}if("photo-galery"===e.params.id){const e=await l.find().lean();return t.json(e)}let s,a=await o.findById(e.params.id),u=await n.findById(e.params.id),d=null;if(null===a&&null==u)return s=null,t.json(s);null!==a&&(s=a),null!==u&&(s=u);let m=[];if(0!==s.links.length){const{links:e,categoryFK:t}=s;null!==t&&(d=await c.findById(t));for(let s=0;s<e.length;s++){let t=await o.findById(e[s]).lean();const{title:a,_id:n}=t;let r={id:n,title:a,imgCategory:null!==d&&""!==d.img?d.img:null};m.push(r)}}let{title:g,description:p,keywords:y,html_body:w,language:h,slider:j,files:A,publishDate:f,type:I,views:N,mainPhoto:q}=s;return void 0!==I?await n.findByIdAndUpdate(s._id,{views:++N}):await o.findByIdAndUpdate(s._id,{views:++N}),t.json({title:g,description:p,publishDate:f,keywords:y,html_body:w,language:h,slider:j,files:A,shared_pages:m,views:N,mainPhoto:q})}catch(s){console.error(s)}},module.exports.getImage=async(t,s)=>{const{name:a}=t.params;let n=Number.parseInt(t.query.width,10),o=Number.parseInt(t.query.height,10);(Number.isNaN(n)||n<0)&&(n=0),(Number.isNaN(o)||o<0)&&(o=0);const r=e.join(j,a),i=await y(n,o,r);s.send(i)},module.exports.getIcon=async(t,s)=>{const{name:a}=t.params;let n=Number.parseInt(t.query.width,10),o=Number.parseInt(t.query.height,10);(Number.isNaN(n)||n<0)&&(n=0),(Number.isNaN(o)||o<0)&&(o=0);const r=e.join(h,a),i=await y(n,o,r);s.send(i)},module.exports.getFile=async(t,s)=>{const{name:a}=t.params,n=e.join(A,a);s.sendFile(n)};