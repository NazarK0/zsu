"use strict";const e=require("path"),n=require("fs"),a=require("moment"),i=require("image-size"),s=require("sharp"),t=require("jimp"),o=require("../Models/SliderNames"),r=require("../Models/FileNames"),d=require("../Models/MainPhoto"),l=require("../Models/Message"),c=require("../Models/Main_Menu"),m=require("../Models/Content"),u=require("../Models/Link"),p=require("../Models/CorpsSign"),y=require("../Models/CorpsBackground"),f=require("../Models/CommandSign"),g=require("../Models/CommandBackground"),_=require("../Models/Contact"),S=require("../Models/CategoryPhoto"),w=require("../API/SubMenuAPI/getAllChildMain"),h=require("../API/isExistHelper"),{getOneElementBody:j,getSideMenu:x,getNews:b,getResultForTroops:A,getResultForCommand:M,getSlidersPhotoPath:k,getFiltersNews:O}=require("../API/publicAPI/public"),I=a(),C=!0;module.exports.getMainMenu=async(e,n)=>{const a=[];try{const e=await c.find();for(let n=0;n<e.length;n++)e[n].submenu_item=await w(e[n].id),a.push(e[n]);n.set("Access-Control-Allow-Origin","*"),n.json(a)}catch(i){throw new Error(i)}},module.exports.getSideMenu=async(e,n)=>{try{const a=await x(e.params.lang);n.set("Access-Control-Allow-Origin","*"),n.status(200).json(a)}catch(a){throw new Error(a)}},module.exports.getNewsALL=async(e,n)=>{try{const a=await b(e.params.lang);n.set("Access-Control-Allow-Origin","*"),n.status(200).json(a)}catch(a){throw new Error(a)}},module.exports.getFilterNews=async(e,n)=>{console.log("in");try{const{category:a,date:i}=e.query,{lang:s}=e.params,t={category:a,date:i,lang:s},o=await O(t);return n.json(o)}catch(a){n.status(500)}},module.exports.getElementMenuBody=async(e,n)=>{n.set("Access-Control-Allow-Origin","*");try{const a=await j(e.params.id);n.status(200).json(a)}catch(a){throw new Error(a)}},module.exports.getElementSideMenu=async(e,n)=>{n.set("Access-Control-Allow-Origin","*");const a={...JSON.parse(JSON.stringify(await m.findOne().where({generated_sidemenu_link:e.params.id})))},i=await k(e,2);a.photo=i,n.status(200).json(a)},module.exports.getNewsOne=async(e,n)=>{n.set("Access-Control-Allow-Origin","*");try{const a=await m.findById(e.params.id),i=await k(e,1);n.status(200).json({title:a.page_title,photo:i,date:a.date,html_body:a.html_body,createdAt:a.createdAt})}catch(a){throw new Error(a)}},module.exports.getSocialLinks=async(e,n)=>{n.set("Access-Control-Allow-Origin","*");const a=await u.find();n.status(200).json(a)},module.exports.getAllTroops=async(e,n)=>{try{n.set("Access-Control-Allow-Origin","*");const e=await A();n.status(200).json(e)}catch(a){throw new Error(a)}},module.exports.getContacts=async(e,n)=>{try{const e=await _.find().select({_id:1,title:2,contact:3,type:4});n.set("Access-Control-Allow-Origin","*"),n.status(200).json(e)}catch(a){console.error(a)}},module.exports.getAllCommand=async(e,n)=>{try{n.set("Access-Control-Allow-Origin","*");const e=await M();n.status(200).json(e)}catch(a){throw new Error(a)}},module.exports.getContentPicture=async(n,a)=>{const{content:i,type:s,img:t}=n.params,o=e.join(__dirname,"../..","uploads/images",i,s,t);return a.sendFile(o)},module.exports.getCorpsImg=async(n,a,i)=>{const{type:s,name:t}=n.params,o={filename:e.join(__dirname,"../..","uploads/images/corps",s,t)};a.sendFile(t,o,e=>{if(e)try{i(e)}catch(n){}})},module.exports.getCommandImg=async(n,a,i)=>{const{type:s,name:t}=n.params,o={filename:e.join(__dirname,"../..","uploads/images/command",s,t)};a.sendFile(t,o,e=>{if(e)try{i(e)}catch(n){}})},module.exports.getContentFile=async(n,a,i)=>{const{content:s,name:t}=n.params,o={root:e.join(__dirname,"../..","uploads/images",s,"files")};a.sendFile(t,o,e=>{e&&i(e)})},module.exports.getRss=async(n,a)=>a.status(200).sendFile(e.join(__dirname,"../..","public","rss.xml")),module.exports.SaveMessage=async(e,n)=>{const{email:a,text:i}=e.body;return await new l({email:a,text:i,date:I.format("DD-MM-YYYY:HH-mm")}).save(),n.status(200).json({Message:"Good"})},module.exports.postUploadMainPhoto=async(a,t)=>{const o=await a.file,{folder_path:r}=a.body;let l=await d.findOne({base_url:r});if(o){const a=e.join(__dirname,"../..","uploads",r,"fullsize"),c=e.join(__dirname,"../..","uploads",r,"middlesize"),m=e.join(__dirname,"../..","uploads",r,"smallsize"),u=e.join(__dirname,"../..","uploads",r,"960x540");if(n.existsSync(a)){const i=n.readdirSync(a);for(let s=0;s<i.length;s++)n.unlinkSync(e.join(a,i[s]))}else n.mkdirSync(a,{recursive:!0});if(n.existsSync(c)){const a=n.readdirSync(c);for(let i=0;i<a.length;i++)n.unlinkSync(e.join(c,a[i]))}else n.mkdirSync(c,{recursive:!0});if(n.existsSync(m)){const a=n.readdirSync(m);for(let i=0;i<a.length;i++)n.unlinkSync(e.join(m,a[i]))}else n.mkdirSync(m,{recursive:!0});if(n.existsSync(u)){const a=n.readdirSync(u);for(let i=0;i<a.length;++i)n.unlinkSync(e.join(u,a[i]))}else n.mkdirSync(u,{recursive:!0});n.renameSync(e.join(__dirname,"../../uploads/images/temp",o.filename),e.join(__dirname,"../..","uploads",r,"fullsize",o.originalname));const p=e.join(a,o.originalname);i(p,(n,a)=>{if(n)return console.error(n),t.sendStatus(500);s(p).resize({height:parseInt((a.height/2).toString().split(".")[0],10),width:parseInt((a.width/2).toString().split(".")[0],10)}).toFile(e.join(c,o.originalname)).catch(e=>{console.error("Error occured",e)}),s(p).resize({height:parseInt((a.height/4).toString().split(".")[0],10),width:parseInt((a.width/4).toString().split(".")[0],10)}).toFile(e.join(m,o.originalname)).catch(e=>{console.error("Error occured",e)}),s(p).resize({height:540,width:960}).toFile(e.join(u,o.originalname)).catch(e=>{console.error("Error ocurred",e)})}),l?(await d.findByIdAndUpdate(l.id,{name:o.originalname}),l.name=o.originalname):l=await new d({base_url:r,name:o.originalname}).save()}const c=l?l.name:null;return t.send(JSON.stringify({folder:r,filename:c}))},module.exports.postDeleteMainPhoto=async(a,i)=>{const{folder_path:s}=a.body,t=await d.findOne({base_url:s}).select({name:1});if(t)try{n.unlinkSync(e.join(__dirname,"../..","uploads",s,"fullsize",t.name)),n.unlinkSync(e.join(__dirname,"../..","uploads",s,"middlesize",t.name)),n.unlinkSync(e.join(__dirname,"../..","uploads",s,"smallsize",t.name)),n.unlinkSync(e.join(__dirname,"../..","uploads",s,"960x540",t.name)),await d.findOneAndDelete({base_url:s})}catch(o){return console.error(o),i.sendStatus(500)}return i.sendStatus(200)},module.exports.postUploadSlider=async(a,i)=>{const{folder_path:s}=a.body,t=e.join(__dirname,"../..","uploads",s,"sliders");let r=await o.findOne({base_url:s});const d=[],l=await a.files;if(l.length){if(n.existsSync(t)){const a=n.readdirSync(t);for(let i=0;i<a.length;i++)n.unlinkSync(e.join(t,a[i]))}else n.mkdirSync(t,{recursive:!0});l.forEach(a=>{const i="".concat(Math.trunc(1e5*Math.random()),"-").concat(a.originalname);n.renameSync(e.join(__dirname,"../../uploads/images/temp",a.filename),e.join(__dirname,"../..","uploads",s,"sliders",i)),d.push(i)}),r?(await o.findByIdAndUpdate(r.id,{names:d}),r.names=d):r=await new o({names:d,base_url:s}).save()}const c=r?r.names:null,m=r?r.id:null;return i.send(JSON.stringify({folder:s,filenames:c,id:m}))},module.exports.postAddSlider=async(a,i)=>{const{folder_path:s}=a.body,t=await o.findOne({base_url:s}),r=t?t.names:[];if(t&&a.files.length){const d=[];await a.files.forEach(a=>{const i="".concat(Math.trunc(1e5*Math.random()),"-").concat(Date.now());n.renameSync(e.join(__dirname,"../../uploads/images/temp",a.filename),e.join(__dirname,"../..","uploads",s,"sliders",i)),d.push(i)}),r.push(...d),await o.findByIdAndUpdate(t.id,{names:r}).then(()=>i.send(JSON.stringify({folder:s,filenames:r,id:t.id})))}return i.sendStatus(500)},module.exports.postDeleteSliderImage=async(a,i)=>{const{id:s,name:t}=a.params,r=await o.findById(s);if(r){const{names:a,base_url:d}=r,l=a.findIndex(e=>e===t);if(-1!==l){const r=[...a.slice(0,l),...a.slice(l+1)],c=e.join(__dirname,"../..","uploads",d,"sliders");if(r.length)await o.findByIdAndUpdate(s,{names:r}),n.unlinkSync(e.join(c,t));else{await o.findByIdAndDelete(s);n.readdirSync(c).forEach(a=>{n.unlinkSync(e.join(c,a))})}return i.send(JSON.stringify({folder:d,filenames:r}))}}return i.sendStatus(500)},module.exports.postUploadFiles=async(a,i)=>{const{folder_path:s}=a.body,t=e.join(__dirname,"../..","uploads",s,"files");let o=await r.findOne({base_url:s});const d=[];if(a.files.length){if(n.existsSync(t)){const a=n.readdirSync(t);for(let i=0;i<a.length;i++)n.unlinkSync(e.join(t,a[i]))}else n.mkdirSync(t,{recursive:!0});await a.files.forEach(a=>{const i="".concat(Math.trunc(1e5*Math.random()),"-").concat(a.originalname);n.renameSync(e.join(__dirname,"../../uploads/images/temp",a.filename),e.join(__dirname,"../..","uploads",s,"files",i)),d.push(i)}),o?(await r.findByIdAndUpdate(o.id,{names:d}),o.names=d):o=await new r({names:d,base_url:s}).save()}const l=o?o.names:null,c=o?o.id:null;return i.send(JSON.stringify({filenames:l,id:c}))},module.exports.postAddFiles=async(a,i)=>{const{folder_path:s}=a.body,t=await r.findOne({base_url:s}),o=t?t.names:[];if(t&&a.files.length){const d=[];return await a.files.forEach(a=>{const i="".concat(Math.trunc(1e5*Math.random()),"-").concat(a.originalname);n.renameSync(e.join(__dirname,"../../uploads/images/temp",a.filename),e.join(__dirname,"../..","uploads",s,"files",i)),d.push(i)}),o.push(...d),await r.findByIdAndUpdate(t.id,{names:o}),i.send(JSON.stringify({filenames:o,id:t.id}))}return i.sendStatus(500)},module.exports.postDeleteFile=async(a,i)=>{const{id:s,name:t}=a.params,d=await r.findById(s);if(d){const{names:a,base_url:l}=d,c=a.findIndex(e=>e===t);if(-1!==c){const d=[...a.slice(0,c),...a.slice(c+1)],m=e.join(__dirname,"../..","uploads",l,"files");if(d.length)await r.findByIdAndUpdate(s,{names:d}),n.unlinkSync(e.join(m,t));else{await o.findByIdAndDelete(s);n.readdirSync(m).forEach(a=>{n.unlinkSync(e.join(m,a))})}return i.send(JSON.stringify({filenames:d}))}}return i.sendStatus(500)},module.exports.postSendCorpsBG=async(a,i)=>{const s=e.join(__dirname,"../..","uploads/images/corps/bg");if(n.existsSync(s)||n.mkdirSync(s,{recursive:!0}),a.files){const i=await a.files;for(const a of i){const i="".concat(Math.trunc(1e4*Math.random()),"-").concat(a.originalname);n.renameSync(e.join(__dirname,"../../uploads/images/temp",a.filename),e.join(s,i)),await new y({name:i,url:e.join(s,i),base64:n.readFileSync(e.join(s,i),"base64")}).save()}}const t=await y.find().select({_id:1,base64:2}).lean();return i.send(JSON.stringify(t))},module.exports.postDeleteCorpsBG=async(a,i)=>{const{id:s}=a.params,t=await y.findByIdAndDelete(s);if(t)try{n.unlinkSync(e.join(__dirname,"../..","uploads/images/corps/bg",t.name))}catch(r){console.error(r)}const o=await y.find().select({_id:1,base64:2}).lean();return i.send(JSON.stringify(o))},module.exports.postSendCorpsSign=async(a,i)=>{const s=e.join(__dirname,"../..","uploads/images/corps/sign");if(n.existsSync(s)||n.mkdirSync(s,{recursive:!0}),a.files){const i=await a.files;for(const a of i){const i="".concat(Math.trunc(1e4*Math.random()),"-").concat(a.originalname);n.renameSync(e.join(__dirname,"../../uploads/images/temp",a.filename),e.join(s,i)),await new p({name:i,url:e.join(s,i),base64:n.readFileSync(e.join(s,i),"base64")}).save()}}const t=await p.find().select({_id:1,base64:2}).lean();return i.send(JSON.stringify(t))},module.exports.postDeleteCorpsSign=async(a,i)=>{const{id:s}=a.params,t=await p.findByIdAndDelete(s);if(t)try{n.unlinkSync(e.join(__dirname,"../..","uploads/images/corps/sign",t.name))}catch(r){console.error(r)}const o=await p.find().select({_id:1,base64:2}).lean();return i.send(JSON.stringify(o))},module.exports.postSendCommandBG=async(a,i)=>{const s=e.join(__dirname,"../..","uploads/images/command/bg");if(n.existsSync(s)||n.mkdirSync(s,{recursive:!0}),a.files){const i=await a.files;for(const a of i){const i="".concat(Math.trunc(1e4*Math.random()),"-").concat(a.originalname);n.renameSync(e.join(__dirname,"../../uploads/images/temp",a.filename),e.join(s,i)),await new g({name:i,url:e.join(s,i),base64:n.readFileSync(e.join(s,i),"base64")}).save()}}const t=await g.find().select({_id:1,base64:2}).lean();return i.send(JSON.stringify(t))},module.exports.postDeleteCommandBG=async(a,i)=>{const{id:s}=a.params,t=await g.findByIdAndDelete(s);if(t)try{n.unlinkSync(e.join(__dirname,"../..","uploads/images/command/bg",t.name))}catch(r){console.error(r)}const o=await g.find().select({_id:1,base64:2}).lean();return i.send(JSON.stringify(o))},module.exports.postSendCommandSign=async(a,i)=>{const s=e.join(__dirname,"../..","uploads/images/command/sign");if(n.existsSync(s)||n.mkdirSync(s,{recursive:!0}),a.files){const i=await a.files;for(const a of i){const i="".concat(Math.trunc(1e4*Math.random()),"-").concat(a.originalname);n.renameSync(e.join(__dirname,"../../uploads/images/temp",a.filename),e.join(s,i)),await new f({name:i,url:e.join(s,i),base64:n.readFileSync(e.join(s,i),"base64")}).save()}}const t=await f.find().select({_id:1,base64:2}).lean();return i.send(JSON.stringify(t))},module.exports.postDeleteCommandSign=async(a,i)=>{const{id:s}=a.params,t=await f.findByIdAndDelete(s);if(t)try{n.unlinkSync(e.join(__dirname,"../..","uploads/images/command/sign",t.name))}catch(r){console.error(r)}const o=await f.find().select({_id:1,base64:2}).lean();return i.send(JSON.stringify(o))},module.exports.postAddCategoryPhoto=async(a,i)=>{const s=e.join(__dirname,"../..","uploads/images/category");if(n.existsSync(s)||n.mkdirSync(s,{recursive:!0}),a.files){const i=await a.files;for(const a of i){const i="".concat(Math.trunc(1e4*Math.random()),"-").concat(a.originalname);n.renameSync(e.join(__dirname,"../../uploads/images/temp",a.filename),e.join(s,i)),await new S({name:i,url:e.join(s,i),base64:n.readFileSync(e.join(s,i),"base64")}).save()}}const t=await S.find().select({_id:1,base64:2}).lean();return i.send(JSON.stringify(t))},module.exports.Update=async(e,n)=>{JSON.parse(JSON.stringify(await m.find())).forEach(async e=>{await m.findByIdAndUpdate({_id:e._id},{$set:{public_status:"active"}})}),n.json(!0)},module.exports.postSetLinkImg=async(a,i)=>{const s=await a.file;let{linkId:o}=a.body;const r=e.join(__dirname,"../..","uploads","/images/links");let d;if((await u.find({title_ua:void 0,tilte_en:void 0}).lean()).forEach(({img:a})=>{n.unlinkSync(e.join(r,a))}),await u.deleteMany({title_ua:void 0}),s){const a=e.extname(s.originalname);o||(d=await(new u).save(),o=d.id),n.existsSync(r)||n.mkdirSync(r,{recursive:!0});const{isImgExist:l,filename:c}=h(o,r);l&&n.unlinkSync(e.join(r,c));const m="".concat(o,"-").concat(Date.now()).concat(a);return t.read(e.join(__dirname,"../../uploads/images/temp",s.filename)).then(n=>n.cover(300,200).quality(60).write(e.join(r,m))).then(()=>n.unlinkSync(e.join(__dirname,"../../uploads/images/temp",s.filename))),await u.findByIdAndUpdate(o,{img:m}),i.send(JSON.stringify({img:m,id:o}))}return i.sendStatus(404)},module.exports.postDeleteLinkImg=async(a,i)=>{const{id:s}=a.params,t=e.join(__dirname,"../..","uploads","/images/links"),o=n.readdirSync(t).find(e=>e.includes(s));o?(n.unlinkSync(e.join(t,o)),await u.findByIdAndUpdate(s,{img:""}),i.sendStatus(200)):i.sendStatus(404)},module.exports.getLinkPicture=async(n,a,i)=>{const{img:s}=n.params,t=e.join(__dirname,"../..","uploads/images/links",s);a.sendFile(t,e=>{i(e)})};