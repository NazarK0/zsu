"use strict";const e=require("lodash"),n=require("../Models/Main_Menu"),t=require("../Models/Submenu"),i=require("../Models/Content"),a=require("../Models/ChildSub"),r=require("../Models/User"),d=require("../Models/History"),s=require("../API/getAdminid"),l=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:o}=require("../API/Session/session"),c=require("../API/userAPI/hasAccess"),m=require("../API/userAPI/enabledIds"),g=require("../Models/Link");module.exports.getMainMenu=async(e,t)=>{const i=await r.findById(s.getId(e));e.params.lang,e.params.lang;if(!0===await o(e.session,i.id,t)){if(!(await c(i.id,l.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});try{const i=await n.find().where({lang:e.params.lang});return i.sort((e,n)=>e.number-n.number),t.render("main_menu",{user:s.getId(e),lang:"ua"!==e.params.lang?"ua":"en",main:await u.getConvert(i)})}catch(a){console.error(a)}}return null===await o(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Данний користувач авторизований в системі , використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.getEditMainMenuItem=async(e,t)=>{const a=await r.findById(s.getId(e));if(!0===await o(e.session,a.id,t)&&await c(a.id,l.MAIN_MENU)){const{idmenu:r}=e.params,s=await n.findById(r),l=await g.find().lean(),u=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files","commander"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6}),{title:o,lang:c,_id:m,content_id:_}=s;let f="";switch(_){case"historyWar":f="Історія війни";break;case"files":f="Нормативно-правова база";break;case"contact":f="Контакти";break;case"commander":f="Командування";break;case"null":break;default:{const e=await i.findById(_).select({_id:0,page_title:1}).lean();f=e?e.page_title:""}}try{return t.status(200).render("edit_mainmenu",{user:a.id,action_type:"edit/".concat(m),title:o,lang:c,id:m,link_list:l,parameter:"visible",type:2,content_page_list:u,currentContent:f})}catch(d){console.error(d)}}return null===await o(e.session,a.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postEditedMainMenuItem=async(e,i)=>{const u=await r.findById(s.getId(e));if(!0===await o(e.session,u.id,i)){if(!(await c(u.id,l.MAIN_MENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id});{const{title:r,lang:l,content_id:o,link_id:c}=e.body,{idmenu:g}=e.params;try{let m=await n.findById(g);m||(m=await t.findById(g),m||(m=await a.findById(g))),await n.findByIdAndUpdate(e.params.idmenu,{title:r,lang:l,content_id:"null"!==o?o:null,link:"null"!==c?c:null,user_id:s.getId(e)});const _=new d({type_content:"Головне меню",operation:"Редагування пункту головного меню ".concat(m.title),user:u.login});return await _.save(),i.status(200).redirect("/admin/".concat(u.id,"/mainmenu"))}catch(m){console.error(m)}}}return null===await o(e.session,u.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.deleteMainMenuItem=async(u,m)=>{const g=await r.findById(s.getId(u));if(!0===await o(u.session,g.id,m)){if(!(await c(g.id,l.MAIN_MENU)))return m.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(g.id,"/main"),url_text:"Повернутися до Головного Меню",user:g.id});{const{idmenu:r}=u.params,s=await n.findById(r);try{const l=await n.findByIdAndDelete(r);let u=await n.find().where({lang:l.lang}).sort({number:1}).lean();for(let e=0;e<u.length;e++)await n.findByIdAndUpdate({_id:u[e]._id},{$set:{number:e+1}});const o=await t.find({parent_main:l.id}).select({_id:1});let c=[];for(let e=0;e<o.length;e++)c.push(await a.find({parent_sub:o[e].id}).select({_id:1}));c=e.flattenDeep(c);let _=[];for(let e=0;e<c.length;e++)_.push(await a.find({parent_sub:c[e].id}).select({_id:1}));_=e.flattenDeep(_);let f=[];for(let e=0;e<_.length;e++)f.push(await a.find({parent_sub:_[e].id}).select({_id:1}));f=e.flattenDeep(f);const p=e.concat(c,_,f);for(let e=0;e<p.length;e++)await a.findByIdAndDelete(p[e].id),await i.findOneAndUpdate({generated_menu_link:p[e]},{generated_menu_link:null});for(let e=0;e<o.length;e++)await t.findByIdAndDelete(o[e].id),await i.findOneAndUpdate({generated_menu_link:o[e]},{generated_menu_link:null});const w=new d({type_content:"Головне меню",operation:"Видалення пункту головного меню ".concat(s.title),user:g.login});return await w.save(),m.status(200).redirect("/admin/".concat(g.id,"/mainmenu/lang/").concat(l.lang))}catch(_){console.error(_)}}}return null===await o(u.session,g.id,m)?m.redirect("/admin/login"):m.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:g.id})},module.exports.getAddMainMenuItem=async(e,n)=>{const t=await r.findById(s.getId(e)),a=await g.find().lean();if(!0===await o(e.session,t.id,n)){if(await c(t.id,l.MAIN_MENU)){const e=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files","commander"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});return n.status(200).render("edit_mainmenu",{user:t.id,action_type:"add",parameter:"hidden",type:1,content_page_list:e,link_list:a})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(t.id,"/main"),url_text:"Повернутися до Головного Меню",user:t.id})}return null===await o(e.session,t.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.postAddedMainMenuItem=async(e,t)=>{const i=await r.findById(s.getId(e));if(!0===await o(e.session,i.id,t)){if(!(await c(i.id,l.MAIN_MENU)))return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const{title:r,lang:l,content_id:u,link_id:o}=e.body;let c=(await n.find().where({lang:l})).length;const m=new n({title:r,lang:l,content_id:"null"!==u?o:null,link:"null"!==o?o:null,submenu_item:[],user_id:s.getId(e),number:c+=1});try{await m.save();const e=new d({type_content:"Головне меню",operation:"Додавання пункту головного меню ".concat(m.title),user:i.login});return await e.save(),t.redirect("/admin/".concat(i.id,"/mainmenu/lang/").concat(l))}catch(a){console.error(a)}}}return null===await o(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.setUp=async(e,t)=>{const i=await r.findById(s.getId(e));let a=await n.findById(e.params.id).lean(),d=await n.findOne().where({number:a.number-1});return null!==d&&(await n.findByIdAndUpdate({_id:d._id},{$set:{number:d.number+1}}),await n.findByIdAndUpdate({_id:e.params.id},{$set:{number:a.number-1}})),t.redirect("/admin/".concat(i.id,"/mainmenu"))},module.exports.setDown=async(e,t)=>{const i=await r.findById(s.getId(e));let a=await n.findById(e.params.id).lean(),d=await n.findOne().where({number:a.number+1});return null!==d&&(await n.findByIdAndUpdate({_id:d._id},{$set:{number:d.number-1}}),await n.findByIdAndUpdate({_id:e.params.id},{$set:{number:a.number+1}})),t.redirect("/admin/".concat(i.id,"/mainmenu"))},module.exports.Back=(e,n)=>{try{switch(e.params.type){case"1":case"2":return n.redirect("..");default:return n.sendStatus(500)}}catch(t){console.error(t)}},module.exports.getMainPage=async(e,n)=>{const t=await r.findById(s.getId(e));return!0===await o(e.session,t.id,n)?n.render("start_main_menu",{user:t.id,nameuser:t.login}):null===await o(e.session,t.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})};