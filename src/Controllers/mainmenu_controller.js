"use strict";const e=require("lodash"),t=require("../Models/Main_Menu"),i=require("../Models/Submenu"),n=require("../Models/Content"),a=require("../Models/ChildSub"),r=require("../Models/User"),d=require("../Models/History"),s=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),c=require("../API/userAPI/hasAccess"),m=require("../API/userAPI/enabledIds");module.exports.getMainMenu=async(e,i)=>{const n=await r.findById(s.getId(e));if(!0===await l(e.session,n.id,i)){if(!(await c(n.id,o.MAIN_MENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});try{const n=await t.find();return i.render("main_menu",{user:s.getId(e),main:await u.getConvert(n)})}catch(a){console.error(a)}}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Данний користувач авторизований в системі , використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.getEditMainMenuItem=async(e,i)=>{const n=await r.findById(s.getId(e));if(!0===await l(e.session,n.id,i)&&await c(n.id,o.MAIN_MENU)){const{idmenu:r}=e.params,d=await t.findById(r),{title:s,lang:o,_id:u}=d;try{return i.status(200).render("edit_mainmenu",{user:n.id,action_type:"edit/".concat(u),title:s,lang:o,id:u,parameter:"visible",type:2})}catch(a){console.error(a)}}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.postEditedMainMenuItem=async(e,n)=>{const u=await r.findById(s.getId(e));if(!0===await l(e.session,u.id,n)){if(!(await c(u.id,o.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id});{const{title:r,lang:o}=e.body,{idmenu:l}=e.params;try{let c=await t.findById(l);c||(c=await i.findById(l),c||(c=await a.findById(l))),await t.findByIdAndUpdate(e.params.idmenu,{title:r,lang:o,user_id:s.getId(e)});const m=new d({type_content:"Головне меню",operation:"Редагування пункту головного меню ".concat(c.title),user:u.login});return await m.save(),n.status(200).redirect("/admin/".concat(u.id,"/mainmenu"))}catch(m){console.error(m)}}}return null===await l(e.session,u.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.deleteMainMenuItem=async(u,m)=>{const f=await r.findById(s.getId(u));if(!0===await l(u.session,f.id,m)){if(!(await c(f.id,o.MAIN_MENU)))return m.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(f.id,"/main"),url_text:"Повернутися до Головного Меню",user:f.id});{const{idmenu:r}=u.params,s=await t.findById(r);try{const o=await t.findByIdAndDelete(r),u=await i.find({parent_main:o.id}).select({_id:1});let l=[];for(let e=0;e<u.length;e++)l.push(await a.find({parent_sub:u[e].id}).select({_id:1}));l=e.flattenDeep(l);let c=[];for(let e=0;e<l.length;e++)c.push(await a.find({parent_sub:l[e].id}).select({_id:1}));c=e.flattenDeep(c);let g=[];for(let e=0;e<c.length;e++)g.push(await a.find({parent_sub:c[e].id}).select({_id:1}));g=e.flattenDeep(g);const p=e.concat(l,c,g);for(let e=0;e<p.length;e++)await a.findByIdAndDelete(p[e].id),await n.findOneAndUpdate({generated_menu_link:p[e]},{generated_menu_link:null});for(let e=0;e<u.length;e++)await i.findByIdAndDelete(u[e].id),await n.findOneAndUpdate({generated_menu_link:u[e]},{generated_menu_link:null});const w=new d({type_content:"Головне меню",operation:"Видалення пункту головного меню ".concat(s.title),user:f.login});return await w.save(),m.status(200).redirect("/admin/".concat(f.id,"/mainmenu"))}catch(g){console.error(g)}}}return null===await l(u.session,f.id,m)?m.redirect("/admin/login"):m.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:f.id})},module.exports.getAddMainMenuItem=async(e,t)=>{const i=await r.findById(s.getId(e));return!0===await l(e.session,i.id,t)?await c(i.id,o.MAIN_MENU)?t.status(200).render("edit_mainmenu",{user:i.id,action_type:"add",parameter:"hidden",type:1}):t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id}):null===await l(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.postAddedMainMenuItem=async(e,i)=>{const n=await r.findById(s.getId(e));if(!0===await l(e.session,n.id,i)){if(!(await c(n.id,o.MAIN_MENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id});{const{title:r,lang:o}=e.body,u=new t({title:r,lang:o,submenu_item:[],user_id:s.getId(e)});try{await u.save();const e=new d({type_content:"Головне меню",operation:"Додавання пункту головного меню ".concat(u.title),user:n.login});return await e.save(),i.redirect("/admin/".concat(n.id,"/mainmenu"))}catch(a){console.error(a)}}}return null===await l(e.session,n.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.Back=(e,t)=>{try{switch(e.params.type){case"1":case"2":return t.redirect("..");default:return t.sendStatus(500)}}catch(i){console.error(i)}},module.exports.getMainPage=async(e,t)=>{const i=await r.findById(s.getId(e));return!0===await l(e.session,i.id,t)?t.render("start_main_menu",{user:i.id,nameuser:i.login}):null===await l(e.session,i.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})};