"use strict";const e=require("lodash"),t=require("../Models/Main_Menu"),n=require("../Models/Submenu"),i=require("../Models/Content"),a=require("../Models/ChildSub"),r=require("../Models/User"),d=require("../Models/History"),s=require("../API/getAdminid"),u=require("../API/op_categories"),o=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),c=require("../API/userAPI/hasAccess"),m=require("../API/userAPI/enabledIds");module.exports.getMainMenu=async(e,n)=>{const i=await r.findById(s.getId(e));if(!0===await l(e.session,i.id,n)){if(!(await c(i.id,u.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});try{const i=await t.find();return i.sort((e,t)=>e.number-t.number),n.render("main_menu",{user:s.getId(e),main:await o.getConvert(i)})}catch(a){console.error(a)}}return null===await l(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Данний користувач авторизований в системі , використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.getEditMainMenuItem=async(e,n)=>{const a=await r.findById(s.getId(e));if(!0===await l(e.session,a.id,n)&&await c(a.id,u.MAIN_MENU)){const{idmenu:r}=e.params,s=await t.findById(r),u=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6}),{title:o,lang:l,_id:c}=s;try{return n.status(200).render("edit_mainmenu",{user:a.id,action_type:"edit/".concat(c),title:o,lang:l,id:c,parameter:"visible",type:2,content_page_list:u})}catch(d){console.error(d)}}return null===await l(e.session,a.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postEditedMainMenuItem=async(e,i)=>{const o=await r.findById(s.getId(e));if(!0===await l(e.session,o.id,i)){if(!(await c(o.id,u.MAIN_MENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(o.id,"/main"),url_text:"Повернутися до Головного Меню",user:o.id});{const{title:r,lang:u,content_id:l}=e.body,{idmenu:c}=e.params;try{let m=await t.findById(c);m||(m=await n.findById(c),m||(m=await a.findById(c))),await t.findByIdAndUpdate(e.params.idmenu,{title:r,lang:u,content_id:l,user_id:s.getId(e)});const _=new d({type_content:"Головне меню",operation:"Редагування пункту головного меню ".concat(m.title),user:o.login});return await _.save(),i.status(200).redirect("/admin/".concat(o.id,"/mainmenu"))}catch(m){console.error(m)}}}return null===await l(e.session,o.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:o.id})},module.exports.deleteMainMenuItem=async(o,m)=>{const _=await r.findById(s.getId(o));if(!0===await l(o.session,_.id,m)){if(!(await c(_.id,u.MAIN_MENU)))return m.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(_.id,"/main"),url_text:"Повернутися до Головного Меню",user:_.id});{const{idmenu:r}=o.params,s=await t.findById(r);try{const u=await t.findByIdAndDelete(r);let o=await t.find().sort({number:1}).lean();for(let e=0;e<o.length;e++)await t.findByIdAndUpdate({_id:o[e]._id},{$set:{number:e+1}});const l=await n.find({parent_main:u.id}).select({_id:1});let c=[];for(let e=0;e<l.length;e++)c.push(await a.find({parent_sub:l[e].id}).select({_id:1}));c=e.flattenDeep(c);let f=[];for(let e=0;e<c.length;e++)f.push(await a.find({parent_sub:c[e].id}).select({_id:1}));f=e.flattenDeep(f);let g=[];for(let e=0;e<f.length;e++)g.push(await a.find({parent_sub:f[e].id}).select({_id:1}));g=e.flattenDeep(g);const p=e.concat(c,f,g);for(let e=0;e<p.length;e++)await a.findByIdAndDelete(p[e].id),await i.findOneAndUpdate({generated_menu_link:p[e]},{generated_menu_link:null});for(let e=0;e<l.length;e++)await n.findByIdAndDelete(l[e].id),await i.findOneAndUpdate({generated_menu_link:l[e]},{generated_menu_link:null});const w=new d({type_content:"Головне меню",operation:"Видалення пункту головного меню ".concat(s.title),user:_.login});return await w.save(),m.status(200).redirect("/admin/".concat(_.id,"/mainmenu"))}catch(f){console.error(f)}}}return null===await l(o.session,_.id,m)?m.redirect("/admin/login"):m.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:_.id})},module.exports.getAddMainMenuItem=async(e,t)=>{const n=await r.findById(s.getId(e));if(!0===await l(e.session,n.id,t)){if(await c(n.id,u.MAIN_MENU)){const e=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});return t.status(200).render("edit_mainmenu",{user:n.id,action_type:"add",parameter:"hidden",type:1,content_page_list:e})}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id})}return null===await l(e.session,n.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.postAddedMainMenuItem=async(e,n)=>{const i=await r.findById(s.getId(e));if(!0===await l(e.session,i.id,n)){if(!(await c(i.id,u.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const{title:r,lang:u,content_id:o}=e.body;let l=(await t.find()).length;const c=new t({title:r,lang:u,content_id:o,submenu_item:[],user_id:s.getId(e),number:l+=1});try{await c.save();const e=new d({type_content:"Головне меню",operation:"Додавання пункту головного меню ".concat(c.title),user:i.login});return await e.save(),n.redirect("/admin/".concat(i.id,"/mainmenu"))}catch(a){console.error(a)}}}return null===await l(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.setUp=async(e,n)=>{const i=await r.findById(s.getId(e));let a=await t.findById(e.params.id).lean(),d=await t.findOne().where({number:a.number-1});return null!==d&&(await t.findByIdAndUpdate({_id:d._id},{$set:{number:d.number+1}}),await t.findByIdAndUpdate({_id:e.params.id},{$set:{number:a.number-1}})),n.redirect("/admin/".concat(i.id,"/mainmenu"))},module.exports.setDown=async(e,n)=>{const i=await r.findById(s.getId(e));let a=await t.findById(e.params.id).lean(),d=await t.findOne().where({number:a.number+1});return null!==d&&(await t.findByIdAndUpdate({_id:d._id},{$set:{number:d.number-1}}),await t.findByIdAndUpdate({_id:e.params.id},{$set:{number:a.number+1}})),n.redirect("/admin/".concat(i.id,"/mainmenu"))},module.exports.Back=(e,t)=>{try{switch(e.params.type){case"1":case"2":return t.redirect("..");default:return t.sendStatus(500)}}catch(n){console.error(n)}},module.exports.getMainPage=async(e,t)=>{const n=await r.findById(s.getId(e));return!0===await l(e.session,n.id,t)?t.render("start_main_menu",{user:n.id,nameuser:n.login}):null===await l(e.session,n.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})};