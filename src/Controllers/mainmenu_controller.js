"use strict";const e=require("lodash"),t=require("../Models/Main_Menu"),n=require("../Models/Submenu"),i=require("../Models/Content"),a=require("../Models/ChildSub"),r=require("../Models/User"),d=require("../Models/History"),s=require("../API/getAdminid"),o=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:l}=require("../API/Session/session"),c=require("../API/userAPI/hasAccess"),m=require("../API/userAPI/enabledIds");module.exports.getMainMenu=async(e,n)=>{const i=await r.findById(s.getId(e));if(!0===await l(e.session,i.id,n)){if(!(await c(i.id,o.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});try{const i=await t.find();return n.render("main_menu",{user:s.getId(e),main:await u.getConvert(i)})}catch(a){console.error(a)}}return null===await l(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Данний користувач авторизований в системі , використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.getEditMainMenuItem=async(e,n)=>{const a=await r.findById(s.getId(e));if(!0===await l(e.session,a.id,n)&&await c(a.id,o.MAIN_MENU)){const{idmenu:r}=e.params,s=await t.findById(r),o=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6}),{title:u,lang:l,_id:c}=s;try{return n.status(200).render("edit_mainmenu",{user:a.id,action_type:"edit/".concat(c),title:u,lang:l,id:c,parameter:"visible",type:2,content_page_list:o})}catch(d){console.error(d)}}return null===await l(e.session,a.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postEditedMainMenuItem=async(e,i)=>{const u=await r.findById(s.getId(e));if(!0===await l(e.session,u.id,i)){if(!(await c(u.id,o.MAIN_MENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(u.id,"/main"),url_text:"Повернутися до Головного Меню",user:u.id});{const{title:r,lang:o,content_id:l}=e.body,{idmenu:c}=e.params;try{let m=await t.findById(c);m||(m=await n.findById(c),m||(m=await a.findById(c))),await t.findByIdAndUpdate(e.params.idmenu,{title:r,lang:o,content_id:l,user_id:s.getId(e)});const g=new d({type_content:"Головне меню",operation:"Редагування пункту головного меню ".concat(m.title),user:u.login});return await g.save(),i.status(200).redirect("/admin/".concat(u.id,"/mainmenu"))}catch(m){console.error(m)}}}return null===await l(e.session,u.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:u.id})},module.exports.deleteMainMenuItem=async(u,m)=>{const g=await r.findById(s.getId(u));if(!0===await l(u.session,g.id,m)){if(!(await c(g.id,o.MAIN_MENU)))return m.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(g.id,"/main"),url_text:"Повернутися до Головного Меню",user:g.id});{const{idmenu:r}=u.params,s=await t.findById(r);try{const o=await t.findByIdAndDelete(r),u=await n.find({parent_main:o.id}).select({_id:1});let l=[];for(let e=0;e<u.length;e++)l.push(await a.find({parent_sub:u[e].id}).select({_id:1}));l=e.flattenDeep(l);let c=[];for(let e=0;e<l.length;e++)c.push(await a.find({parent_sub:l[e].id}).select({_id:1}));c=e.flattenDeep(c);let _=[];for(let e=0;e<c.length;e++)_.push(await a.find({parent_sub:c[e].id}).select({_id:1}));_=e.flattenDeep(_);const f=e.concat(l,c,_);for(let e=0;e<f.length;e++)await a.findByIdAndDelete(f[e].id),await i.findOneAndUpdate({generated_menu_link:f[e]},{generated_menu_link:null});for(let e=0;e<u.length;e++)await n.findByIdAndDelete(u[e].id),await i.findOneAndUpdate({generated_menu_link:u[e]},{generated_menu_link:null});const p=new d({type_content:"Головне меню",operation:"Видалення пункту головного меню ".concat(s.title),user:g.login});return await p.save(),m.status(200).redirect("/admin/".concat(g.id,"/mainmenu"))}catch(_){console.error(_)}}}return null===await l(u.session,g.id,m)?m.redirect("/admin/login"):m.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:g.id})},module.exports.getAddMainMenuItem=async(e,t)=>{const n=await r.findById(s.getId(e));if(!0===await l(e.session,n.id,t)){if(await c(n.id,o.MAIN_MENU)){const e=await i.find().where({page_type:"content_page",public_status:"active",page_subclass:{$nin:["historyWar","current","contacts","files"]}}).select({_id:1,page_title:2,generated_menu_link:3,generated_sidemenu_link:4,lang:5,keywords:6});return t.status(200).render("edit_mainmenu",{user:n.id,action_type:"add",parameter:"hidden",type:1,content_page_list:e})}return t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(n.id,"/main"),url_text:"Повернутися до Головного Меню",user:n.id})}return null===await l(e.session,n.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})},module.exports.postAddedMainMenuItem=async(e,n)=>{const i=await r.findById(s.getId(e));if(!0===await l(e.session,i.id,n)){if(!(await c(i.id,o.MAIN_MENU)))return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:"/admin/".concat(i.id,"/main"),url_text:"Повернутися до Головного Меню",user:i.id});{const{title:r,lang:o,content_id:u}=e.body,l=new t({title:r,lang:o,content_id:u,submenu_item:[],user_id:s.getId(e)});try{await l.save();const e=new d({type_content:"Головне меню",operation:"Додавання пункту головного меню ".concat(l.title),user:i.login});return await e.save(),n.redirect("/admin/".concat(i.id,"/mainmenu"))}catch(a){console.error(a)}}}return null===await l(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.Back=(e,t)=>{try{switch(e.params.type){case"1":case"2":return t.redirect("..");default:return t.sendStatus(500)}}catch(n){console.error(n)}},module.exports.getMainPage=async(e,t)=>{const n=await r.findById(s.getId(e));return!0===await l(e.session,n.id,t)?t.render("start_main_menu",{user:n.id,nameuser:n.login}):null===await l(e.session,n.id,t)?t.redirect("/admin/login"):t.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:n.id})};