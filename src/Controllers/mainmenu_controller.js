"use strict";const e=require("lodash"),n=require("../Models/Main_Menu"),i=require("../Models/Submenu"),t=require("../Models/Page"),a=require("../Models/ChildSub"),d=require("../Models/User"),r=require("../Models/History"),s=require("../API/getAdminid"),l=require("../API/op_categories"),u=require("../API/Converter"),{ValidSession:o}=require("../API/Session/session"),m=require("../API/userAPI/hasAccess"),c=require("../API/userAPI/enabledIds"),g=require("../Models/Link");module.exports.getMainMenu=async(e,i)=>{const t=await d.findById(s.getId(e));if(!0===await o(e.session,t.id,i)){if(!(await m(t.id,l.MAIN_MENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${t.id}/main`,url_text:"Повернутися до Головного Меню",user:t.id});{const{lang:t}=e.params;try{let a=await n.find({lang:t});a.sort((e,n)=>e.number-n.number);const d="ua"===t?"en":"ua";return i.render("main_menu",{user:s.getId(e),langCurrent:t,langOther:d,main:await u.getConvert(a)})}catch(a){console.error(a)}}}return null===await o(e.session,t.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Данний користувач авторизований в системі , використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:t.id})},module.exports.getEditMainMenuItem=async(e,i)=>{const a=await d.findById(s.getId(e));if(!0===await o(e.session,a.id,i)&&await m(a.id,l.MAIN_MENU)){const{language:d,idmenu:s}=e.params,l=await n.findById(s),u=await g.find().lean(),o=await t.find({public_status:"active",language:d,isMain:!0,bindedToMenu:!1}).select({_id:1,title:2}).lean(),{title:m,_id:c,content_id:f}=l;let _="";const w=await t.findById(f).select({_id:0,title:1}).lean();_=w?w.title:"";try{return i.status(200).render("edit_mainmenu",{user:a.id,mode:"edit",title:m,language:d,id:c,link_list:u,type:2,pagesList:o,currentContent:_})}catch(r){console.error(r)}}return null===await o(e.session,a.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.postEditedMainMenuItem=async(e,i)=>{const a=await d.findById(s.getId(e));if(!0===await o(e.session,a.id,i)){if(!(await m(a.id,l.MAIN_MENU)))return i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${a.id}/main`,url_text:"Повернутися до Головного Меню",user:a.id});{const{title:d,content__id:l,link_id:o}=e.body,{language:m,idmenu:c}=e.params,g={title:d,lang:m,link:"null"!==o?o:null,user_id:s.getId(e)},f=await n.findById(c).select({_id:0,content_id:1}).lean();"unlink"===l?(g.content_id=null,f.content_id&&await t.findByIdAndUpdate(f.content_id,{bindedToMenu:!1})):l&&"null"!==l&&"unlink"!==l&&(g.content_id=l,await t.findByIdAndUpdate(l,{bindedToMenu:!0}));try{const e=await n.findByIdAndUpdate(c,g);return await new r({type_content:"Головне меню",operation:"Редагування пункту головного меню "+e.title,user:a.login}).save(),i.status(200).redirect(`/admin/${a.id}/mainmenu/lang/${e.lang}`)}catch(u){console.error(u)}}}return null===await o(e.session,a.id,i)?i.redirect("/admin/login"):i.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:a.id})},module.exports.deleteMainMenuItem=async(u,c)=>{const g=await d.findById(s.getId(u));if(!0===await o(u.session,g.id,c)){if(!(await m(g.id,l.MAIN_MENU)))return c.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${g.id}/main`,url_text:"Повернутися до Головного Меню",user:g.id});{const{idmenu:d}=u.params,s=await n.findById(d);try{const l=await n.findByIdAndDelete(d);let u=await n.find().where({lang:l.lang}).lean();u.sort((e,n)=>e.number-n.number);for(let e=0;e<u.length;e++)await n.findByIdAndUpdate({_id:u[e]._id},{$set:{number:e+1}});const o=await i.find({parent_main:l.id}).select({_id:1});let m=[];for(let e=0;e<o.length;e++)m.push(await a.find({parent_sub:o[e].id}).select({_id:1}));m=e.flattenDeep(m);let f=[];for(let e=0;e<m.length;e++)f.push(await a.find({parent_sub:m[e].id}).select({_id:1}));f=e.flattenDeep(f);let _=[];for(let e=0;e<f.length;e++)_.push(await a.find({parent_sub:f[e].id}).select({_id:1}));_=e.flattenDeep(_);const w=e.concat(m,f,_);for(let e=0;e<w.length;e++)await a.findByIdAndDelete(w[e].id),await t.findOneAndUpdate({generated_menu_link:w[e]},{generated_menu_link:null});for(let e=0;e<o.length;e++)await i.findByIdAndDelete(o[e].id),await t.findOneAndUpdate({generated_menu_link:o[e]},{generated_menu_link:null});const p=new r({type_content:"Головне меню",operation:"Видалення пункту головного меню "+s.title,user:g.login});return await p.save(),c.status(200).redirect(`/admin/${g.id}/mainmenu/lang/${l.lang}`)}catch(f){console.error(f)}}}return null===await o(u.session,g.id,c)?c.redirect("/admin/login"):c.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:g.id})},module.exports.getAddMainMenuItem=async(e,n)=>{const i=await d.findById(s.getId(e)),a=await g.find().lean();if(!0===await o(e.session,i.id,n)){if(await m(i.id,l.MAIN_MENU)){const{language:d}=e.params,r=await t.find({public_status:"active",isMain:!0,language:d,bindedToMenu:!1}).select({_id:1,title:2});return n.status(200).render("edit_mainmenu",{user:i.id,mode:"add",language:d,type:1,pagesList:r,link_list:a})}return n.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})}return null===await o(e.session,i.id,n)?n.redirect("/admin/login"):n.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:i.id})},module.exports.postAddedMainMenuItem=async(e,u)=>{const c=await d.findById(s.getId(e));if(!0===await o(e.session,c.id,u)){if(await m(c.id,l.MAIN_MENU)){const{title:d,content__id:l,link_id:o}=e.body,{language:m}=e.params,g=(await n.find().where({lang:m})).length,f={title:d,lang:m,link:"null"!==o?o:null,user_id:s.getId(e),number:g+1};l&&"null"!==l&&"unlink"!==l?(await n.findOneAndUpdate({content_id:l},{content_id:null}),await i.findOneAndUpdate({content_id:l},{content_id:null}),await a.findOneAndUpdate({content_id:l},{content_id:null}),f.content_id=l,await t.findByIdAndUpdate(l,{bindedToMenu:!0})):f.content_id=null;const _=await new n(f).save();return await new r({type_content:"Головне меню",operation:"Додавання пункту головного меню "+_.title,user:c.login}).save(),u.redirect(`/admin/${c.id}/mainmenu/lang/${m}`)}return u.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${c.id}/main`,url_text:"Повернутися до Головного Меню",user:c.id})}return null===await o(e.session,c.id,u)?u.redirect("/admin/login"):u.status(400).render("infopage",{info:"Даний користувач авторизований в системі, використайте інший обліковий запис!",url:"/admin/login",url_text:"Повернутися до форми авторизації",user:c.id})},module.exports.setUp=async(e,i)=>{const t=await d.findById(s.getId(e)),a=await n.findById(e.params.id).lean(),r=await n.findOne().where({number:a.number-1});return null!==r&&(await n.findByIdAndUpdate({_id:r._id},{$set:{number:r.number+1}}),await n.findByIdAndUpdate({_id:e.params.id},{$set:{number:a.number-1}})),i.redirect(`/admin/${t.id}/mainmenu/lang/${e.params.lang}`)},module.exports.setDown=async(e,i)=>{const t=await d.findById(s.getId(e)),a=await n.findById(e.params.id).lean(),r=await n.findOne().where({number:a.number+1});return null!==r&&(await n.findByIdAndUpdate({_id:r._id},{$set:{number:r.number-1}}),await n.findByIdAndUpdate({_id:e.params.id},{$set:{number:a.number+1}})),i.redirect(`/admin/${t.id}/mainmenu/lang/${e.params.lang}`)},module.exports.Back=(e,n)=>{try{switch(e.params.type){case"1":case"2":return n.redirect("..");default:return n.sendStatus(500)}}catch(i){console.error(i)}};