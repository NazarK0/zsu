"use strict";const e=require("../../src/Models/Video"),t=require("../../src/Models/VideoCategory"),i=require("../../src/Models/History"),a=require("../../src/Models/User"),d=require("../API/getAdminid"),r=require("../API/userAPI/hasAccess"),n=require("../API/op_categories");module.exports.getAllCategorys=async(e,i)=>{let o=await a.findById(d.getId(e)).lean(),s=await t.find().lean();return await r(o._id,n.VIDEO)?i.render("main_menu_video_category",{user:o._id,videos:s}):i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.getAddCategory=async function(e,t){let i=await a.findById(d.getId(e)).lean();return await r(i._id,n.VIDEO)?t.render("edit_video_category",{userid:i._id,action_type:"add",parameter:"hidden "}):t.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${i.id}/main`,url_text:"Повернутися до Головного Меню",user:i.id})},module.exports.getEditCategory=async function(e,i){let o=await a.findById(d.getId(e)).lean(),s=await t.findById(e.params.id).lean();const{title_ua:l,title_en:c,_id:u}=s;return await r(o._id,n.VIDEO)?i.render("edit_video_category",{selected_category_id:s._id,title_ua:l,title_en:c,userid:o._id,action_type:"edit/"+u}):i.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${o.id}/main`,url_text:"Повернутися до Головного Меню",user:o.id})},module.exports.postAddCategory=async function(e,o){let s=await a.findById(d.getId(e)).lean(),l={...e.body};return await r(s._id,n.VIDEO)?(await new t({title_ua:l.title_ua,title_en:l.title_en}).save(),await new i({type_content:"Відео Категорія",operation:`Додавання нової категорії: ${l.title_ua}/${l.title_en}`,user:""+s.login}).save(),o.redirect(`/admin/${s._id}/video-categorys`)):o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${s.id}/main`,url_text:"Повернутися до Головного Меню",user:s.id})},module.exports.postEditCategory=async function(e,o){let s=await a.findById(d.getId(e)).lean(),l={...e.body};if(await r(s._id,n.VIDEO)){let a=await t.findByIdAndUpdate(e.params.id,{...l});return await new i({type_content:"Відео Категорія",operation:`Редагування Відео Категорії: ${a.title_ua}/${a.title_en}`,user:""+s.login}).save(),o.redirect(`/admin/${s._id}/video-categorys`)}return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${s.id}/main`,url_text:"Повернутися до Головного Меню",user:s.id})},module.exports.postRemoveCategory=async function(e,o){let s=await a.findById(d.getId(e)).lean();if(await r(s._id,n.VIDEO)){let a=await t.findByIdAndRemove(e.params.id);return await new i({type_content:"Відео Категорія",operation:`Видалення Відео Категорії: ${a.title_ua}/${a.title_en}`,user:""+s.login}).save(),o.redirect(`/admin/${s._id}/video-categorys`)}return o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${s.id}/main`,url_text:"Повернутися до Головного Меню",user:s.id})},module.exports.getAllVideosByCategory=async function(i,o){let s=await a.findById(d.getId(i)).lean(),l=await e.find().where({categoryId:i.params.id_category}).lean(),c=await t.findById(i.params.id_category);return await r(s._id,n.VIDEO)?o.render("main_menu_video",{category:c.title_ua,id_category:i.params.id_category,user:s._id,videos:l}):o.status(400).render("infopage",{info:"Вам обмежено доступ для данної Категорії!",url:`/admin/${s.id}/main`,url_text:"Повернутися до Головного Меню",user:s.id})},module.exports.getAddVideo=async function(e,t){try{let i=await a.findById(d.getId(e)).lean();return t.render("edit_video",{id_category:e.params.id_category,action_type:"add",userid:i._id})}catch(i){console.error(i)}},module.exports.postAddVideo=async function(t,r){let n=await a.findById(d.getId(t)).lean();const{title:o,description:s,link:l,date:c}=t.body;return await new e({title:o,description:s,link:l,date:c,categoryId:t.params.id_category}).save(),await new i({type_content:"Відео",operation:`Додавання Відео: ${o} `,user:n.login}).save(),r.redirect(`/admin/${n._id}/video-categorys/${t.params.id_category}/video`)},module.exports.getEditVideo=async function(t,i){try{let r=await a.findById(d.getId(t)).lean(),n=await e.findById(t.params.id);const{_id:o,title:s,description:l,link:c,date:u}=n;return i.render("edit_video",{id:o,action_type:"edit/"+o,userid:r._id,title:s,description:l,link:c,date:u,id_category:t.params.id_category})}catch(r){console.error(r)}},module.exports.postEditVideo=async function(t,r){try{let n=await a.findById(d.getId(t)).lean();const{title:o,description:s,link:l,date:c}=t.body;return await e.findByIdAndUpdate(t.params.id,{title:o,description:s,link:l,date:c}),await new i({type_content:"Відео",operation:`Редагування Відео: ${o} `,user:n.login}).save(),r.redirect(`/admin/${n._id}/video-categorys/${t.params.id_category}/video`)}catch(n){console.error(n)}},module.exports.postRemoveVideo=async function(t,r){try{let n=await a.findById(d.getId(t)).lean(),o=await e.findByIdAndDelete(t.params.id);return await new i({type_content:"Відео",operation:`Видалення Відео: ${o.title} `,user:n.login}).save(),r.redirect(`/admin/${n._id}/video-categorys/${t.params.id_category}/video`)}catch(n){console.error(n)}};